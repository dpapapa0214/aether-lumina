<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Echoes PVP - „Ç¢„Éº„Ç±„Ç§„É≥„Ç®„Ç≥„Éº„Ç∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" href="icons/logo-gamepad2.png">
    <link rel="apple-touch-icon" href="icons/logo-gamepad2.png">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+JP:wght@300;400&display=swap" rel="stylesheet">
    <style>
        /* magic_rpg.html „Åã„Çâ„Çπ„Çø„Ç§„É´„ÇíÊµÅÁî® */
        :root { --bg-color: #0a0a1a; --primary-color: #1a1a3a; --secondary-color: #2a2a5a; --accent-color: #c0a0ff; --text-color: #e0e0ff; --gold-color: #ffd700; --p1-color: #4ade80; --p2-color: #f87171; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Noto Sans JP', sans-serif; background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0); background-size: 20px 20px; }
        .font-cinzel { font-family: 'Cinzel', serif; }
        .glassmorphism { background: rgba(26, 26, 58, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(192, 160, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .magic-button { position: relative; border: 1px solid var(--accent-color); background: linear-gradient(145deg, var(--secondary-color), var(--primary-color)); color: var(--text-color); transition: all 0.3s ease; box-shadow: 0 0 5px rgba(192, 160, 255, 0.3); clip-path: polygon(5% 0%, 95% 0%, 100% 50%, 95% 100%, 5% 100%, 0% 50%); }
        .magic-button:hover { transform: translateY(-2px); box-shadow: 0 0 15px var(--accent-color); color: white; }
        .magic-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .turn-active { border: 2px solid var(--gold-color); box-shadow: 0 0 15px var(--gold-color); }
        
        .p1-theme .magic-button { border-color: var(--p1-color); }
        .p2-theme .magic-button { border-color: var(--p2-color); }
        
        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Éî„Éä„Éº */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl md:text-6xl font-cinzel text-center mb-8 text-shadow-lg" style="text-shadow: 0 0 15px var(--accent-color);">PvP Arena</h1>

        <!-- „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢ -->
        <div id="setup-screen" class="glassmorphism p-6 rounded-xl">
            <!-- URLÂÖ•Âäõ„Éï„Ç©„Éº„É†„ÇíÂâäÈô§ -->

            <div class="mb-6">
                <label class="block text-sm font-bold mb-2">„ÅÇ„Å™„Åü„ÅÆ„Çª„Éº„Éñ„Éá„Éº„Çø (JSON / ÊöóÂè∑Âåñ„Éá„Éº„Çø)</label>
                <textarea id="my-save-data" class="w-full p-2 bg-gray-800 border border-gray-600 rounded h-24 text-xs" placeholder="magic_rpg.html„Åß„Ç≥„Éî„Éº„Åó„Åü„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
            </div>

            <div class="flex gap-4 justify-center">
                <button id="create-room-btn" class="magic-button px-8 py-3 w-1/2 font-bold">ÈÉ®Â±ã„Çí‰ΩúÊàê (Player 1)</button>
                <div class="w-1/2">
                    <div class="flex gap-2">
                        <input type="text" id="room-id-input" class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-center" placeholder="ÈÉ®Â±ãID">
                        <button id="join-room-btn" class="magic-button px-4 py-3 font-bold whitespace-nowrap">ÂèÇÂä† (Player 2)</button>
                    </div>
                </div>
            </div>
            <div id="status-message" class="mt-4 text-center text-yellow-300 h-6"></div>
        </div>

        <!-- ÂæÖÊ©üÁîªÈù¢ -->
        <div id="waiting-screen" class="hidden glassmorphism p-6 rounded-xl text-center mt-8">
            <h2 class="text-2xl font-cinzel mb-4">Waiting for Opponent...</h2>
            <p class="mb-4">ÈÉ®Â±ãID: <span id="display-room-id" class="text-4xl font-bold text-yellow-400 mx-2"></span></p>
            <p class="text-sm text-gray-400">ÂØæÊà¶Áõ∏Êâã„Å´„Åì„ÅÆID„Çí‰ºù„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            <div class="flex justify-center mt-6">
                <div class="loader"></div>
            </div>
            <p id="polling-status" class="text-xs text-gray-500 mt-2">Connecting...</p>
        </div>

        <!-- „Éê„Éà„É´ÁîªÈù¢ -->
        <div id="battle-screen" class="hidden mt-4">
            <!-- „É≠„Ç∞ -->
            <div id="battle-log" class="w-full h-32 p-2 mb-4 bg-black bg-opacity-60 rounded-lg overflow-y-auto text-sm border border-gray-600 font-mono"></div>

            <!-- „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„Ç®„É™„Ç¢ -->
            <div class="flex justify-between items-start gap-4 mb-4">
                <!-- Player 1 -->
                <div id="p1-status-box" class="w-1/2 glassmorphism p-3 rounded-lg border-2 border-transparent transition-all">
                    <p class="font-bold text-green-400 text-lg">P1: <span id="p1-name">Player 1</span></p>
                    <div class="relative w-full h-3 bg-gray-700 rounded-full mt-2 overflow-hidden">
                        <div id="p1-hp-bar" class="h-full bg-green-500 transition-all duration-500"></div>
                        <div id="p1-shield-bar" class="absolute top-0 left-0 h-full bg-cyan-400 bg-opacity-60 transition-all duration-500"></div>
                    </div>
                    <div class="w-full h-2 bg-gray-700 rounded-full mt-1 overflow-hidden">
                        <div id="p1-mp-bar" class="h-full bg-blue-500 transition-all duration-500"></div>
                    </div>
                    <div class="flex justify-between text-xs mt-1">
                        <span id="p1-hp-text">HP: -/-</span>
                        <span id="p1-mp-text">MP: -/-</span>
                    </div>
                    <div id="p1-shield-val" class="text-xs text-cyan-300 h-4"></div>
                    <div id="p1-effects" class="flex flex-wrap gap-1 mt-1 min-h-[1.5rem]"></div>
                </div>

                <!-- VS -->
                <div class="self-center font-cinzel text-xl text-gray-500">VS</div>

                <!-- Player 2 -->
                <div id="p2-status-box" class="w-1/2 glassmorphism p-3 rounded-lg border-2 border-transparent transition-all">
                    <p class="font-bold text-red-400 text-lg text-right"><span id="p2-name">Player 2</span> :P2</p>
                    <div class="relative w-full h-3 bg-gray-700 rounded-full mt-2 overflow-hidden">
                        <div id="p2-hp-bar" class="h-full bg-green-500 transition-all duration-500"></div>
                        <div id="p2-shield-bar" class="absolute top-0 left-0 h-full bg-cyan-400 bg-opacity-60 transition-all duration-500"></div>
                    </div>
                    <div class="w-full h-2 bg-gray-700 rounded-full mt-1 overflow-hidden">
                        <div id="p2-mp-bar" class="h-full bg-blue-500 transition-all duration-500"></div>
                    </div>
                    <div class="flex justify-between text-xs mt-1">
                        <span id="p2-hp-text">HP: -/-</span>
                        <span id="p2-mp-text">MP: -/-</span>
                    </div>
                    <div id="p2-shield-val" class="text-xs text-cyan-300 h-4 text-right"></div>
                    <div id="p2-effects" class="flex flex-wrap gap-1 mt-1 justify-end min-h-[1.5rem]"></div>
                </div>
            </div>

            <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Ç®„É™„Ç¢ -->
            <div id="action-area" class="glassmorphism p-4 rounded-xl">
                <p id="turn-indicator" class="text-center text-xl font-bold mb-4 animate-pulse"></p>
                
                <!-- È≠îÊ≥ï„Éú„Çø„É≥Áæ§ -->
                <div id="magic-buttons" class="grid grid-cols-2 gap-2"></div>
            </div>
        </div>
    </div>

<script>
    // --- ÂÆöÊï∞ÂÆöÁæ© ---
    // GAS„ÅÆURL„ÇíÂõ∫ÂÆö
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzmzeGe7rL2d24q0WcdBL8DbibpRSRA1XVErdeyOWZ5-PyeDHTdZKxz0Horcaoge8G0/exec";

    // --- „Éá„Éº„ÇøÂÆöÁæ© (magic_rpg.html „Åã„ÇâÂÆåÂÖ®ÁßªÊ§ç) ---
    const ELEMENTS = {
        WATER: { name: 'Ê∞¥', icon: 'üíß' }, FIRE: { name: 'ÁÇé', icon: 'üî•' }, GRASS: { name: 'Ëçâ', icon: 'üåø' },
        THUNDER: { name: 'Èõ∑', icon: '‚ö°' }, WIND: { name: 'È¢®', icon: 'üí®' }, LIGHT: { name: 'ÂÖâ', icon: 'üåü' },
        VOID: { name: 'ËôöÁÑ°', icon: 'üåå' }, EARTH: { name: 'Âú∞', icon: 'üåç' }, TIME: { name: 'ÊôÇÁ©∫', icon: '‚è≥' },
        NEUTRAL: { name: 'ÁÑ°', icon: 'üí´' }, DARK: { name: 'Èóá', icon: 'üåë' },
    };

    const MAGIC_MASTER = {
        // Normal - ÂàùÊúüÈ≠îÊ≥ï
        m000: { name: '„Éû„Ç∏„ÉÉ„ÇØ„Ç¢„É≠„Éº', element: 'NEUTRAL', rarity: 'NORMAL', category: 'NORMAL', type: 'ATTACK', basePower: 8, baseCost: 4, description: 'È≠îÂäõ„ÅÆÁü¢„ÇíÊîæ„Å§Âü∫Êú¨È≠îÊ≥ï„ÄÇ' },
        m009: { name: '„Éû„Ç∏„ÉÉ„ÇØ„Ç¨„Éº„Éâ', element: 'NEUTRAL', rarity: 'NORMAL', category: 'NORMAL', type: 'DEFENSE', basePower: 15, baseCost: 8, duration: 3, description: 'È≠îÂäõ„ÅÆÁõæ„ÅßË∫´„ÇíÂÆà„ÇãÂü∫Êú¨È≠îÊ≥ï„ÄÇ' },
        // Normal
        m001: { name: '„Ç¶„Ç©„Éº„Çø„Éº„Ç∑„Éß„ÉÉ„Éà', element: 'WATER', rarity: 'NORMAL', category: 'NORMAL', type: 'ATTACK', basePower: 10, baseCost: 5, description: 'Ê∞¥„ÅÆÂºæ‰∏∏„ÇíÁô∫Â∞Ñ„Åô„Çã„ÄÇ' },
        m002: { name: '„Éï„Ç°„Ç§„Ç¢„Éú„Éº„É´', element: 'FIRE', rarity: 'NORMAL', category: 'NORMAL', type: 'ATTACK', basePower: 12, baseCost: 6, description: 'Â∞è„Åï„Å™ÁÅ´ÁêÉ„ÇíÊîæ„Å§„ÄÇ' },
        m003: { name: '„Ç¶„Ç£„É≥„Éâ„Ç´„ÉÉ„Çø„Éº', element: 'WIND', rarity: 'NORMAL', category: 'NORMAL', type: 'ATTACK', basePower: 8, baseCost: 4, description: 'È¢®„ÅÆÂàÉ„ÅßÂàá„ÇäË£Ç„Åè„ÄÇ' },
        m004: { name: '„Éí„Éº„É´', element: 'GRASS', rarity: 'NORMAL', category: 'NORMAL', type: 'HEAL', basePower: 20, baseCost: 10, description: 'HP„ÇíÂ∞ë„ÅóÂõûÂæ©„Åô„Çã„ÄÇ' },
        m005: { name: '„Éó„É≠„ÉÜ„ÇØ„Ç∑„Éß„É≥', element: 'LIGHT', rarity: 'NORMAL', category: 'NORMAL', type: 'DEFENSE', basePower: 10, baseCost: 8, duration: 3, description: '3„Çø„Éº„É≥„ÅÆÈñì„ÄÅ„Ç∑„Éº„É´„Éâ„ÇíÂºµ„Çã„ÄÇ' },
        m006: { name: '„Çπ„Éà„Éº„É≥„Éñ„É©„Çπ„Éà', element: 'EARTH', rarity: 'NORMAL', category: 'NORMAL', type: 'ATTACK', basePower: 15, baseCost: 8, description: 'Áü≥„ÅÆÁ§´„ÇíÈ£õ„Å∞„Åô„ÄÇ' },
        m007: { name: '„Éï„É©„ÉÉ„Ç∑„É•', element: 'LIGHT', rarity: 'NORMAL', category: 'NORMAL', type: 'DEBUFF', basePower: 0.8, baseCost: 7, duration: 2, description: '2„Çø„Éº„É≥„ÅÆÈñì„ÄÅÊïµ„ÅÆÊîªÊíÉÂäõ„Çí20%Ê∏õÂ∞ë„Åï„Åõ„Çã„ÄÇ' },
        m008: { name: '„ÉÄ„Éº„ÇØ„Ç¢„É≠„Éº', element: 'VOID', rarity: 'NORMAL', category: 'NORMAL', type: 'ATTACK', basePower: 13, baseCost: 7, description: 'Èóá„ÅÆÁü¢„ÇíÊîæ„Å§„ÄÇ' },
        
        // Rare
        m101: { name: '„Ç¢„ÇØ„Ç¢„Çπ„Éà„É™„Éº„É†', element: 'WATER', rarity: 'RARE', category: 'NORMAL', type: 'ATTACK', basePower: 25, baseCost: 12, description: 'ÊøÄ„Åó„ÅÑÊ∞¥ÊµÅ„ÅßÊîªÊíÉ„Åô„Çã„ÄÇ' },
        m102: { name: '„Éï„É¨„Ç§„É†„É©„É≥„Çπ', element: 'FIRE', rarity: 'RARE', category: 'NORMAL', type: 'ATTACK', basePower: 30, baseCost: 15, description: 'ÁÇé„ÅÆÊßç„ÇíÁ™Å„ÅçÂà∫„Åô„ÄÇ' },
        m103: { name: '„Çµ„É≥„ÉÄ„Éº„Éú„É´„Éà', element: 'THUNDER', rarity: 'RARE', category: 'NORMAL', type: 'ATTACK', basePower: 28, baseCost: 14, description: 'Èõ∑„ÇíËêΩ„Å®„Åô„ÄÇ' },
        m104: { name: '„É™„Ç∏„Çß„Éç„É¨„Éº„Ç∑„Éß„É≥', element: 'GRASS', rarity: 'RARE', category: 'NORMAL', type: 'HEAL', basePower: 15, baseCost: 20, duration: 3, description: '3„Çø„Éº„É≥„ÅÆÈñì„ÄÅHP„ÅåÂæê„ÄÖ„Å´ÂõûÂæ©„Åô„Çã„ÄÇ' },
        m105: { name: '„Éò„Ç§„Çπ„Éà', element: 'WIND', rarity: 'RARE', category: 'NORMAL', type: 'BUFF', basePower: 1.2, baseCost: 18, duration: 3, description: '3„Çø„Éº„É≥„ÅÆÈñì„ÄÅ„ÉÄ„É°„Éº„Ç∏„Åå20%Â¢óÂä†„Åô„Çã„ÄÇ' },
        m106: { name: '„Ç¢„ÇØ„Ç¢„Éê„É™„Ç¢', element: 'WATER', rarity: 'RARE', category: 'NORMAL', type: 'DEFENSE', basePower: 30, baseCost: 15, duration: 3, description: 'Ê∞¥„ÅÆÈöúÂ£Å„ÅßË∫´„ÇíÂÆà„Çã„ÄÇ' },
        m107: { name: '„Éù„Ç§„Ç∫„É≥„Éü„Çπ„Éà', element: 'GRASS', rarity: 'RARE', category: 'NORMAL', type: 'ATTACK', basePower: 10, baseCost: 18, duration: 3, isDot: true, description: '3„Çø„Éº„É≥„ÅÆÈñì„ÄÅÊïµ„ÇíÊØíÁä∂ÊÖã„Å´„Åó„ÄÅÁ∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ' },
        m108: { name: '„Ç¢„Éº„Çπ„Ç¶„Ç©„Éº„É´', element: 'EARTH', rarity: 'RARE', category: 'NORMAL', type: 'DEFENSE', basePower: 40, baseCost: 18, duration: 2, description: '2„Çø„Éº„É≥„ÅÆÈñì„ÄÅÂº∑Âõ∫„Å™Âúü„ÅÆÂ£Å„ÅßË∫´„ÇíÂÆà„Çã„ÄÇ' },
        m109: { name: '„Éõ„Éº„É™„Éº„É©„Ç§„Éà', element: 'LIGHT', rarity: 'RARE', category: 'NORMAL', type: 'HEAL', basePower: 50, baseCost: 25, description: 'ËÅñ„Å™„ÇãÂÖâ„ÅßHP„Çí‰∏≠Á®ãÂ∫¶ÂõûÂæ©„Åô„Çã„ÄÇ' },
        m110: { name: '„Ç´„Ç™„Çπ„Éú„É´„Éà', element: 'VOID', rarity: 'RARE', category: 'NORMAL', type: 'ATTACK', basePower: 35, baseCost: 18, description: 'Ê∑∑Ê≤å„ÅÆÂäõ„Åß‰∫àÊ∏¨‰∏çËÉΩ„Å™„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ' },

        // Epic
        m201: { name: '„É°„Ç§„É´„Çπ„Éà„É≠„É†', element: 'WATER', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 60, baseCost: 30, isAoe: true, description: 'Â∑®Â§ß„Å™Ê∏¶ÊΩÆ„ÇíÁô∫Áîü„Åï„Åõ„ÄÅÊïµÂÖ®‰Ωì„ÇíÊîªÊíÉ„Åô„Çã„ÄÇ' },
        m202: { name: '„Ç§„É≥„Éï„Çß„É´„Éé', element: 'FIRE', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 75, baseCost: 35, description: 'Ê•≠ÁÅ´„ÅßÊïµ„ÇíÁÑº„ÅçÂ∞Ω„Åè„Åô„ÄÇ' },
        m203: { name: '„ÇΩ„Éº„É©„Éº„Éì„Éº„É†', element: 'GRASS', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 85, baseCost: 40, description: 'Â§™ÈôΩ„ÅÆÂÖâ„ÇíÂèéÊùü„Åï„Åõ„Å¶Êîæ„Å§„ÄÇ' },
        m204: { name: '„Ç∞„É¨„Éº„Éà„Éí„Éº„É´', element: 'GRASS', rarity: 'EPIC', category: 'NORMAL', type: 'HEAL', basePower: 100, baseCost: 45, description: 'HP„ÇíÂ§ßÂπÖ„Å´ÂõûÂæ©„Åô„Çã„ÄÇ' },
        m205: { name: '„ÇÆ„Ç¨„Çπ„Éë„Éº„ÇØ', element: 'THUNDER', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 80, baseCost: 38, description: 'Âº∑Âäõ„Å™ÈõªÊíÉ„ÇíÂ∫ÉÁØÑÂõ≤„Å´Êîæ„Å§„ÄÇ' },
        m206: { name: 'ÁîüÂëΩ„ÅÆÊÅµ„Åø', element: 'GRASS', rarity: 'EPIC', category: 'NORMAL', type: 'HEAL', basePower: 60, baseCost: 50, duration: 5, description: '5„Çø„Éº„É≥„ÅÆÈñì„ÄÅHP„ÅåÂ§ß„Åç„ÅèÂõûÂæ©„ÅóÁ∂ö„Åë„Çã„ÄÇ' },
        m207: { name: '„Éà„É´„Éç„Éº„Éâ', element: 'WIND', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 90, baseCost: 48, isAoe: true, description: 'Â∑®Â§ß„Å™Á´úÂ∑ª„ÅßÊïµÂÖ®‰Ωì„ÇíÊîªÊíÉ„Åô„Çã„ÄÇ' },
        m208: { name: '„Éâ„É¨„Ç§„É≥„ÇΩ„Ç¶„É´', element: 'VOID', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 65, baseCost: 40, drain: 0.3, description: 'Êïµ„Å´„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„ÄÅ„Åù„ÅÆ„ÉÄ„É°„Éº„Ç∏„ÅÆ30%„ÇíÂê∏Âèé„Åó„Å¶HP„ÇíÂõûÂæ©„Åô„Çã„ÄÇ' },
        m209: { name: '„Éó„É©„Ç∫„Éû„Éï„Ç£„Éº„É´„Éâ', element: 'THUNDER', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 25, baseCost: 38, duration: 3, isDot: true, isAoe: true, description: '3„Çø„Éº„É≥„ÅÆÈñì„ÄÅ„Éó„É©„Ç∫„Éû„Éï„Ç£„Éº„É´„Éâ„ÅßÊïµÂÖ®‰Ωì„Å´Á∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ' },
        m210: { name: '„Ç¢„Éº„Çπ„ÇØ„Ç®„Ç§„ÇØ', element: 'EARTH', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 100, baseCost: 55, isAoe: true, description: 'Â§ßÂú∞Èúá„ÅßÊïµÂÖ®‰Ωì„Å´„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ' },
        m211: { name: '„Ç®„É≥„Ç∏„Çß„É´„Éñ„É¨„Çπ', element: 'LIGHT', rarity: 'EPIC', category: 'NORMAL', type: 'BUFF', basePower: 1.3, baseCost: 40, duration: 3, description: '3„Çø„Éº„É≥„ÅÆÈñì„ÄÅÊîªÊíÉÂäõ„Çí30%Â¢óÂä†„Åï„Åõ„Çã„ÄÇ' },
        m212: { name: '„É¥„Ç©„Ç§„Éâ„ÉÜ„É≥„Çø„ÇØ„É´', element: 'VOID', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 70, baseCost: 42, duration: 2, description: 'ËôöÁÑ°„ÅÆËß¶Êâã„ÅßÊîªÊíÉ„Åó„ÄÅ2„Çø„Éº„É≥„ÅÆÈñì„ÄÅÊïµ„ÅÆË°åÂãï„ÇíÂ∞Å„Åò„Çã„Åì„Å®„Åå„ÅÇ„Çã„ÄÇ' },
        m213: { name: '„Éñ„É™„Ç∂„Éº„Éâ', element: 'WATER', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 80, baseCost: 50, isAoe: true, description: 'ÊøÄ„Åó„ÅÑÂêπÈõ™„ÅßÊïµÂÖ®‰Ωì„ÇíÂáç„Å¶„Å§„Åã„Åõ„Çã„ÄÇ' },
        m214: { name: '„Éï„É¨„Ç¢', element: 'FIRE', rarity: 'EPIC', category: 'NORMAL', type: 'ATTACK', basePower: 120, baseCost: 60, description: 'ÁàÜÁô∫ÁöÑ„Å™ÁÇé„ÅßÂ§ß„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ' },

        // Legendary („Ç≥„Çπ„ÉàË™øÊï¥: Â∫èÁõ§‰ΩøÁî®‰∏çÂèØ„Å´„Åô„Çã„Åü„ÇÅÂ§ßÂπÖÂ¢ó)
        m301: { name: '„Ç∏„É£„ÉÉ„Ç∏„É°„É≥„Éà', element: 'LIGHT', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 250, baseCost: 320, isAoe: true, description: 'ËÅñ„Å™„ÇãÂÖâ„ÅßÊïµÂÖ®‰Ωì„Å´Ë£Å„Åç„Çí‰∏ã„Åô„ÄÇ' },
        m302: { name: '„É°„ÉÜ„Ç™„Çπ„Éà„É©„Ç§„ÇØ', element: 'FIRE', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 350, baseCost: 400, isAoe: true, description: 'Â∑®Â§ß„Å™ÈöïÁü≥„ÇíËêΩ‰∏ã„Åï„Åõ„ÄÅÊïµÂÖ®‰Ωì„ÇíÊîªÊíÉ„Åô„Çã„ÄÇ'},
        m303: { name: '„Ç¢„Éì„Çπ„Ç≤„Éº„Éà', element: 'VOID', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 300, baseCost: 350, description: 'Ê∑±Ê∑µ„Å∏„ÅÆÈñÄ„ÇíÈñã„Åç„ÄÅÊïµ„ÇíÂºï„Åç„Åö„ÇäËæº„ÇÄ„ÄÇ' },
        m304: { name: 'ËÅñÂüü', element: 'LIGHT', rarity: 'LEGENDARY', category: 'NORMAL', type: 'DEFENSE', basePower: 250, baseCost: 280, duration: 5, description: '5„Çø„Éº„É≥„ÅÆÈñì„ÄÅÂº∑Âõ∫„Å™ËÅñÂüü„ÇíÂ±ïÈñã„Åó„ÄÅ„Åï„Çâ„Å´HP„ÅåÂ∞ë„Åó„Åö„Å§ÂõûÂæ©„Åô„Çã„ÄÇ' },
        m305: { name: '„ÉØ„Éº„É´„Éâ„Ç®„É≥„Éâ', element: 'VOID', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 600, baseCost: 1000, isAoe: true, description: '‰∏ñÁïå„ÅÆÁµÇ„Çè„Çä„ÇíÂëä„Åí„ÇãËôöÁÑ°„ÅÆÊ≥¢Âãï„ÇíÊïµÂÖ®‰Ωì„Å´Êîæ„Å§„ÄÇ' },
        m306: { name: 'ÂâµÁîü„ÅÆÂÖâ', element: 'LIGHT', rarity: 'LEGENDARY', category: 'NORMAL', type: 'HEAL', basePower: 200, baseCost: 450, duration: 3, description: 'HP„ÇíÂÆåÂÖ®„Å´ÂõûÂæ©„Åó„ÄÅ3„Çø„Éº„É≥„ÅÆÈñìÂº∑Âäõ„Å™„É™„Ç∏„Çß„ÉçÂäπÊûú„Çí‰ªò‰∏é„Åô„Çã„ÄÇ' },
        m307: { name: '„Ç®„É¨„É°„É≥„Çø„É´„Éê„Éº„Çπ„Éà', element: 'VOID', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 400, baseCost: 480, isAoe: true, description: 'ÂÖ®Â±ûÊÄß„ÅÆÂäõ„ÇíÂáùÁ∏Æ„Åó„Å¶ÊïµÂÖ®‰Ωì„Å´Êîæ„Å§„ÄÇ' },
        m308: { name: '„Ç¨„Ç§„Ç¢„Ç∫„É©„Éº„Çπ', element: 'EARTH', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 450, baseCost: 600, isAoe: true, description: 'Â§ßÂú∞„ÅÆÊÄí„Çä„ÇíÂëº„Å≥Ëµ∑„Åì„Åó„ÄÅÊïµÂÖ®‰Ωì„ÇíÁ≤âÁ†ï„Åô„Çã„ÄÇ' },
        m309: { name: '„Çπ„Éº„Éë„Éº„Éé„É¥„Ç°', element: 'FIRE', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 500, baseCost: 720, isAoe: true, description: 'Ë∂ÖÊñ∞ÊòüÁàÜÁô∫„ÇíÊïµÂÖ®‰Ωì„Å´Âºï„ÅçËµ∑„Åì„ÅôÁ©∂Ê•µ„ÅÆÁÇéÈ≠îÊ≥ï„ÄÇ' },
        m310: { name: 'ÊôÇÁ©∫„ÅÆË£Ç„ÅëÁõÆ', element: 'VOID', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 300, baseCost: 440, duration: 3, isDot: true, description: 'ÊôÇÁ©∫„ÇíÊ≠™„ÇÅ„ÄÅ3„Çø„Éº„É≥„ÅÆÈñì„ÄÅÊïµ„Å´Á∂ôÁ∂öÁöÑ„Å™Ê¨°ÂÖÉ„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ' },
        m311: { name: '„Çº„Ç¶„Çπ„ÅÆÂØ©Âà§', element: 'THUNDER', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 480, baseCost: 640, isAoe: true, description: 'Â§©„Åã„ÇâÁ•û„ÅÆÈõ∑„ÇíÂè¨Âñö„Åó„ÄÅÊïµÂÖ®‰Ωì„ÇíÁÑº„ÅçÊâï„ÅÜ„ÄÇ' },
        m312: { name: '„Ç¢„É´„Ç±„Ç§„É≥„Ç™„Éº„Éê„Éº„Éâ„É©„Ç§„Éñ', element: 'VOID', rarity: 'LEGENDARY', category: 'NORMAL', type: 'BUFF', basePower: 2.0, baseCost: 600, duration: 3, description: '3„Çø„Éº„É≥„ÅÆÈñì„ÄÅÈ≠îÊ≥ïÂ®ÅÂäõ„Çí100%Â¢óÂä†„Åï„Åõ„Çã„ÄÇ' },
        m313: { name: '„Ç¢„Éù„Ç´„É™„Éó„Çπ', element: 'VOID', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 200, baseCost: 600, duration: 3, isDot: true, isAoe: true, description: 'ÁµÇÊú´„ÅÆÂàªÂç∞„ÇíÊïµÂÖ®‰Ωì„Å´Âàª„Åø„ÄÅ3„Çø„Éº„É≥„ÅÆÈñì„ÄÅÁîöÂ§ß„Å™Á∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ'},
        m314: { name: '„Çπ„Çø„Éº„ÉÄ„Çπ„Éà„Éª„É¨„Ç§„É≥', element: 'LIGHT', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 420, baseCost: 550, isAoe: true, description: 'Èôç„ÇäÊ≥®„ÅêÊòü„ÅÆÈõ®„ÅßÊïµÂÖ®‰Ωì„ÇíÊµÑÂåñ„Åô„Çã„ÄÇ' },
        m315: { name: '„Ç¢„Éñ„ÇΩ„É™„É•„Éº„Éà„Éª„Çº„É≠', element: 'WATER', rarity: 'LEGENDARY', category: 'NORMAL', type: 'DEBUFF', basePower: 0.2, baseCost: 500, duration: 2, description: 'Áµ∂ÂØæÈõ∂Â∫¶„ÅßÊïµ„ÇíÂáçÁµê„Åï„Åõ„ÄÅÊîªÊíÉÂäõ„ÇíÊøÄÊ∏õ„Åï„Åõ„Çã„ÄÇ' },
        m316: { name: '„Ç∞„É©„Éì„ÉÜ„Ç£„Éª„Éó„É¨„Çπ', element: 'EARTH', rarity: 'LEGENDARY', category: 'NORMAL', type: 'ATTACK', basePower: 550, baseCost: 650, description: 'Ë∂ÖÈáçÂäõ„ÅßÊïµÂçò‰Ωì„ÇíÊäº„ÅóÊΩ∞„Åô„ÄÇ' },

        // Boss Unique
        b001: { name: '„Çø„Ç§„É†„Çπ„Éà„ÉÉ„Éó', element: 'TIME', rarity: 'LEGENDARY', category: 'BOSS', type: 'DEBUFF', basePower: 0, baseCost: 100, duration: 1, description: 'ÊôÇÈñì„ÇíÂÅúÊ≠¢„Åï„Åõ„ÄÅ1„Çø„Éº„É≥Ë°åÂãï‰∏çËÉΩ„Å´„Åô„Çã„ÄÇ'},
        b002: { name: '„Éá„Ç£„É°„É≥„Ç∑„Éß„Éä„É´„É™„Éï„Éà', element: 'TIME', rarity: 'LEGENDARY', category: 'BOSS', type: 'ATTACK', basePower: 500, baseCost: 200, isAoe: true, description: 'Áï∞Ê¨°ÂÖÉ„ÅÆË£Ç„ÅëÁõÆ„Åã„ÇâËé´Â§ß„Å™„Ç®„Éç„É´„ÇÆ„Éº„ÇíÊîæ„Å§„ÄÇ'},

        // Inherited Magics (Áõ∏‰ºù„ÅÆÈ≠îÊ≥ï) - c001 Dragon Blood („Ç≥„Çπ„ÉàË™øÊï¥)
        i001: { name: 'Á´ú„ÅÆÊÅØÂêπ', element: 'FIRE', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 50, baseCost: 120, isAoe: true, description: '„ÄêÁ´ú„ÅÆË°ÄËÑà„ÄëÁÅºÁÜ±„ÅÆ„Éñ„É¨„Çπ„ÇíÂêê„ÅçÂá∫„Åô„ÄÇ' },
        i002: { name: 'Á´úÈ±ó„ÅÆÂÆà„Çä', element: 'EARTH', rarity: 'SPECIAL', category: 'INHERITED', type: 'DEFENSE', basePower: 50, baseCost: 100, duration: 4, description: '„ÄêÁ´ú„ÅÆË°ÄËÑà„ÄëÁ°¨Ë≥™„Å™Á´ú„ÅÆÈ±ó„ÅßË∫´„ÇíÂÆà„Çã„ÄÇ' },
        i003: { name: '„Éâ„É©„Ç¥„Éã„ÉÉ„ÇØ„É≠„Ç¢', element: 'NEUTRAL', rarity: 'SPECIAL', category: 'INHERITED', type: 'DEBUFF', basePower: 0.7, baseCost: 150, duration: 3, description: '„ÄêÁ´ú„ÅÆË°ÄËÑà„ÄëÊïµ„ÇíÂ®ÅÂúß„ÅóÊîªÊíÉÂäõ„Çí‰∏ã„Åí„Çã„ÄÇ' },
        i004: { name: '„Ç®„É≥„Ç∑„Çß„É≥„Éà„É°„ÉÜ„Ç™', element: 'FIRE', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 300, baseCost: 400, isAoe: true, description: '„ÄêÁ´ú„ÅÆË°ÄËÑà„ÄëÂè§„ÅÆÈöïÁü≥È≠îÊ≥ï„ÄÇ' },

        // Inherited Magics - c002 Void Walker („Ç≥„Çπ„ÉàË™øÊï¥)
        i005: { name: 'ËôöÁ©∫„ÅÆÊ≠©Ê≥ï', element: 'VOID', rarity: 'SPECIAL', category: 'INHERITED', type: 'BUFF', basePower: 1.5, baseCost: 140, duration: 3, description: '„ÄêËôöÁÑ°„ÅÆÂô®„ÄëÊ¨°ÂÖÉ„ÇíÊªë„Çä„ÄÅÂõûÈÅø„Å®ÊîªÊíÉÂäõ„ÇíÈ´ò„ÇÅ„Çã„ÄÇ' },
        i006: { name: '„Ç®„É≥„Éà„É≠„Éî„Éº', element: 'VOID', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 20, baseCost: 100, duration: 5, isDot: true, description: '„ÄêËôöÁÑ°„ÅÆÂô®„ÄëÂØæË±°„ÇíÂæê„ÄÖ„Å´Â¥©Â£ä„Åï„Åõ„Çã„ÄÇ' },
        i007: { name: '„Éñ„É©„ÉÉ„ÇØ„Éõ„Éº„É´', element: 'VOID', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 150, baseCost: 350, isAoe: true, description: '„ÄêËôöÁÑ°„ÅÆÂô®„ÄëÂÖ®„Å¶„ÇíÈ£≤„ÅøËæº„ÇÄÈóá„ÄÇ' },
        i008: { name: 'ÁÑ°„Å∏„ÅÆÂõûÂ∏∞', element: 'VOID', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 100, baseCost: 180, drain: 0.5, description: '„ÄêËôöÁÑ°„ÅÆÂô®„ÄëÂ≠òÂú®„ÇíÂñ∞„Çâ„ÅÑHP„ÇíÂõûÂæ©„Åô„Çã„ÄÇ' },

        // Inherited Magics - c007 Ice Empress („Ç≥„Çπ„ÉàË™øÊï¥)
        i009: { name: '„ÉÄ„Ç§„É§„É¢„É≥„Éâ„ÉÄ„Çπ„Éà', element: 'WATER', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 40, baseCost: 100, isAoe: true, description: '„ÄêÊ∞∑„ÅÆÂ•≥Â∏ù„ÄëÁæé„Åó„Åè„ÇÇÂÜ∑ÈÖ∑„Å™Ê∞∑„ÅÆÂµê„ÄÇ' },
        i010: { name: 'Áµ∂ÂØæÈõ∂Â∫¶', element: 'WATER', rarity: 'SPECIAL', category: 'INHERITED', type: 'DEBUFF', basePower: 0.5, baseCost: 200, duration: 3, description: '„ÄêÊ∞∑„ÅÆÂ•≥Â∏ù„ÄëÊïµ„ÇíÂáçÁµê„Åï„Åõ„ÄÅ3„Çø„Éº„É≥„ÅÆÈñìÊîªÊíÉÂäõ„ÇíÂçäÊ∏õ„Åï„Åõ„Çã„ÄÇ' },
        i011: { name: 'Ê∞∑„ÅÆÂüéÂ£Å', element: 'WATER', rarity: 'SPECIAL', category: 'INHERITED', type: 'DEFENSE', basePower: 80, baseCost: 140, duration: 4, description: '„ÄêÊ∞∑„ÅÆÂ•≥Â∏ù„ÄëÈõ£Êîª‰∏çËêΩ„ÅÆÊ∞∑Â£Å„ÇíÂ±ïÈñã„Åô„Çã„ÄÇ' },
        i012: { name: '„Ç≥„Ç≠„É•„Éº„Éà„Çπ', element: 'WATER', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 250, baseCost: 380, isAoe: true, description: '„ÄêÊ∞∑„ÅÆÂ•≥Â∏ù„ÄëÂú∞ÁçÑ„ÅÆÊúÄ‰∏ãÂ±§„ÅÆÂ¶Ç„ÅçÂØíÊ∞ó„ÅßÊïµ„ÇíÁµ∂ÊªÖ„Åï„Åõ„Çã„ÄÇ' },

        // Inherited Magics - c008 Storm Avatar („Ç≥„Çπ„ÉàË™øÊï¥)
        i013: { name: 'Èõ∑Á•û„ÅÆÈâÑÊßå', element: 'THUNDER', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 60, baseCost: 120, description: '„ÄêÂµê„ÅÆÂåñË∫´„ÄëÁ•ûÈÄü„ÅÆÈõ∑ÊíÉ„ÄÇ' },
        i014: { name: '„ÉÜ„É≥„Éö„Çπ„Éà', element: 'WIND', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 50, baseCost: 140, isAoe: true, description: '„ÄêÂµê„ÅÆÂåñË∫´„ÄëÂÖ®„Å¶„ÇíÂêπ„ÅçÈ£õ„Å∞„ÅôÊö¥È¢®Èõ®„ÄÇ' },
        i015: { name: 'È¢®Á•û„ÅÆÂä†Ë≠∑', element: 'WIND', rarity: 'SPECIAL', category: 'INHERITED', type: 'BUFF', basePower: 1.4, baseCost: 160, duration: 3, description: '„ÄêÂµê„ÅÆÂåñË∫´„ÄëÈ¢®„ÇíÁ∫è„ÅÑ„ÄÅ3„Çø„Éº„É≥„ÅÆÈñìÊîªÊíÉÂäõ„Çí40%‰∏äÊòá„Åï„Åõ„Çã„ÄÇ' },
        i016: { name: '„Éú„É´„Éà„ÉÅ„Çß„Ç§„É≥', element: 'THUNDER', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 40, baseCost: 140, duration: 3, isDot: true, isAoe: true, description: '„ÄêÂµê„ÅÆÂåñË∫´„ÄëÈÄ£Èéñ„Åô„ÇãÈõ∑„ÅßÊïµÂÖ®‰Ωì„Å´Á∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ' },

        // Inherited Magics - c009 Light Saintess („Ç≥„Çπ„ÉàË™øÊï¥)
        i017: { name: '„Çª„Ç§„ÇØ„É™„ÉÉ„Éâ„Éí„Éº„É´', element: 'LIGHT', rarity: 'SPECIAL', category: 'INHERITED', type: 'HEAL', basePower: 120, baseCost: 200, description: '„ÄêÂÖâ„ÅÆËÅñÂ•≥„ÄëËÅñ„Å™„ÇãÂÖâ„ÅßHP„ÇíÂ§ß„Åç„ÅèÂõûÂæ©„Åô„Çã„ÄÇ' },
        i018: { name: '„Éá„Ç£„Éê„Ç§„É≥„Ç∑„Éº„É´„Éâ', element: 'LIGHT', rarity: 'SPECIAL', category: 'INHERITED', type: 'DEFENSE', basePower: 80, baseCost: 150, duration: 3, description: '„ÄêÂÖâ„ÅÆËÅñÂ•≥„ÄëÁ•ûËÅñ„Å™Áõæ„ÅßË∫´„ÇíÂÆà„Çã„ÄÇ' },
        i019: { name: '„Ç®„É≥„Ç∏„Çß„É´„ÇΩ„É≥„Ç∞', element: 'LIGHT', rarity: 'SPECIAL', category: 'INHERITED', type: 'BUFF', basePower: 1.4, baseCost: 180, duration: 3, description: '„ÄêÂÖâ„ÅÆËÅñÂ•≥„ÄëÂ§©‰Ωø„ÅÆÊ≠åÂ£∞„ÅßÊîªÊíÉÂäõ„ÇíÈ´ò„ÇÅ„Çã„ÄÇ' },
        i020: { name: '„Ç∏„É£„ÉÉ„Ç∏„É°„É≥„Éà„É¨„Ç§', element: 'LIGHT', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 220, baseCost: 300, description: '„ÄêÂÖâ„ÅÆËÅñÂ•≥„ÄëÈÇ™ÊÇ™„ÇíÊªÖ„Åº„ÅôË£Å„Åç„ÅÆÂÖâ„ÄÇ' },

        // Inherited Magics - c010 Dark Necromancer („Ç≥„Çπ„ÉàË™øÊï¥)
        i021: { name: '„ÇΩ„Ç¶„É´„É™„Éº„Éó', element: 'DARK', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 100, baseCost: 190, drain: 0.8, description: '„ÄêÊ≠ªÈúäË°ìÂ∏´„ÄëÊïµ„ÅÆÈ≠Ç„ÇíÂàà„ÇäÂèñ„Çä„ÄÅËá™Ë∫´„ÅÆHP„Å´„Åô„Çã„ÄÇ' },
        i022: { name: '„Ç´„Éº„Çπ„ÇØ„É©„Ç¶„Éâ', element: 'DARK', rarity: 'SPECIAL', category: 'INHERITED', type: 'DEBUFF', basePower: 0.6, baseCost: 180, duration: 4, description: '„ÄêÊ≠ªÈúäË°ìÂ∏´„ÄëÂë™„ÅÑ„ÅÆÈõ≤„ÅßÊïµ„ÅÆÊîªÊíÉÂäõ„Çí‰∏ã„Åí„Çã„ÄÇ' },
        i023: { name: '„Éú„Éº„É≥„Çπ„Éî„Ç¢', element: 'DARK', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 160, baseCost: 220, description: '„ÄêÊ≠ªÈúäË°ìÂ∏´„ÄëÈ™®„ÅÆÊßç„ÅßÊïµ„ÇíË≤´„Åè„ÄÇ' },
        i024: { name: '„Éá„Çπ„Éû„Éº„ÉÅ', element: 'DARK', rarity: 'SPECIAL', category: 'INHERITED', type: 'ATTACK', basePower: 70, baseCost: 280, duration: 3, isDot: true, isAoe: true, description: '„ÄêÊ≠ªÈúäË°ìÂ∏´„ÄëÊ≠ªËÄÖ„ÅÆË°åÈÄ≤„Å´„Çà„ÇäÁ∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çã„ÄÇ' },

        // Weapon Magics („Ç≥„Çπ„ÉàË™øÊï¥)
        w001: { name: 'ÁÅΩ„ÅÑ„ÅÆÁÇé', element: 'DARK', rarity: 'EPIC', category: 'WEAPON', type: 'ATTACK', basePower: 150, baseCost: 180, description: 'È≠îÂâ£„É¨„É¥„Ç°„ÉÜ„Ç§„É≥„ÅÆÂë™„ÅÑ„ÅÆ‰∏ÄÊíÉ„ÄÇ' },
        w002: { name: 'Èõ∑Âàá', element: 'THUNDER', rarity: 'LEGENDARY', category: 'WEAPON', type: 'ATTACK', basePower: 200, baseCost: 200, description: 'Èõ∑„ÇíÊñ≠„Å°Âàá„ÇãÁ•ûÈÄü„ÅÆÊäúÂàÄË°ì„ÄÇ' },
        w003: { name: '„Ç®„ÇØ„Çπ„Ç´„É™„Éê„Éº', element: 'LIGHT', rarity: 'LEGENDARY', category: 'WEAPON', type: 'ATTACK', basePower: 300, baseCost: 350, isAoe: true, description: 'Á¥ÑÊùü„Åï„Çå„ÅüÂãùÂà©„ÅÆÂâ£„Å´„Çà„ÇãÊ•µÂ§ß„ÅÆÂÖâ„ÄÇ' },
        w004: { name: '„Ç´„Éâ„Ç•„Ç±„Ç¶„Çπ', element: 'NEUTRAL', rarity: 'LEGENDARY', category: 'WEAPON', type: 'HEAL', basePower: 150, baseCost: 280, duration: 3, description: 'Á•û„ÅÆÊùñ„Å´„Çà„ÇãÁôí„Åó„Å®Ê¥ªÊÄßÂåñ„ÅÆÊ≥¢Âãï„ÄÇ' },
        w005: { name: 'È≠ÇÂàá„Çä', element: 'DARK', rarity: 'LEGENDARY', category: 'WEAPON', type: 'ATTACK', basePower: 250, baseCost: 250, drain: 0.5, description: 'Â¶ñÂàÄ„É†„É©„Éû„Çµ„Å´„Çà„Çã„ÄÅÈ≠Ç„ÇíÂñ∞„Çâ„ÅÜ‰∏ÄÊíÉ„ÄÇ' },
        w006: { name: 'ÊµÅÊòüÈõ®', element: 'WIND', rarity: 'LEGENDARY', category: 'WEAPON', type: 'ATTACK', basePower: 220, baseCost: 300, isAoe: true, description: 'Á•ûÂºì„Ç¢„É´„ÉÜ„Éü„Çπ„Åã„ÇâÊîæ„Åü„Çå„ÇãÁÑ°Êï∞„ÅÆÂÖâÁü¢„ÄÇ' },
    };
    
    // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®„ÉÄ„Éü„Éº
    const DUMMY_MAGIC = { name: 'Unknown', element: 'NEUTRAL', rarity: 'NORMAL', type: 'ATTACK', basePower: 1, baseCost: 1 };

    const CONSTITUTION_MASTER = {
        c001: { name: 'Á´ú„ÅÆË°ÄËÑà', type: 'SET_MAGIC', magics: ['i001', 'i002', 'i003', 'i004'], description: 'Â§™Âè§„ÅÆÁ´ú„ÅÆÂäõ„Çí„Åù„ÅÆË∫´„Å´ÂÆø„ÅôÂ∏åÂ∞ë„Å™‰ΩìË≥™„ÄÇÁÇé„Å®Âº∑Èù≠„Å™ËÇâ‰Ωì„ÇíÂæó„Çã„ÄÇ', color: 'text-red-500' },
        c002: { name: 'ËôöÁÑ°„ÅÆÂô®', type: 'SET_MAGIC', magics: ['i005', 'i006', 'i007', 'i008'], description: 'Áîü„Åæ„Çå„Å™„Åå„Çâ„Å´„Åó„Å¶ËôöÁÑ°„Å®Áπã„Åå„Å£„Å¶„ÅÑ„Çã‰ΩìË≥™„ÄÇÂ∏∏ÁêÜ„ÇíË∂Ö„Åà„ÅüÁèæË±°„ÇíÊìç„Çã„ÄÇ', color: 'text-purple-500' },
        c003: { name: 'Â§öÈáçË©†Âî±', type: 'EXTRA_SLOTS', value: 2, description: '‰∏¶ÂàóÊÄùËÄÉ„Å´ÂÑ™„Çå„Åü‰ΩìË≥™„ÄÇË£ÖÂÇô„Åß„Åç„ÇãÈ≠îÊ≥ï„ÅÆ„Çπ„É≠„ÉÉ„Éà„Åå2„Å§Â¢óÂä†„Åô„Çã„ÄÇ', color: 'text-blue-400' },
        c004: { name: 'ÈÆÆË°Ä„ÅÆ‰ª£ÂÑü', type: 'BLOOD_MAGIC', description: 'ÁîüÂëΩÂäõ„ÇíÈ≠îÂäõ„Å∏Â§âÊèõ„Åô„ÇãÁ¶ÅÂøå„ÅÆ‰ΩìË≥™„ÄÇMP‰∏çË∂≥ÊôÇ„ÄÅHP„ÇíÊ∂àË≤ª„Åó„Å¶È≠îÊ≥ï„ÇíË°å‰Ωø„Åß„Åç„Çã„ÄÇ', color: 'text-red-700' },
        c005: { name: 'Á≤æÈúä„ÅÆÂä†Ë≠∑', type: 'PASSIVE_REGEN', value: 0.1, description: 'Á≤æÈúä„Å´ÊÑõ„Åï„Çå„Åü‰ΩìË≥™„ÄÇ„Çø„Éº„É≥ÁµÇ‰∫ÜÊôÇ„Å´MP„ÅåÊúÄÂ§ßÂÄ§„ÅÆ10%ÂõûÂæ©„Åô„Çã„ÄÇ', color: 'text-green-400' },
        c006: { name: 'ÁãÇÊà¶Â£´', type: 'PASSIVE_BERSERK', value: 0.5, description: 'ÁÄïÊ≠ª„Å´„Å™„Çã„Åª„Å©Âäõ„ÇíÁô∫ÊèÆ„Åô„Çã‰ΩìË≥™„ÄÇHP„Åå50%‰ª•‰∏ã„ÅÆÊôÇ„ÄÅÈ≠îÊ≥ïÂ®ÅÂäõ„Åå50%‰∏äÊòá„Åô„Çã„ÄÇ', color: 'text-orange-600' },
        c007: { name: 'Ê∞∑„ÅÆÂ•≥Â∏ù', type: 'SET_MAGIC', magics: ['i009', 'i010', 'i011', 'i012'], description: '‰∏áÁâ©„ÇíÂáç„Å¶„Å§„Åã„Åõ„ÇãÂÜ∑Ê∞ó„ÅÆÊîØÈÖçËÄÖ„ÄÇÈò≤Âæ°„Å®Âà∂Âúß„Å´Èï∑„Åë„Çã„ÄÇ', color: 'text-cyan-300' },
        c008: { name: 'Âµê„ÅÆÂåñË∫´', type: 'SET_MAGIC', magics: ['i013', 'i014', 'i015', 'i016'], description: 'Â§©ÂÄô„ÇíÊìç„ÇãËçí„Å∂„ÇãÈ≠Ç„ÄÇÈ¢®„Å®Èõ∑„ÅÆË§áÂêàÊîªÊíÉ„ÇíÂæóÊÑè„Å®„Åô„Çã„ÄÇ', color: 'text-yellow-300' },
        c009: { name: 'ÂÖâ„ÅÆËÅñÂ•≥', type: 'SET_MAGIC', magics: ['i017', 'i018', 'i019', 'i020'], description: 'Á•û„Å´ÈÅ∏„Å∞„Çå„ÅóËÅñ„Å™„Çã‰ΩìË≥™„ÄÇÁôí„ÇÑ„Åó„Å®ÊµÑÂåñ„ÅÆÂäõ„ÇíÊåÅ„Å§„ÄÇ', color: 'text-yellow-200' },
        c010: { name: 'Ê≠ªÈúäË°ìÂ∏´', type: 'SET_MAGIC', magics: ['i021', 'i022', 'i023', 'i024'], description: 'Ê≠ª„ÇíÊìç„ÇãÁ¶ÅÂøå„ÅÆ‰ΩìË≥™„ÄÇÁîüÂëΩÂäõ„ÇíÂ•™„ÅÑ„ÄÅÂë™„ÅÑ„ÇíÊíí„ÅçÊï£„Çâ„Åô„ÄÇ', color: 'text-indigo-400' },
    };

    const EQUIPMENT_MASTER = {
        // Normal
        e001: { name: 'È≠îÂäõ„ÅÆÊåáËº™', rarity: 'NORMAL', type: 'MP', value: 0.05, description: 'ÊúÄÂ§ßMP„Åå5%Â¢óÂä†„Åô„Çã„ÄÇ' },
        e002: { name: 'Ë¶ãÁøí„ÅÑ„ÅÆÊùñ', rarity: 'NORMAL', type: 'POWER', value: 0.05, description: 'È≠îÊ≥ïÂ®ÅÂäõ„Åå5%Â¢óÂä†„Åô„Çã„ÄÇ' },

        // Rare
        e101: { name: 'Ë≥¢ËÄÖ„ÅÆÊåáËº™', rarity: 'RARE', type: 'MP', value: 0.1, description: 'ÊúÄÂ§ßMP„Åå10%Â¢óÂä†„Åô„Çã„ÄÇ' },
        e102: { name: 'È≠îË°ìÂ∏´„ÅÆÊùñ', rarity: 'RARE', type: 'POWER', value: 0.1, description: 'È≠îÊ≥ïÂ®ÅÂäõ„Åå10%Â¢óÂä†„Åô„Çã„ÄÇ' },
        e103: { name: 'ÂÆà„Çä„ÅÆ„Ç¢„Éü„É•„É¨„ÉÉ„Éà', rarity: 'RARE', type: 'HP', value: 0.1, description: 'ÊúÄÂ§ßHP„Åå10%Â¢óÂä†„Åô„Çã„ÄÇ' },
        e104: { name: 'ÈÄüË©†„ÅÆ„ÉÅ„É£„Éº„É†', rarity: 'RARE', type: 'COST_REDUCTION', value: 0.1, description: 'È≠îÊ≥ï„ÅÆÊ∂àË≤ªMP„Åå10%Ê∏õÂ∞ë„Åô„Çã„ÄÇ' },
        e105: { name: 'Á≤æÈúä„ÅÆ„Ç¢„Éü„É•„É¨„ÉÉ„Éà', rarity: 'RARE', type: 'MP', value: 0.12, description: 'ÊúÄÂ§ßMP„Åå12%Â¢óÂä†„Åô„Çã„ÄÇ' },
        
        // Epic
        e201: { name: 'Â§ßË≥¢ËÄÖ„ÅÆÊåáËº™', rarity: 'EPIC', type: 'MP', value: 0.2, description: 'ÊúÄÂ§ßMP„Åå20%Â¢óÂä†„Åô„Çã„ÄÇ' },
        e202: { name: 'Â§ßÈ≠îË°ìÂ∏´„ÅÆÊùñ', rarity: 'EPIC', type: 'POWER', value: 0.2, description: 'È≠îÊ≥ïÂ®ÅÂäõ„Åå20%Â¢óÂä†„Åô„Çã„ÄÇ' },
        e203: { name: 'Á≤æÈúä„ÅÆËÖïËº™', rarity: 'EPIC', type: 'MP_REGEN', value: 0.05, description: 'Êà¶Èóò‰∏≠„ÄÅ„Çø„Éº„É≥ÁµÇ‰∫ÜÊôÇ„Å´ÊúÄÂ§ßMP„ÅÆ5%„ÇíÂõûÂæ©„Åô„Çã„ÄÇ' },
        e204: { name: 'Âê∏Ë°Ä„ÅÆÂÆùÁè†', rarity: 'EPIC', type: 'DRAIN', value: 0.1, description: '‰∏é„Åà„Åü„ÉÄ„É°„Éº„Ç∏„ÅÆ10%ÂàÜHP„ÇíÂê∏Âèé„Åô„Çã„ÄÇ' },
        e205: { name: 'Á´úÈ±ó„ÅÆÁõæ', rarity: 'EPIC', type: 'HP', value: 0.25, description: 'ÊúÄÂ§ßHP„Åå25%Â¢óÂä†„Åô„Çã„ÄÇ' },

        // Legendary
        e301: { name: '‰∏ñÁïåÊ®π„ÅÆÊåáËº™', rarity: 'LEGENDARY', type: 'MP', value: 0.5, description: 'ÊúÄÂ§ßMP„Åå50%Â¢óÂä†„Åô„Çã„ÄÇ' },
        e302: { name: 'Ê†πÊ∫ê„ÅÆÊùñ', rarity: 'LEGENDARY', type: 'POWER', value: 0.5, description: 'È≠îÊ≥ïÂ®ÅÂäõ„Åå50%Â¢óÂä†„Åô„Çã„ÄÇ' },
        e303: { name: 'Ë≥¢ËÄÖ„ÅÆÁü≥', rarity: 'LEGENDARY', type: 'ALL', value: 0.15, description: 'ÊúÄÂ§ßHP„ÄÅÊúÄÂ§ßMP„ÄÅÈ≠îÊ≥ïÂ®ÅÂäõ„Åå15%Â¢óÂä†„Åô„Çã„ÄÇ'},
        e304: { name: 'ÁîüÂëΩ„ÅÆ„Ç™„Éº„Éñ', rarity: 'LEGENDARY', type: 'HP_REGEN', value: 0.1, description: 'Êà¶Èóò‰∏≠„ÄÅ„Çø„Éº„É≥ÁµÇ‰∫ÜÊôÇ„Å´ÊúÄÂ§ßHP„ÅÆ10%„ÇíÂõûÂæ©„Åô„Çã„ÄÇ' },
        e305: { name: '„ÇØ„É≠„Éé„Éû„É≥„Çµ„Éº„ÅÆ„Éö„É≥„ÉÄ„É≥„Éà', rarity: 'LEGENDARY', type: 'COST_REDUCTION', value: 0.25, description: 'È≠îÊ≥ï„ÅÆÊ∂àË≤ªMP„Åå25%Ê∏õÂ∞ë„Åó„ÄÅ„Éá„Éê„ÉïÂäπÊûú„ÇíÁü≠Á∏Æ„Åô„Çã„ÄÇ' },
        e306: { name: 'ÊîØÈÖç„ÅÆÁéãÈå´', rarity: 'LEGENDARY', type: 'POWER', value: 0.60, description: 'È≠îÊ≥ïÂ®ÅÂäõ„Åå60%Â¢óÂä†„Åô„Çã„ÄÇ' },

        // Weapon Magic Equipment
        e401: { name: 'È≠îÂâ£„É¨„É¥„Ç°„ÉÜ„Ç§„É≥', rarity: 'EPIC', type: 'GRANT_MAGIC', magicId: 'w001', value: 0, description: 'Ë£ÖÂÇô„Åô„Çã„Å®È≠îÊ≥ï„ÄåÁÅΩ„ÅÑ„ÅÆÁÇé„Äç„Åå‰ΩøÁî®ÂèØËÉΩ„Å´„Å™„Çã„ÄÇ' },
        e402: { name: 'ÂêçÂàÄ„ÉªÈõ∑Âàá', rarity: 'LEGENDARY', type: 'GRANT_MAGIC', magicId: 'w002', value: 0, description: 'Ë£ÖÂÇô„Åô„Çã„Å®È≠îÊ≥ï„ÄåÈõ∑Âàá„Äç„Åå‰ΩøÁî®ÂèØËÉΩ„Å´„Å™„Çã„ÄÇ' },
        e403: { name: 'ËÅñÂâ£„Ç®„ÇØ„Çπ„Ç´„É™„Éê„Éº', rarity: 'LEGENDARY', type: 'GRANT_MAGIC', magicId: 'w003', value: 0, description: 'Ë£ÖÂÇô„Åô„Çã„Å®È≠îÊ≥ï„Äå„Ç®„ÇØ„Çπ„Ç´„É™„Éê„Éº„Äç„Åå‰ΩøÁî®ÂèØËÉΩ„Å´„Å™„Çã„ÄÇ' },
        e404: { name: 'Á•ûÊùñ„Ç´„Éâ„Ç•„Ç±„Ç¶„Çπ', rarity: 'LEGENDARY', type: 'GRANT_MAGIC', magicId: 'w004', value: 0, description: 'Ë£ÖÂÇô„Åô„Çã„Å®È≠îÊ≥ï„Äå„Ç´„Éâ„Ç•„Ç±„Ç¶„Çπ„Äç„Åå‰ΩøÁî®ÂèØËÉΩ„Å´„Å™„Çã„ÄÇ' },
        e405: { name: 'Â¶ñÂàÄ„É†„É©„Éû„Çµ', rarity: 'LEGENDARY', type: 'GRANT_MAGIC', magicId: 'w005', value: 0, description: 'Ë£ÖÂÇô„Åô„Çã„Å®È≠îÊ≥ï„ÄåÈ≠ÇÂàá„Çä„Äç„Åå‰ΩøÁî®ÂèØËÉΩ„Å´„Å™„Çã„ÄÇ' },
        e406: { name: 'Á•ûÂºì„Ç¢„É´„ÉÜ„Éü„Çπ', rarity: 'LEGENDARY', type: 'GRANT_MAGIC', magicId: 'w006', value: 0, description: 'Ë£ÖÂÇô„Åô„Çã„Å®È≠îÊ≥ï„ÄåÊµÅÊòüÈõ®„Äç„Åå‰ΩøÁî®ÂèØËÉΩ„Å´„Å™„Çã„ÄÇ' },
    };

    // --- „Ç¢„Éó„É™„É≠„Ç∏„ÉÉ„ÇØ ---

    const dom = {
        mySaveData: document.getElementById('my-save-data'),
        createRoomBtn: document.getElementById('create-room-btn'),
        joinRoomBtn: document.getElementById('join-room-btn'),
        roomIdInput: document.getElementById('room-id-input'),
        statusMessage: document.getElementById('status-message'),
        setupScreen: document.getElementById('setup-screen'),
        waitingScreen: document.getElementById('waiting-screen'),
        battleScreen: document.getElementById('battle-screen'),
        displayRoomId: document.getElementById('display-room-id'),
        pollingStatus: document.getElementById('polling-status'),
        battleLog: document.getElementById('battle-log'),
        actionArea: document.getElementById('action-area'),
        magicButtons: document.getElementById('magic-buttons'),
        turnIndicator: document.getElementById('turn-indicator')
    };

    let pollingInterval = null;
    let battleState = {
        p1: null,
        p2: null,
        turn: 'p1', // 'p1' or 'p2'
        turnCount: 1
    };

    dom.createRoomBtn.onclick = async () => {
        const url = GAS_API_URL;
        const rawData = dom.mySaveData.value;
        if (!rawData) return showStatus('„Çª„Éº„Éñ„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'text-red-400');

        showStatus('„Éá„Éº„Çø„ÇíÊ§úË®º‰∏≠...', 'text-yellow-300');
        
        // „Éá„Éº„Çø„ÅÆÊ§úË®º„Å®Êï¥ÂΩ¢ÔºàÂπ≥Êñá/ÊöóÂè∑Âåñ ‰∏°ÂØæÂøúÔºâ
        let p1DataObj;
        try {
            p1DataObj = parseSaveData(rawData);
        } catch(e) {
            return showStatus('„Éá„Éº„Çø„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì', 'text-red-400');
        }
        
        // „Çµ„Éº„Éê„Éº„Å´„ÅØJSONÊñáÂ≠óÂàó„Å®„Åó„Å¶ÈÄÅ‰ø°
        const dataToSend = JSON.stringify(p1DataObj);

        showStatus('ÈÉ®Â±ã„Çí‰ΩúÊàê‰∏≠...', 'text-yellow-300');
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ action: 'create_room', data: dataToSend })
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                showWaitingScreen(result.roomId, 'p1');
            } else {
                showStatus('„Ç®„É©„Éº: ' + result.message, 'text-red-400');
            }
        } catch (e) {
            showStatus('ÈÄö‰ø°„Ç®„É©„Éº: ' + e.message, 'text-red-400');
        }
    };

    dom.joinRoomBtn.onclick = async () => {
        const url = GAS_API_URL;
        const rawData = dom.mySaveData.value;
        const roomId = dom.roomIdInput.value;
        if (!rawData || !roomId) return showStatus('ÂÖ®„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'text-red-400');

        showStatus('„Éá„Éº„Çø„ÇíÊ§úË®º‰∏≠...', 'text-yellow-300');
        
        let p2DataObj;
        try {
            p2DataObj = parseSaveData(rawData);
        } catch(e) {
            return showStatus('„Éá„Éº„Çø„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì', 'text-red-400');
        }
        
        const dataToSend = JSON.stringify(p2DataObj);

        showStatus('ÈÉ®Â±ã„Å´ÂèÇÂä†‰∏≠...', 'text-yellow-300');
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ action: 'join_room', roomId: roomId, data: dataToSend })
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                showWaitingScreen(roomId, 'p2');
            } else {
                showStatus('„Ç®„É©„Éº: ' + result.message, 'text-red-400');
            }
        } catch (e) {
            showStatus('ÈÄö‰ø°„Ç®„É©„Éº: ' + e.message, 'text-red-400');
        }
    };

    // „Éá„Éº„Çø„Éë„Éº„ÇπÈñ¢Êï∞ (Âπ≥ÊñáJSON„Å®Base64ÊöóÂè∑Âåñ„Éá„Éº„Çø„ÅÆ‰∏°Êñπ„Å´ÂØæÂøú)
    function parseSaveData(input) {
        input = input.trim();
        try {
            // „Åæ„ÅöÂπ≥ÊñáJSON„Å®„Åó„Å¶Ë©¶„Åô
            return JSON.parse(input);
        } catch (e) {
            try {
                // Â§±Êïó„Åó„Åü„ÇâBase64„Éá„Ç≥„Éº„Éâ„ÇíË©¶„Åô
                // magic_rpg.html„Åß„ÅØ btoa(unescape(encodeURIComponent(json))) „Åó„Å¶„ÅÑ„Çã„ÅÆ„Åß
                // decodeURIComponent(escape(atob(input))) „ÅßÂæ©ÂÖÉ„Åô„Çã
                const decoded = decodeURIComponent(escape(atob(input)));
                return JSON.parse(decoded);
            } catch (e2) {
                console.error(e2);
                throw new Error("Invalid Data");
            }
        }
    }

    function showStatus(msg, colorClass) {
        dom.statusMessage.textContent = msg;
        dom.statusMessage.className = `mt-4 text-center h-6 ${colorClass}`;
    }

    function showWaitingScreen(roomId, role) {
        dom.setupScreen.classList.add('hidden');
        dom.waitingScreen.classList.remove('hidden');
        dom.displayRoomId.textContent = roomId;
        
        // „Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
        const url = GAS_API_URL;
        let dots = 0;
        
        pollingInterval = setInterval(async () => {
            dots = (dots + 1) % 4;
            dom.pollingStatus.textContent = 'ÂØæÊà¶Áõ∏Êâã„ÇíÂæÖÊ©ü‰∏≠' + '.'.repeat(dots);
            
            try {
                const response = await fetch(`${url}?action=check_room&roomId=${roomId}`);
                const result = await response.json();
                
                if (result.status === 'ready') {
                    clearInterval(pollingInterval);
                    startPvPBattle(result.p1Data, result.p2Data);
                }
            } catch (e) {
                console.error("Polling error", e);
            }
        }, 3000); // 3Áßí„Åî„Å®„Å´Á¢∫Ë™ç
    }

    // --- „Éê„Éà„É´„É≠„Ç∏„ÉÉ„ÇØ ---

    function startPvPBattle(p1Json, p2Json) {
        dom.waitingScreen.classList.add('hidden');
        dom.battleScreen.classList.remove('hidden');

        const p1Data = JSON.parse(p1Json);
        const p2Data = JSON.parse(p2Json);

        battleState = {
            p1: initPlayerBattleData(p1Data, 'Player 1'),
            p2: initPlayerBattleData(p2Data, 'Player 2'),
            turn: 'p1',
            turnCount: 1
        };

        addLog(`=== „Éê„Éà„É´ÈñãÂßã ===`);
        addLog(`P1: Lv.${p1Data.player.level} vs P2: Lv.${p2Data.player.level}`);
        
        updateBattleUI();
    }

    function initPlayerBattleData(data, defaultName) {
        // magic_rpg.html „ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„ÇíÁ∞°Áï•Âåñ„Åó„Å¶ÂÜçÁèæ
        // Ë£ÖÂÇôË£úÊ≠£Á≠â„ÅØÁ∞°ÊòìË®àÁÆó„Åæ„Åü„ÅØdata„Åã„ÇâÂèñÂæó
        const p = data.player;
        
        // Ë£ÖÂÇôÂäπÊûú„ÅÆÂÜçË®àÁÆóÔºàË¶öÈÜíÂÄ§ËÄÉÊÖÆÔºâ
        let hpBoost = 0;
        let mpBoost = 0;
        let powerBoost = 0;
        
        // Ë£ÖÂÇô„Ç§„É≥„Éô„É≥„Éà„É™„Çí‰Ωø„Å£„Å¶Ë¶öÈÜíÂÄ§„ÇíÂèñÂæó
        const equipmentInventory = data.equipmentInventory || [];

        p.equippedEquipment.forEach(eqId => {
            if(!eqId) return;
            
            const master = EQUIPMENT_MASTER[eqId];
            if(master) {
                // „Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâË©≤ÂΩì„Ç¢„Ç§„ÉÜ„É†„ÇíÊé¢„ÅôÔºà„Å™„Åë„Çå„Å∞Ë¶öÈÜí0„Å®„Åó„Å¶Êâ±„ÅÜÔºâ
                const instance = equipmentInventory.find(i => i.masterId === eqId) || { awakening: 0 };
                
                // Ë¶öÈÜí„Éú„Éº„Éä„ÇπË®àÁÆó (magic_rpg.htmlÊ∫ñÊã†)
                let bonusPerAwakening = { 'NORMAL': 0.05, 'RARE': 0.10, 'EPIC': 0.50, 'LEGENDARY': 1.00, 'SPECIAL': 1.50 }[master.rarity] || 0;
                const awakeningBonus = 1 + instance.awakening * bonusPerAwakening;
                const value = master.value * awakeningBonus;

                if(master.type === 'HP' || master.type === 'ALL') hpBoost += value;
                if(master.type === 'MP' || master.type === 'ALL') mpBoost += value;
                if(master.type === 'POWER' || master.type === 'ALL') powerBoost += value;
            }
        });

        // Âü∫Á§é„Çπ„ÉÜ„Éº„Çø„ÇπÂÜçË®àÁÆó (magic_rpg.htmlÊ∫ñÊã†)
        let baseHp = 100 + (p.level - 1) * 50;
        let maxHp = Math.floor(baseHp * (1 + hpBoost));
        
        let baseMp = 50 + (p.level - 1) * 5 + (p.permanentMpBonus || 0);
        let maxMp = Math.floor(baseMp * (1 + mpBoost));

        return {
            name: defaultName,
            level: p.level,
            potentialLevel: p.potentialLevel || 0,
            maxHp: maxHp,
            currentHp: maxHp,
            maxMp: maxMp,
            currentMp: maxMp,
            shield: 0,
            effects: [],
            equippedMagic: p.equippedMagic,
            equippedEquipment: p.equippedEquipment,
            constitution: p.constitution,
            powerBoost: powerBoost, // Ë£ÖÂÇô„Å´„Çà„ÇãË£úÊ≠£ÂÄ§
            magicInventory: data.magicInventory || [],
            equipmentInventory: equipmentInventory // Ë£ÖÂÇô„Ç§„É≥„Éô„É≥„Éà„É™„ÇÇ‰øùÊåÅ
        };
    }

    function updateBattleUI() {
        const { p1, p2, turn } = battleState;

        // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        updatePlayerStatus('p1', p1);
        updatePlayerStatus('p2', p2);

        // „Çø„Éº„É≥Ë°®Á§∫
        const activePlayer = turn === 'p1' ? p1 : p2;
        const playerColor = turn === 'p1' ? 'text-green-400' : 'text-red-400';
        dom.turnIndicator.innerHTML = `<span class="${playerColor}">${activePlayer.name}„ÅÆ„Çø„Éº„É≥</span>`;
        
        // Êû†„ÅÆ„Éè„Ç§„É©„Ç§„Éà
        document.getElementById('p1-status-box').classList.toggle('turn-active', turn === 'p1');
        document.getElementById('p2-status-box').classList.toggle('turn-active', turn === 'p2');
        dom.actionArea.className = `glassmorphism p-4 rounded-xl transition-colors duration-500 ${turn === 'p1' ? 'p1-theme' : 'p2-theme'}`;

        // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ÁîüÊàê
        renderActionButtons(activePlayer);
    }

    function updatePlayerStatus(prefix, player) {
        document.getElementById(`${prefix}-hp-bar`).style.width = `${Math.max(0, (player.currentHp / player.maxHp) * 100)}%`;
        document.getElementById(`${prefix}-shield-bar`).style.width = `${Math.min(100, (player.shield / player.maxHp) * 100)}%`;
        document.getElementById(`${prefix}-mp-bar`).style.width = `${Math.max(0, (player.currentMp / player.maxMp) * 100)}%`;
        document.getElementById(`${prefix}-hp-text`).textContent = `HP: ${player.currentHp}/${player.maxHp}`;
        document.getElementById(`${prefix}-mp-text`).textContent = `MP: ${player.currentMp}/${player.maxMp}`;
        document.getElementById(`${prefix}-shield-val`).textContent = player.shield > 0 ? `Shield: ${player.shield}` : '';
        
        const effectsDiv = document.getElementById(`${prefix}-effects`);
        effectsDiv.innerHTML = '';
        player.effects.forEach(eff => {
            const m = MAGIC_MASTER[eff.magicId] || DUMMY_MAGIC;
            let icon = '‚ú®';
            if(eff.type === 'BUFF') icon = '‚öîÔ∏è';
            if(eff.type === 'DEFENSE') icon = 'üõ°Ô∏è';
            if(eff.type === 'DEBUFF') icon = 'üíÄ';
            effectsDiv.innerHTML += `<span class="text-xs bg-gray-700 px-1 rounded" title="${m.name}">${icon}${eff.turnsLeft}</span>`;
        });
    }

    function renderActionButtons(player) {
        const container = dom.magicButtons;
        container.innerHTML = '';

        // Ë£ÖÂÇôÈ≠îÊ≥ï
        player.equippedMagic.forEach(mid => {
            if(mid) createMagicBtn(mid, player, container, 'EQUIPPED');
        });

        // ÁâπÊÆä‰ΩìË≥™È≠îÊ≥ï
        if (player.constitution) {
            const c = CONSTITUTION_MASTER[player.constitution];
            if (c && c.type === 'SET_MAGIC') {
                c.magics.forEach(mid => createMagicBtn(mid, player, container, 'INHERITED'));
            }
        }

        // Ê≠¶Âô®È≠îÊ≥ï
        player.equippedEquipment.forEach(eid => {
            if(!eid) return;
            const em = EQUIPMENT_MASTER[eid];
            if(em && em.type === 'GRANT_MAGIC') {
                createMagicBtn(em.magicId, player, container, 'WEAPON');
            }
        });

        // ÂÖ±ÈÄö„Ç¢„ÇØ„Ç∑„Éß„É≥
        // Á≤æÁ•ûÈõÜ‰∏≠
        const recoverBtn = document.createElement('button');
        recoverBtn.className = 'magic-button w-full h-12 flex items-center justify-center gap-2 col-span-2 mt-2';
        recoverBtn.innerHTML = '<span>üßò Á≤æÁ•ûÈõÜ‰∏≠ (MPÂõûÂæ©)</span>';
        recoverBtn.onclick = () => executeAction('RECOVER_MP');
        container.appendChild(recoverBtn);

        // È≠îÂäõÁµêÈõÜ (Lv75‰ª•‰∏ä)
        if(player.level >= 75) {
            const blastCost = Math.floor(player.maxMp / 2);
            const blastBtn = document.createElement('button');
            blastBtn.className = 'magic-button w-full h-12 flex items-center justify-center gap-2 col-span-2 border-red-500';
            blastBtn.innerHTML = `<span>üí• È≠îÂäõÁµêÈõÜ (Ê∂àË≤ª:${blastCost})</span>`;
            blastBtn.disabled = player.currentMp < blastCost;
            blastBtn.onclick = () => executeAction('MANA_BLAST');
            container.appendChild(blastBtn);
        }
    }

    function createMagicBtn(masterId, player, container, context) {
        const m = MAGIC_MASTER[masterId];
        if(!m) return;

        // „Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâË¶öÈÜíÂÄ§„Å™„Å©„ÇíÂèñÂæóÔºàÁ∞°ÊòìÂÆüË£ÖÔºöË¶ã„Å§„Åã„Çâ„Å™„Åë„Çå„Å∞Lv1Ôºâ
        let instance = player.magicInventory.find(i => i.masterId === masterId) || { level: player.level, awakening: 0 };
        
        // „Ç≥„Çπ„ÉàË®àÁÆó (Ë£ÖÂÇôË£úÊ≠£Ëæº„Åø„ÉªË¶öÈÜíÂÄ§ËÄÉÊÖÆ)
        let costReduction = 0;
        player.equippedEquipment.forEach(eid => {
            if(!eid) return;
            const em = EQUIPMENT_MASTER[eid];
            if(em && em.type === 'COST_REDUCTION') {
                const eqInstance = player.equipmentInventory.find(i => i.masterId === eid) || { awakening: 0 };
                let bonusPerAwakening = { 'NORMAL': 0.05, 'RARE': 0.10, 'EPIC': 0.50, 'LEGENDARY': 1.00, 'SPECIAL': 1.50 }[em.rarity] || 0;
                const awakeningBonus = 1 + eqInstance.awakening * bonusPerAwakening;
                costReduction += em.value * awakeningBonus;
            }
        });
        const cost = Math.max(1, Math.floor(m.baseCost * (1 - costReduction)));

        const btn = document.createElement('button');
        let borderClass = '';
        if(context === 'INHERITED') borderClass = 'border-red-500';
        if(context === 'WEAPON') borderClass = 'border-purple-500';

        btn.className = `magic-button w-full h-14 flex items-center px-2 gap-2 text-left ${borderClass}`;
        btn.innerHTML = `
            <div class="text-2xl">${ELEMENTS[m.element]?.icon || '‚ú®'}</div>
            <div class="flex-1 min-w-0">
                <div class="font-bold text-sm truncate">${m.name}</div>
                <div class="text-xs text-blue-300">MP: ${cost}</div>
            </div>
        `;
        btn.disabled = player.currentMp < cost;
        btn.onclick = () => executeAction('MAGIC', { masterId, cost, instance });
        container.appendChild(btn);
    }

    function executeAction(type, data) {
        const actor = battleState.turn === 'p1' ? battleState.p1 : battleState.p2;
        const target = battleState.turn === 'p1' ? battleState.p2 : battleState.p1;

        if (type === 'RECOVER_MP') {
            const amount = Math.floor(actor.maxMp * 0.2);
            actor.currentMp = Math.min(actor.maxMp, actor.currentMp + amount);
            addLog(`${actor.name}„ÅØÁ≤æÁ•û„ÇíÈõÜ‰∏≠„Åó„ÄÅMP„Åå${amount}ÂõûÂæ©„Åó„ÅüÔºÅ`);
        } 
        else if (type === 'MANA_BLAST') {
            const cost = Math.floor(actor.maxMp / 2);
            actor.currentMp -= cost;
            
            // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆó (magic_rpg.htmlÊ∫ñÊã†)
            let baseDamage = cost * 30;
            const levelBonus = 1 + (actor.level * 0.02);
            const potentialBonus = 1 + (actor.potentialLevel * 0.10);
            let buffMultiplier = 1 + actor.powerBoost; // Ë£ÖÂÇôË£úÊ≠£
            
            // „Éê„Éï„ÉÅ„Çß„ÉÉ„ÇØ
            actor.effects.forEach(eff => {
                const m = MAGIC_MASTER[eff.magicId];
                if(eff.type === 'BUFF' && m) buffMultiplier *= m.basePower;
            });

            // ÁãÇÊà¶Â£´
            if(actor.constitution === 'c006' && actor.currentHp <= actor.maxHp * 0.5) {
                buffMultiplier *= 1.5;
            }

            const damage = Math.floor(baseDamage * levelBonus * potentialBonus * buffMultiplier);
            addLog(`${actor.name}„ÅÆÈ≠îÂäõÁµêÈõÜÔºÅ`);
            takeDamage(target, damage);
        }
        else if (type === 'MAGIC') {
            const { masterId, cost, instance } = data;
            const m = MAGIC_MASTER[masterId];
            actor.currentMp -= cost;
            addLog(`${actor.name}„ÅØ${m.name}„ÇíÂî±„Åà„ÅüÔºÅ`);

            // Â®ÅÂäõË®àÁÆó
            let bonusPerAwakening = { 'NORMAL': 0.05, 'RARE': 0.10, 'EPIC': 0.50, 'LEGENDARY': 1.00, 'SPECIAL': 1.50 }[m.rarity] || 0;
            const awakeningBonus = 1 + instance.awakening * bonusPerAwakening;
            // „É¨„Éô„É´Ë£úÊ≠£ („Ç§„É≥„Çπ„Çø„É≥„Çπ„É¨„Éô„É´ or „Éó„É¨„Ç§„É§„Éº„É¨„Éô„É´)
            const level = (m.category === 'INHERITED' || m.category === 'WEAPON') ? actor.level : (instance.level || 1);
            
            let power = Math.floor(m.basePower * (1 + level * 0.1) * awakeningBonus);
            
            // Áõ∏‰ºùÈ≠îÊ≥ï„Éù„ÉÜ„É≥„Ç∑„É£„É´„Éú„Éº„Éä„Çπ
            if (m.category === 'INHERITED') {
                power = Math.floor(power * (1 + actor.potentialLevel * 0.05));
            }

            // „Éê„ÉïË£úÊ≠£
            let multiplier = 1 + actor.powerBoost;
            actor.effects.forEach(eff => {
                const buffM = MAGIC_MASTER[eff.magicId];
                if(eff.type === 'BUFF' && buffM) multiplier *= buffM.basePower;
            });
            // ÊîªÊíÉ/ÂõûÂæ©/Èò≤Âæ°„ÅÆÂ†¥Âêà„ÅØ„Éó„É¨„Ç§„É§„Éº„É¨„Éô„É´Ë£úÊ≠£(ÂÖ®‰Ωì)„ÇÇ‰πó„Çã‰ªïÊßò
            if(['ATTACK', 'HEAL', 'DEFENSE'].includes(m.type)) {
                multiplier *= (1 + actor.level / 100);
            }

            const finalPower = Math.floor(power * multiplier);

            if (m.type === 'ATTACK') {
                takeDamage(target, finalPower);
                if (m.isDot) target.effects.push({ magicId: masterId, type: 'DOT', power: finalPower, turnsLeft: m.duration });
                // „Éâ„É¨„Ç§„É≥Âá¶ÁêÜÁ≠â„ÅØÁúÅÁï•
            } else if (m.type === 'HEAL') {
                actor.currentHp = Math.min(actor.maxHp, actor.currentHp + finalPower);
                addLog(`HP„Åå${finalPower}ÂõûÂæ©„Åó„Åü„ÄÇ`);
                if(m.duration) actor.effects.push({ magicId: masterId, type: 'HEAL', power: finalPower, turnsLeft: m.duration });
            } else if (m.type === 'DEFENSE') {
                actor.shield += finalPower;
                addLog(`„Ç∑„Éº„É´„Éâ„Çí${finalPower}Â±ïÈñã„Åó„Åü„ÄÇ`);
                if(m.duration) actor.effects.push({ magicId: masterId, type: 'DEFENSE', power: finalPower, turnsLeft: m.duration });
            } else if (m.type === 'BUFF') {
                actor.effects.push({ magicId: masterId, type: 'BUFF', turnsLeft: m.duration });
                addLog(`Âº∑ÂåñÂäπÊûú„ÇíÂæó„ÅüÔºÅ`);
            } else if (m.type === 'DEBUFF') {
                target.effects.push({ magicId: masterId, type: 'DEBUFF', turnsLeft: m.duration });
                addLog(`${target.name}„ÇíÂº±‰ΩìÂåñ„Åï„Åõ„ÅüÔºÅ`);
            }
        }

        // „Çø„Éº„É≥ÁµÇ‰∫ÜÂá¶ÁêÜ
        checkBattleEnd();
        if (battleState.p1.currentHp > 0 && battleState.p2.currentHp > 0) {
            switchTurn();
        }
    }

    function takeDamage(target, damage) {
        // „Ç∑„Éº„É´„ÉâÂá¶ÁêÜ
        let actualDamage = damage;
        if (target.shield > 0) {
            const blocked = Math.min(target.shield, actualDamage);
            target.shield -= blocked;
            actualDamage -= blocked;
            addLog(`„Ç∑„Éº„É´„Éâ„Åå${blocked}„ÉÄ„É°„Éº„Ç∏„ÇíÈò≤„ÅÑ„Å†ÔºÅ`);
        }
        
        target.currentHp = Math.max(0, target.currentHp - actualDamage);
        addLog(`${target.name}„Å´${actualDamage}„ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`);
    }

    function switchTurn() {
        // „Çø„Éº„É≥ÁµåÈÅéÂá¶ÁêÜÔºàDoT, „Éê„ÉïÂàá„Çå„Å™„Å©Ôºâ
        const nextTurn = battleState.turn === 'p1' ? 'p2' : 'p1';
        const nextActor = nextTurn === 'p1' ? battleState.p1 : battleState.p2;

        addLog(`--- „Çø„Éº„É≥ ${++battleState.turnCount} ---`);
        
        // „Ç®„Éï„Çß„ÇØ„ÉàÂá¶ÁêÜ
        nextActor.effects = nextActor.effects.filter(eff => {
            const m = MAGIC_MASTER[eff.magicId];
            if(eff.type === 'DOT') {
                const dmg = Math.floor(eff.power / m.duration);
                takeDamage(nextActor, dmg);
                addLog(`${nextActor.name}„ÅØÁ∂ôÁ∂ö„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„Åü`);
            }
            else if(eff.type === 'HEAL') {
                const heal = Math.floor(eff.power / m.duration);
                nextActor.currentHp = Math.min(nextActor.maxHp, nextActor.currentHp + heal);
                addLog(`${nextActor.name}„ÅØÂÜçÁîüÂäπÊûú„ÅßÂõûÂæ©„Åó„Åü`);
            }
            // „Éë„ÉÉ„Ç∑„ÉñMPÂõûÂæ© (Á≤æÈúä„ÅÆÂä†Ë≠∑)
            if(nextActor.constitution === 'c005') {
                 const heal = Math.floor(nextActor.maxMp * 0.1);
                 nextActor.currentMp = Math.min(nextActor.maxMp, nextActor.currentMp + heal);
            }

            eff.turnsLeft--;
            return eff.turnsLeft > 0;
        });

        checkBattleEnd();
        
        if (battleState.p1.currentHp > 0 && battleState.p2.currentHp > 0) {
            battleState.turn = nextTurn;
            updateBattleUI();
        }
    }

    function checkBattleEnd() {
        if (battleState.p1.currentHp <= 0) {
            endGame(battleState.p2.name);
        } else if (battleState.p2.currentHp <= 0) {
            endGame(battleState.p1.name);
        }
    }

    function endGame(winnerName) {
        dom.actionArea.innerHTML = `
            <div class="text-center py-8">
                <h2 class="text-4xl font-cinzel text-yellow-400 mb-4">WINNER</h2>
                <p class="text-2xl font-bold">${winnerName}</p>
                <button onclick="location.reload()" class="magic-button px-8 py-3 mt-8">„Çø„Ç§„Éà„É´„Å∏Êàª„Çã</button>
            </div>
        `;
    }

    function addLog(msg) {
        const p = document.createElement('p');
        p.innerHTML = msg;
        dom.battleLog.prepend(p);
    }

</script>
</body>
</html>
