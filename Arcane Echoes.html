<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Echoes - ã‚¢ãƒ¼ã‚±ã‚¤ãƒ³ã‚¨ã‚³ãƒ¼ã‚º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+JP:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a1a;
            --primary-color: #1a1a3a;
            --secondary-color: #2a2a5a;
            --accent-color: #c0a0ff;
            --text-color: #e0e0ff;
            --gold-color: #ffd700;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Sans JP', sans-serif;
            background-image:
                radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 20px 20px;
        }

        .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        .game-container {
            max-width: 1000px;
            margin: auto;
            padding: 1rem;
        }
        
        /* ã‚¬ãƒ©ã‚¹é¢¨UI */
        .glassmorphism {
            background: rgba(26, 26, 58, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(192, 160, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒœãƒ¼ãƒ€ãƒ¼ */
        .gradient-border {
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        .gradient-border::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -2px;
            border-radius: inherit;
            background: linear-gradient(to right, var(--accent-color), #8a2be2);
        }

        /* è£…é£¾çš„ãªãƒœã‚¿ãƒ³ */
        .magic-button {
            position: relative;
            border: 1px solid var(--accent-color);
            background: linear-gradient(145deg, var(--secondary-color), var(--primary-color));
            color: var(--text-color);
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(192, 160, 255, 0.3), inset 0 0 5px rgba(26, 26, 58, 0.5);
            clip-path: polygon(10% 0%, 90% 0%, 100% 50%, 90% 100%, 10% 100%, 0% 50%);
        }

        .magic-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 0 15px var(--accent-color), inset 0 0 10px rgba(192, 160, 255, 0.3);
            color: white;
        }
        .magic-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ã‚¿ãƒ– */
        .tab-button {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            color: var(--gold-color);
            border-bottom-color: var(--gold-color);
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--primary-color); }
        ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a080ff; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            width: 90%;
            max-width: 500px;
            padding: 2rem;
            border-radius: 1rem;
        }

        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£è‰² */
        .rarity-Normal { color: #ffffff; }
        .rarity-Rare { color: #87cefa; }
        .rarity-Epic { color: #da70d6; }
        .rarity-Legendary { color: var(--gold-color); }

        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒœãƒ¼ãƒ€ãƒ¼ */
        .card-border { border: 2px solid; }
        .border-rarity-Normal { border-color: rgba(170, 170, 170, 0.5); }
        .border-rarity-Rare { border-color: #87cefa; }
        .border-rarity-Epic { border-color: #da70d6; }
        .border-rarity-Legendary { border-color: var(--gold-color); }
        
        .bg-rarity-Normal { background-color: rgba(100, 100, 100, 0.3); }
        .bg-rarity-Rare { background-color: rgba(70, 130, 180, 0.3); }
        .bg-rarity-Epic { background-color: rgba(138, 43, 226, 0.3); }
        .bg-rarity-Legendary { background-color: rgba(255, 215, 0, 0.3); }

        /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ã‚¬ãƒãƒ£Legendaryæ¼”å‡º */
        .legendary-animation {
            animation: legendary-glow 0.8s ease-in-out;
            box-shadow: 0 0 30px var(--gold-color), 0 0 50px white;
        }
        @keyframes legendary-glow {
            0% { transform: scale(1.1); box-shadow: 0 0 10px var(--gold-color); }
            50% { transform: scale(1.15); box-shadow: 0 0 60px var(--gold-color), 0 0 80px white; }
            100% { transform: scale(1.1); box-shadow: 0 0 10px var(--gold-color); }
        }

        .effect-icon {
            position: relative;
            font-size: 1.5rem;
        }
        .turn-counter {
            position: absolute;
            bottom: -2px;
            right: -4px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            font-size: 0.7rem;
            line-height: 1rem;
            text-align: center;
            font-weight: bold;
        }
        
        .enemy-card.targeting {
            cursor: pointer;
            outline: 2px solid red;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
    <div id="title-screen" class="min-h-screen flex flex-col justify-center items-center text-center p-4">
        <h1 class="text-6xl md:text-8xl font-cinzel text-shadow-lg" style="text-shadow: 0 0 15px var(--accent-color);">Arcane Echoes</h1>
        <p class="mt-4 text-xl text-gray-300">ã‚¢ãƒ¼ã‚±ã‚¤ãƒ³ã‚¨ã‚³ãƒ¼ã‚º</p>
        <button id="start-game-button" class="mt-12 magic-button px-10 py-4 text-2xl font-cinzel">START</button>
        <div class="mt-8 flex gap-4">
            <label for="import-save" class="magic-button px-6 py-2 cursor-pointer">ãƒ‡ãƒ¼ã‚¿å¼•ç¶™ã</label>
            <input type="file" id="import-save" class="hidden" accept=".json">
            <button id="reset-game-button" class="magic-button px-6 py-2">ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ æœ¬ä½“ -->
    <div id="game-container" class="hidden game-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="flex justify-between items-center p-4 glassmorphism rounded-xl mb-4">
            <div>
                <span id="player-level" class="font-bold"></span>
                <span id="player-potential" class="text-xs text-yellow-300 ml-2"></span>
                <div id="player-trait" class="text-xs text-cyan-300 mt-1 h-4"></div>
                <div class="w-40 h-2 bg-gray-700 rounded-full overflow-hidden mt-1">
                    <div id="player-exp-bar" class="h-full bg-yellow-400"></div>
                </div>
            </div>
            <div class="text-center">
                 <h1 class="text-3xl font-cinzel">Home</h1>
            </div>
            <div class="text-right">
                <div id="player-mp" class="font-bold text-blue-300"></div>
                <div id="player-gacha-stones" class="font-bold text-pink-400"></div>
                <div id="player-materials" class="font-bold text-gray-400"></div>
                <div id="player-tomes" class="font-bold text-yellow-400"></div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main id="main-content" class="fade-in">
            <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
            <div id="home-screen">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button data-screen="dungeon-screen" class="nav-button h-32 md:h-40 magic-button flex flex-col justify-center items-center">
                        <span class="text-5xl">âš”ï¸</span>
                        <span class="mt-2 text-lg font-cinzel">Dungeon</span>
                    </button>
                     <button data-screen="infinite-tower-screen" class="nav-button h-32 md:h-40 magic-button flex flex-col justify-center items-center">
                        <span class="text-5xl">ğŸ—¼</span>
                        <span class="mt-2 text-lg font-cinzel">Infinite Tower</span>
                    </button>
                    <button data-screen="rift-challenge-screen" class="nav-button h-32 md:h-40 magic-button flex flex-col justify-center items-center">
                        <span class="text-5xl">ğŸŒ€</span>
                        <span class="mt-2 text-lg font-cinzel">Rift Challenge</span>
                    </button>
                    <button data-screen="gacha-screen" class="nav-button h-32 md:h-40 magic-button flex flex-col justify-center items-center">
                        <span class="text-5xl">âœ¨</span>
                        <span class="mt-2 text-lg font-cinzel">Gacha</span>
                    </button>
                    <button data-screen="magic-school-screen" class="nav-button h-32 md:h-40 magic-button flex flex-col justify-center items-center">
                        <span class="text-5xl">ğŸ«</span>
                        <span class="mt-2 text-lg font-cinzel">Magic School</span>
                    </button>
                    <button data-screen="magic-screen" class="nav-button h-32 md:h-40 magic-button flex flex-col justify-center items-center">
                        <span class="text-5xl">ğŸ“–</span>
                        <span class="mt-2 text-lg font-cinzel">Magic</span>
                    </button>
                    <button data-screen="equipment-screen" class="nav-button h-32 md:h-40 magic-button flex flex-col justify-center items-center">
                        <span class="text-5xl">ğŸ›¡ï¸</span>
                        <span class="mt-2 text-lg font-cinzel">Equipment</span>
                    </button>
                    <button data-screen="encyclopedia-screen" class="nav-button h-32 md:h-40 magic-button flex flex-col justify-center items-center">
                        <span class="text-5xl">ğŸ“š</span>
                        <span class="mt-2 text-lg font-cinzel">Encyclopedia</span>
                    </button>
                    <button id="export-save-button" class="h-32 md:h-40 magic-button flex flex-col justify-center items-center">
                        <span class="text-5xl">ğŸ’¾</span>
                        <span class="mt-2 text-lg font-cinzel">Save Data</span>
                    </button>
                </div>
            </div>
            
            <!-- ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³é¸æŠç”»é¢ -->
            <div id="dungeon-screen" class="hidden">
                 <h2 class="text-3xl font-cinzel mb-4 text-center">Dungeons</h2>
                 <div id="dungeon-list" class="space-y-4"></div>
            </div>
            
            <!-- æ¬¡å…ƒãƒè£‚ã‘ç›®ç”»é¢ -->
            <div id="rift-challenge-screen" class="hidden text-center">
                <h2 class="text-3xl font-cinzel mb-4">æ¬¡å…ƒã®è£‚ã‘ç›®</h2>
                <p class="mb-6 text-gray-400">æ¬¡å…ƒã®ç‹­é–“ã‹ã‚‰ç¾ã‚ŒãŸå¼·æ•µã«æŒ‘ã‚ã€‚æŒ‘æˆ¦ã¯1æ—¥1åº¦ã®ã¿ã€‚</p>
                <div id="rift-boss-list" class="space-y-4"></div>
            </div>

            <!-- é­”æ³•å­¦æ ¡ç”»é¢ -->
            <div id="magic-school-screen" class="hidden">
                 <h2 class="text-3xl font-cinzel mb-4 text-center">Magic School</h2>
                 <p class="text-center mb-4 text-gray-400">æ•™å¸«ã¨ã®è¨“ç·´ã§æ–°ãŸãªåŠ›ã‚’æ‰‹ã«å…¥ã‚Œã‚ˆã†ã€‚</p>
                 <div id="teacher-list" class="space-y-4"></div>
            </div>

            <!-- ç„¡é™ã®å¡”ç”»é¢ -->
            <div id="infinite-tower-screen" class="hidden text-center">
                <h2 class="text-3xl font-cinzel mb-4">ç„¡é™ã®å¡”</h2>
                <div class="p-8 glassmorphism rounded-xl">
                    <p class="mb-4">å·±ã®é™ç•Œã«æŒ‘ã¿ã€éšå±¤ã‚’è¸ç ´ã›ã‚ˆã€‚</p>
                    <p class="mb-6 text-lg">è‡ªå·±æœ€é«˜è¨˜éŒ²: <span id="highest-floor" class="font-bold text-yellow-400">0</span>éš</p>
                    <button id="start-tower-button" class="magic-button px-10 py-4 text-xl">æŒ‘æˆ¦é–‹å§‹</button>
                    <div class="mt-6 text-sm text-gray-400">
                        <p>ãƒ»æ•—åŒ—ã™ã‚‹ã¾ã§æˆ¦é—˜ã¯ç¶šãã¾ã™ã€‚</p>
                        <p>ãƒ»éšå±¤çªç ´æ™‚ã«HPãƒ»MPãŒå…¨å›å¾©ã—ã¾ã™ã€‚</p>
                        <p>ãƒ»5éšå±¤ã”ã¨ã«å¼·åŒ–ç´ æã€10éšå±¤ã”ã¨ã«é­”æ³•çŸ³ãŒæ‰‹ã«å…¥ã‚Šã¾ã™ã€‚</p>
                        <p>ãƒ»æˆ¦é—˜ä¸­ã«ã€Œæ’¤é€€ã€ã™ã‚‹ã“ã¨ã§ã€ãã“ã¾ã§ã®å ±é…¬ã‚’ç¢ºä¿ã§ãã¾ã™ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- æˆ¦é—˜ç”»é¢ -->
            <div id="battle-screen" class="hidden">
                <div class="flex flex-col items-center">
                    <div id="battle-header" class="w-full text-center text-2xl font-cinzel mb-4"></div>
                    <div id="enemies-area" class="mb-8 w-full flex justify-center items-start gap-4 flex-wrap">
                        <!-- æ•µã‚«ãƒ¼ãƒ‰ã¯ã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </div>

                    <div id="player-area" class="mb-8 text-center">
                        <p class="text-2xl font-bold">Player</p>
                         <div class="flex justify-center items-center gap-4 mt-4">
                             <div class="relative w-48 h-4 bg-gray-700 rounded-full overflow-hidden border border-green-900">
                                <div id="battle-player-hp-bar" class="h-full bg-green-500 transition-all duration-500"></div>
                                <div id="battle-player-shield-bar" class="absolute top-0 left-0 h-full bg-cyan-400 bg-opacity-70 transition-all duration-500"></div>
                             </div>
                            <div class="w-48 h-4 bg-gray-700 rounded-full overflow-hidden border border-blue-900">
                                 <div id="battle-player-mp-bar" class="h-full bg-blue-500 transition-all duration-500"></div>
                            </div>
                        </div>
                        <div class="flex justify-center items-center gap-4 mt-1 text-sm">
                            <p id="battle-player-hp-text"></p>
                            <p id="battle-player-mp-text"></p>
                        </div>
                        <div id="player-shield-text" class="text-sm text-cyan-300 mt-1 h-5"></div>
                        <div id="player-effects" class="flex justify-center gap-2 mt-2 h-8"></div>
                    </div>
                    
                    <div id="battle-log" class="w-full h-24 p-2 mb-4 bg-black bg-opacity-50 rounded-lg overflow-y-auto text-sm"></div>

                    <div id="magic-slots" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 w-full max-w-4xl"></div>
                    
                    <div id="battle-controls" class="mt-4"></div>
                </div>
            </div>

            <!-- ã‚¬ãƒãƒ£ç”»é¢ -->
            <div id="gacha-screen" class="hidden">
                 <div class="flex justify-center mb-4">
                     <button id="magic-gacha-tab" class="tab-button active">é­”æ³•ã‚¬ãƒãƒ£</button>
                     <button id="equipment-gacha-tab" class="tab-button">è£…å‚™ã‚¬ãƒãƒ£</button>
                 </div>
                 <div id="magic-gacha-content">
                    <div class="text-center p-8 glassmorphism rounded-xl">
                        <h3 class="text-2xl font-cinzel mb-4">Summon Magic</h3>
                        <p class="mb-6">é­”æ³•çŸ³ã‚’æ¶ˆè²»ã—ã¦æ–°ãŸãªé­”æ³•ã‚’å¬å–šã—ã¾ã™ã€‚</p>
                        <div class="flex justify-center gap-4">
                            <button data-gacha-type="magic" data-amount="1" class="gacha-button magic-button px-6 py-3">1å›å¬å–š<br/>(çŸ³x10)</button>
                            <button data-gacha-type="magic" data-amount="10" class="gacha-button magic-button px-6 py-3">10å›å¬å–š<br/>(çŸ³x100)</button>
                            <button data-gacha-type="magic" data-amount="50" class="gacha-button magic-button px-6 py-3">50å›å¬å–š<br/>(çŸ³x500)</button>
                        </div>
                    </div>
                 </div>
                 <div id="equipment-gacha-content" class="hidden">
                     <div class="text-center p-8 glassmorphism rounded-xl">
                        <h3 class="text-2xl font-cinzel mb-4">Forge Equipment</h3>
                        <p class="mb-6">é­”æ³•çŸ³ã‚’æ¶ˆè²»ã—ã¦æ–°ãŸãªè£…å‚™ã‚’é›é€ ã—ã¾ã™ã€‚</p>
                        <div class="flex justify-center gap-4">
                            <button data-gacha-type="equipment" data-amount="1" class="gacha-button magic-button px-6 py-3">1å›é›é€ <br/>(çŸ³x10)</button>
                            <button data-gacha-type="equipment" data-amount="10" class="gacha-button magic-button px-6 py-3">10å›é›é€ <br/>(çŸ³x100)</button>
                             <button data-gacha-type="equipment" data-amount="50" class="gacha-button magic-button px-6 py-3">50å›é›é€ <br/>(çŸ³x500)</button>
                        </div>
                    </div>
                 </div>
                 <div id="gacha-rates" class="mt-4 text-center text-sm text-gray-400"></div>
            </div>

            <!-- é­”æ³•ç®¡ç†ç”»é¢ -->
            <div id="magic-screen" class="hidden">
                <h2 class="text-2xl font-cinzel mb-4 text-center">Magic Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-cinzel mb-4 text-center">Equipped Magic</h3>
                        <div id="equipped-magic-list" class="grid grid-cols-2 gap-4"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-cinzel mb-4 text-center">Inventory</h3>
                        <div id="magic-inventory-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 h-[60vh] overflow-y-auto p-2 bg-black bg-opacity-30 rounded-lg"></div>
                    </div>
                </div>
            </div>

            <!-- è£…å‚™ç®¡ç†ç”»é¢ -->
             <div id="equipment-screen" class="hidden">
                <h2 class="text-2xl font-cinzel mb-4 text-center">Equipment Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-cinzel mb-4 text-center">Equipped</h3>
                        <div id="equipped-equipment-list" class="space-y-4"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-cinzel mb-4 text-center">Inventory</h3>
                        <div id="equipment-inventory-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 h-[60vh] overflow-y-auto p-2 bg-black bg-opacity-30 rounded-lg"></div>
                    </div>
                </div>
             </div>
             
            <!-- å›³é‘‘ç”»é¢ -->
            <div id="encyclopedia-screen" class="hidden">
                <div class="flex justify-center mb-4">
                    <button id="magic-encyclopedia-tab" class="tab-button active">é­”æ³•å›³é‘‘</button>
                    <button id="equipment-encyclopedia-tab" class="tab-button">è£…å‚™å›³é‘‘</button>
                </div>
                <div id="magic-encyclopedia-content">
                    <div id="magic-encyclopedia-list" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                </div>
                <div id="equipment-encyclopedia-content" class="hidden">
                    <div id="equipment-encyclopedia-list" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                </div>
            </div>

        </main>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼/ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <footer class="mt-4">
            <button id="back-to-home" class="magic-button px-6 py-2 hidden">Home</button>
        </footer>
    </div>
    
    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
    <div id="modal-container" class="hidden"></div>
    
    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
    <div id="tooltip" class="hidden absolute p-2 text-sm bg-gray-800 text-white rounded-md shadow-lg z-50 pointer-events-none"></div>

<script>
// ã“ã“ã‹ã‚‰ã‚²ãƒ¼ãƒ ã®å…¨ãƒ­ã‚¸ãƒƒã‚¯ãŒå§‹ã¾ã‚Šã¾ã™
document.addEventListener('DOMContentLoaded', () => {

    // å®šæ•°å®šç¾©
    const ELEMENTS = {
        WATER: { name: 'æ°´', icon: 'ğŸ’§' },
        FIRE: { name: 'ç‚', icon: 'ğŸ”¥' },
        GRASS: { name: 'è‰', icon: 'ğŸŒ¿' },
        THUNDER: { name: 'é›·', icon: 'âš¡' },
        WIND: { name: 'é¢¨', icon: 'ğŸ’¨' },
        LIGHT: { name: 'å…‰', icon: 'ğŸŒŸ' },
        VOID: { name: 'è™šç„¡', icon: 'ğŸŒŒ' },
        EARTH: { name: 'åœ°', icon: 'ğŸŒ' },
        TIME: { name: 'æ™‚ç©º', icon: 'â³' },
        NEUTRAL: { name: 'ç„¡', icon: 'ğŸ’«' },
    };

    const RARITIES = {
        NORMAL: { name: 'Normal', color: 'text-white' },
        RARE: { name: 'Rare', color: 'text-blue-300' },
        EPIC: { name: 'Epic', color: 'text-purple-400' },
        LEGENDARY: { name: 'Legendary', color: 'text-yellow-400' },
    };

    const MAGIC_TYPES = {
        ATTACK: 'æ”»æ’ƒ',
        HEAL: 'å›å¾©',
        BUFF: 'å¼·åŒ–',
        DEFENSE: 'é˜²å¾¡',
        DEBUFF: 'å¼±ä½“',
    };
    
    const SINGULARITY_TRAITS = {
        MORE_SLOTS: { name: 'é­”åŠ›éå¤š', description: 'é­”æ³•ã®è£…å‚™ã‚¹ãƒ­ãƒƒãƒˆãŒ2ã¤å¢—åŠ ã™ã‚‹ã€‚' },
        BLOOD_MAGIC: { name: 'ç”Ÿå‘½è»¢æ›', description: 'MPãŒè¶³ã‚Šãªã„æ™‚ã€HPã‚’æ¶ˆè²»ã—ã¦é­”æ³•ã‚’ä½¿ç”¨ã§ãã‚‹ã€‚(æ¶ˆè²»MPã®2å€ã®HPãŒå¿…è¦)' }
    };
    
    // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
    const MAGIC_MASTER = {
        // Normal - åˆæœŸé­”æ³•
        m000: { name: 'ãƒã‚¸ãƒƒã‚¯ã‚¢ãƒ­ãƒ¼', element: 'NEUTRAL', rarity: 'NORMAL', type: 'ATTACK', basePower: 8, baseCost: 4, description: 'é­”åŠ›ã®çŸ¢ã‚’æ”¾ã¤åŸºæœ¬é­”æ³•ã€‚' },
        m009: { name: 'ãƒã‚¸ãƒƒã‚¯ã‚¬ãƒ¼ãƒ‰', element: 'NEUTRAL', rarity: 'NORMAL', type: 'DEFENSE', basePower: 15, baseCost: 8, duration: 3, description: 'é­”åŠ›ã®ç›¾ã§èº«ã‚’å®ˆã‚‹åŸºæœ¬é­”æ³•ã€‚' },
        // Normal
        m001: { name: 'ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ã‚·ãƒ§ãƒƒãƒˆ', element: 'WATER', rarity: 'NORMAL', type: 'ATTACK', basePower: 10, baseCost: 5, description: 'æ°´ã®å¼¾ä¸¸ã‚’ç™ºå°„ã™ã‚‹ã€‚' },
        m002: { name: 'ãƒ•ã‚¡ã‚¤ã‚¢ãƒœãƒ¼ãƒ«', element: 'FIRE', rarity: 'NORMAL', type: 'ATTACK', basePower: 12, baseCost: 6, description: 'å°ã•ãªç«çƒã‚’æ”¾ã¤ã€‚' },
        m003: { name: 'ã‚¦ã‚£ãƒ³ãƒ‰ã‚«ãƒƒã‚¿ãƒ¼', element: 'WIND', rarity: 'NORMAL', type: 'ATTACK', basePower: 8, baseCost: 4, description: 'é¢¨ã®åˆƒã§åˆ‡ã‚Šè£‚ãã€‚' },
        m004: { name: 'ãƒ’ãƒ¼ãƒ«', element: 'GRASS', rarity: 'NORMAL', type: 'HEAL', basePower: 20, baseCost: 10, description: 'HPã‚’å°‘ã—å›å¾©ã™ã‚‹ã€‚' },
        m005: { name: 'ãƒ—ãƒ­ãƒ†ã‚¯ã‚·ãƒ§ãƒ³', element: 'LIGHT', rarity: 'NORMAL', type: 'DEFENSE', basePower: 10, baseCost: 8, duration: 3, description: '3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ã‚·ãƒ¼ãƒ«ãƒ‰ã‚’å¼µã‚‹ã€‚' },
        m006: { name: 'ã‚¹ãƒˆãƒ¼ãƒ³ãƒ–ãƒ©ã‚¹ãƒˆ', element: 'EARTH', rarity: 'NORMAL', type: 'ATTACK', basePower: 15, baseCost: 8, description: 'çŸ³ã®ç¤«ã‚’é£›ã°ã™ã€‚' },
        m007: { name: 'ãƒ•ãƒ©ãƒƒã‚·ãƒ¥', element: 'LIGHT', rarity: 'NORMAL', type: 'DEBUFF', basePower: 0.8, baseCost: 7, duration: 2, description: '2ã‚¿ãƒ¼ãƒ³ã®é–“ã€æ•µã®æ”»æ’ƒåŠ›ã‚’20%æ¸›å°‘ã•ã›ã‚‹ã€‚' },
        m008: { name: 'ãƒ€ãƒ¼ã‚¯ã‚¢ãƒ­ãƒ¼', element: 'VOID', rarity: 'NORMAL', type: 'ATTACK', basePower: 13, baseCost: 7, description: 'é—‡ã®çŸ¢ã‚’æ”¾ã¤ã€‚' },
        
        // Rare
        m101: { name: 'ã‚¢ã‚¯ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ', element: 'WATER', rarity: 'RARE', type: 'ATTACK', basePower: 25, baseCost: 12, description: 'æ¿€ã—ã„æ°´æµã§æ”»æ’ƒã™ã‚‹ã€‚' },
        m102: { name: 'ãƒ•ãƒ¬ã‚¤ãƒ ãƒ©ãƒ³ã‚¹', element: 'FIRE', rarity: 'RARE', type: 'ATTACK', basePower: 30, baseCost: 15, description: 'ç‚ã®æ§ã‚’çªãåˆºã™ã€‚' },
        m103: { name: 'ã‚µãƒ³ãƒ€ãƒ¼ãƒœãƒ«ãƒˆ', element: 'THUNDER', rarity: 'RARE', type: 'ATTACK', basePower: 28, baseCost: 14, description: 'é›·ã‚’è½ã¨ã™ã€‚' },
        m104: { name: 'ãƒªã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', element: 'GRASS', rarity: 'RARE', type: 'HEAL', basePower: 15, baseCost: 20, duration: 3, description: '3ã‚¿ãƒ¼ãƒ³ã®é–“ã€HPãŒå¾ã€…ã«å›å¾©ã™ã‚‹ã€‚' },
        m105: { name: 'ãƒ˜ã‚¤ã‚¹ãƒˆ', element: 'WIND', rarity: 'RARE', type: 'BUFF', basePower: 1.2, baseCost: 18, duration: 3, description: '3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ20%å¢—åŠ ã™ã‚‹ã€‚' },
        m106: { name: 'ã‚¢ã‚¯ã‚¢ãƒãƒªã‚¢', element: 'WATER', rarity: 'RARE', type: 'DEFENSE', basePower: 30, baseCost: 15, duration: 3, description: 'æ°´ã®éšœå£ã§èº«ã‚’å®ˆã‚‹ã€‚' },
        m107: { name: 'ãƒã‚¤ã‚ºãƒ³ãƒŸã‚¹ãƒˆ', element: 'GRASS', rarity: 'RARE', type: 'ATTACK', basePower: 10, baseCost: 18, duration: 3, isDot: true, description: '3ã‚¿ãƒ¼ãƒ³ã®é–“ã€æ•µã‚’æ¯’çŠ¶æ…‹ã«ã—ã€ç¶™ç¶šãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚' },
        m108: { name: 'ã‚¢ãƒ¼ã‚¹ã‚¦ã‚©ãƒ¼ãƒ«', element: 'EARTH', rarity: 'RARE', type: 'DEFENSE', basePower: 40, baseCost: 18, duration: 2, description: '2ã‚¿ãƒ¼ãƒ³ã®é–“ã€å¼·å›ºãªåœŸã®å£ã§èº«ã‚’å®ˆã‚‹ã€‚' },
        m109: { name: 'ãƒ›ãƒ¼ãƒªãƒ¼ãƒ©ã‚¤ãƒˆ', element: 'LIGHT', rarity: 'RARE', type: 'HEAL', basePower: 50, baseCost: 25, description: 'è–ãªã‚‹å…‰ã§HPã‚’ä¸­ç¨‹åº¦å›å¾©ã™ã‚‹ã€‚' },
        m110: { name: 'ã‚«ã‚ªã‚¹ãƒœãƒ«ãƒˆ', element: 'VOID', rarity: 'RARE', type: 'ATTACK', basePower: 35, baseCost: 18, description: 'æ··æ²Œã®åŠ›ã§äºˆæ¸¬ä¸èƒ½ãªãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚' },

        // Epic
        m201: { name: 'ãƒ¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ­ãƒ ', element: 'WATER', rarity: 'EPIC', type: 'ATTACK', basePower: 60, baseCost: 30, isAoe: true, description: 'å·¨å¤§ãªæ¸¦æ½®ã‚’ç™ºç”Ÿã•ã›ã€æ•µå…¨ä½“ã‚’æ”»æ’ƒã™ã‚‹ã€‚' },
        m202: { name: 'ã‚¤ãƒ³ãƒ•ã‚§ãƒ«ãƒ', element: 'FIRE', rarity: 'EPIC', type: 'ATTACK', basePower: 75, baseCost: 35, description: 'æ¥­ç«ã§æ•µã‚’ç„¼ãå°½ãã™ã€‚' },
        m203: { name: 'ã‚½ãƒ¼ãƒ©ãƒ¼ãƒ“ãƒ¼ãƒ ', element: 'GRASS', rarity: 'EPIC', type: 'ATTACK', basePower: 85, baseCost: 40, description: 'å¤ªé™½ã®å…‰ã‚’åæŸã•ã›ã¦æ”¾ã¤ã€‚' },
        m204: { name: 'ã‚°ãƒ¬ãƒ¼ãƒˆãƒ’ãƒ¼ãƒ«', element: 'GRASS', rarity: 'EPIC', type: 'HEAL', basePower: 100, baseCost: 45, description: 'HPã‚’å¤§å¹…ã«å›å¾©ã™ã‚‹ã€‚' },
        m205: { name: 'ã‚®ã‚¬ã‚¹ãƒ‘ãƒ¼ã‚¯', element: 'THUNDER', rarity: 'EPIC', type: 'ATTACK', basePower: 80, baseCost: 38, description: 'å¼·åŠ›ãªé›»æ’ƒã‚’åºƒç¯„å›²ã«æ”¾ã¤ã€‚' },
        m206: { name: 'ç”Ÿå‘½ã®æµã¿', element: 'GRASS', rarity: 'EPIC', type: 'HEAL', basePower: 60, baseCost: 50, duration: 5, description: '5ã‚¿ãƒ¼ãƒ³ã®é–“ã€HPãŒå¤§ããå›å¾©ã—ç¶šã‘ã‚‹ã€‚' },
        m207: { name: 'ãƒˆãƒ«ãƒãƒ¼ãƒ‰', element: 'WIND', rarity: 'EPIC', type: 'ATTACK', basePower: 90, baseCost: 48, isAoe: true, description: 'å·¨å¤§ãªç«œå·»ã§æ•µå…¨ä½“ã‚’æ”»æ’ƒã™ã‚‹ã€‚' },
        m208: { name: 'ãƒ‰ãƒ¬ã‚¤ãƒ³ã‚½ã‚¦ãƒ«', element: 'VOID', rarity: 'EPIC', type: 'ATTACK', basePower: 65, baseCost: 40, drain: 0.3, description: 'æ•µã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã€ãã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã®30%ã‚’å¸åã—ã¦HPã‚’å›å¾©ã™ã‚‹ã€‚' },
        m209: { name: 'ãƒ—ãƒ©ã‚ºãƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰', element: 'THUNDER', rarity: 'EPIC', type: 'ATTACK', basePower: 25, baseCost: 38, duration: 3, isDot: true, isAoe: true, description: '3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ãƒ—ãƒ©ã‚ºãƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æ•µå…¨ä½“ã«ç¶™ç¶šãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚' },
        m210: { name: 'ã‚¢ãƒ¼ã‚¹ã‚¯ã‚¨ã‚¤ã‚¯', element: 'EARTH', rarity: 'EPIC', type: 'ATTACK', basePower: 100, baseCost: 55, isAoe: true, description: 'å¤§åœ°éœ‡ã§æ•µå…¨ä½“ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚' },
        m211: { name: 'ã‚¨ãƒ³ã‚¸ã‚§ãƒ«ãƒ–ãƒ¬ã‚¹', element: 'LIGHT', rarity: 'EPIC', type: 'BUFF', basePower: 1.3, baseCost: 40, duration: 3, description: '3ã‚¿ãƒ¼ãƒ³ã®é–“ã€æ”»æ’ƒåŠ›ã‚’30%å¢—åŠ ã•ã›ã‚‹ã€‚' },
        m212: { name: 'ãƒ´ã‚©ã‚¤ãƒ‰ãƒ†ãƒ³ã‚¿ã‚¯ãƒ«', element: 'VOID', rarity: 'EPIC', type: 'ATTACK', basePower: 70, baseCost: 42, duration: 2, description: 'è™šç„¡ã®è§¦æ‰‹ã§æ”»æ’ƒã—ã€2ã‚¿ãƒ¼ãƒ³ã®é–“ã€æ•µã®è¡Œå‹•ã‚’å°ã˜ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚' },
        m213: { name: 'ãƒ–ãƒªã‚¶ãƒ¼ãƒ‰', element: 'WATER', rarity: 'EPIC', type: 'ATTACK', basePower: 80, baseCost: 50, isAoe: true, description: 'æ¿€ã—ã„å¹é›ªã§æ•µå…¨ä½“ã‚’å‡ã¦ã¤ã‹ã›ã‚‹ã€‚' },
        m214: { name: 'ãƒ•ãƒ¬ã‚¢', element: 'FIRE', rarity: 'EPIC', type: 'ATTACK', basePower: 120, baseCost: 60, description: 'çˆ†ç™ºçš„ãªç‚ã§å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚' },

        // Legendary
        m301: { name: 'ã‚¸ãƒ£ãƒƒã‚¸ãƒ¡ãƒ³ãƒˆ', element: 'LIGHT', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 250, baseCost: 80, isAoe: true, description: 'è–ãªã‚‹å…‰ã§æ•µå…¨ä½“ã«è£ãã‚’ä¸‹ã™ã€‚' },
        m302: { name: 'ãƒ¡ãƒ†ã‚ªã‚¹ãƒˆãƒ©ã‚¤ã‚¯', element: 'FIRE', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 350, baseCost: 100, isAoe: true, description: 'å·¨å¤§ãªéš•çŸ³ã‚’è½ä¸‹ã•ã›ã€æ•µå…¨ä½“ã‚’æ”»æ’ƒã™ã‚‹ã€‚'},
        m303: { name: 'ã‚¢ãƒ“ã‚¹ã‚²ãƒ¼ãƒˆ', element: 'VOID', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 300, baseCost: 90, description: 'æ·±æ·µã¸ã®é–€ã‚’é–‹ãã€æ•µã‚’å¼•ããšã‚Šè¾¼ã‚€ã€‚' },
        m304: { name: 'è–åŸŸ', element: 'LIGHT', rarity: 'LEGENDARY', type: 'DEFENSE', basePower: 250, baseCost: 70, duration: 5, description: '5ã‚¿ãƒ¼ãƒ³ã®é–“ã€å¼·å›ºãªè–åŸŸã‚’å±•é–‹ã—ã€ã•ã‚‰ã«HPãŒå°‘ã—ãšã¤å›å¾©ã™ã‚‹ã€‚' },
        m305: { name: 'ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ³ãƒ‰', element: 'VOID', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 600, baseCost: 250, isAoe: true, description: 'ä¸–ç•Œã®çµ‚ã‚ã‚Šã‚’å‘Šã’ã‚‹è™šç„¡ã®æ³¢å‹•ã‚’æ•µå…¨ä½“ã«æ”¾ã¤ã€‚' },
        m306: { name: 'å‰µç”Ÿã®å…‰', element: 'LIGHT', rarity: 'LEGENDARY', type: 'HEAL', basePower: 200, baseCost: 120, duration: 3, description: 'HPã‚’å®Œå…¨ã«å›å¾©ã—ã€3ã‚¿ãƒ¼ãƒ³ã®é–“å¼·åŠ›ãªãƒªã‚¸ã‚§ãƒåŠ¹æœã‚’ä»˜ä¸ã™ã‚‹ã€‚' },
        m307: { name: 'ã‚¨ãƒ¬ãƒ¡ãƒ³ã‚¿ãƒ«ãƒãƒ¼ã‚¹ãƒˆ', element: 'VOID', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 400, baseCost: 120, isAoe: true, description: 'å…¨å±æ€§ã®åŠ›ã‚’å‡ç¸®ã—ã¦æ•µå…¨ä½“ã«æ”¾ã¤ã€‚' },
        m308: { name: 'ã‚¬ã‚¤ã‚¢ã‚ºãƒ©ãƒ¼ã‚¹', element: 'EARTH', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 450, baseCost: 150, isAoe: true, description: 'å¤§åœ°ã®æ€’ã‚Šã‚’å‘¼ã³èµ·ã“ã—ã€æ•µå…¨ä½“ã‚’ç²‰ç •ã™ã‚‹ã€‚' },
        m309: { name: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ´ã‚¡', element: 'FIRE', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 500, baseCost: 180, isAoe: true, description: 'è¶…æ–°æ˜Ÿçˆ†ç™ºã‚’æ•µå…¨ä½“ã«å¼•ãèµ·ã“ã™ç©¶æ¥µã®ç‚é­”æ³•ã€‚' },
        m310: { name: 'æ™‚ç©ºã®è£‚ã‘ç›®', element: 'VOID', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 300, baseCost: 110, duration: 3, isDot: true, description: 'æ™‚ç©ºã‚’æ­ªã‚ã€3ã‚¿ãƒ¼ãƒ³ã®é–“ã€æ•µã«ç¶™ç¶šçš„ãªæ¬¡å…ƒãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚' },
        m311: { name: 'ã‚¼ã‚¦ã‚¹ã®å¯©åˆ¤', element: 'THUNDER', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 480, baseCost: 160, isAoe: true, description: 'å¤©ã‹ã‚‰ç¥ã®é›·ã‚’å¬å–šã—ã€æ•µå…¨ä½“ã‚’ç„¼ãæ‰•ã†ã€‚' },
        m312: { name: 'ã‚¢ãƒ«ã‚±ã‚¤ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–', element: 'VOID', rarity: 'LEGENDARY', type: 'BUFF', basePower: 2.0, baseCost: 150, duration: 3, description: '3ã‚¿ãƒ¼ãƒ³ã®é–“ã€é­”æ³•å¨åŠ›ã‚’100%å¢—åŠ ã•ã›ã‚‹ã€‚' },
        m313: { name: 'ã‚¢ãƒã‚«ãƒªãƒ—ã‚¹', element: 'VOID', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 200, baseCost: 150, duration: 3, isDot: true, isAoe: true, description: 'çµ‚æœ«ã®åˆ»å°ã‚’æ•µå…¨ä½“ã«åˆ»ã¿ã€3ã‚¿ãƒ¼ãƒ³ã®é–“ã€ç”šå¤§ãªç¶™ç¶šãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚'},

        // Boss Unique
        b001: { name: 'ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒƒãƒ—', element: 'TIME', rarity: 'LEGENDARY', type: 'DEBUFF', basePower: 0, baseCost: 100, duration: 1, description: 'æ™‚é–“ã‚’åœæ­¢ã•ã›ã€1ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã«ã™ã‚‹ã€‚'},
        b002: { name: 'ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒŠãƒ«ãƒªãƒ•ãƒˆ', element: 'TIME', rarity: 'LEGENDARY', type: 'ATTACK', basePower: 500, baseCost: 200, isAoe: true, description: 'ç•°æ¬¡å…ƒã®è£‚ã‘ç›®ã‹ã‚‰è«å¤§ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æ”¾ã¤ã€‚'},
    };

    const EQUIPMENT_MASTER = {
        // Normal
        e001: { name: 'é­”åŠ›ã®æŒ‡è¼ª', rarity: 'NORMAL', type: 'MP', value: 0.05, description: 'æœ€å¤§MPãŒ5%å¢—åŠ ã™ã‚‹ã€‚' },
        e002: { name: 'è¦‹ç¿’ã„ã®æ–', rarity: 'NORMAL', type: 'POWER', value: 0.05, description: 'é­”æ³•å¨åŠ›ãŒ5%å¢—åŠ ã™ã‚‹ã€‚' },

        // Rare
        e101: { name: 'è³¢è€…ã®æŒ‡è¼ª', rarity: 'RARE', type: 'MP', value: 0.1, description: 'æœ€å¤§MPãŒ10%å¢—åŠ ã™ã‚‹ã€‚' },
        e102: { name: 'é­”è¡“å¸«ã®æ–', rarity: 'RARE', type: 'POWER', value: 0.1, description: 'é­”æ³•å¨åŠ›ãŒ10%å¢—åŠ ã™ã‚‹ã€‚' },
        e103: { name: 'å®ˆã‚Šã®ã‚¢ãƒŸãƒ¥ãƒ¬ãƒƒãƒˆ', rarity: 'RARE', type: 'HP', value: 0.1, description: 'æœ€å¤§HPãŒ10%å¢—åŠ ã™ã‚‹ã€‚' },
        e104: { name: 'é€Ÿè© ã®ãƒãƒ£ãƒ¼ãƒ ', rarity: 'RARE', type: 'COST_REDUCTION', value: 0.1, description: 'é­”æ³•ã®æ¶ˆè²»MPãŒ10%æ¸›å°‘ã™ã‚‹ã€‚' },
        e105: { name: 'ç²¾éœŠã®ã‚¢ãƒŸãƒ¥ãƒ¬ãƒƒãƒˆ', rarity: 'RARE', type: 'MP', value: 0.12, description: 'æœ€å¤§MPãŒ12%å¢—åŠ ã™ã‚‹ã€‚' },
        
        // Epic
        e201: { name: 'å¤§è³¢è€…ã®æŒ‡è¼ª', rarity: 'EPIC', type: 'MP', value: 0.2, description: 'æœ€å¤§MPãŒ20%å¢—åŠ ã™ã‚‹ã€‚' },
        e202: { name: 'å¤§é­”è¡“å¸«ã®æ–', rarity: 'EPIC', type: 'POWER', value: 0.2, description: 'é­”æ³•å¨åŠ›ãŒ20%å¢—åŠ ã™ã‚‹ã€‚' },
        e203: { name: 'ç²¾éœŠã®è…•è¼ª', rarity: 'EPIC', type: 'MP_REGEN', value: 0.05, description: 'æˆ¦é—˜ä¸­ã€ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«æœ€å¤§MPã®5%ã‚’å›å¾©ã™ã‚‹ã€‚' },
        e204: { name: 'å¸è¡€ã®å®ç ', rarity: 'EPIC', type: 'DRAIN', value: 0.1, description: 'ä¸ãˆãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã®10%åˆ†HPã‚’å¸åã™ã‚‹ã€‚' },
        e205: { name: 'ç«œé±—ã®ç›¾', rarity: 'EPIC', type: 'HP', value: 0.25, description: 'æœ€å¤§HPãŒ25%å¢—åŠ ã™ã‚‹ã€‚' },

        // Legendary
        e301: { name: 'ä¸–ç•Œæ¨¹ã®æŒ‡è¼ª', rarity: 'LEGENDARY', type: 'MP', value: 0.5, description: 'æœ€å¤§MPãŒ50%å¢—åŠ ã™ã‚‹ã€‚' },
        e302: { name: 'æ ¹æºã®æ–', rarity: 'LEGENDARY', type: 'POWER', value: 0.5, description: 'é­”æ³•å¨åŠ›ãŒ50%å¢—åŠ ã™ã‚‹ã€‚' },
        e303: { name: 'è³¢è€…ã®çŸ³', rarity: 'LEGENDARY', type: 'ALL', value: 0.15, description: 'æœ€å¤§HPã€æœ€å¤§MPã€é­”æ³•å¨åŠ›ãŒ15%å¢—åŠ ã™ã‚‹ã€‚'},
        e304: { name: 'ç”Ÿå‘½ã®ã‚ªãƒ¼ãƒ–', rarity: 'LEGENDARY', type: 'HP_REGEN', value: 0.1, description: 'æˆ¦é—˜ä¸­ã€ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«æœ€å¤§HPã®10%ã‚’å›å¾©ã™ã‚‹ã€‚' },
        e305: { name: 'ã‚¯ãƒ­ãƒãƒãƒ³ã‚µãƒ¼ã®ãƒšãƒ³ãƒ€ãƒ³ãƒˆ', rarity: 'LEGENDARY', type: 'COST_REDUCTION', value: 0.25, description: 'é­”æ³•ã®æ¶ˆè²»MPãŒ25%æ¸›å°‘ã—ã€ãƒ‡ãƒãƒ•åŠ¹æœã‚’çŸ­ç¸®ã™ã‚‹ã€‚' },
        e306: { name: 'æ”¯é…ã®ç‹éŒ«', rarity: 'LEGENDARY', type: 'POWER', value: 0.60, description: 'é­”æ³•å¨åŠ›ãŒ60%å¢—åŠ ã™ã‚‹ã€‚' },
    };
    
    const ENEMY_MASTER = {
        en001: { name: 'ã‚¹ãƒ©ã‚¤ãƒ ', icon: 'ğŸ’§', rarity: 'NORMAL', baseHp: 50, baseMp: 10, magics: ['m001'] },
        en002: { name: 'ã‚´ãƒ–ãƒªãƒ³', icon: 'ğŸ‘º', rarity: 'NORMAL', baseHp: 80, baseMp: 20, magics: ['m006'] },
        en101: { name: 'ã‚ªãƒ¼ã‚¯', icon: 'ğŸ‘¹', rarity: 'RARE', baseHp: 200, baseMp: 50, magics: ['m102', 'm005'] },
        en102: { name: 'ã‚µãƒ³ãƒ€ãƒ¼ãƒãƒ¼ãƒ‰', icon: 'ğŸ¦…', rarity: 'RARE', baseHp: 150, baseMp: 80, magics: ['m103', 'm105'] },
        en103: { name: 'ã‚°ãƒªãƒ•ã‚£ãƒ³', icon: 'ğŸ¦', rarity: 'RARE', baseHp: 180, baseMp: 60, magics: ['m003', 'm105'] },
        en201: { name: 'ã‚´ãƒ¼ãƒ¬ãƒ ', icon: 'ğŸ—¿', rarity: 'EPIC', baseHp: 500, baseMp: 100, magics: ['m210', 'm108'] },
        en202: { name: 'ã‚­ãƒã‚¤ãƒ©', icon: 'ğŸ¦„', rarity: 'EPIC', baseHp: 400, baseMp: 200, magics: ['m202', 'm107', 'm104'] },
        en203: { name: 'ãƒ’ãƒ¥ãƒ‰ãƒ©', icon: 'ğŸ', rarity: 'EPIC', baseHp: 600, baseMp: 150, magics: ['m201', 'm104'] },
        en204: { name: 'ãƒªãƒƒãƒ', icon: 'ğŸ’€', rarity: 'EPIC', baseHp: 600, baseMp: 300, magics: ['m208', 'm212', 'm110'] },
        en205: { name: 'ã‚µã‚¤ã‚¯ãƒ­ãƒ—ã‚¹', icon: 'ğŸ‘ï¸â€ğŸ—¨ï¸', rarity: 'EPIC', baseHp: 800, baseMp: 80, magics: ['m210'] },
        en301: { name: 'ãƒ‰ãƒ©ã‚´ãƒ³', icon: 'ğŸ‰', rarity: 'LEGENDARY', baseHp: 2000, baseMp: 500, magics: ['m202', 'm302'] },
        en302: { name: 'è™šç„¡ã®ç›£è¦–è€…', icon: 'ğŸ‘ï¸', rarity: 'LEGENDARY', baseHp: 5000, baseMp: 1000, magics: ['m303', 'm305', 'm304'] },
        en303: { name: 'ãƒ™ãƒ’ãƒ¼ãƒ¢ã‚¹', icon: 'ğŸ—', rarity: 'LEGENDARY', baseHp: 3000, baseMp: 300, magics: ['m308', 'm108'] },
        boss001: { name: 'ã‚¯ãƒ­ãƒã‚¹', icon: 'â³', rarity: 'LEGENDARY', baseHp: 75000, baseMp: 15000, magics: ['b001', 'b002', 'm310'], isBoss: true },
        boss002: { name: 'ãƒ‹ãƒ£ãƒ«ãƒ©ãƒˆãƒ›ãƒ†ãƒ—', icon: 'ğŸ™', rarity: 'LEGENDARY', baseHp: 100000, baseMp: 20000, magics: ['m303', 'm305', 'm212'], isBoss: true },
        boss003: { name: 'ãƒ†ãƒ©ãƒ»ã‚¿ã‚¤ã‚¿ãƒ³', icon: 'ğŸŒ³', rarity: 'LEGENDARY', baseHp: 150000, baseMp: 10000, magics: ['m308', 'm210', 'm108'], isBoss: true },
        boss004: { name: 'ãƒ¨ã‚°ï¼ã‚½ãƒˆãƒ¼ã‚¹', icon: 'âœ¨', rarity: 'LEGENDARY', baseHp: 250000, baseMp: 50000, magics: ['m307', 'm313', 'b002'], isBoss: true },
    };
    
    const DUNGEON_MASTER = [
        { name: 'å§‹ã¾ã‚Šã®æ£®', levelRange: [1, 5], enemies: ['en001', 'en002'], boss: 'en101' },
        { name: 'æ¹¿åœ°ã®æ´çªŸ', levelRange: [6, 10], enemies: ['en001', 'en002'], boss: 'en101' },
        { name: 'é›·é³´ã®å¹³åŸ', levelRange: [11, 20], enemies: ['en002', 'en102', 'en103'], boss: 'en102' },
        { name: 'å¿˜ã‚Œã‚‰ã‚ŒãŸç¥æ®¿', levelRange: [21, 30], enemies: ['en101', 'en102'], boss: 'en201' },
        { name: 'å¤ä»£éºè·¡', levelRange: [31, 45], enemies: ['en101', 'en201', 'en202'], boss: 'en202' },
        { name: 'ç¼ç†±ã®ç«å±±', levelRange: [46, 60], enemies: ['en201', 'en203'], boss: 'en301' },
        { name: 'ç«œã®å·£', levelRange: [61, 80], enemies: ['en202', 'en301'], boss: 'en301' },
        { name: 'æ·±æ·µã®é–€', levelRange: [81, 100], enemies: ['en301', 'en302'], boss: 'en302' },
        { name: 'æœˆå…‰ã®æ£®', levelRange: [101, 120], enemies: ['en202', 'en104'], boss: 'en204' },
        { name: 'å·¨äººã®å±±è„ˆ', levelRange: [121, 140], enemies: ['en201', 'en205'], boss: 'en303' },
        { name: 'çµ‚ç„‰ã®åœ°', levelRange: [141, 160], enemies: ['en301', 'en302', 'en303'], boss: 'boss002' },
    ];
    
    const TEACHER_MASTER = {
        t001: { name: 'ãƒ«ãƒŠå…ˆç”Ÿ (åˆç´š)', icon: 'ğŸ‘©â€ğŸ«', level: 10, baseHp: 500, baseMp: 200, magics: ['m001', 'm002', 'm004'], reward: { type: 'magic', id: 'm107' }, description: 'æ¯’é­”æ³•ã®åŸºç¤ã‚’æ•™ãˆã¦ãã‚Œã‚‹ã€‚' },
        t002: { name: 'ã‚°ãƒ¬ã‚¤å…ˆç”Ÿ (ä¸­ç´š)', icon: 'ğŸ§‘â€ğŸ«', level: 30, baseHp: 2500, baseMp: 800, magics: ['m101', 'm103', 'm106'], reward: { type: 'equipment', id: 'e203' }, description: 'MPç®¡ç†ã®æ¥µæ„ã‚’æ•™ãˆã¦ãã‚Œã‚‹ã€‚' },
        t003: { name: 'ã‚½ãƒ•ã‚£ã‚¢å…ˆç”Ÿ (ä¸Šç´š)', icon: 'ğŸ§™â€â™€ï¸', level: 50, baseHp: 8000, baseMp: 2000, magics: ['m201', 'm202', 'm205'], reward: { type: 'magic', id: 'm208' }, description: 'æ”»é˜²ä¸€ä½“ã®æˆ¦é—˜è¡“ã‚’æ•™ãˆã¦ãã‚Œã‚‹ã€‚' },
        t004: { name: 'æ ¡é•· (ä¼èª¬)', icon: 'ğŸ§™â€â™‚ï¸', level: 80, baseHp: 20000, baseMp: 5000, magics: ['m301', 'm304', 'm302'], reward: { type: 'equipment', id: 'e303' }, description: 'å…¨ã¦ã®é­”æ³•ã®æ ¹æºã«è§¦ã‚Œã‚‹è©¦ç·´ã€‚' },
        t005: { name: 'ã‚¢ãƒ¼ã‚¯ãƒ¡ã‚¤ã‚¸ (å¤§è³¢è€…)', icon: 'ğŸ“œ', level: 100, baseHp: 35000, baseMp: 8000, magics: ['m307', 'm309', 'm211'], reward: { type: 'magic', id: 'm312' }, description: 'ç©¶æ¥µã®æ”»æ’ƒé­”æ³•ã‚’æˆã‘ã‚‹è©¦ç·´ã€‚' },
        t006: { name: 'ã‚¨ãƒ¬ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ­ãƒ¼ãƒ‰ (ç²¾éœŠç‹)', icon: 'ğŸ‘‘', level: 120, baseHp: 50000, baseMp: 10000, magics: ['m308', 'm311', 'm306'], reward: { type: 'equipment', id: 'e305' }, description: 'ä¸–ç•Œã®ç†ã‚’è­˜ã‚‹è€…ã¸ã®æœ€çµ‚è©¦ç·´ã€‚' },
    };

    // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
    let gameData;

    const defaultGameData = {
        player: {
            level: 1,
            exp: 0,
            hp: 100,
            mp: 50,
            potentialLevel: 0,
            singularityTrait: null,
            gachaStones: 400,
            materials: 0,
            tomesOfSecrets: 0,
            equippedMagic: [null, null, null, null], // masterIds
            equippedEquipment: [null, null], // masterIds, 0: weapon, 1: accessory
            permanentMpBonus: 0,
        },
        magicInventory: [], // {masterId: 'm001', level: 0, awakening: 0}
        equipmentInventory: [], // {masterId: 'e001', awakening: 0}
        unlockedDungeon: 0,
        infiniteTower: {
            highestFloor: 0,
            lastChallenge: null,
        },
        defeatedTeachers: [], // teacherIds
        lastRiftChallenge: null, // Date string
    };
    
    // æˆ¦é—˜çŠ¶æ…‹
    let battleState = {};

    // DOMè¦ç´ 
    const dom = {
        titleScreen: document.getElementById('title-screen'),
        gameContainer: document.getElementById('game-container'),
        startGameButton: document.getElementById('start-game-button'),
        resetGameButton: document.getElementById('reset-game-button'),
        mainContent: document.getElementById('main-content'),
        backToHomeButton: document.getElementById('back-to-home'),
        headerTitle: document.querySelector('#game-container h1'),
        modalContainer: document.getElementById('modal-container'),
        tooltip: document.getElementById('tooltip'),
        importSaveInput: document.getElementById('import-save'),
        exportSaveButton: document.getElementById('export-save-button'),
    };

    // åˆæœŸåŒ–
    function init() {
        loadGame();
        
        dom.startGameButton.addEventListener('click', startGame);
        dom.resetGameButton.addEventListener('click', confirmResetGame);
        dom.backToHomeButton.addEventListener('click', () => showScreen('home-screen'));
        dom.importSaveInput.addEventListener('change', importData);
        dom.exportSaveButton.addEventListener('click', exportData);
        
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const screen = e.currentTarget.dataset.screen;
                if (screen) showScreen(screen);
            });
        });

        // ã‚¬ãƒãƒ£ã‚¿ãƒ–
        document.getElementById('magic-gacha-tab').addEventListener('click', () => switchGachaTab('magic'));
        document.getElementById('equipment-gacha-tab').addEventListener('click', () => switchGachaTab('equipment'));

        // å›³é‘‘ã‚¿ãƒ–
        document.getElementById('magic-encyclopedia-tab').addEventListener('click', () => switchEncyclopediaTab('magic'));
        document.getElementById('equipment-encyclopedia-tab').addEventListener('click', () => switchEncyclopediaTab('equipment'));
        
        // ç„¡é™ã®å¡”
        document.getElementById('start-tower-button').addEventListener('click', () => startInfiniteTowerBattle(1));

        // ã‚¬ãƒãƒ£ãƒœã‚¿ãƒ³
        document.querySelectorAll('.gacha-button').forEach(btn => {
            btn.addEventListener('click', handleGacha);
        });
        
        // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–
        setInterval(saveGame, 30000); // 30ç§’ã”ã¨ã«ä¿å­˜
    }
    
    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame() {
        dom.titleScreen.classList.add('hidden');
        dom.gameContainer.classList.remove('hidden');
        showScreen('home-screen');
    }

    // ã‚»ãƒ¼ãƒ–ï¼†ãƒ­ãƒ¼ãƒ‰
    function saveGame() {
        localStorage.setItem('arcaneEchoesSave', JSON.stringify(gameData));
        console.log("Game saved automatically.");
    }

    function loadGame() {
        const savedData = localStorage.getItem('arcaneEchoesSave');
        if (savedData) {
            gameData = JSON.parse(savedData);
            // ä¸‹ä½äº’æ›æ€§ã®ãŸã‚ã€æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒãªã„å ´åˆã¯è¿½åŠ 
             if (!gameData.player.tomesOfSecrets) gameData.player.tomesOfSecrets = 0;
            if (!gameData.infiniteTower) gameData.infiniteTower = { highestFloor: 0, lastChallenge: null };
            if (!gameData.infiniteTower.lastChallenge) gameData.infiniteTower.lastChallenge = null;
            if (gameData.player.singularityTrait === undefined) gameData.player.singularityTrait = null;
            if (!gameData.player.permanentMpBonus) gameData.player.permanentMpBonus = 0;
            if (!gameData.defeatedTeachers) gameData.defeatedTeachers = [];
            if (!gameData.lastRiftChallenge) gameData.lastRiftChallenge = null;
            if (!gameData.player.potentialLevel) {
                // è¤‡æ•°å›ä¹±æ•°ã‚’ç”Ÿæˆã—ã€æœ€å°å€¤ã‚’å–ã‚‹ã“ã¨ã§é«˜ã„å€¤ãŒå‡ºã«ãããªã‚‹ã‚ˆã†ã«ã™ã‚‹
                const p1 = Math.pow(Math.random(), 2) * 200;
                const p2 = Math.random() * 200;
                gameData.player.potentialLevel = Math.floor(Math.min(p1, p2)) + 1;
            }
        } else {
            gameData = JSON.parse(JSON.stringify(defaultGameData));
            // è¤‡æ•°å›ä¹±æ•°ã‚’ç”Ÿæˆã—ã€æœ€å°å€¤ã‚’å–ã‚‹ã“ã¨ã§é«˜ã„å€¤ãŒå‡ºã«ãããªã‚‹ã‚ˆã†ã«ã™ã‚‹
            const p1 = Math.pow(Math.random(), 2) * 200; // Skew even more
            const p2 = Math.random() * 200;
            gameData.player.potentialLevel = Math.floor(Math.min(p1, p2)) + 1;

            // Singularity Trait
            let magicSlots = 4;
            if (Math.random() < 0.01) { // 1% chance
                const traits = Object.keys(SINGULARITY_TRAITS);
                const chosenTrait = traits[Math.floor(Math.random() * traits.length)];
                gameData.player.singularityTrait = chosenTrait;
                if (chosenTrait === 'MORE_SLOTS') {
                    magicSlots = 6;
                }
            }
            gameData.player.equippedMagic = Array(magicSlots).fill(null);

            // åˆæœŸã‚¢ã‚¤ãƒ†ãƒ 
            addMagicToInventory('m000');
            addMagicToInventory('m009');
            addMagicToInventory('m001');
            addMagicToInventory('m004');
            addEquipmentToInventory('e001');
            const initialEquipped = ['m000', 'm001', 'm004', 'm009'];
            for(let i=0; i<initialEquipped.length && i<gameData.player.equippedMagic.length; i++) {
                gameData.player.equippedMagic[i] = initialEquipped[i];
            }
            gameData.player.equippedEquipment = [null, 'e001'];
            saveGame();
        }
    }
    
    function exportData() {
        const dataStr = JSON.stringify(gameData);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'arcane_echoes_save.json';
        a.click();
        URL.revokeObjectURL(url);
        showModal('ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', 'ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸã€‚');
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                // ç°¡å˜ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (importedData.player && importedData.magicInventory) {
                    gameData = importedData;
                    saveGame();
                    showModal('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«æˆåŠŸã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚', () => {
                       location.reload();
                    });
                } else {
                    throw new Error('Invalid save file format.');
                }
            } catch (error) {
                showModal('ã‚¨ãƒ©ãƒ¼', 'ã‚»ãƒ¼ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                console.error(error);
            }
        };
        reader.readAsText(file);
    }
    
    function confirmResetGame() {
        showModal(
            'ç¢ºèª', 
            'æœ¬å½“ã«ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚',
            () => {
                localStorage.removeItem('arcaneEchoesSave');
                location.reload();
            },
            true
        );
    }


    // ç”»é¢é·ç§»
    function showScreen(screenId) {
        dom.mainContent.querySelectorAll(':scope > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(screenId).classList.remove('hidden');
        
        dom.backToHomeButton.classList.toggle('hidden', screenId === 'home-screen' || screenId === 'battle-screen');
        dom.headerTitle.textContent = screenId.replace('-screen', '').replace(/([A-Z])/g, ' $1').replace(/^\w/, c => c.toUpperCase());


        // å„ç”»é¢ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        switch (screenId) {
            case 'home-screen':
                updatePlayerStatsUI();
                break;
            case 'dungeon-screen':
                renderDungeonList();
                break;
            case 'rift-challenge-screen':
                renderRiftChallengeScreen();
                break;
            case 'magic-school-screen':
                renderMagicSchoolScreen();
                break;
            case 'gacha-screen':
                updatePlayerStatsUI();
                switchGachaTab('magic'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
                break;
            case 'magic-screen':
                renderMagicScreen();
                break;
            case 'equipment-screen':
                renderEquipmentScreen();
                break;
            case 'encyclopedia-screen':
                renderEncyclopediaScreen();
                break;
            case 'infinite-tower-screen':
                renderInfiniteTowerScreen();
                break;
        }
    }

    // UIæ›´æ–°
    function updatePlayerStatsUI() {
        const player = gameData.player;
        const maxExp = getNextLevelExp(player.level);
        const maxMp = calculateMaxMp();
        
        document.getElementById('player-level').textContent = `Lv. ${player.level}`;
        document.getElementById('player-potential').textContent = `ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«: ${player.potentialLevel}`;
        document.getElementById('player-exp-bar').style.width = `${(player.exp / maxExp) * 100}%`;
        document.getElementById('player-mp').textContent = `MP: ${player.mp}/${maxMp}`;
        document.getElementById('player-gacha-stones').textContent = `ğŸ’ ${player.gachaStones}`;
        document.getElementById('player-materials').textContent = `ğŸ§± ${player.materials}`;
        document.getElementById('player-tomes').textContent = `ğŸ“– ${player.tomesOfSecrets}`;

        const trait = gameData.player.singularityTrait;
        const traitEl = document.getElementById('player-trait');
        if (trait) {
            traitEl.textContent = `ç‰¹ç•°ä½“è³ª: ${SINGULARITY_TRAITS[trait].name}`;
            traitEl.title = SINGULARITY_TRAITS[trait].description;
        } else {
            traitEl.textContent = '';
            traitEl.title = '';
        }
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é–¢é€£ã®è¨ˆç®—
    function getNextLevelExp(level) {
        return Math.floor(10 * Math.pow(level, 1.8));
    }
    
    function calculateMaxHp() {
         let baseHp = 100 + (gameData.player.level - 1) * 50;
         const hpBoost = getEquipmentEffect('HP') + getEquipmentEffect('ALL');
         return Math.floor(baseHp * (1 + hpBoost));
    }

    function calculateMaxMp() {
        let baseMp = 50 + (gameData.player.level - 1) * 5 + (gameData.player.permanentMpBonus || 0);
        const mpBoost = getEquipmentEffect('MP') + getEquipmentEffect('ALL');
        return Math.floor(baseMp * (1 + mpBoost));
    }

    function levelUp() {
        const player = gameData.player;
        const maxExp = getNextLevelExp(player.level);
        if (player.exp >= maxExp) {
            player.level++;
            player.exp -= maxExp;
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒœãƒ¼ãƒŠã‚¹
            player.hp = calculateMaxHp();
            player.mp = calculateMaxMp();
            showModal("LEVEL UP!", `ãƒ¬ãƒ™ãƒ«ãŒ ${player.level} ã«ä¸ŠãŒã£ãŸï¼`);
            if (player.exp >= getNextLevelExp(player.level)) {
                levelUp(); // é€£ç¶šãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
            }
        }
    }
    
    // ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ç”»é¢
    function renderDungeonList() {
        const listEl = document.getElementById('dungeon-list');
        listEl.innerHTML = '';
        DUNGEON_MASTER.forEach((dungeon, index) => {
            const isLocked = index > gameData.unlockedDungeon;
            const button = document.createElement('button');
            button.className = `w-full p-6 text-left magic-button flex justify-between items-center ${isLocked ? 'opacity-50 cursor-not-allowed' : ''}`;
            button.disabled = isLocked;
            button.innerHTML = `
                <div>
                    <h3 class="text-xl font-cinzel">${dungeon.name}</h3>
                    <p class="text-sm text-gray-400">æ¨å¥¨ Lv: ${dungeon.levelRange[0]} - ${dungeon.levelRange[1]}</p>
                </div>
                <span class="text-3xl">${isLocked ? 'ğŸ”’' : 'â–¶'}</span>
            `;
            if (!isLocked) {
                button.addEventListener('click', () => startBattle('dungeon', index));
            }
            listEl.appendChild(button);
        });
    }

    // Rift Challenge Screen
    function renderRiftChallengeScreen() {
        const listEl = document.getElementById('rift-boss-list');
        listEl.innerHTML = '';

        const lastChallengeDate = gameData.lastRiftChallenge ? new Date(gameData.lastRiftChallenge).toDateString() : null;
        const todayDate = new Date().toDateString();
        const canChallenge = lastChallengeDate !== todayDate;

        Object.keys(ENEMY_MASTER).filter(id => ENEMY_MASTER[id].isBoss).forEach(bossId => {
            const boss = ENEMY_MASTER[bossId];
            const card = document.createElement('div');
            card.className = 'p-6 glassmorphism rounded-xl flex justify-between items-center';

            card.innerHTML = `
                <div class="text-left">
                    <p class="text-2xl font-bold text-purple-300">${boss.name}</p>
                    <p class="text-sm text-gray-400">HP: ${boss.baseHp}, MP: ${boss.baseMp}</p>
                </div>
                <div class="text-center">
                    <p class="text-8xl">${boss.icon}</p>
                    <button data-boss-id="${bossId}" class="start-rift-button magic-button px-8 py-2 mt-2" ${!canChallenge ? 'disabled' : ''}>
                        ${canChallenge ? 'æŒ‘æˆ¦' : 'æŒ‘æˆ¦æ¸ˆã¿'}
                    </button>
                </div>
            `;
            listEl.appendChild(card);
        });

        document.querySelectorAll('.start-rift-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const bossId = e.currentTarget.dataset.bossId;
                startBattle('rift', bossId);
            });
        });
    }

    // é­”æ³•å­¦æ ¡ç”»é¢
    function renderMagicSchoolScreen() {
        const listEl = document.getElementById('teacher-list');
        listEl.innerHTML = '';
        Object.keys(TEACHER_MASTER).forEach(teacherId => {
            const teacher = TEACHER_MASTER[teacherId];
            const button = document.createElement('button');
            button.className = `w-full p-6 text-left magic-button flex justify-between items-center`;
            
            let rewardHtml = '';
            if (teacher.reward.type === 'magic') {
                const magic = MAGIC_MASTER[teacher.reward.id];
                rewardHtml = `<p class="text-sm rarity-${magic.rarity}">å ±é…¬: ${magic.name}</p>`;
            } else {
                const equipment = EQUIPMENT_MASTER[teacher.reward.id];
                rewardHtml = `<p class="text-sm rarity-${equipment.rarity}">å ±é…¬: ${equipment.name}</p>`;
            }
            
            button.innerHTML = `
                <div>
                    <h3 class="text-xl font-cinzel">${teacher.name}</h3>
                    <p class="text-sm text-gray-400">æ¨å¥¨ Lv: ${teacher.level}</p>
                    <p class="text-sm text-gray-300 mt-1">${teacher.description}</p>
                    ${rewardHtml}
                </div>
                <span class="text-3xl">${teacher.icon}</span>
            `;
            button.addEventListener('click', () => startBattle('school', teacherId));
            listEl.appendChild(button);
        });
    }

    // ãƒãƒˆãƒ«
    function startBattle(mode, id) {
        battleState = {
            mode,
            player: createInitialPlayerBattleState(),
            turn: 'player',
            log: [],
            enemies: [],
            originalEnemies: []
        };

        if (mode === 'dungeon') {
            const dungeonIndex = id;
            const dungeon = DUNGEON_MASTER[dungeonIndex];
            const isBossFloor = Math.random() < 0.2;
            const numEnemies = isBossFloor ? 1 : Math.floor(Math.random() * 3) + 1;
            
            for(let i=0; i<numEnemies; i++) {
                const enemyLevel = dungeon.levelRange[0] + Math.floor(Math.random() * (dungeon.levelRange[1] - dungeon.levelRange[0] + 1));
                const enemyMasterId = isBossFloor ? dungeon.boss : dungeon.enemies[Math.floor(Math.random() * dungeon.enemies.length)];
                const enemyMaster = ENEMY_MASTER[enemyMasterId];
                const maxHp = Math.floor(enemyMaster.baseHp * (1 + enemyLevel * 0.1));
                const maxMp = Math.floor(enemyMaster.baseMp * (1 + enemyLevel * 0.1));
                const enemy = { ...enemyMaster, level: enemyLevel, maxHp, currentHp: maxHp, maxMp, currentMp: maxMp, shield: 0, effects: [] };
                battleState.enemies.push(enemy);
            }
            battleState.originalEnemies = [...battleState.enemies];
            battleState.dungeonIndex = dungeonIndex;
        } else {
            // School, Rift, Tower are 1v1
            let enemyMaster;
            let enemyLevel;
            if (mode === 'school') {
                enemyMaster = TEACHER_MASTER[id];
                enemyLevel = enemyMaster.level;
                battleState.teacherId = id;
            } else if (mode === 'rift') {
                enemyMaster = ENEMY_MASTER[id];
                enemyLevel = 150;
                battleState.riftBossId = id;
                gameData.lastRiftChallenge = new Date().toISOString();
            }
            const maxHp = enemyMaster.isBoss ? enemyMaster.baseHp : Math.floor(enemyMaster.baseHp * (1 + enemyLevel * 0.1));
            const maxMp = enemyMaster.isBoss ? enemyMaster.baseMp : Math.floor(enemyMaster.baseMp * (1 + enemyLevel * 0.1));
            const enemy = { ...enemyMaster, level: enemyLevel, maxHp, currentHp: maxHp, maxMp, currentMp: maxMp, shield: 0, effects: [] };
            battleState.enemies.push(enemy);
            battleState.originalEnemies.push(enemy);
        }
        
        addLog('æˆ¦é—˜é–‹å§‹ï¼');
        showScreen('battle-screen');
        updateBattleUI();
    }


    function createInitialPlayerBattleState() {
        return {
            maxHp: calculateMaxHp(), currentHp: calculateMaxHp(),
            maxMp: calculateMaxMp(), currentMp: calculateMaxMp(),
            shield: 0, effects: [],
        };
    }
    
    function updateBattleUI() {
        const { player, enemies, mode, currentFloor } = battleState;

        const battleHeader = document.getElementById('battle-header');
        if (mode === 'infinite') {
            battleHeader.textContent = `ç„¡é™ã®å¡” - ${currentFloor}éš`;
            battleHeader.classList.remove('hidden');
        } else {
            battleHeader.classList.add('hidden');
        }

        // æ•µæƒ…å ±
        const enemiesArea = document.getElementById('enemies-area');
        enemiesArea.innerHTML = '';
        enemies.forEach((enemy, index) => {
            if (enemy.currentHp > 0) {
                const enemyCard = document.createElement('div');
                enemyCard.id = `enemy-card-${index}`;
                enemyCard.className = 'enemy-card text-center p-2 transition-transform duration-200';
                enemyCard.innerHTML = `
                    <p class="text-lg font-bold">${enemy.name} Lv.${enemy.level}</p>
                    <p class="text-6xl my-2">${enemy.icon}</p>
                    <div class="w-32 h-3 bg-gray-700 rounded-full overflow-hidden border border-red-900">
                         <div style="width: ${Math.max(0, (enemy.currentHp / enemy.maxHp) * 100)}%" class="h-full bg-red-500 transition-all duration-500"></div>
                    </div>
                    <p class="mt-1 text-xs">HP: ${enemy.currentHp} / ${enemy.maxHp}</p>
                `;
                enemiesArea.appendChild(enemyCard);
            }
        });
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±
        document.getElementById('battle-player-hp-bar').style.width = `${Math.max(0, (player.currentHp / player.maxHp) * 100)}%`;
        document.getElementById('battle-player-shield-bar').style.width = `${Math.min(100, (player.shield / player.maxHp) * 100)}%`;
        document.getElementById('battle-player-mp-bar').style.width = `${Math.max(0, (player.currentMp / player.maxMp) * 100)}%`;
        document.getElementById('battle-player-hp-text').textContent = `HP: ${player.currentHp} / ${player.maxHp}`;
        document.getElementById('battle-player-mp-text').textContent = `MP: ${player.currentMp} / ${player.maxMp}`;
        
        const playerShieldEl = document.getElementById('player-shield-text');
        playerShieldEl.textContent = player.shield > 0 ? `ã‚·ãƒ¼ãƒ«ãƒ‰: ${player.shield}` : '';

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        const playerEffectsEl = document.getElementById('player-effects');
        playerEffectsEl.innerHTML = '';
        player.effects.forEach(effect => {
            let icon = '';
            let master = MAGIC_MASTER[effect.magicId];
            let title = `${master.name} (æ®‹ã‚Š ${effect.turnsLeft} ã‚¿ãƒ¼ãƒ³)`;
            switch(effect.type) {
                case 'BUFF': icon = 'âš”ï¸'; break;
                case 'DEFENSE': icon = 'ğŸ›¡ï¸'; break;
                case 'HEAL': icon = 'â•'; break;
                case 'DEBUFF': icon = 'ğŸ’€'; break;
            }
            playerEffectsEl.innerHTML += `<div class="effect-icon" title="${title}">${icon}<span class="turn-counter">${effect.turnsLeft}</span></div>`;
        });
        
        // é­”æ³•ã‚¹ãƒ­ãƒƒãƒˆ
        const magicSlotsEl = document.getElementById('magic-slots');
        magicSlotsEl.innerHTML = '';
        gameData.player.equippedMagic.forEach(masterId => {
            const slot = document.createElement('button');
            if (masterId) {
                const magicInstance = getMagicInstanceByMasterId(masterId);
                const magicMaster = MAGIC_MASTER[magicInstance.masterId];
                const cost = getMagicCost(magicInstance);
                
                slot.className = 'magic-button h-24 flex flex-col justify-center items-center';
                slot.innerHTML = `
                    <div class="text-2xl">${ELEMENTS[magicMaster.element].icon}</div>
                    <div class="text-sm">${magicMaster.name}</div>
                    <div class="text-xs">MP: ${cost}</div>
                `;
                slot.disabled = player.currentMp < cost || battleState.turn !== 'player';
                slot.onclick = () => playerTurn(masterId);
            } else {
                slot.className = 'h-24 border border-dashed border-gray-600 rounded-lg flex justify-center items-center text-gray-600';
                slot.textContent = 'Empty';
                slot.disabled = true;
            }
            magicSlotsEl.appendChild(slot);
        });

        // ç²¾ç¥é›†ä¸­ãƒœã‚¿ãƒ³
        const recoverMpButton = document.createElement('button');
        recoverMpButton.className = 'magic-button h-24 flex flex-col justify-center items-center';
        recoverMpButton.innerHTML = `
            <div class="text-2xl">ğŸ§˜</div>
            <div class="text-sm">ç²¾ç¥é›†ä¸­</div>
            <div class="text-xs">MPå›å¾©</div>
        `;
        recoverMpButton.disabled = battleState.turn !== 'player';
        recoverMpButton.onclick = () => playerRecoverMpTurn();
        magicSlotsEl.appendChild(recoverMpButton);
        
        // æˆ¦é—˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        const battleControls = document.getElementById('battle-controls');
        battleControls.innerHTML = '';
        if (mode === 'infinite') {
            const retreatButton = document.createElement('button');
            retreatButton.id = 'retreat-button';
            retreatButton.className = 'magic-button px-8 py-2';
            retreatButton.textContent = 'æ’¤é€€';
            retreatButton.onclick = () => endInfiniteTowerRun(false);
            battleControls.appendChild(retreatButton);
        }

        // ãƒ­ã‚°
        const logEl = document.getElementById('battle-log');
        logEl.innerHTML = battleState.log.join('<br>');
        logEl.scrollTop = logEl.scrollHeight;
    }
    
    function addLog(message) {
        battleState.log.unshift(message);
        if (battleState.log.length > 20) battleState.log.pop();
    }

    function playerRecoverMpTurn() {
        if (battleState.turn !== 'player') return;
        battleState.turn = 'processing';
        updateBattleUI();

        const recoverAmount = Math.floor(battleState.player.maxMp * 0.2);
        battleState.player.currentMp = Math.min(battleState.player.maxMp, battleState.player.currentMp + recoverAmount);
        
        addLog(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç²¾ç¥ã‚’é›†ä¸­ã—ã€MPãŒ ${recoverAmount} å›å¾©ã—ãŸï¼`);
        
        applyTurnEffects(battleState.player);
        updateBattleUI();

        setTimeout(enemyTurn, 1500);
    }

    function playerTurn(masterId) {
        if (battleState.turn !== 'player') return;

        const magicInstance = getMagicInstanceByMasterId(masterId);
        const magicMaster = MAGIC_MASTER[magicInstance.masterId];
        const cost = getMagicCost(magicInstance);
        const isBloodMagicPossible = gameData.player.singularityTrait === 'BLOOD_MAGIC' && battleState.player.currentHp > cost * 2;

        if (battleState.player.currentMp < cost) {
            if (isBloodMagicPossible) {
                if (magicMaster.type === 'ATTACK' && !magicMaster.isAoe) {
                    enterTargetingMode(masterId, true); // Targeting for blood magic
                } else {
                    confirmAndExecuteBloodMagic(masterId, -1); // No target needed
                }
            } else {
                addLog(isBloodMagicPossible ? "HPãŒè¶³ã‚Šãªã„ï¼" : "MPãŒè¶³ã‚Šãªã„ï¼");
            }
            return;
        }

        // Normal cast
        if (magicMaster.type === 'ATTACK' && !magicMaster.isAoe) {
            enterTargetingMode(masterId, false);
        } else {
            executePlayerAction(masterId, -1, false);
        }
    }

    function confirmAndExecuteBloodMagic(masterId, targetIndex) {
        const magicInstance = getMagicInstanceByMasterId(masterId);
        const magicMaster = MAGIC_MASTER[magicInstance.masterId];
        const cost = getMagicCost(magicInstance);
        const hpCost = cost * 2;

        showModal(
            'ç”Ÿå‘½è»¢æ›',
            `MPãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚<br>HPã‚’ ${hpCost} æ¶ˆè²»ã—ã¦ã€Œ${magicMaster.name}ã€ã‚’å”±ãˆã¾ã™ã‹ï¼Ÿ`,
            () => executePlayerAction(masterId, targetIndex, true),
            true
        );
    }

    function enterTargetingMode(masterId, isBloodMagic = false) {
        addLog("ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        updateBattleUI();
        battleState.enemies.forEach((enemy, index) => {
            if (enemy.currentHp > 0) {
                const card = document.getElementById(`enemy-card-${index}`);
                card.classList.add('targeting');
                if (isBloodMagic) {
                    card.onclick = () => confirmAndExecuteBloodMagic(masterId, index);
                } else {
                    card.onclick = () => executePlayerAction(masterId, index, false);
                }
            }
        });
    }

    function executePlayerAction(masterId, targetIndex, useHp = false) {
        // Cleanup targeting UI
        document.querySelectorAll('.enemy-card').forEach(card => {
            card.classList.remove('targeting');
            card.onclick = null;
        });

        battleState.turn = 'processing';
        updateBattleUI(); // Disable buttons

        const magicInstance = getMagicInstanceByMasterId(masterId);
        const magicMaster = MAGIC_MASTER[magicInstance.masterId];
        const cost = getMagicCost(magicInstance);

        if (useHp) {
            const hpCost = cost * 2;
            battleState.player.currentHp -= hpCost;
            addLog(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯HPã‚’ ${hpCost} æ¶ˆè²»ã—ã¦ ${magicMaster.name} ã‚’å”±ãˆãŸï¼`);
        } else {
            battleState.player.currentMp -= cost;
            addLog(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ ${magicMaster.name} ã‚’å”±ãˆãŸï¼`);
        }
        
        const target = targetIndex !== -1 ? battleState.enemies[targetIndex] : null;
        applyMagicEffect(magicInstance, battleState.player, target);
        
        updateBattleUI();
        
        const allEnemiesDefeated = battleState.enemies.every(e => e.currentHp <= 0);
        if (allEnemiesDefeated) {
            setTimeout(() => endBattle(true), 1000);
            return;
        }
        
        applyTurnEffects(battleState.player);
        updateBattleUI();
        
        setTimeout(enemyTurn, 1500);
    }
    
    function enemyTurn() {
        battleState.turn = 'processing';
        processSingleEnemyTurn(0);
    }

    function processSingleEnemyTurn(enemyIndex) {
        // Find next living enemy
        while(enemyIndex < battleState.enemies.length && battleState.enemies[enemyIndex].currentHp <= 0) {
            enemyIndex++;
        }

        if (enemyIndex >= battleState.enemies.length) {
            // All enemies have taken their turn
            battleState.turn = 'player';
            updateBattleUI();
            return;
        }

        const enemy = battleState.enemies[enemyIndex];
        
        applyTurnEffects(enemy);
        if (enemy.currentHp <= 0) { // Check if enemy died from DoT
             updateBattleUI();
             setTimeout(() => processSingleEnemyTurn(enemyIndex + 1), 1000);
             return;
        }

        const availableMagics = enemy.magics.filter(id => {
            const instance = { masterId: id, level: enemy.level, awakening: 0 };
            return getMagicCost(instance) <= enemy.currentMp;
        });

        if (availableMagics.length > 0 && Math.random() > 0.3) {
            const magicId = availableMagics[Math.floor(Math.random() * availableMagics.length)];
            const magicInstance = { masterId: magicId, level: enemy.level, awakening: 0 };
            const magicMaster = MAGIC_MASTER[magicInstance.masterId];
            const cost = getMagicCost(magicInstance);
            
            enemy.currentMp -= cost;
            addLog(`${enemy.name} ã¯ ${magicMaster.name} ã‚’ä½¿ã£ãŸï¼`);
            applyMagicEffect(magicInstance, enemy, battleState.player);
        } else {
            addLog(`${enemy.name} ã®é€šå¸¸æ”»æ’ƒï¼`);
            const damage = Math.floor(enemy.level * 3 * (Math.random() * 0.4 + 0.8));
            takeDamage(battleState.player, damage);
        }
        
        updateBattleUI();

        if (battleState.player.currentHp <= 0) {
            setTimeout(() => endBattle(false), 1000);
            return;
        }

        // Process next enemy after a delay
        setTimeout(() => processSingleEnemyTurn(enemyIndex + 1), 1500);
    }
    
    function applyMagicEffect(magicInstance, caster, target) {
        const master = MAGIC_MASTER[magicInstance.masterId];
        let power = getMagicPower(magicInstance);
        
        let powerMultiplier = 1;
        caster.effects.forEach(effect => {
            if (effect.type === 'BUFF') powerMultiplier *= MAGIC_MASTER[effect.magicId].basePower;
        });

        if (caster === battleState.player) {
            powerMultiplier *= (1 + getEquipmentEffect('POWER') + getEquipmentEffect('ALL'));
        }
        
        let finalPower = Math.floor(power * powerMultiplier);
        
        if (caster === battleState.player && (master.type === 'ATTACK' || master.type === 'HEAL' || master.type === 'DEFENSE')) {
            const levelBonus = 1 + (gameData.player.level * 0.05);
            finalPower = Math.floor(finalPower * levelBonus);
        }

        const applyToTarget = (t) => {
            if (t.currentHp <= 0) return;
            let targetPowerMultiplier = 1;
            t.effects.forEach(effect => {
                if (effect.type === 'DEBUFF') targetPowerMultiplier *= MAGIC_MASTER[effect.magicId].basePower;
            });
            let finalTargetPower = Math.floor(finalPower * targetPowerMultiplier);

            switch (master.type) {
                case 'ATTACK':
                    const damageDealt = takeDamage(t, finalTargetPower);
                    const drainBonus = caster === battleState.player ? getEquipmentEffect('DRAIN') : 0;
                    const totalDrainRate = (master.drain || 0) + drainBonus;
                    if (totalDrainRate > 0) {
                        const healedAmount = Math.floor(damageDealt * totalDrainRate);
                        caster.currentHp = Math.min(caster.maxHp, caster.currentHp + healedAmount);
                        addLog(`HPãŒ ${healedAmount} å›å¾©ã—ãŸã€‚`);
                    }
                    if(master.isDot){
                        t.effects.push({ magicId: magicInstance.masterId, type: 'DOT', power: finalTargetPower, turnsLeft: master.duration });
                    }
                    break;
                case 'DEBUFF':
                     t.effects.push({ magicId: magicInstance.masterId, type: master.type, turnsLeft: master.duration });
                    break;
            }
        };

        if (master.type === 'ATTACK' || master.type === 'DEBUFF') {
            if (master.isAoe) {
                const targets = caster === battleState.player ? battleState.enemies : [battleState.player];
                targets.forEach(applyToTarget);
            } else {
                applyToTarget(target);
            }
        } else { // HEAL, BUFF, DEFENSE always apply to caster
            switch (master.type) {
                case 'HEAL':
                    if (master.masterId === 'm306') { //å‰µç”Ÿã®å…‰
                        caster.currentHp = caster.maxHp;
                        addLog(`${caster.name || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'}ã®HPãŒå®Œå…¨ã«å›å¾©ã—ãŸï¼`);
                    } else if (!master.duration) {
                        caster.currentHp = Math.min(caster.maxHp, caster.currentHp + finalPower);
                        addLog(`${caster.name || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'}ã®HPãŒ ${finalPower} å›å¾©ã—ãŸã€‚`);
                    }
                    if (master.duration) {
                        caster.effects.push({ magicId: magicInstance.masterId, type: 'HEAL', power: finalPower, turnsLeft: master.duration });
                    }
                    break;
                case 'DEFENSE':
                    caster.shield += finalPower;
                    if (master.duration) {
                        caster.effects.push({ magicId: magicInstance.masterId, type: 'DEFENSE', power: finalPower, turnsLeft: master.duration });
                    }
                    break;
                case 'BUFF':
                    const type = master.masterId === 'b001' ? 'STUN' : master.type; // ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒƒãƒ—
                    caster.effects.push({ magicId: magicInstance.masterId, type: type, turnsLeft: master.duration });
                    addLog(`${caster.name || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'}ã®æ”»æ’ƒåŠ›ãŒ ${Math.round((master.basePower - 1) * 100)}% å¢—åŠ ã—ãŸï¼`);
                    break;
            }
        }
    }
    
    function takeDamage(target, damage) {
        let actualDamage = damage;
        if (target.shield > 0) {
            const shieldDamage = Math.min(target.shield, actualDamage);
            target.shield -= shieldDamage;
            actualDamage -= shieldDamage;
            addLog(`ã‚·ãƒ¼ãƒ«ãƒ‰ãŒ ${shieldDamage} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å¸åã—ãŸï¼`);
        }
        target.currentHp = Math.max(0, target.currentHp - actualDamage);
        const targetName = target.name || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
        addLog(`${targetName} ã¯ ${actualDamage} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`);
        if (target.currentHp <= 0) {
            addLog(`${targetName} ã‚’å€’ã—ãŸï¼`);
        }
        return actualDamage;
    }
    
    function applyTurnEffects(actor) {
        actor.effects = actor.effects.filter(effect => {
            const master = MAGIC_MASTER[effect.magicId];
            if (effect.type === 'HEAL') {
                const healAmount = Math.floor(effect.power / master.duration);
                actor.currentHp = Math.min(actor.maxHp, actor.currentHp + healAmount);
                addLog(`${actor.name || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'}ã¯å†ç”ŸåŠ¹æœã§HPãŒ${healAmount}å›å¾©ã—ãŸã€‚`);
            }
            if (effect.type === 'DOT') {
                const dotDamage = Math.floor(effect.power / master.duration);
                takeDamage(actor, dotDamage);
                 addLog(`${actor.name || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'}ã¯ç¶™ç¶šãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€‚`);
            }
            if (effect.magicId === 'm304') { // è–åŸŸ
                const healAmount = Math.floor(actor.maxHp * 0.05);
                actor.currentHp = Math.min(actor.maxHp, actor.currentHp + healAmount);
                addLog(`è–åŸŸã®åŠ›ã§HPãŒ${healAmount}å›å¾©ã—ãŸã€‚`);
            }
            effect.turnsLeft--;
            return effect.turnsLeft > 0;
        });

        if (actor === battleState.player) {
            const mpRegenBonus = getEquipmentEffect('MP_REGEN');
            if (mpRegenBonus > 0) {
                const mpRecovered = Math.floor(actor.maxMp * mpRegenBonus);
                actor.currentMp = Math.min(actor.maxMp, actor.currentMp + mpRecovered);
                addLog(`è£…å‚™åŠ¹æœã§MPãŒ ${mpRecovered} å›å¾©ã—ãŸã€‚`);
            }
            const hpRegenBonus = getEquipmentEffect('HP_REGEN');
            if (hpRegenBonus > 0) {
                const hpRecovered = Math.floor(actor.maxHp * hpRegenBonus);
                actor.currentHp = Math.min(actor.maxHp, actor.currentHp + hpRecovered);
                addLog(`è£…å‚™åŠ¹æœã§HPãŒ ${hpRecovered} å›å¾©ã—ãŸã€‚`);
            }
        }
    }

    function endBattle(isWin) {
        // ç„¡é™ã®å¡”
        if (battleState.mode === 'infinite') {
            if (isWin) {
                const floor = battleState.currentFloor;
                battleState.player.currentHp = battleState.player.maxHp;
                battleState.player.currentMp = battleState.player.maxMp;
                battleState.player.shield = 0;
                battleState.player.effects = [];
                showModal(`ç¬¬${floor}éšå±¤ çªç ´`, `HPã¨MPãŒå…¨å›å¾©ã—ãŸï¼`, () => { dom.modalContainer.classList.add('hidden'); startInfiniteTowerBattle(floor + 1); });
            } else {
                endInfiniteTowerRun(true); // Player was defeated
            }
            return;
        }

        // ãã‚Œä»¥å¤–ã®ãƒ¢ãƒ¼ãƒ‰
        let title = '', message = '', onConfirm = () => {};

        if (isWin) {
            title = "å‹åˆ©ï¼";
            switch(battleState.mode) {
                case 'dungeon':
                    let totalExp = 0, totalStones = 0, totalMaterials = 0;
                    battleState.originalEnemies.forEach(enemy => {
                        const potentialMultiplier = gameData.player.potentialLevel * 0.1;
                        const baseExp = enemy.level * 10;
                        totalExp += Math.floor(baseExp + (baseExp * potentialMultiplier));
                        totalStones += enemy.level * 5 + Math.floor(Math.random() * 25);
                        totalMaterials += enemy.level * 2 + Math.floor(Math.random() * 10);
                    });
                    
                    gameData.player.exp += totalExp;
                    gameData.player.gachaStones += totalStones;
                    gameData.player.materials += totalMaterials;
                    if (battleState.dungeonIndex === gameData.unlockedDungeon && gameData.unlockedDungeon < DUNGEON_MASTER.length - 1) {
                        gameData.unlockedDungeon++;
                    }
                    message = `çµŒé¨“å€¤+${totalExp}, é­”æ³•çŸ³+${totalStones}, ç´ æ+${totalMaterials}`;
                    onConfirm = () => { dom.modalContainer.classList.add('hidden'); levelUp(); saveGame(); showScreen('dungeon-screen'); };
                    break;
                case 'school':
                    const teacher = TEACHER_MASTER[battleState.teacherId];
                    const reward = teacher.reward;
                    message = '';
                    if (reward.type === 'magic') {
                        addMagicToInventory(reward.id);
                        message = `æ–°ãŸãªé­”æ³•ã€Œ${MAGIC_MASTER[reward.id].name}ã€ã‚’ç¿’å¾—ã—ãŸï¼`;
                    } else {
                        addEquipmentToInventory(reward.id);
                        message = `æ–°ãŸãªè£…å‚™ã€Œ${EQUIPMENT_MASTER[reward.id].name}ã€ã‚’å…¥æ‰‹ã—ãŸï¼`;
                    }
                    if (!gameData.defeatedTeachers.includes(battleState.teacherId)) {
                        gameData.defeatedTeachers.push(battleState.teacherId);
                        let mpBonus = {t001:50, t002:75, t003:100, t004:150, t005:200, t006:250}[battleState.teacherId] || 0;
                        if (mpBonus > 0) {
                            gameData.player.permanentMpBonus += mpBonus;
                            message += `<br>åˆå›å‹åˆ©ãƒœãƒ¼ãƒŠã‚¹ã¨ã—ã¦æœ€å¤§MPãŒ ${mpBonus} å¢—åŠ ã—ãŸï¼`;
                        }
                    }
                    onConfirm = () => { dom.modalContainer.classList.add('hidden'); saveGame(); showScreen('magic-school-screen'); };
                    break;
                case 'rift':
                    gameData.player.gachaStones += 5000;
                    gameData.player.materials += 2500;
                    gameData.player.tomesOfSecrets += 5;
                    message = `é­”æ³•çŸ³+5000, é­”åŠ›ã®æ¬ ç‰‡+2500, ç§˜ä¼ã®æ›¸+5 ã‚’ç²å¾—ï¼`;
                    onConfirm = () => { dom.modalContainer.classList.add('hidden'); saveGame(); showScreen('rift-challenge-screen'); };
                    break;
            }
        } else {
            title = "æ•—åŒ—...";
            message = "æ‹ åœ°ã«æˆ»ã•ã‚ŒãŸã€‚";
            let screenMap = {'dungeon': 'dungeon-screen', 'school': 'magic-school-screen', 'rift': 'rift-challenge-screen', 'infinite': 'infinite-tower-screen'};
            onConfirm = () => { dom.modalContainer.classList.add('hidden'); saveGame(); showScreen(screenMap[battleState.mode]); };
        }
        
        gameData.player.hp = Math.max(1, battleState.player.currentHp);
        gameData.player.mp = battleState.player.currentMp;
        
        showModal(title, message, onConfirm);
    }
    
    // ã‚¬ãƒãƒ£
    function switchGachaTab(tab) {
        const ratesEl = document.getElementById('gacha-rates');
        if (tab === 'magic') {
            document.getElementById('magic-gacha-tab').classList.add('active');
            document.getElementById('equipment-gacha-tab').classList.remove('active');
            document.getElementById('magic-gacha-content').classList.remove('hidden');
            document.getElementById('equipment-gacha-content').classList.add('hidden');
            ratesEl.innerHTML = `<p>æ’å‡ºç¢ºç‡: Legendary(0.1%) / Epic(1%) / Rare(10%) / Normal(20%)</p>`;
        } else {
            document.getElementById('magic-gacha-tab').classList.remove('active');
            document.getElementById('equipment-gacha-tab').classList.add('active');
            document.getElementById('magic-gacha-content').classList.add('hidden');
            document.getElementById('equipment-gacha-content').classList.remove('hidden');
            ratesEl.innerHTML = `<p>æ’å‡ºç¢ºç‡: Legendary(0.2%) / Epic(2%) / Rare(20%) / Normal(20%)</p>`;
        }
    }
    
    function handleGacha(e) {
        const type = e.currentTarget.dataset.gachaType;
        const amount = parseInt(e.currentTarget.dataset.amount);
        const cost = amount * 10;
        
        if (gameData.player.gachaStones < cost) {
            showModal("é­”æ³•çŸ³ä¸è¶³", "é­”æ³•çŸ³ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        
        gameData.player.gachaStones -= cost;
        
        const rates = type === 'magic' 
            ? { LEGENDARY: 0.1, EPIC: 1.1, RARE: 11.1, NORMAL: 31.1 }
            : { LEGENDARY: 0.2, EPIC: 2.2, RARE: 22.2, NORMAL: 42.2 };
        
        const results = [];
        for (let i = 0; i < amount; i++) {
            const rand = Math.random() * 100;
            let rarity;
            if (rand < rates.LEGENDARY) rarity = 'LEGENDARY';
            else if (rand < rates.EPIC) rarity = 'EPIC';
            else if (rand < rates.RARE) rarity = 'RARE';
            else if (rand < rates.NORMAL) rarity = 'NORMAL';
            else rarity = 'MATERIAL';

            if (rarity !== 'MATERIAL') {
                const master = type === 'magic' ? MAGIC_MASTER : EQUIPMENT_MASTER;
                const possibleItems = Object.keys(master).filter(id => master[id].rarity === rarity && !master[id].isBoss);
                const itemId = possibleItems[Math.floor(Math.random() * possibleItems.length)];
                let isNew = true;
                if (type === 'magic') {
                    isNew = !gameData.magicInventory.some(item => item.masterId === itemId);
                    addMagicToInventory(itemId);
                } else {
                    isNew = !gameData.equipmentInventory.some(item => item.masterId === itemId);
                    addEquipmentToInventory(itemId);
                }
                results.push({ item: master[itemId], type: 'item', isNew: isNew });
            } else {
                const materialAmount = 10 + Math.floor(Math.random() * 10);
                gameData.player.materials += materialAmount;
                results.push({ item: { name: `é­”åŠ›ã®æ¬ ç‰‡x${materialAmount}`, rarity: 'NORMAL'}, type: 'material' });
            }
        }
        
        showGachaResultModal(results);
        saveGame();
        updatePlayerStatsUI();
    }
    
    function showGachaResultModal(results) {
        let content = '<div class="max-h-[60vh] overflow-y-auto p-2 bg-black bg-opacity-20 rounded-lg"><div id="gacha-result-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div></div>';
        showModal("å¬å–šçµæœ", content);

        const grid = document.getElementById('gacha-result-grid');
        results.forEach((result, index) => {
            setTimeout(() => {
                const rarity = result.item.rarity;
                const rarityClass = `rarity-${rarity}`;
                let newTag = '';
                if (result.type === 'item') {
                    newTag = result.isNew ? '<span class="text-xs text-yellow-300">NEW!</span>' : '<span class="text-xs text-green-300">è¦šé†’!</span>';
                }

                const card = document.createElement('div');
                card.className = `text-center p-2 rounded-lg bg-rarity-${rarity} card-border border-rarity-${rarity} ${rarity === 'Legendary' ? 'legendary-animation' : ''}`;
                card.innerHTML = `
                    <div class="text-2xl">${result.type === 'item' ? ELEMENTS[result.item.element]?.icon || 'ğŸ›¡ï¸' : 'ğŸ§±'}</div>
                    <div class="text-xs ${rarityClass} font-bold">${result.item.name}</div>
                    <div class="text-xs ${rarityClass}">${RARITIES[rarity].name}</div>
                    <div>${newTag}</div>
                `;
                grid.appendChild(card);
            }, index * 100);
        });
    }

    // é­”æ³•ç®¡ç†
    function renderMagicScreen() {
        renderEquippedMagicList();
        renderMagicInventoryList();
    }
    
    function renderEquippedMagicList() {
        const listEl = document.getElementById('equipped-magic-list');
        listEl.innerHTML = '';
        listEl.classList.toggle('sm:grid-cols-3', gameData.player.equippedMagic.length > 4);
        for (let i = 0; i < gameData.player.equippedMagic.length; i++) {
            const masterId = gameData.player.equippedMagic[i];
            const slot = document.createElement('div');
            if (masterId) {
                const instance = getMagicInstanceByMasterId(masterId);
                const master = MAGIC_MASTER[instance.masterId];
                slot.className = `h-32 rounded-lg relative p-2 card-border border-rarity-${master.rarity} bg-rarity-${master.rarity} flex flex-col justify-center items-center cursor-pointer`;
                slot.innerHTML = `
                    <div class="text-4xl">${ELEMENTS[master.element].icon}</div>
                    <p class="font-bold text-sm ${`rarity-${master.rarity}`}">${master.name}</p>
                    <p class="text-xs">Lv.${instance.level} / è¦šé†’+${instance.awakening}</p>
                `;
                slot.onclick = () => showMagicDetailModal(instance, 'equipped', i);
            } else {
                slot.className = 'h-32 border border-dashed border-gray-600 rounded-lg flex justify-center items-center text-gray-500 relative p-2 cursor-pointer';
                slot.textContent = 'ç©ºã‚¹ãƒ­ãƒƒãƒˆ';
            }
            listEl.appendChild(slot);
        }
    }
    
    function renderMagicInventoryList() {
        const listEl = document.getElementById('magic-inventory-list');
        listEl.innerHTML = '';
        gameData.magicInventory.forEach(instance => {
            const master = MAGIC_MASTER[instance.masterId];
            const card = document.createElement('div');
            card.className = `h-32 rounded-lg p-2 card-border border-rarity-${master.rarity} bg-rarity-${master.rarity} flex flex-col justify-center items-center cursor-pointer`;
            card.innerHTML = `
                <div class="text-4xl">${ELEMENTS[master.element].icon}</div>
                <p class="font-bold text-sm text-center ${`rarity-${master.rarity}`}">${master.name}</p>
                <p class="text-xs">Lv.${instance.level} / è¦šé†’+${instance.awakening}</p>
            `;
            card.onclick = () => showMagicDetailModal(instance, 'inventory');
            listEl.appendChild(card);
        });
    }
    
    // è£…å‚™ç®¡ç†
    function renderEquipmentScreen() {
        renderEquippedEquipmentList();
        renderEquipmentInventoryList();
    }
    
    function renderEquippedEquipmentList() {
        const listEl = document.getElementById('equipped-equipment-list');
        listEl.innerHTML = '';
        const types = ['æ­¦å™¨ (å¨åŠ›)', 'è£…é£¾å“ (MP/HP)'];
        for (let i = 0; i < 2; i++) {
             const masterId = gameData.player.equippedEquipment[i];
             const slot = document.createElement('div');
             if (masterId) {
                const instance = getEquipmentInstanceByMasterId(masterId);
                const master = EQUIPMENT_MASTER[instance.masterId];
                slot.className = `p-4 rounded-lg flex flex-col justify-center items-center card-border border-rarity-${master.rarity} bg-rarity-${master.rarity} cursor-pointer h-32`;
                slot.innerHTML = `
                    <p class="font-bold text-center ${RARITIES[master.rarity].color}">${master.name}</p>
                    <p class="text-green-400">è¦šé†’+${instance.awakening}</p>
                `;
                slot.onclick = () => showEquipmentDetailModal(instance, 'equipped', i);
             } else {
                 slot.className = 'p-4 border border-dashed border-gray-600 rounded-lg flex flex-col justify-center items-center text-gray-500 cursor-pointer h-32';
                 slot.innerHTML = `<span>${types[i]} ã‚¹ãƒ­ãƒƒãƒˆ</span>`;
             }
             listEl.appendChild(slot);
        }
    }
    
    function renderEquipmentInventoryList() {
        const listEl = document.getElementById('equipment-inventory-list');
        listEl.innerHTML = '';
        gameData.equipmentInventory.forEach(instance => {
            const master = EQUIPMENT_MASTER[instance.masterId];
            const card = document.createElement('div');
            card.className = `p-3 rounded-lg card-border border-rarity-${master.rarity} bg-rarity-${master.rarity} cursor-pointer flex flex-col justify-center items-center h-32`;
            card.innerHTML = `
                <p class="font-bold text-center ${RARITIES[master.rarity].color}">${master.name}</p>
                <p class="text-green-400">è¦šé†’+${instance.awakening}</p>
            `;
            card.onclick = () => showEquipmentDetailModal(instance, 'inventory');
            listEl.appendChild(card);
        });
    }

    // ã‚¢ã‚¤ãƒ†ãƒ æ“ä½œ
    function addMagicToInventory(masterId) {
        let instance = getMagicInstanceByMasterId(masterId);
        if (instance) {
            instance.awakening++;
        } else {
            gameData.magicInventory.push({ masterId, level: 0, awakening: 0 });
        }
    }
    function addEquipmentToInventory(masterId) {
        let instance = getEquipmentInstanceByMasterId(masterId);
        if (instance) {
            instance.awakening++;
        } else {
            gameData.equipmentInventory.push({ masterId, awakening: 0 });
        }
    }
    function getMagicInstanceByMasterId(masterId) {
        return gameData.magicInventory.find(m => m.masterId === masterId);
    }
    function getEquipmentInstanceByMasterId(masterId) {
        return gameData.equipmentInventory.find(e => e.masterId === masterId);
    }
    
    function equipMagic(masterId) {
        if (gameData.player.equippedMagic.includes(masterId)) {
            showModal("ã‚¨ãƒ©ãƒ¼", "ãã®é­”æ³•ã¯ã™ã§ã«è£…å‚™ã•ã‚Œã¦ã„ã¾ã™ã€‚");
            return;
        }
        const emptySlot = gameData.player.equippedMagic.findIndex(id => id === null);
        if (emptySlot !== -1) {
            gameData.player.equippedMagic[emptySlot] = masterId;
            renderMagicScreen();
            saveGame();
            dom.modalContainer.classList.add('hidden'); // Close detail modal
        } else {
            showModal("ã‚¨ãƒ©ãƒ¼", "è£…å‚™ã‚¹ãƒ­ãƒƒãƒˆã«ç©ºããŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        }
    }
    
    function unequipMagic(slotIndex) {
        gameData.player.equippedMagic[slotIndex] = null;
        renderMagicScreen();
        saveGame();
        dom.modalContainer.classList.add('hidden'); // Close detail modal
    }
    
    function upgradeMagic(instance) {
        const master = MAGIC_MASTER[instance.masterId];
        const nextLevel = instance.level + 1;
        
        let materialCost = nextLevel * 50;
        if (master.rarity === 'LEGENDARY') materialCost *= 2;
        if (master.rarity === 'EPIC') materialCost *= 1.5;

        let tomeCost = 0;
        if (nextLevel % 10 === 0) {
            tomeCost = 1 + Math.floor(instance.level / 10);
        }

        if (gameData.player.materials < materialCost) {
            showModal("ç´ æä¸è¶³", `å¼·åŒ–ã«ã¯é­”åŠ›ã®æ¬ ç‰‡ãŒ ${materialCost} å¿…è¦ã§ã™ã€‚`);
            return;
        }
        if (gameData.player.tomesOfSecrets < tomeCost) {
            showModal("ç´ æä¸è¶³", `é™ç•Œçªç ´ã«ã¯ç§˜ä¼ã®æ›¸ãŒ ${tomeCost} å¿…è¦ã§ã™ã€‚`);
            return;
        }

        gameData.player.materials -= materialCost;
        gameData.player.tomesOfSecrets -= tomeCost;
        instance.level++;
        
        renderMagicScreen(); // Re-render main screen
        // Re-render the modal with updated info
        showMagicDetailModal(instance, 'inventory');
    }

    function equipEquipment(masterId) {
        if (gameData.player.equippedEquipment.includes(masterId)) {
            showModal("ã‚¨ãƒ©ãƒ¼", "ãã®è£…å‚™ã¯ã™ã§ã«è£…å‚™ã•ã‚Œã¦ã„ã¾ã™ã€‚");
            return;
        }
        const master = EQUIPMENT_MASTER[masterId];
        const slotIndex = master.type === 'POWER' || master.type === 'ALL' ? 0 : 1;
        gameData.player.equippedEquipment[slotIndex] = masterId;
        renderEquipmentScreen();
        saveGame();
        dom.modalContainer.classList.add('hidden');
    }
    
    function unequipEquipment(slotIndex) {
        gameData.player.equippedEquipment[slotIndex] = null;
        renderEquipmentScreen();
        saveGame();
        dom.modalContainer.classList.add('hidden');
    }

    // è¨ˆç®—ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function getMagicPower(instance) {
        const master = MAGIC_MASTER[instance.masterId];
        let bonusPerAwakening = { 'NORMAL': 0.05, 'RARE': 0.10, 'EPIC': 0.50, 'LEGENDARY': 1.00 }[master.rarity] || 0;
        const awakeningBonus = 1 + instance.awakening * bonusPerAwakening;
        const level = instance.level || 0; // level can be 0 for newly acquired magic
        return Math.floor(master.basePower * (1 + level * 0.1) * awakeningBonus);
    }

    function getMagicCost(instance) {
        const master = MAGIC_MASTER[instance.masterId];
        const costReduction = getEquipmentEffect('COST_REDUCTION');
        return Math.max(1, Math.floor(master.baseCost * (1 - costReduction)));
    }
    
    function getEquipmentEffect(type) {
        let totalValue = 0;
        gameData.player.equippedEquipment.forEach(masterId => {
            if (!masterId) return;
            const instance = getEquipmentInstanceByMasterId(masterId);
            const master = EQUIPMENT_MASTER[instance.masterId];
            let bonusPerAwakening = { 'NORMAL': 0.05, 'RARE': 0.10, 'EPIC': 0.50, 'LEGENDARY': 1.00 }[master.rarity] || 0;
            const awakeningBonus = 1 + instance.awakening * bonusPerAwakening;
            if (master.type === type || (type !== 'MP_REGEN' && type !== 'HP_REGEN' && type !== 'COST_REDUCTION' && type !== 'DRAIN' && master.type === 'ALL')) {
                totalValue += master.value * awakeningBonus;
            }
        });
        return totalValue;
    }
    
    // å›³é‘‘
    function switchEncyclopediaTab(tab) {
        if (tab === 'magic') {
            document.getElementById('magic-encyclopedia-tab').classList.add('active');
            document.getElementById('equipment-encyclopedia-tab').classList.remove('active');
            document.getElementById('magic-encyclopedia-content').classList.remove('hidden');
            document.getElementById('equipment-encyclopedia-content').classList.add('hidden');
        } else {
            document.getElementById('magic-encyclopedia-tab').classList.remove('active');
            document.getElementById('equipment-encyclopedia-tab').classList.add('active');
            document.getElementById('magic-encyclopedia-content').classList.add('hidden');
            document.getElementById('equipment-encyclopedia-content').classList.remove('hidden');
        }
    }

    function renderEncyclopediaScreen() {
        const magicListEl = document.getElementById('magic-encyclopedia-list');
        const equipmentListEl = document.getElementById('equipment-encyclopedia-list');
        magicListEl.innerHTML = '';
        equipmentListEl.innerHTML = '';

        Object.keys(MAGIC_MASTER).forEach(masterId => {
            const master = MAGIC_MASTER[masterId];
            const isOwned = !!getMagicInstanceByMasterId(masterId);
            const card = document.createElement('div');
            card.className = `p-2 rounded-lg cursor-pointer card-border border-rarity-${master.rarity} bg-rarity-${master.rarity} ${!isOwned ? 'opacity-50' : ''}`;
            card.innerHTML = `
                <div class="flex items-center">
                    <div class="text-3xl mr-3">${ELEMENTS[master.element].icon}</div>
                    <div>
                        <p class="font-bold rarity-${master.rarity}">${isOwned ? master.name : '???'}</p>
                        <p class="text-xs text-gray-400">${ELEMENTS[master.element].name} / ${master.type}</p>
                        <p class="text-xs rarity-${master.rarity}">${RARITIES[master.rarity].name}</p>
                    </div>
                </div>
            `;
            card.onclick = () => showEncyclopediaDetail(master);
            magicListEl.appendChild(card);
        });

        Object.keys(EQUIPMENT_MASTER).forEach(masterId => {
            const master = EQUIPMENT_MASTER[masterId];
            const isOwned = !!getEquipmentInstanceByMasterId(masterId);
            const card = document.createElement('div');
            card.className = `p-3 rounded-lg flex justify-between items-center card-border border-rarity-${master.rarity} bg-rarity-${master.rarity} ${!isOwned ? 'opacity-50' : ''}`;
            card.innerHTML = `
                <div>
                    <p class="font-bold rarity-${master.rarity}">${isOwned ? master.name : '???'}</p>
                    <p class="text-xs rarity-${master.rarity}">${RARITIES[master.rarity].name}</p>
                    <p class="text-sm text-gray-400 mt-1">${isOwned ? master.description : '---'}</p>
                </div>
            `;
            card.onclick = () => showEncyclopediaDetail(master);
            equipmentListEl.appendChild(card);
        });
        
        switchEncyclopediaTab('magic');
    }
    
    function showEncyclopediaDetail(master) {
        const isMagic = !!master.basePower;
        const masterId = isMagic 
            ? Object.keys(MAGIC_MASTER).find(key => MAGIC_MASTER[key] === master)
            : Object.keys(EQUIPMENT_MASTER).find(key => EQUIPMENT_MASTER[key] === master);
        const isOwned = isMagic ? !!getMagicInstanceByMasterId(masterId) : !!getEquipmentInstanceByMasterId(masterId);

        if (!isOwned) {
            showModal("è©³ç´°", "ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã¾ã æ‰€æŒã—ã¦ã„ã¾ã›ã‚“ã€‚");
            return;
        }
        let content = `<p class="font-bold text-lg rarity-${master.rarity}">${master.name}</p>`;
        if (isMagic) {
            content += `<p>åŸºæœ¬å¨åŠ›: ${master.basePower}</p><p>åŸºæœ¬æ¶ˆè²»MP: ${master.baseCost}</p>`;
        }
        content += `<p class="mt-2 text-gray-400">${master.description}</p>`;
        showModal("è©³ç´°", content);
    }

    // ç„¡é™ã®å¡”
    function renderInfiniteTowerScreen() {
        document.getElementById('highest-floor').textContent = gameData.infiniteTower.highestFloor;
        const lastChallengeDate = gameData.infiniteTower.lastChallenge ? new Date(gameData.infiniteTower.lastChallenge).toDateString() : null;
        const todayDate = new Date().toDateString();
        const canChallenge = lastChallengeDate !== todayDate;

        const startButton = document.getElementById('start-tower-button');
        startButton.disabled = !canChallenge;
        startButton.textContent = canChallenge ? 'æŒ‘æˆ¦é–‹å§‹' : 'æŒ‘æˆ¦æ¸ˆã¿';
    }

    function startInfiniteTowerBattle(floor) {
        if (floor === 1) { // åˆå›ã®ã¿
            gameData.infiniteTower.lastChallenge = new Date().toISOString();
            saveGame();
            battleState = {
                mode: 'infinite',
                currentFloor: 1,
                player: createInitialPlayerBattleState(),
                rewards: { stones: 0, materials: 0 },
                log: [],
                enemies: [],
                originalEnemies: []
            };
        }
        battleState.enemies = [];
        battleState.originalEnemies = [];

        let enemyPool = [];
        if (floor <= 10) enemyPool = Object.keys(ENEMY_MASTER).filter(id => ENEMY_MASTER[id].rarity === 'NORMAL');
        else if (floor <= 30) enemyPool = Object.keys(ENEMY_MASTER).filter(id => ['NORMAL', 'RARE'].includes(ENEMY_MASTER[id].rarity));
        else if (floor <= 60) enemyPool = Object.keys(ENEMY_MASTER).filter(id => ['RARE', 'EPIC'].includes(ENEMY_MASTER[id].rarity));
        else enemyPool = Object.keys(ENEMY_MASTER).filter(id => ['EPIC', 'LEGENDARY'].includes(ENEMY_MASTER[id].rarity) && !ENEMY_MASTER[id].isBoss);
        if (enemyPool.length === 0) enemyPool = Object.keys(ENEMY_MASTER).filter(id => !ENEMY_MASTER[id].isBoss);

        const enemyMasterId = enemyPool[Math.floor(Math.random() * enemyPool.length)];
        const enemyMaster = ENEMY_MASTER[enemyMasterId];

        const enemyLevel = floor;
        const statMultiplier = 1 + floor * 0.12;
        const maxHp = Math.floor(enemyMaster.baseHp * statMultiplier);
        const maxMp = Math.floor(enemyMaster.baseMp * statMultiplier);

        const enemy = { ...enemyMaster, level: enemyLevel, maxHp, currentHp: maxHp, maxMp, currentMp: maxMp, shield: 0, effects: [] };
        battleState.enemies.push(enemy);
        battleState.originalEnemies.push(enemy);
        battleState.currentFloor = floor;
        battleState.turn = 'player';
        
        addLog(`ç¬¬${floor}éšå±¤`);
        showScreen('battle-screen');
        updateBattleUI();
    }

    function endInfiniteTowerRun(wasDefeated) {
        const floorsCleared = wasDefeated ? battleState.currentFloor - 1 : battleState.currentFloor;
        if (floorsCleared > gameData.infiniteTower.highestFloor) {
            gameData.infiniteTower.highestFloor = floorsCleared;
        }

        let totalStones = 0, totalMaterials = 0, totalTomes = 0;
        for (let i = 1; i <= floorsCleared; i++) {
            totalMaterials += i * 5;
            if (i % 5 === 0) totalMaterials += i * 20;
            if (i % 10 === 0) totalStones += i * 50;
            if (i % 25 === 0) totalTomes += 1;
        }
        
        gameData.player.gachaStones += totalStones;
        gameData.player.materials += totalMaterials;
        gameData.player.tomesOfSecrets += totalTomes;
        
        const message = `
            åˆ°é”éšå±¤: ${floorsCleared}éš<br>
            ç²å¾—é­”æ³•çŸ³: ${totalStones}å€‹<br>
            ç²å¾—ç´ æ: ${totalMaterials}å€‹<br>
            ç²å¾—ã—ãŸç§˜ä¼ã®æ›¸: ${totalTomes}å†Š
        `;
        showModal(wasDefeated ? "æŒ‘æˆ¦å¤±æ•—" : "æ’¤é€€", message, () => {
            dom.modalContainer.classList.add('hidden');
            saveGame();
            showScreen('home-screen');
        });
    }

    // --- Modal Functions ---
    function showModal(title, content, onConfirm = null, showCancel = false, customButtonsHTML = '') {
        let buttonsHTML = customButtonsHTML;
        if (buttonsHTML === '') {
            buttonsHTML = `<button id="modal-confirm-button" class="magic-button px-8 py-2">${showCancel ? 'OK' : 'é–‰ã˜ã‚‹'}</button>`;
            if (showCancel) {
                buttonsHTML += `<button id="modal-cancel-button" class="magic-button px-8 py-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`;
            }
        }

        dom.modalContainer.innerHTML = `
            <div class="modal fade-in">
                <div class="modal-content glassmorphism gradient-border rounded-xl">
                    <h2 class="text-2xl font-cinzel mb-4 text-center">${title}</h2>
                    <div>${content}</div>
                    <div class="text-center mt-6 flex justify-center gap-4">
                        ${buttonsHTML}
                    </div>
                </div>
            </div>
        `;
        dom.modalContainer.classList.remove('hidden');
        
        if (customButtonsHTML === '') {
            const confirmBtn = document.getElementById('modal-confirm-button');
            if(confirmBtn) {
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    else dom.modalContainer.classList.add('hidden');
                };
            }

            const cancelBtn = document.getElementById('modal-cancel-button');
            if (cancelBtn) {
                cancelBtn.onclick = () => {
                    dom.modalContainer.classList.add('hidden');
                };
            }
        }
    }
    
    function showMagicDetailModal(instance, context, slotIndex = -1) {
        const master = MAGIC_MASTER[instance.masterId];
        const nextLevel = instance.level + 1;
        let materialCost = nextLevel * 50;
        if (master.rarity === 'LEGENDARY') materialCost *= 2;
        if (master.rarity === 'EPIC') materialCost *= 1.5;

        let tomeCost = 0;
        if (nextLevel % 10 === 0) {
            tomeCost = 1 + Math.floor(instance.level / 10);
        }

        let buttonsHTML = '';
        if (context === 'inventory') {
            buttonsHTML += `<button id="equip-btn" class="magic-button px-4 py-2">è£…å‚™</button>`;
        } else if (context === 'equipped') {
            buttonsHTML += `<button id="unequip-btn" class="magic-button px-4 py-2">å¤–ã™</button>`;
        }
        buttonsHTML += `<button id="upgrade-btn" class="magic-button px-4 py-2">å¼·åŒ–</button>`;
        buttonsHTML += `<button id="close-modal-btn" class="magic-button px-4 py-2">é–‰ã˜ã‚‹</button>`;
        
        const content = `
            <div class="text-center">
                <p class="text-2xl">${ELEMENTS[master.element].icon}</p>
                <p class="font-bold text-lg ${`rarity-${master.rarity}`}">${master.name}</p>
                <p class="text-sm">${RARITIES[master.rarity].name} / ${ELEMENTS[master.element].name} / ${master.type}</p>
                <p class="text-gray-300 my-2">${master.description}</p>
                <div class="bg-black bg-opacity-30 p-2 rounded-lg text-left text-sm space-y-1">
                    <p>Lv: ${instance.level} / è¦šé†’: +${instance.awakening}</p>
                    <p>å¨åŠ›: ${Math.floor(getMagicPower(instance) * (1 + gameData.player.level * 0.05))} (åŸºæœ¬: ${getMagicPower(instance)})</p>
                    <p>æ¶ˆè²»MP: ${getMagicCost(instance)}</p>
                    <hr class="border-gray-600 my-1">
                    <p class="font-bold">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸ã®å¼·åŒ–ã‚³ã‚¹ãƒˆ:</p>
                    <p>é­”åŠ›ã®æ¬ ç‰‡: ${materialCost}</p>
                    ${tomeCost > 0 ? `<p>ç§˜ä¼ã®æ›¸: ${tomeCost}</p>` : ''}
                </div>
            </div>
        `;
        showModal("é­”æ³•è©³ç´°", content, null, false, buttonsHTML);

        document.getElementById('upgrade-btn').onclick = () => upgradeMagic(instance);
        document.getElementById('close-modal-btn').onclick = () => dom.modalContainer.classList.add('hidden');
        if (context === 'inventory') {
            document.getElementById('equip-btn').onclick = () => equipMagic(instance.masterId);
        } else if(context === 'equipped') {
            document.getElementById('unequip-btn').onclick = () => unequipMagic(slotIndex);
        }
    }
    
    function showEquipmentDetailModal(instance, context, slotIndex = -1) {
        const master = EQUIPMENT_MASTER[instance.masterId];
        let buttonsHTML = '';
        if (context === 'inventory') {
            buttonsHTML += `<button id="equip-eq-btn" class="magic-button px-4 py-2">è£…å‚™</button>`;
        } else if (context === 'equipped') {
            buttonsHTML += `<button id="unequip-eq-btn" class="magic-button px-4 py-2">å¤–ã™</button>`;
        }
        buttonsHTML += `<button id="close-modal-btn" class="magic-button px-4 py-2">é–‰ã˜ã‚‹</button>`;
        
        const content = `
            <div class="text-center">
                <p class="font-bold text-lg ${RARITIES[master.rarity].color}">${master.name}</p>
                <p class="text-sm">${RARITIES[master.rarity].name}</p>
                <p class="text-gray-300 my-2">${master.description}</p>
                 <div class="bg-black bg-opacity-30 p-2 rounded-lg text-left text-sm space-y-1">
                    <p>è¦šé†’: +${instance.awakening}</p>
                </div>
            </div>
        `;
        showModal("è£…å‚™è©³ç´°", content, null, false, buttonsHTML);
        
        document.getElementById('close-modal-btn').onclick = () => dom.modalContainer.classList.add('hidden');
        if (context === 'inventory') {
            document.getElementById('equip-eq-btn').onclick = () => equipEquipment(instance.masterId);
        } else if (context === 'equipped') {
            document.getElementById('unequip-eq-btn').onclick = () => unequipEquipment(slotIndex);
        }
    }

    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
    function addTooltipListener(element, content) {
        element.addEventListener('mouseenter', (e) => {
            dom.tooltip.innerHTML = content;
            dom.tooltip.classList.remove('hidden');
            moveTooltip(e);
        });
        element.addEventListener('mousemove', moveTooltip);
        element.addEventListener('mouseleave', () => {
            dom.tooltip.classList.add('hidden');
        });
    }

    function moveTooltip(e) {
        let x = e.clientX + 15;
        let y = e.clientY + 15;
        if (x + dom.tooltip.offsetWidth > window.innerWidth) {
            x = e.clientX - dom.tooltip.offsetWidth - 15;
        }
        if (y + dom.tooltip.offsetHeight > window.innerHeight) {
            y = e.clientY - dom.tooltip.offsetHeight - 15;
        }
        dom.tooltip.style.left = `${x}px`;
        dom.tooltip.style.top = `${y}px`;
    }
    
    // å®Ÿè¡Œ
    init();
});
</script>
</body>
</html>



