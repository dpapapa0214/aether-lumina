<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•°ç•Œæˆ¦è¨˜ã‚¯ãƒ­ãƒ‹ã‚¯ãƒ« Ver. 27.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" href="icons/logo-gamepad2.png">
    <link rel="apple-touch-icon" href="icons/logo-gamepad2.png">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºæœ¬çš„ãªã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #0a0a1a;
            color: #e0e0e0;
            overscroll-behavior: none;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ©ã‚¹ */
        .screen { display: none; width: 100%; height: 100vh; overflow: auto; }
        .active-screen { display: flex; flex-direction: column; }
        .glass-panel {
            background-color: rgba(10, 10, 30, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 100, 220, 0.3);
            border-radius: 1rem;
        }
        .btn-primary {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(99, 102, 241, 0.8);
        }
        .btn-primary:disabled {
            background: #333; box-shadow: none; cursor: not-allowed; opacity: 0.5;
        }
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover { background-color: rgba(255, 255, 255, 0.2); }
        .btn-danger {
            background-color: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        .btn-danger:hover { background-color: rgba(239, 68, 68, 0.4); }
        .btn-limit-break {
            background: linear-gradient(45deg, #f59e0b, #ef4444);
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }
        .hub-btn {
            transition: all 0.2s ease-in-out;
        }
        .hub-btn:hover {
            border-color: rgba(129, 140, 248, 0.7);
            transform: scale(1.02);
        }

        /* å±æ€§ã”ã¨ã®è‰² */
        .attr-erosion { color: #f43f5e; border-color: #f43f5e; } /* ä¾µé£Ÿ */
        .attr-void { color: #8b5cf6; border-color: #8b5cf6; } /* è™šç„¡ */
        .attr-quantum { color: #22d3ee; border-color: #22d3ee; } /* é‡å­ */
        .attr-causality { color: #facc15; border-color: #facc15; } /* å› æœ */

        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã”ã¨ã®è‰² */
        .rarity-3 { color: #60a5fa; } /* blue-400 */
        .rarity-4 { color: #c084fc; } /* purple-400 */
        .rarity-5 { color: #facc15; } /* yellow-400 */
        .rarity-6 { color: #f87171; } /* red-400 */

        /* ãƒãƒƒãƒ—ã‚¿ã‚¤ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .map-tile { transition: all 0.3s ease; cursor: pointer; }
        .map-tile.unexplored { background-color: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .map-tile.unexplored:hover { background-color: rgba(255,255,255,0.15); border-color: #22d3ee; }
        .map-tile.conquered { background-color: rgba(34, 211, 238, 0.2); border: 1px solid rgba(34, 211, 238, 0.5); cursor: default;}
        .map-tile.elite { background-color: rgba(192, 132, 252, 0.2); border: 1px solid rgba(192, 132, 252, 0.5); }
        .map-tile.elite:hover { background-color: rgba(192, 132, 252, 0.4); border-color: #c084fc; }
        .map-tile.mid-boss { background-color: rgba(250, 204, 21, 0.2); border: 1px solid rgba(250, 204, 21, 0.5); }
        .map-tile.mid-boss:hover { background-color: rgba(250, 204, 21, 0.4); border-color: #facc15; }
        .map-tile.boss { background-color: rgba(244, 63, 94, 0.2); border: 1px solid rgba(244, 63, 94, 0.5); }
        .map-tile.boss:hover { background-color: rgba(244, 63, 94, 0.4); border-color: #f43f5e; }

        /* æˆ¦é—˜ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes attack-animation { 0% { transform: translate(0, 0); } 50% { transform: translate(10px, -5px) scale(1.05); } 100% { transform: translate(0, 0); } }
        .attacking { animation: attack-animation 0.3s ease-in-out; }
        @keyframes damage-animation { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.2); opacity: 0; color: #ef4444; } }
        .damage-popup { position: absolute; top: 40%; left: 50%; transform: translateX(-50%); font-size: 1.5rem; font-weight: bold; pointer-events: none; animation: damage-animation 0.7s forwards; }
        .btn-enhanced {
            background: linear-gradient(45deg, #fde047, #f59e0b);
            color: #422006;
            box-shadow: 0 0 15px rgba(252, 211, 77, 0.7);
        }
    </style>
</head>
<body class="w-full h-screen overflow-hidden">

    <div id="game-container" class="w-full h-full max-w-5xl mx-auto p-4 flex flex-col items-center justify-center">
        <input type="file" id="load-file-input" class="hidden" accept=".txt,text/plain">

        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div id="title-screen" class="screen active-screen items-center justify-center text-center">
            <h1 class="text-5xl md:text-7xl font-orbitron mb-4 tracking-widest">ç•°ç•Œæˆ¦è¨˜ã‚¯ãƒ­ãƒ‹ã‚¯ãƒ«</h1>
            <p class="text-lg md:text-xl text-cyan-300 mb-8">Ver. 27.0</p>
            <p class="max-w-2xl mb-12">ç•°æ¬¡å…ƒã®ä¾µæ”»ã«ã‚ˆã‚Šã€ä¸–ç•Œã¯çµ‚ç„‰ã®æ·µã«ç«‹ãŸã•ã‚ŒãŸã€‚<br>äººé¡æœ€å¾Œã®å¸Œæœ›ã€ç•°ç•Œæˆ¦å£«ã¨ã—ã¦ã€åœ°çƒã‚’æµ„åŒ–ã›ã‚ˆã€‚</p>
            <button id="start-game-btn" class="btn-primary font-bold text-2xl py-4 px-12 rounded-lg">GAME START</button>
            <p class="text-sm mt-12 text-gray-500">ã“ã®ç‰©èªã®çµæœ«ã¯ã€ã‚ãªãŸã®é¸æŠã«å§”ã­ã‚‰ã‚Œã‚‹ã€‚</p>
        </div>

        <!-- ãƒãƒ–ç”»é¢ -->
        <div id="hub-screen" class="screen">
             <div class="w-full h-full flex flex-col p-4">
                <header class="w-full glass-panel p-4 mb-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-orbitron">å¸ä»¤å®¤</h2>
                        <p>æµ„åŒ–ç‡: <span id="purification-rate">0</span>% / ç²¾ç¥æ±šæŸ“: <span id="mental-pollution">0</span>%</p>
                    </div>
                    <div class="text-right">
                        <p>è³‡æº: <span id="player-resources">1000</span></p>
                        <p>é™è‡¨ãƒã‚±ãƒƒãƒˆ: <span id="gacha-tickets">100</span></p>
                        <p class="text-sm">ã‚¨ãƒ¼ãƒ†ãƒ«çµæ™¶: <span id="limit-break-materials-display">0</span></p>
                    </div>
                </header>
                <main class="w-full flex-grow flex flex-col md:flex-row gap-4">
                    <div class="flex-grow flex flex-col gap-4">
                        <div data-screen="map-screen" class="hub-btn glass-panel flex-grow flex flex-col justify-center items-center cursor-pointer p-4"><h3 class="text-5xl font-orbitron mb-2">å‡ºæ’ƒ</h3><p class="text-sm text-gray-400">æ”¯é…åŸŸã‚’æ‹¡å¤§ã™ã‚‹</p></div>
                        <div class="flex gap-4 h-2/5">
                            <div data-screen="god-slay-screen" class="hub-btn glass-panel w-1/3 flex flex-col justify-center items-center cursor-pointer p-2 text-center"><h3 class="text-2xl font-orbitron mb-2">ç•°ç¥è¨ä¼</h3><p class="text-xs text-gray-400">ä¸–ç•Œã®ç†ã‚’è¶…ãˆãŸå­˜åœ¨ã«æŒ‘ã‚€</p></div>
                            <div data-screen="relic-hunt-screen" class="hub-btn glass-panel w-1/3 flex flex-col justify-center items-center cursor-pointer p-2 text-center"><h3 class="text-2xl font-orbitron mb-2">éºè·¡æ¢ç´¢</h3><p class="text-xs text-gray-400">è–éºç‰©ã‚’å…¥æ‰‹ã™ã‚‹</p></div>
                            <div data-screen="infinite-corridor-screen" class="hub-btn glass-panel w-1/3 flex flex-col justify-center items-center cursor-pointer p-2 text-center"><h3 class="text-2xl font-orbitron mb-2">ç„¡é™å›å»Š</h3><p class="text-xs text-gray-400">æœã¦ãªãè©¦ç·´ã«æŒ‘ã‚€</p></div>
                        </div>
                    </div>
                    <div class="md:w-1/3 flex flex-col gap-4">
                        <div data-screen="character-screen" class="hub-btn glass-panel h-1/4 flex flex-col justify-center items-center cursor-pointer p-4"><h3 class="text-2xl font-orbitron mb-2">éƒ¨éšŠ</h3><p class="text-sm text-gray-400">ç·¨æˆã¨å¼·åŒ–</p></div>
                        <div data-screen="relic-screen" class="hub-btn glass-panel h-1/4 flex flex-col justify-center items-center cursor-pointer p-4"><h3 class="text-2xl font-orbitron mb-2">è–éºç‰©</h3><p class="text-sm text-gray-400">è–éºç‰©ã‚’è£…å‚™ãƒ»å¼·åŒ–</p></div>
                        <div data-screen="gacha-screen" class="hub-btn glass-panel h-1/4 flex flex-col justify-center items-center cursor-pointer p-4"><h3 class="text-2xl font-orbitron mb-2">é™è‡¨</h3><p class="text-sm text-gray-400">æ–°ãŸãªæˆ¦åŠ›ã‚’å¾—ã‚‹</p></div>
                        <div class="flex gap-4 h-1/4">
                            <div id="save-game-btn" class="hub-btn glass-panel w-1/2 flex flex-col justify-center items-center cursor-pointer p-4"><h3 class="text-xl font-orbitron">ã‚»ãƒ¼ãƒ–</h3></div>
                            <div id="load-game-btn" class="hub-btn glass-panel w-1/2 flex flex-col justify-center items-center cursor-pointer p-4"><h3 class="text-xl font-orbitron">ãƒ­ãƒ¼ãƒ‰</h3></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        
        <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ç·¨æˆç”»é¢ -->
        <div id="character-screen" class="screen">
            <div class="w-full h-full flex flex-col p-4">
                <header class="w-full flex justify-between items-center mb-4"><button class="back-to-hub btn-secondary px-4 py-2 rounded-lg">&lt; å¸ä»¤å®¤ã¸</button><h2 class="text-3xl font-orbitron">éƒ¨éšŠç®¡ç†</h2></header>
                <main class="w-full flex-grow flex flex-col md:flex-row gap-4">
                    <div class="md:w-2/5 h-full glass-panel p-4 flex flex-col"><h3 class="text-xl font-bold mb-2 text-center">æˆ¦é—˜éƒ¨éšŠ</h3><div id="current-party" class="grid grid-cols-1 gap-2 flex-grow"></div></div>
                    <div class="md:w-3/5 h-full glass-panel p-4 flex flex-col"><h3 class="text-xl font-bold mb-2 text-center">æ‰€æŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</h3><div id="character-list" class="grid grid-cols-2 sm:grid-cols-3 gap-2 overflow-y-auto"></div></div>
                </main>
            </div>
        </div>

        <!-- ãƒãƒƒãƒ—ç”»é¢ -->
        <div id="map-screen" class="screen items-center">
            <div class="w-full h-full flex flex-col p-4">
                <header class="w-full flex justify-between items-center mb-4"><button class="back-to-hub btn-secondary px-4 py-2 rounded-lg">&lt; å¸ä»¤å®¤ã¸</button><h2 id="map-name" class="text-3xl font-orbitron"></h2></header>
                <div class="w-full flex-grow glass-panel p-4"><div id="map-grid" class="w-full h-full grid grid-cols-8 gap-1"></div></div>
                <footer class="w-full flex justify-center items-center mt-4 space-x-2">
                    <button class="map-change-btn btn-secondary px-3 py-1 rounded" data-map="ground">åœ°ä¸Š</button>
                    <button class="map-change-btn btn-secondary px-3 py-1 rounded" data-map="underground">åœ°ä¸‹</button>
                    <button class="map-change-btn btn-secondary px-3 py-1 rounded" data-map="heaven">å¤©ç•Œ</button>
                    <button class="map-change-btn btn-secondary px-3 py-1 rounded" data-map="abyss">æ·µç•Œ</button>
                    <button class="map-change-btn btn-secondary px-3 py-1 rounded" data-map="soukai">è’¼ç•Œ</button>
                </footer>
            </div>
        </div>
        
        <!-- ç•°ç¥è¨ä¼ç”»é¢ -->
        <div id="god-slay-screen" class="screen">
            <div class="w-full h-full flex flex-col p-4">
                <header class="w-full flex justify-between items-center mb-4"><button class="back-to-hub btn-secondary px-4 py-2 rounded-lg">&lt; å¸ä»¤å®¤ã¸</button><h2 class="text-3xl font-orbitron">ç•°ç¥è¨ä¼</h2></header>
                <main id="god-list" class="w-full flex-grow grid grid-cols-1 md:grid-cols-2 gap-4"></main>
            </div>
        </div>
        
        <!-- éºè·¡æ¢ç´¢ç”»é¢ -->
        <div id="relic-hunt-screen" class="screen">
             <div class="w-full h-full flex flex-col p-4">
                 <header class="w-full flex justify-between items-center mb-4"><button class="back-to-hub btn-secondary px-4 py-2 rounded-lg">&lt; å¸ä»¤å®¤ã¸</button><h2 class="text-3xl font-orbitron">éºè·¡æ¢ç´¢</h2></header>
                 <main class="w-full flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
                    <div id="relic-dungeon-list" class="md:w-1/3 h-full glass-panel p-4 overflow-y-auto space-y-2"></div>
                    <div id="relic-dungeon-detail" class="md:w-2/3 h-full glass-panel p-4 flex flex-col"></div>
                 </main>
            </div>
        </div>

        <!-- ç„¡é™å›å»Šç”»é¢ -->
        <div id="infinite-corridor-screen" class="screen">
            <div class="w-full h-full flex flex-col p-4">
                <header class="w-full flex justify-between items-center mb-4">
                    <button class="back-to-hub btn-secondary px-4 py-2 rounded-lg">&lt; å¸ä»¤å®¤ã¸</button>
                    <h2 class="text-3xl font-orbitron">ç„¡é™å›å»Š</h2>
                </header>
                <main class="w-full flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
                    <div class="md:w-1/3 h-full glass-panel p-6 flex flex-col items-center justify-center text-center">
                        <h3 class="text-2xl font-bold mb-4">ç¾åœ¨ã®è¨˜éŒ²</h3>
                        <p class="text-6xl font-orbitron text-cyan-300 mb-6"><span id="highest-floor-display">0</span>éš</p>
                        <button id="start-corridor-btn" class="btn-primary font-bold text-xl py-3 px-10 rounded-lg w-full">æŒ‘æˆ¦é–‹å§‹</button>
                        <p class="text-xs text-gray-400 mt-2">ç¾åœ¨ã®æœ€é«˜è¨˜éŒ²+1éšã‹ã‚‰é–‹å§‹ã—ã¾ã™</p>
                    </div>
                    <div class="md:w-2/3 h-full glass-panel p-4 flex flex-col">
                        <h3 class="text-xl font-bold mb-4 text-center">éšå±¤é”æˆå ±é…¬</h3>
                        <div id="corridor-rewards-list" class="flex-grow overflow-y-auto space-y-2 pr-2">
                            <!-- å ±é…¬ãƒªã‚¹ãƒˆã¯JSã§ç”Ÿæˆ -->
                        </div>
                    </div>
                </main>
            </div>
        </div>
        
        <!-- è–éºç‰©ç”»é¢ -->
        <div id="relic-screen" class="screen">
             <div class="w-full h-full flex flex-col p-4">
                <header class="w-full flex justify-between items-center mb-4"><button class="back-to-hub btn-secondary px-4 py-2 rounded-lg">&lt; å¸ä»¤å®¤ã¸</button><h2 class="text-3xl font-orbitron">è–éºç‰©</h2></header>
                <main class="w-full flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
                    <div class="md:w-1/3 h-full glass-panel p-4 flex flex-col">
                        <h3 class="text-xl font-bold mb-4 text-center">è£…å‚™ä¸­ã®è–éºç‰©</h3>
                        <div id="equipped-relics-container" class="grid grid-cols-2 gap-4 flex-grow"></div>
                        <div id="active-set-bonus-container" class="mt-4 glass-panel p-3"></div>
                    </div>
                    <div class="md:w-2/3 h-full glass-panel p-4 flex flex-col">
                        <div class="flex items-center justify-between mb-2">
                           <h3 class="text-xl font-bold text-center">æ‰€æŒè–éºç‰©</h3>
                           <div id="relic-filter-buttons" class="flex gap-1"></div>
                        </div>
                        <div id="relic-inventory-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 overflow-y-auto"></div>
                    </div>
                </main>
            </div>
        </div>

        <!-- æˆ¦é—˜ç”»é¢ -->
        <div id="battle-screen" class="screen items-center justify-center p-4">
            <div class="w-full h-full flex flex-col glass-panel p-6">
                <div id="battle-header" class="h-8 text-center text-2xl font-orbitron text-yellow-400"></div>
                <div id="turn-order-display" class="h-16 w-full flex justify-center items-center gap-2 mb-2"></div>
                <div id="enemy-area" class="flex-grow flex justify-around items-center"></div>
                <div id="party-shield-bar-container" class="w-full my-2"></div>
                <div id="battle-log" class="h-24 bg-black bg-opacity-50 rounded-lg p-2 my-2 overflow-y-auto text-sm"></div>
                <div id="party-buff-display" class="h-6 text-center font-bold"></div>
                <div id="player-area" class="flex justify-around items-center"></div>
                <div id="command-area" class="h-40 mt-4 flex justify-between items-center">
                    <div id="character-status-area" class="w-2/5 h-full flex flex-col justify-around"></div>
                    <div class="w-3/5 h-full flex flex-col items-center justify-center space-y-2">
                         <div id="action-point-display" class="flex items-center gap-1 text-2xl font-orbitron mb-2"></div>
                         <div id="action-buttons-area" class="w-full flex flex-col items-center justify-center space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ã‚¬ãƒãƒ£ç”»é¢ -->
        <div id="gacha-screen" class="screen items-center justify-center">
             <div class="w-full h-full flex flex-col p-4">
                <header class="w-full flex justify-between items-center mb-4"><button class="back-to-hub btn-secondary px-4 py-2 rounded-lg">&lt; å¸ä»¤å®¤ã¸</button><h2 class="text-3xl font-orbitron">é™è‡¨ã‚·ã‚¹ãƒ†ãƒ </h2></header>
                <main class="w-full flex-grow glass-panel flex flex-col items-center justify-around p-8">
                    <p class="text-xl">é™è‡¨ãƒã‚±ãƒƒãƒˆ: <span id="gacha-tickets-display"></span>æš</p>
                    <div class="flex w-full gap-4">
                        <div class="w-1/2 flex flex-col items-center glass-panel p-4">
                            <h3 class="text-2xl font-orbitron mb-4">æˆ¦å£«é™è‡¨</h3>
                            <p class="text-center text-sm mb-4"><span class="rarity-6">â˜…6: 0.2%</span> / <span class="rarity-5">â˜…5: 2%</span> / <span class="rarity-4">â˜…4: 10%</span></p>
                            <div class="w-full grid grid-cols-1 gap-2">
                                <button data-gacha-type="character" data-gacha-count="1" class="gacha-btn btn-primary font-bold text-lg py-2 px-6 rounded-lg">1å›é™è‡¨</button>
                                <button data-gacha-type="character" data-gacha-count="10" class="gacha-btn btn-primary font-bold text-lg py-2 px-6 rounded-lg">10å›é™è‡¨</button>
                                <button data-gacha-type="character" data-gacha-count="100" class="gacha-btn btn-primary font-bold text-lg py-2 px-6 rounded-lg">100å›é™è‡¨</button>
                            </div>
                        </div>
                        <div class="w-1/2 flex flex-col items-center glass-panel p-4">
                            <h3 class="text-2xl font-orbitron mb-4">å…µè£…é¡•ç¾</h3>
                            <p class="text-center text-sm mb-4"><span class="rarity-6">â˜…6: 0.3%</span> / <span class="rarity-5">â˜…5: 3%</span> / <span class="rarity-4">â˜…4: 15%</span></p>
                            <div class="w-full grid grid-cols-1 gap-2">
                                <button data-gacha-type="weapon" data-gacha-count="1" class="gacha-btn btn-primary font-bold text-lg py-2 px-6 rounded-lg">1å›é¡•ç¾</button>
                                <button data-gacha-type="weapon" data-gacha-count="10" class="gacha-btn btn-primary font-bold text-lg py-2 px-6 rounded-lg">10å›é¡•ç¾</button>
                                <button data-gacha-type="weapon" data-gacha-count="100" class="gacha-btn btn-primary font-bold text-lg py-2 px-6 rounded-lg">100å›é¡•ç¾</button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
        
        <!-- ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
        <div id="ending-screen" class="screen items-center justify-center text-center p-8">
            <div id="ending-content" class="glass-panel p-8 max-w-3xl"><h2 id="ending-title" class="text-4xl font-orbitron mb-6"></h2><p id="ending-text" class="text-lg leading-relaxed mb-8"></p><button class="back-to-hub btn-primary px-6 py-3 rounded-lg">è¨˜éŒ²ã‚’é–‰ã˜ã‚‹</button></div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ -->
        <div id="character-detail-modal" class="modal hidden"><div class="glass-panel w-11/12 max-w-4xl h-5/6 p-6 rounded-lg flex flex-col"><div id="character-detail-content" class="flex-grow overflow-y-auto"></div><button id="close-character-detail-btn" class="btn-secondary mt-4 py-2 px-4 rounded-lg self-center">é–‰ã˜ã‚‹</button></div></div>
        <div id="equipment-select-modal" class="modal hidden"><div class="glass-panel w-11/12 max-w-3xl h-4/6 p-6 rounded-lg flex flex-col"><h3 class="text-2xl font-bold mb-4 text-center font-orbitron">è£…å‚™é¸æŠ</h3><div id="equipment-select-list" class="flex-grow overflow-y-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div><button id="close-equipment-select-btn" class="btn-secondary mt-4 py-2 px-6 rounded-lg self-center">é–‰ã˜ã‚‹</button></div></div>
        <div id="equipment-detail-modal" class="modal hidden"><div class="glass-panel w-11/12 max-w-lg p-6 rounded-lg flex flex-col"><div id="equipment-detail-content" class="flex-grow overflow-y-auto"></div><div id="equipment-detail-buttons" class="flex justify-center gap-4 mt-4"></div></div></div>
        <div id="relic-detail-modal" class="modal hidden"><div class="glass-panel w-11/12 max-w-lg p-6 rounded-lg flex flex-col"><div id="relic-detail-content" class="flex-grow overflow-y-auto"></div><div id="relic-detail-buttons" class="flex justify-center gap-4 mt-4"></div></div></div>
        <div id="gacha-result-modal" class="modal hidden"><div class="glass-panel w-11/12 max-w-4xl h-5/6 p-6 rounded-lg flex flex-col"><h3 class="text-2xl font-bold mb-4 text-center font-orbitron">é™è‡¨çµæœ</h3><div id="gacha-result-list" class="flex-grow overflow-y-auto grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4"></div><button id="close-gacha-result-btn" class="btn-primary mt-4 py-2 px-6 rounded-lg self-center">ç¢ºèª</button></div></div>
        <div id="message-modal" class="modal hidden"><div class="glass-panel p-8 rounded-lg text-center max-w-sm"><p id="message-text" class="mb-6 text-lg"></p><button id="message-ok-btn" class="btn-primary px-6 py-2 rounded-lg">OK</button></div></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const screens = document.querySelectorAll('.screen');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const characterDetailModal = document.getElementById('character-detail-modal');
        const equipmentSelectModal = document.getElementById('equipment-select-modal');
        const equipmentDetailModal = document.getElementById('equipment-detail-modal');
        const gachaResultModal = document.getElementById('gacha-result-modal');
        const relicDetailModal = document.getElementById('relic-detail-modal');


        // --- ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚¿ãƒ¼ ---
        const GAME_DATA = {
            ATTRIBUTES: {
                erosion: { name: 'ä¾µé£Ÿ', symbol: 'â˜£ï¸', colorClass: 'attr-erosion' }, void: { name: 'è™šç„¡', symbol: 'ğŸŒŒ', colorClass: 'attr-void' },
                quantum: { name: 'é‡å­', symbol: 'âš›ï¸', colorClass: 'attr-quantum' }, causality: { name: 'å› æœ', symbol: 'âš–ï¸', colorClass: 'attr-causality' },
            },
            ROLES: {
                attacker: { name: 'ã‚¢ã‚¿ãƒƒã‚«ãƒ¼', symbol: 'âš”ï¸' }, shielder: { name: 'ã‚·ãƒ¼ãƒ«ãƒ€ãƒ¼', symbol: 'ğŸ›¡ï¸' },
                attack_buffer: { name: 'æ”»æ’ƒåŠ›ãƒãƒƒãƒ•ã‚¡ãƒ¼', symbol: 'âœ¨' }, healer: { name: 'ãƒ’ãƒ¼ãƒ©ãƒ¼', symbol: 'â¤ï¸' },
                ultimate_buffer: { name: 'çµ‚ç„‰ãƒãƒƒãƒ•ã‚¡ãƒ¼', symbol: 'âŒ›' }, speed_buffer: { name: 'é€Ÿåº¦ãƒãƒƒãƒ•ã‚¡ãƒ¼', symbol: 'ğŸš€' }, ap_buffer: { name: 'APãƒãƒƒãƒ•ã‚¡ãƒ¼', symbol: 'ğŸ”‹' },
            },
            ATTACKER_TYPES: {
                conventional: { name: 'å¾“æ¥å‹' },
                normal_enhance: { name: 'é€šå¸¸æ”»æ’ƒå¼·åŒ–å‹' },
                ultimate_special: { name: 'çµ‚ç„‰é–‹æ”¾å‹' },
                gauge_flexible: { name: 'ã‚²ãƒ¼ã‚¸è§£æ”¾å‹' }
            },
            RARITY: {
                3: { name: 'Rare', colorClass: 'rarity-3' }, 4: { name: 'Epic', colorClass: 'rarity-4' }, 5: { name: 'Legendary', colorClass: 'rarity-5' },
                6: { name: 'Mythic', colorClass: 'rarity-6' }
            },
            CHARACTERS: {
                c001: { name: 'ã‚¢ãƒ¬ã‚¹', symbol: 'âš”ï¸', rarity: 4, attribute: 'erosion', role: 'attacker', attackerType: 'normal_enhance', hp: 100, atk: 40, spd: 50, skills: { otherworld: { name: 'ãƒ¬ã‚¤ã‚¸ãƒ³ã‚°ã‚¢ã‚µãƒ«ãƒˆ', cost: 1, effect: { type: 'self_buff', buffTarget: 'normal_attack', power: 2.5, duration: 3 }, desc: "æ¬¡ã®3ã‚¿ãƒ¼ãƒ³ã€é€šå¸¸æ”»æ’ƒã‚’å¤§å¹…ã«å¼·åŒ–ã™ã‚‹ã€‚" }, ultimate: { name: 'ãƒãƒ¼ãƒŸãƒªã‚ªãƒ³ã‚¨ãƒƒã‚¸', cost: 100, effect: { type: 'damage', power: 3.0, target: 'all' }, desc: "æ•µå…¨ä½“ã«å¼·åŠ›ãªãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚" } }, potentials: [ { name: "é—˜äº‰æœ¬èƒ½", desc: "è‡ªèº«ã®HPãŒ50%ä»¥ä¸‹ã®æ™‚ã€ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ20%å¢—åŠ ã™ã‚‹ã€‚", unlock: { level: 40 }, effect: { type: 'conditional_damage_buff', threshold: 0.5, multiplier: 1.2 } } ] },
                c002: { name: 'ã‚¢ãƒ«ãƒ†ãƒŸã‚¹', symbol: 'ğŸ¹', rarity: 4, attribute: 'quantum', role: 'attacker', attackerType: 'gauge_flexible', hp: 90, atk: 45, spd: 60, skills: { otherworld: { name: 'ã‚¯ã‚¤ãƒƒã‚¯ã‚·ãƒ§ãƒƒãƒˆ', cost: 1, effect: { type: 'damage', power: 1.5 }, desc: "æ•µå˜ä½“ã«ç´ æ—©ã„ä¸€æ’ƒã‚’æ”¾ã¤ã€‚" }, ultimate: { name: 'ãƒ ãƒ¼ãƒ³ãƒ©ã‚¤ãƒˆã‚¸ãƒ£ãƒƒã‚¸ãƒ¡ãƒ³ãƒˆ', cost: 100, effect: { type: 'damage', power: 3.5 }, desc: "ã‚²ãƒ¼ã‚¸ã‚’å…¨ã¦æ¶ˆè²»ã—ã€é‡ã«å¿œã˜ãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚" } }, potentials: [ { name: "æœˆå…‰ã®åŠ è­·", desc: "è‡ªèº«ã®HPãŒæº€ã‚¿ãƒ³ã®æ™‚ã€é€Ÿåº¦ãŒ20%å¢—åŠ ã™ã‚‹ã€‚", unlock: { limitBreak: 1 }, effect: { type: 'conditional_stat_buff', stat: 'spd', multiplier: 1.2 } } ] },
                c003: { name: 'ãƒ˜ãƒ«ãƒ¡ã‚¹', symbol: 'ğŸ•Šï¸', rarity: 4, attribute: 'void', role: 'attack_buffer', hp: 120, atk: 25, spd: 40, skills: { otherworld: { name: 'ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ã‚¹', cost: 1, effect: { type: 'buff', buffType: 'damage', multiplier: 1.3, dupeBonus: 0.05, duration: 2, target: 'party' } }, ultimate: { name: 'ã‚¯ãƒ­ãƒãƒ–ãƒ¼ã‚¹ãƒˆ', cost: 110, effect: { type: 'buff', buffType: 'damage', multiplier: 1.7, dupeBonus: 0.1, duration: 3, target: 'party' } } }, potentials: [ { name: "ç¥é€Ÿ", desc: "æˆ¦é—˜é–‹å§‹æ™‚ã€å‘³æ–¹å…¨ä½“ã®é€Ÿåº¦ã‚’1ã‚¿ãƒ¼ãƒ³15%ä¸Šæ˜‡ã•ã›ã‚‹ã€‚", unlock: { level: 40 }, effect: { type: 'battle_start_buff', buffType: 'speed', multiplier: 1.15, duration: 1, target: 'party' } } ] },
                c004: { name: 'ã‚¼ã‚¦ã‚¹', symbol: 'âš¡ï¸', rarity: 5, attribute: 'quantum', role: 'attacker', attackerType: 'conventional', hp: 200, atk: 100, spd: 85, skills: { otherworld: { name: 'ã‚µãƒ³ãƒ€ãƒ¼ãƒœãƒ«ãƒˆ', cost: 1, effect: { type: 'damage', power: 1.9 }, desc: "æ•µå˜ä½“ã«å¼·åŠ›ãªé›·æ’ƒã‚’æ”¾ã¤ã€‚" }, ultimate: { name: 'ã‚¯ãƒ­ãƒãƒ‰ãƒ©ã‚¤ãƒ–', cost: 120, effect: { type: 'damage', power: 3.8, target: 'all' }, desc: "æ•µå…¨ä½“ã«æ™‚ç©ºã‚’æ­ªã‚ã‚‹ã»ã©ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚" } }, potentials: [ { name: "ç¥ã€…ã®ç‹", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã«ã„ã‚‹ã ã‘ã§å‘³æ–¹å…¨ä½“ã®æ”»æ’ƒåŠ›ãŒ5%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { limitBreak: 2 }, effect: { type: 'party_passive_stat_buff', stat: 'atk', multiplier: 1.05 } } ] },
                c005: { name: 'ãƒãƒ‡ã‚¹', symbol: 'ğŸ’€', rarity: 5, attribute: 'void', role: 'shielder', hp: 280, atk: 55, spd: 60, skills: { otherworld: { name: 'ã‚½ã‚¦ãƒ«ã‚¬ãƒ¼ãƒ‰', cost: 1, effect: { type: 'shield', power: 1.2, target: 'party' } }, ultimate: { name: 'ã‚¿ãƒŠãƒˆã‚¹ã‚¦ã‚©ãƒ¼ãƒ«', cost: 120, effect: { type: 'shield', power: 1.8, target: 'party' } } }, potentials: [ { name: "å†¥ç‹ã®æ¨©å¨", desc: "è‡ªèº«ã«ã‚·ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹æ™‚ã€æ”»æ’ƒåŠ›ãŒ30%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { level: 50 }, effect: { type: 'conditional_stat_buff', stat: 'atk', multiplier: 1.3 } } ] },
                c006: { name: 'ã‚¢ãƒãƒ­ãƒ³', symbol: 'â˜€ï¸', rarity: 5, attribute: 'erosion', role: 'healer', hp: 230, atk: 65, spd: 75, skills: { otherworld: { name: 'ãƒ’ãƒ¼ãƒªãƒ³ã‚°ãƒ©ã‚¤ãƒˆ', cost: 1, effect: { type: 'heal', power: 0.5, target: 'party' } }, ultimate: { name: 'ã‚½ãƒ¼ãƒ©ãƒ¼ã‚°ãƒ¬ã‚¤ã‚¹', cost: 120, effect: { type: 'heal', power: 1.0, target: 'party' } } }, potentials: [ { name: "å…‰æ˜", desc: "å›å¾©ã‚¹ã‚­ãƒ«ã®åŠ¹æœãŒ15%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { limitBreak: 1 }, effect: { type: 'heal_power_buff', multiplier: 1.15 } } ] },
                c007: { name: 'ã‚¯ãƒ­ãƒã‚¹', symbol: 'â³', rarity: 6, attribute: 'quantum', role: 'attack_buffer', hp: 400, atk: 130, spd: 110, skills: { otherworld: { name: 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¯ã‚»ãƒ«', cost: 2, effect: { type: 'buff', buffType: 'damage', multiplier: 1.8, dupeBonus: 0.1, duration: 3, target: 'party' } }, ultimate: { name: 'ã‚¸ã‚§ãƒã‚·ã‚¹ãƒ»ã‚¼ãƒ­', cost: 200, effect: { type: 'buff', buffType: 'damage', multiplier: 3.0, dupeBonus: 0.15, duration: 3, target: 'party' } } }, potentials: [ { name: "æ™‚ã®æ”¯é…è€…", desc: "æˆ¦é—˜é–‹å§‹æ™‚ã€è‡ªèº«ã®çµ‚ç„‰ã‚²ãƒ¼ã‚¸ã‚’50ãƒãƒ£ãƒ¼ã‚¸ã™ã‚‹ã€‚", unlock: { limitBreak: 2 }, effect: { type: 'battle_start_self_gauge', amount: 50 } } ] },
                c008: { name: 'ã‚«ã‚ªã‚¹', symbol: 'ğŸŒ€', rarity: 6, attribute: 'erosion', role: 'attacker', attackerType: 'ultimate_special', hp: 450, atk: 160, spd: 95, skills: { otherworld: { name: 'ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒ–ãƒ¬ã‚¤ã‚¯', cost: 1, effect: { type: 'damage', power: 2.5 }, desc: "æ•µå˜ä½“ã«æ¬¡å…ƒã‚’åˆ‡ã‚Šè£‚ãä¸€æ’ƒã‚’ä¸ãˆã‚‹ã€‚" }, ultimate: { name: 'ã‚¼ãƒ­ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³', cost: 200, effect: { type: 'self_buff', buffTarget: 'otherworld_attack', power: 1.5, duration: 3, isFree: true }, desc: "æ¬¡ã®3ã‚¿ãƒ¼ãƒ³ã€APæ¶ˆè²»ãªã—ã§å¼·åŒ–ã•ã‚ŒãŸç•°ç•Œæ”»æ’ƒã‚’æ”¾ã¤ã€‚" } }, potentials: [ { name: "æ··æ²Œã®æ·±æ·µ", desc: "æ”»æ’ƒæ™‚ã€10%ã®ç¢ºç‡ã§æ•µã®é˜²å¾¡åŠ›ã‚’1ã‚¿ãƒ¼ãƒ³ç„¡è¦–ã™ã‚‹ã€‚", unlock: { limitBreak: 3 }, effect: { type: 'on_attack_ignore_def', chance: 0.1 } } ] },
                c009: { name: 'ãƒ‹ã‚¯ã‚¹', symbol: 'ğŸŒ™', rarity: 6, attribute: 'void', role: 'shielder', hp: 550, atk: 110, spd: 90, skills: { otherworld: { name: 'ã‚¨ã‚¿ãƒ¼ãƒŠãƒ«ãƒŠã‚¤ãƒˆ', cost: 1, effect: { type: 'shield', power: 1.5, target: 'party' } }, ultimate: { name: 'ã‚¨ãƒ³ãƒ—ãƒ†ã‚£ãƒ»ã‚´ãƒƒãƒ‰', cost: 200, effect: { type: 'shield', power: 2.5, target: 'party' } } }, potentials: [ { name: "å¤œã®å¸³", desc: "æˆ¦é—˜é–‹å§‹æ™‚ã€å‘³æ–¹å…¨ä½“ã«è‡ªèº«ã®æœ€å¤§HPã®10%åˆ†ã®ã‚·ãƒ¼ãƒ«ãƒ‰ã‚’ä»˜ä¸ã™ã‚‹ã€‚", unlock: { limitBreak: 1 }, effect: { type: 'battle_start_shield', power: 0.1 } } ] },
                c010: { name: 'ã‚¢ãƒ†ãƒŠ', symbol: 'ğŸ¦‰', rarity: 5, attribute: 'causality', role: 'shielder', hp: 260, atk: 60, spd: 70, skills: { otherworld: { name: 'çµ¶å¯¾é˜²å¾¡', cost: 1, effect: { type: 'shield', power: 1.6, target: 'party' } }, ultimate: { name: 'ãƒ‘ãƒ«ãƒ†ãƒãƒ³ãƒ»ã‚¸ãƒ£ãƒƒã‚¸', cost: 130, effect: { type: 'shield', power: 2.5, target: 'party' } } }, potentials: [ { name: "æˆ¦ç•¥çš„æ€è€ƒ", desc: "è‡ªèº«ãŒãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸæ™‚ã€15%ã®ç¢ºç‡ã§è‡ªèº«ã®çµ‚ç„‰ã‚²ãƒ¼ã‚¸ã‚’20ãƒãƒ£ãƒ¼ã‚¸ã™ã‚‹ã€‚", unlock: { level: 50 }, effect: { type: 'on_hit_gauge_charge', chance: 0.15, amount: 20 } } ] },
                c011: { name: 'ãƒã‚»ã‚¤ãƒ‰ãƒ³', symbol: 'ğŸ”±', rarity: 6, attribute: 'causality', role: 'attacker', attackerType: 'ultimate_special', hp: 500, atk: 155, spd: 100, skills: { otherworld: { name: 'ãƒˆãƒ©ã‚¤ãƒ‡ãƒ³ãƒˆã‚¿ã‚¤ãƒ‰', cost: 1, effect: { type: 'damage', power: 2.2 }, desc: "æ•µå˜ä½“ã«æ¿€æµã®ä¸€æ’ƒã‚’å©ãè¾¼ã‚€ã€‚" }, ultimate: { name: 'ãƒã‚¨ãƒ«ã‚¹ãƒˆãƒ­ãƒ ', cost: 210, effect: { type: 'self_buff', buffTarget: 'otherworld_attack', power: 1.4, duration: 3, isFree: true }, desc: "æ¬¡ã®3ã‚¿ãƒ¼ãƒ³ã€APæ¶ˆè²»ãªã—ã§å¼·åŒ–ã•ã‚ŒãŸç•°ç•Œæ”»æ’ƒã‚’æ”¾ã¤ã€‚" } }, potentials: [ { name: "å¤§æµ·ã®ä¸»", desc: "è‡ªèº«ã®HPãŒ80%ä»¥ä¸Šã®æ™‚ã€æ”»æ’ƒåŠ›ãŒ25%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { limitBreak: 1 }, effect: { type: 'conditional_stat_buff', stat: 'atk', multiplier: 1.25 } } ] },
                c012: { name: 'ãƒ˜ãƒ•ã‚¡ã‚¤ã‚¹ãƒˆã‚¹', symbol: 'ğŸ”¨', rarity: 4, attribute: 'erosion', role: 'shielder', hp: 130, atk: 32, spd: 30, skills: { otherworld: { name: 'ã‚¯ãƒ©ãƒ•ãƒˆã‚·ãƒ¼ãƒ«ãƒ‰', cost: 1, effect: { type: 'shield', power: 1.0, target: 'party' } }, ultimate: { name: 'ãƒœãƒ«ã‚«ãƒ‹ãƒƒã‚¯ã‚¬ãƒ¼ãƒ‰', cost: 100, effect: { type: 'shield', power: 1.8, target: 'party' } } }, potentials: [ { name: "è·äººã®é­‚", desc: "ä»˜ä¸ã™ã‚‹ã‚·ãƒ¼ãƒ«ãƒ‰ã®åŠ¹æœãŒ20%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { level: 40 }, effect: { type: 'shield_power_buff', multiplier: 1.2 } } ] },
                c013: { name: 'ã‚¢ãƒ•ãƒ­ãƒ‡ã‚£ãƒ¼ãƒ†', symbol: 'ğŸŒ¹', rarity: 4, attribute: 'causality', role: 'healer', hp: 110, atk: 28, spd: 55, skills: { otherworld: { name: 'ãƒãƒ£ãƒ¼ãƒ ã‚¦ã‚£ãƒ³ã‚¯', cost: 1, effect: { type: 'heal', power: 0.5, target: 'party' } }, ultimate: { name: 'ã‚¨ã‚¿ãƒ¼ãƒŠãƒ«ãƒ©ãƒ–', cost: 100, effect: { type: 'heal', power: 1.0, target: 'party' } } }, potentials: [ { name: "ç¾ã®å¥³ç¥", desc: "ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã€æœ€ã‚‚HPãŒä½ã„å‘³æ–¹1äººã®HPã‚’è‡ªèº«ã®æ”»æ’ƒåŠ›ã®50%åˆ†å›å¾©ã™ã‚‹ã€‚", unlock: { limitBreak: 1 }, effect: { type: 'turn_start_heal', power: 0.5 } } ] },
                c014: { name: 'ã‚ªãƒ¼ãƒ‡ã‚£ãƒ³', symbol: 'ğŸ‘ï¸', rarity: 6, attribute: 'causality', role: 'attacker', attackerType: 'conventional', hp: 420, atk: 175, spd: 105, skills: { otherworld: { name: 'ã‚°ãƒ³ã‚°ãƒ‹ãƒ«', cost: 1, effect: { type: 'damage', power: 2.8 }, desc: "æ•µå˜ä½“ã‚’è²«ãå¿…ä¸­ã®ä¸€æ’ƒã€‚" }, ultimate: { name: 'ãƒ©ã‚°ãƒŠãƒ­ã‚¯', cost: 220, effect: { type: 'damage', power: 5.5, target: 'all' }, desc: "æ•µå…¨ä½“ã«çµ‚æœ«ã‚’ã‚‚ãŸã‚‰ã™æ”»æ’ƒã€‚" } }, potentials: [ { name: "ãƒ«ãƒ¼ãƒ³ã®å¡æ™º", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã«ã„ã‚‹ã ã‘ã§å‘³æ–¹å…¨ä½“ã®çµ‚ç„‰ã‚²ãƒ¼ã‚¸ç²å¾—é‡ãŒ5%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { limitBreak: 3 }, effect: { type: 'party_passive_gauge_buff', multiplier: 1.05 } } ] },
                c015: { name: 'ãƒˆãƒ¼ãƒ«', symbol: 'ğŸ”¨âš¡ï¸', rarity: 5, attribute: 'quantum', role: 'attacker', attackerType: 'gauge_flexible', hp: 280, atk: 105, spd: 80, skills: { otherworld: { name: 'ãƒŸãƒ§ãƒ«ãƒ‹ãƒ«', cost: 1, effect: { type: 'damage', power: 2.0 }, desc: "æ•µå˜ä½“ã«é‰„æ§Œã‚’æŒ¯ã‚Šä¸‹ã‚ã™ã€‚" }, ultimate: { name: 'ãƒ©ã‚°ãƒŠãƒ­ã‚¯ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼', cost: 130, effect: { type: 'damage', power: 5.0, target: 'all' }, desc: "ã‚²ãƒ¼ã‚¸ã‚’å…¨ã¦æ¶ˆè²»ã—ã€é‡ã«å¿œã˜ãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’æ•µå…¨ä½“ã«ä¸ãˆã‚‹ã€‚" } }, potentials: [ { name: "é›·ç¥ã®æ†¤æ€’", desc: "æ”»æ’ƒæ™‚ã€20%ã®ç¢ºç‡ã§è¿½åŠ ã§æ”»æ’ƒåŠ›ã®50%åˆ†ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚", unlock: { limitBreak: 2 }, effect: { type: 'on_attack_extra_damage', chance: 0.2, power: 0.5 } } ] },
                c016: { name: 'ãƒ­ã‚­', symbol: 'ğŸ', rarity: 5, attribute: 'void', role: 'attack_buffer', hp: 220, atk: 70, spd: 90, skills: { otherworld: { name: 'å¹»å½±ã®å›ã', cost: 1, effect: { type: 'buff', buffType: 'damage', multiplier: 1.6, dupeBonus: 0.08, duration: 3, target: 'party' } }, ultimate: { name: 'ãƒˆãƒªãƒƒã‚¯ãƒ‡ã‚¹ã‚¿ãƒ¼', cost: 125, effect: { type: 'buff', buffType: 'damage', multiplier: 2.2, dupeBonus: 0.12, duration: 3, target: 'party' } } }, potentials: [ { name: "ãƒˆãƒªãƒƒã‚¯ã‚¹ã‚¿ãƒ¼", desc: "è‡ªèº«ãŒä»˜ä¸ã™ã‚‹ãƒãƒ•ã®åŠ¹æœã‚¿ãƒ¼ãƒ³ãŒ1å»¶é•·ã•ã‚Œã‚‹ã€‚", unlock: { level: 50 }, effect: { type: 'buff_duration_increase', amount: 1 } } ] },
                c017: { name: 'ã‚¢ãƒãƒ†ãƒ©ã‚¹', symbol: 'â›©ï¸', rarity: 6, attribute: 'causality', role: 'healer', hp: 520, atk: 125, spd: 98, skills: { otherworld: { name: 'å¤©å²©æˆ¸ã®å…‰', cost: 1, effect: { type: 'heal', power: 0.6, target: 'party' } }, ultimate: { name: 'å…«å’«é¡ã®è£ã', cost: 210, effect: { type: 'heal', power: 1.2, target: 'party' } } }, potentials: [ { name: "å¤ªé™½ç¥", desc: "è‡ªèº«ãŒæˆ¦é—˜ä¸èƒ½ã«ãªã£ãŸæ™‚ã€ä¸€åº¦ã ã‘HP50%ã§å¾©æ´»ã™ã‚‹ã€‚", unlock: { limitBreak: 4 }, effect: { type: 'self_revive', hp_percent: 0.5 } } ] },
                c018: { name: 'ã‚¹ã‚µãƒã‚ª', symbol: 'ğŸŒªï¸', rarity: 5, attribute: 'erosion', role: 'attacker', attackerType: 'normal_enhance', hp: 260, atk: 110, spd: 88, skills: { otherworld: { name: 'å‰£ã®èˆ', cost: 1, effect: { type: 'self_buff', buffTarget: 'normal_attack', power: 2.8, duration: 2 }, desc: "æ¬¡ã®2ã‚¿ãƒ¼ãƒ³ã€é€šå¸¸æ”»æ’ƒã‚’æ¥µåº¦ã«å¼·åŒ–ã™ã‚‹ã€‚" }, ultimate: { name: 'å¤©ç¾½ã€…æ–¬', cost: 135, effect: { type: 'damage', power: 4.2 }, desc: "æ•µå˜ä½“ã«æ¸¾èº«ã®åŠ›ã‚’è¾¼ã‚ãŸæ–¬æ’ƒã‚’æ”¾ã¤ã€‚" } }, potentials: [ { name: "è’ã¶ã‚‹ç¥", desc: "æ•µã‚’å€’ã—ãŸæ™‚ã€è‡ªèº«ã®APã‚’1å›å¾©ã™ã‚‹ã€‚", unlock: { limitBreak: 2 }, effect: { type: 'on_kill_ap_gain', amount: 1 } } ] },
                c019: { name: 'ãƒ©ãƒ¼', symbol: 'ğ“‚€', rarity: 6, attribute: 'quantum', role: 'attacker', attackerType: 'conventional', hp: 410, atk: 180, spd: 115, skills: { otherworld: { name: 'å¤ªé™½é¢¨', cost: 2, effect: { type: 'damage', power: 2.5, target: 'all' }, desc: "æ•µå…¨ä½“ã«ç¼ç†±ã®é¢¨ã‚’æµ´ã³ã›ã‚‹ã€‚" }, ultimate: { name: 'ã‚¢ãƒˆã‚¥ãƒ ã®å‰µé€ ', cost: 200, effect: { type: 'damage', power: 5.2, target: 'all' }, desc: "æ•µå…¨ä½“ã‚’ç„¼ãå°½ãã™åŸåˆã®å…‰ã‚’æ”¾ã¤ã€‚" } }, potentials: [ { name: "å‰µé€ ä¸»", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã«ã„ã‚‹ã ã‘ã§å‘³æ–¹å…¨ä½“ã®HPãŒ5%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { limitBreak: 1 }, effect: { type: 'party_passive_stat_buff', stat: 'hp', multiplier: 1.05 } } ] },
                c020: { name: 'ã‚¢ãƒŒãƒ“ã‚¹', symbol: 'âš–ï¸ğŸº', rarity: 5, attribute: 'void', role: 'healer', hp: 300, atk: 65, spd: 72, skills: { otherworld: { name: 'é­‚ã®å¤©ç§¤', cost: 1, effect: { type: 'heal', power: 0.4, target: 'party' } }, ultimate: { name: 'å†¥åºœã®å†ç”Ÿ', cost: 120, effect: { type: 'heal', power: 0.8, target: 'party' } } }, potentials: [ { name: "é­‚ã®å°ãæ‰‹", desc: "HPãŒ50%ä»¥ä¸‹ã®å‘³æ–¹ã‚’å›å¾©ã™ã‚‹æ™‚ã€å›å¾©é‡ãŒ30%å¢—åŠ ã™ã‚‹ã€‚", unlock: { level: 50 }, effect: { type: 'conditional_heal_buff', threshold: 0.5, multiplier: 1.3 } } ] },
                c021: { name: 'ã‚¯ãƒˆã‚¥ãƒ«ãƒ•', symbol: 'ğŸ™', rarity: 6, attribute: 'erosion', role: 'shielder', hp: 650, atk: 105, spd: 85, skills: { otherworld: { name: 'æ·±æ·µã®å‘¼ã³å£°', cost: 2, effect: { type: 'shield', power: 1.5, target: 'party' } }, ultimate: { name: 'ãƒ«ãƒ«ã‚¤ã‚¨æµ®ä¸Š', cost: 250, effect: { type: 'shield', power: 2.8, target: 'party' } } }, potentials: [ { name: "ç‹‚æ°—ã®å…ˆè§¦ã‚Œ", desc: "æ•µå…¨ä½“ã«ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã€ã‚¯ãƒˆã‚¥ãƒ«ãƒ•ã®æœ€å¤§HPã®5%åˆ†ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚", unlock: { limitBreak: 4 }, effect: { type: 'end_of_turn_dot', power: 0.05, target: 'all_enemies' } } ] },
                c022: { name: 'ãƒ˜ã‚«ãƒ†ãƒ¼', symbol: 'ğŸ—ï¸', rarity: 4, attribute: 'void', role: 'ap_buffer', hp: 115, atk: 30, spd: 45, skills: { otherworld: { name: 'é­”åŠ›ã®æºæ³‰', cost: 1, effect: { type: 'ap_gain', amount: 2 } }, ultimate: { name: 'ãƒˆãƒªãƒ—ãƒ«ãƒ»ãƒãƒ£ãƒ¼ã‚¸', cost: 100, effect: { type: 'ap_gain', amount: 3 } } }, potentials: [ { name: "é­”è¡“ã®å¥³ç‹", desc: "æˆ¦é—˜é–‹å§‹æ™‚ã€APã‚’1ç²å¾—ã™ã‚‹ã€‚", unlock: { level: 40 }, effect: { type: 'battle_start_ap_gain', amount: 1 } } ] },
                c023: { name: 'ã‚¤ãƒªã‚¹', symbol: 'ğŸŒˆ', rarity: 4, attribute: 'quantum', role: 'ultimate_buffer', hp: 125, atk: 28, spd: 52, skills: { otherworld: { name: 'è™¹ã®æ¶ã‘æ©‹', cost: 1, effect: { type: 'ultimate_gauge_charge', amount: 20, target: 'party' } }, ultimate: { name: 'ãƒ—ãƒªã‚ºãƒ ãƒ»ãƒ•ãƒ©ãƒƒãƒ‰', cost: 100, effect: { type: 'ultimate_gauge_charge', amount: 40, target: 'party' } } }, potentials: [ { name: "ä¼ä»¤ç¥", desc: "è‡ªèº«ãŒè¡Œå‹•ã—ãŸå¾Œã€10%ã®ç¢ºç‡ã§å†åº¦è¡Œå‹•ã™ã‚‹ã€‚", unlock: { limitBreak: 1 }, effect: { type: 'action_extra_turn', chance: 0.1 } } ] },
                c024: { name: 'ã‚¢ã‚¤ã‚ªãƒ­ã‚¹', symbol: 'ğŸ’¨', rarity: 4, attribute: 'erosion', role: 'speed_buffer', hp: 100, atk: 33, spd: 65, skills: { otherworld: { name: 'è¿½ã„é¢¨', cost: 1, effect: { type: 'buff', buffType: 'speed', multiplier: 1.2, dupeBonus: 0.02, duration: 2, target: 'party' } }, ultimate: { name: 'æš´é¢¨é™£', cost: 110, effect: { type: 'buff', buffType: 'speed', multiplier: 1.4, dupeBonus: 0.05, duration: 2, target: 'party' } } }, potentials: [ { name: "é¢¨ã®ç‹", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã®é€Ÿåº¦ãŒæœ€ã‚‚é€Ÿã„ã€‚", unlock: { level: 40 }, effect: { type: 'always_fastest' } } ] },
                c025: { name: 'ã‚¦ãƒ©ãƒã‚¹', symbol: 'ğŸŒŒ', rarity: 5, attribute: 'void', role: 'ap_buffer', hp: 220, atk: 60, spd: 70, skills: { otherworld: { name: 'æ˜Ÿã€…ã®æ¯å¹', cost: 1, effect: { type: 'ap_gain', amount: 3 } }, ultimate: { name: 'ã‚®ãƒ£ãƒ©ã‚¯ã‚·ãƒ¼ãƒ»ãƒ•ãƒ­ãƒ¼', cost: 130, effect: { type: 'ap_gain', amount: 4 } } }, potentials: [ { name: "å¤©ç©ºç¥", desc: "ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã€25%ã®ç¢ºç‡ã§APã‚’1ç²å¾—ã™ã‚‹ã€‚", unlock: { level: 50 }, effect: { type: 'turn_start_ap_gain', chance: 0.25, amount: 1 } } ] },
                c026: { name: 'ãƒ¢ã‚¤ãƒ©', symbol: 'ğŸ•¸ï¸', rarity: 5, attribute: 'causality', role: 'ultimate_buffer', hp: 250, atk: 55, spd: 75, skills: { otherworld: { name: 'é‹å‘½ã®ç³¸è»Š', cost: 1, effect: { type: 'ultimate_gauge_charge', amount: 30, target: 'party' } }, ultimate: { name: 'çµ‚ç„‰ã¸ã®ç´¡ãæ­Œ', cost: 120, effect: { type: 'ultimate_gauge_charge', amount: 60, target: 'party' } } }, potentials: [ { name: "é‹å‘½ã®ä¸‰å¥³ç¥", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã«ã„ã‚‹ã ã‘ã§å‘³æ–¹å…¨ä½“ã®å—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’5%è»½æ¸›ã™ã‚‹ã€‚", unlock: { limitBreak: 2 }, effect: { type: 'party_passive_damage_reduction', multiplier: 0.95 } } ] },
                c027: { name: 'ãƒ¤ãƒŒã‚¹', symbol: 'ğŸšª', rarity: 5, attribute: 'quantum', role: 'speed_buffer', hp: 210, atk: 65, spd: 92, skills: { otherworld: { name: 'æœªæ¥ã¸ã®æ‰‰', cost: 1, effect: { type: 'buff', buffType: 'speed', multiplier: 1.3, dupeBonus: 0.03, duration: 3, target: 'party' } }, ultimate: { name: 'äºŒã¤ã®é¡”ã®åŠ é€Ÿ', cost: 125, effect: { type: 'buff', buffType: 'speed', multiplier: 1.6, dupeBonus: 0.06, duration: 3, target: 'party' } } }, potentials: [ { name: "å§‹ã¾ã‚Šã¨çµ‚ã‚ã‚Š", desc: "æˆ¦é—˜ã®æœ€åˆã®ã‚¿ãƒ¼ãƒ³ã¨5ã‚¿ãƒ¼ãƒ³æ¯ã«ã€å‘³æ–¹å…¨ä½“ã®APã‚’1å›å¾©ã™ã‚‹ã€‚", unlock: { limitBreak: 1 }, effect: { type: 'turn_based_ap_gain', turn_interval: 5, amount: 1 } } ] },
                c028: { name: 'ãƒ—ãƒ­ãƒ¡ãƒ†ã‚¦ã‚¹', symbol: 'ğŸ”¥', rarity: 6, attribute: 'erosion', role: 'ap_buffer', hp: 430, atk: 120, spd: 95, skills: { otherworld: { name: 'ç¥ã€…ã®ç«', cost: 1, effect: { type: 'ap_gain', amount: 4 } }, ultimate: { name: 'ç„¡é™ã®å¡æ™º', cost: 200, effect: { type: 'ap_max_up', amount: 1 } } }, potentials: [ { name: "äººé¡ã®æ©äºº", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã«ã„ã‚‹ã ã‘ã§ã€æˆ¦é—˜ã§ç²å¾—ã™ã‚‹è³‡æºãŒ10%å¢—åŠ ã™ã‚‹ã€‚", unlock: { limitBreak: 1 }, effect: { type: 'resource_gain_buff', multiplier: 1.1 } } ] },
                c029: { name: 'ãƒ¡ãƒ†ã‚£ã‚¹', symbol: 'ğŸ’¡', rarity: 6, attribute: 'causality', role: 'ultimate_buffer', hp: 480, atk: 115, spd: 105, skills: { otherworld: { name: 'é–ƒå…‰ã®å•“ç¤º', cost: 1, effect: { type: 'ultimate_gauge_charge', amount: 50, target: 'party' } }, ultimate: { name: 'ã‚¢ãƒ†ãƒŠã®èª•ç”Ÿ', cost: 210, effect: { type: 'ultimate_gauge_charge', amount: 100, target: 'party' } } }, potentials: [ { name: "å¡æ™ºã®å¥³ç¥", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã«ã„ã‚‹ã ã‘ã§ã€æˆ¦é—˜ã§ç²å¾—ã™ã‚‹ãƒã‚±ãƒƒãƒˆãŒ5%å¢—åŠ ã™ã‚‹ã€‚", unlock: { limitBreak: 2 }, effect: { type: 'ticket_gain_buff', multiplier: 1.05 } } ] },
                c030: { name: 'ãƒ˜ãƒ«ãƒ¡ã‚¹ãƒ»ãƒˆãƒªã‚¹ãƒ¡ã‚®ã‚¹ãƒˆã‚¹', symbol: 'ğŸ“œ', rarity: 6, attribute: 'void', role: 'speed_buffer', hp: 410, atk: 130, spd: 120, skills: { otherworld: { name: 'ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ', cost: 1, effect: { type: 'buff', buffType: 'speed', multiplier: 1.5, dupeBonus: 0.05, duration: 3, target: 'party' } }, ultimate: { name: 'è¶…è¶Šã®ãƒ˜ãƒ«ãƒ¡ã‚¹ä¸»ç¾©', cost: 220, effect: { type: 'buff', buffType: 'speed', multiplier: 2.0, dupeBonus: 0.1, duration: 3, target: 'party' } } }, potentials: [ { name: "å”¯ä¸€ç¥", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã«3äººä»¥ä¸Šã®è™šç„¡å±æ€§ãŒã„ã‚‹æ™‚ã€è‡ªèº«ã®å…¨èƒ½åŠ›ãŒ15%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { limitBreak: 3 }, effect: { type: 'attribute_synergy_buff', attribute: 'void', threshold: 3, multiplier: 1.15 } } ] },
                c031: { name: 'ãƒ©ãƒ³ã‚¹ãƒ­ãƒƒãƒˆ', symbol: 'ğŸ›¡ï¸âš”ï¸', rarity: 5, attribute: 'quantum', role: 'attacker', attackerType: 'normal_enhance', hp: 290, atk: 100, spd: 82, skills: { otherworld: { name: 'æ¹–å…‰ã®å‰£é–ƒ', cost: 1, effect: { type: 'self_buff', buffTarget: 'normal_attack', power: 2.2, duration: 2}, desc: "æ¬¡ã®2ã‚¿ãƒ¼ãƒ³ã€é€šå¸¸æ”»æ’ƒã‚’å¼·åŒ–ã™ã‚‹ã€‚" }, ultimate: { name: 'ã‚¢ãƒ­ãƒ³ãƒ€ã‚¤ãƒˆãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰', cost: 130, effect: { type: 'damage', power: 4.5 }, desc: "æ•µå˜ä½“ã«é¨å£«ã®å…¨ã¦ã‚’è¾¼ã‚ãŸä¸€æ’ƒã‚’æ”¾ã¤ã€‚" } }, potentials: [ { name: "æ¹–ã®é¨å£«", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã«å¥³æ€§ãŒã„ã‚‹å ´åˆã€è‡ªèº«ã®æ”»æ’ƒåŠ›ãŒ15%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { level: 50 }, effect: { type: 'gender_synergy_buff' } } ] },
                c032: { name: 'ãƒãƒ¼ãƒªãƒ³', symbol: 'ğŸ§™â€â™‚ï¸', rarity: 6, attribute: 'causality', role: 'attack_buffer', hp: 420, atk: 140, spd: 112, skills: { otherworld: { name: 'è‹±é›„å‰µé€ ', cost: 1, effect: { type: 'buff', buffType: 'damage', multiplier: 1.9, dupeBonus: 0.1, duration: 3, target: 'party' } }, ultimate: { name: 'ã‚¢ãƒ´ã‚¡ãƒ­ãƒ³ã®åœ’', cost: 210, effect: { type: 'buff', buffType: 'damage', multiplier: 3.5, dupeBonus: 0.15, duration: 2, target: 'party' } } }, potentials: [ { name: "èŠ±ã®é­”è¡“å¸«", desc: "ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã€10%ã®ç¢ºç‡ã§è‡ªèº«ã®çµ‚ç„‰ã‚²ãƒ¼ã‚¸ã‚’100ãƒãƒ£ãƒ¼ã‚¸ã™ã‚‹ã€‚", unlock: { limitBreak: 2 }, effect: { type: 'turn_end_self_gauge', chance: 0.1, amount: 100 } } ] },
                c033: { name: 'ã‚®ãƒ«ã‚¬ãƒ¡ãƒƒã‚·ãƒ¥', symbol: 'ğŸ‘‘', rarity: 6, attribute: 'causality', role: 'attacker', attackerType: 'conventional', hp: 460, atk: 185, spd: 108, skills: { otherworld: { name: 'ç‹ã®è²¡å®', cost: 2, effect: { type: 'damage', power: 2.0, target: 'all' }, desc: "å®ç‰©åº«ã®æ­¦å…·ã‚’æ”¾ã¡ã€æ•µå…¨ä½“ã‚’æ”»æ’ƒã™ã‚‹ã€‚" }, ultimate: { name: 'å¤©åœ°ä¹–é›¢ã™é–‹é—¢ã®æ˜Ÿ', cost: 230, effect: { type: 'damage', power: 6.0, target: 'all' }, desc: "ä¹–é›¢å‰£ã‚¨ã‚¢ãŒç©ºé–“ã‚’æ–­è£‚ã•ã›ã€æ•µå…¨ä½“ã«çµ¶å¯¾çš„ãªãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚" } }, potentials: [ { name: "äººé¡æœ€å¤ã®è‹±é›„ç‹", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã«ã„ã‚‹ã ã‘ã§ã€å‘³æ–¹å…¨ä½“ã®è–éºç‰©ã®åŠ¹æœãŒ10%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { limitBreak: 4 }, effect: { type: 'relic_power_buff', multiplier: 1.1 } } ] },
                c034: { name: 'ã‚¯ãƒ¼ãƒ»ãƒ•ãƒ¼ãƒªãƒ³', symbol: 'ğŸ©¸', rarity: 5, attribute: 'erosion', role: 'attacker', attackerType: 'gauge_flexible', hp: 270, atk: 115, spd: 95, skills: { otherworld: { name: 'åˆºã—ç©¿ã¤æ­»æ£˜ã®æ§', cost: 1, effect: { type: 'damage', power: 2.2 }, desc: "æ•µå˜ä½“ã«å¿ƒè‡“ã‚’ç©¿ã¤ä¸€æ’ƒã‚’æ”¾ã¤ã€‚" }, ultimate: { name: 'çªãç©¿ã¤æ­»ç¿”ã®æ§', cost: 125, effect: { type: 'damage', power: 5.2, target: 'all' }, desc: "ã‚²ãƒ¼ã‚¸ã‚’å…¨ã¦æ¶ˆè²»ã—ã€å› æœã‚’é€†è»¢ã•ã›ã‚‹æ§ã‚’æ•µå…¨ä½“ã«æŠ•ã’æ”¾ã¤ã€‚" } }, potentials: [ { name: "æˆ¦é—˜ç¶šè¡Œ", desc: "HPãŒ0ã«ãªã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸæ™‚ã€ä¸€åº¦ã ã‘HP1ã§è€ãˆã‚‹ã€‚", unlock: { limitBreak: 2 }, effect: { type: 'guts' } } ] },
                c035: { name: 'ã‚·ãƒ´ã‚¡', symbol: 'ğŸ•‰ï¸', rarity: 6, attribute: 'erosion', role: 'attacker', attackerType: 'conventional', hp: 500, atk: 170, spd: 100, skills: { otherworld: { name: 'ç¬¬ä¸‰ã®ç›®', cost: 1, effect: { type: 'damage', power: 2.9 }, desc: "æ•µå˜ä½“ã‚’ç„¼ãå°½ãã™ç ´å£Šã®è¦–ç·šã€‚" }, ultimate: { name: 'ãƒãƒãƒ¼ãƒ—ãƒ©ãƒ©ãƒ¤', cost: 220, effect: { type: 'damage', power: 5.8, target: 'all' }, desc: "ä¸–ç•Œã‚’çµ‚ç„‰ã•ã›å†ç”Ÿã•ã›ã‚‹ã€å®‡å®™çš„ãªè¦æ¨¡ã®ç ´å£Šã‚’æ•µå…¨ä½“ã«ã‚‚ãŸã‚‰ã™ã€‚" } }, potentials: [ { name: "ç ´å£Šç¥", desc: "æ•µã‚’å€’ã—ãŸæ™‚ã€è‡ªèº«ã®çµ‚ç„‰ã‚²ãƒ¼ã‚¸ã‚’50ãƒãƒ£ãƒ¼ã‚¸ã™ã‚‹ã€‚", unlock: { limitBreak: 3 }, effect: { type: 'on_kill_self_gauge', amount: 50 } } ] },
                c036: { name: 'å­«æ‚Ÿç©º', symbol: 'ğŸ’', rarity: 6, attribute: 'quantum', role: 'attacker', attackerType: 'normal_enhance', hp: 440, atk: 165, spd: 118, skills: { otherworld: { name: 'å¦‚æ„é‡‘ç®æ£’', cost: 1, effect: { type: 'self_buff', buffTarget: 'normal_attack', power: 2.0, duration: 3 }, desc: "æ¬¡ã®3ã‚¿ãƒ¼ãƒ³ã€ä¼¸ç¸®è‡ªåœ¨ã®å¦‚æ„æ£’ã§é€šå¸¸æ”»æ’ƒã‚’å¼·åŒ–ã™ã‚‹ã€‚" }, ultimate: { name: 'å¤§é¬§å¤©å®®', cost: 200, effect: { type: 'damage', power: 5.0, target: 'all' }, desc: "å¤©ç•Œã‚’é¨’ãŒã›ãŸä¼èª¬ã®æˆ¦ã„ã‚’å†ç¾ã—ã€æ•µå…¨ä½“ã‚’è¹‚èº™ã™ã‚‹ã€‚" } }, potentials: [ { name: "æ–‰å¤©å¤§è–", desc: "HPãŒ0ã«ãªã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸæ™‚ã€HP1ã§è€ãˆã€è‡ªèº«ã®æ”»æ’ƒåŠ›ã‚’2ã‚¿ãƒ¼ãƒ³50%ä¸Šæ˜‡ã•ã›ã‚‹ã€‚", unlock: { limitBreak: 4 }, effect: { type: 'guts_and_buff', buffType: 'damage', multiplier: 1.5, duration: 2 } } ] },
                c037: { name: 'ãƒ™ãƒ¼ãƒ«ã‚¼ãƒ–ãƒ–', symbol: 'è¿', rarity: 6, attribute: 'void', role: 'attacker', attackerType: 'ultimate_special', hp: 470, atk: 175, spd: 102, skills: { otherworld: { name: 'ä¸‡é­”ã®è¨€éœŠ', cost: 1, effect: { type: 'damage', power: 2.4 }, desc: "æ•µå˜ä½“ã«å‘ªã„ã®è¨€è‘‰ã‚’æµ´ã³ã›ã‚‹ã€‚" }, ultimate: { name: 'è™šç©ºã®ç‹', cost: 210, effect: { type: 'self_buff', buffTarget: 'otherworld_attack', power: 1.6, duration: 2, isFree: true }, desc: "æ¬¡ã®2ã‚¿ãƒ¼ãƒ³ã€APæ¶ˆè²»ãªã—ã§å¼·åŒ–ã•ã‚ŒãŸç•°ç•Œæ”»æ’ƒã‚’æ”¾ã¤ã€‚" } }, potentials: [ { name: "è¿ã®ç‹", desc: "æ”»æ’ƒæ™‚ã€15%ã®ç¢ºç‡ã§æ•µã®æ”»æ’ƒåŠ›ã‚’1ã‚¿ãƒ¼ãƒ³20%ä½ä¸‹ã•ã›ã‚‹ã€‚", unlock: { limitBreak: 2 }, effect: { type: 'on_attack_debuff', chance: 0.15, debuff: 'atk_down', power: 0.8, duration: 1 } } ] },
                c038: { name: 'ãƒ¡ã‚¿ãƒˆãƒ­ãƒ³', symbol: 'ğŸ•', rarity: 6, attribute: 'quantum', role: 'ultimate_buffer', hp: 500, atk: 135, spd: 105, skills: { otherworld: { name: 'å¤©ã®æ›¸è¨˜', cost: 1, effect: { type: 'ultimate_gauge_charge', amount: 60, target: 'party' } }, ultimate: { name: 'ã‚·ãƒŠã‚¤ã®å•“ç¤º', cost: 180, effect: { type: 'ultimate_gauge_charge', amount: 120, target: 'party' } } }, potentials: [ { name: "å¥‘ç´„ã®å¤©ä½¿", desc: "ãƒ‘ãƒ¼ãƒ†ã‚£ã«ã„ã‚‹ã ã‘ã§ã€å‘³æ–¹å…¨ä½“ã®å¼±ä½“åŠ¹æœã¸ã®è€æ€§ãŒ10%ä¸Šæ˜‡ã™ã‚‹ã€‚", unlock: { limitBreak: 1 }, effect: { type: 'party_passive_debuff_resist', amount: 0.1 } } ] },
                c039: { name: 'ã‚¹ã‚«ã‚µãƒ', symbol: 'ğŸ§™â€â™€ï¸', rarity: 6, attribute: 'void', role: 'attacker', attackerType: 'conventional', hp: 430, atk: 190, spd: 115, skills: { otherworld: { name: 'å½±ã®å›½ã®é­”æ§', cost: 1, effect: { type: 'damage', power: 3.0 }, desc: "æ•µå˜ä½“ã«å½±ã®å›½ã‹ã‚‰ã®ä¸€æ’ƒã‚’æ”¾ã¤ã€‚" }, ultimate: { name: 'ã‚²ãƒ¼ãƒˆãƒ»ã‚ªãƒ–ãƒ»ã‚¹ã‚«ã‚¤', cost: 220, effect: { type: 'damage', power: 5.5, target: 'all' }, desc: "å½±ã®å›½ã®é–€ã‚’é–‹ãã€æ•µå…¨ä½“ã‚’ç•°æ¬¡å…ƒã«å¼•ããšã‚Šè¾¼ã‚€ã€‚" } }, potentials: [ { name: "ç¥æ®ºã—", desc: "ã€Œç¥ã€ç‰¹æ€§ã‚’æŒã¤æ•µã¸ã®ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ30%å¢—åŠ ã™ã‚‹ã€‚", unlock: { limitBreak: 3 }, effect: { type: 'trait_damage_buff', trait: 'god', multiplier: 1.3 } } ] },
                c040: { name: 'ã‚«ãƒ«ãƒŠ', symbol: 'â˜€ï¸ğŸ›¡ï¸', rarity: 5, attribute: 'causality', role: 'attacker', attackerType: 'gauge_flexible', hp: 300, atk: 120, spd: 85, skills: { otherworld: { name: 'æ—¥è¼ªã‚ˆã€å…·è¶³ã¨ãªã‚Œ', cost: 1, effect: { type: 'damage', power: 1.8 }, desc: "é»„é‡‘ã®é§ã®è¼ãã§æ•µå˜ä½“ã‚’æ”»æ’ƒã€‚" }, ultimate: { name: 'æ—¥è¼ªã‚ˆã€æ­»ã«éšãˆ', cost: 140, effect: { type: 'damage', power: 6.0 }, desc: "ã‚²ãƒ¼ã‚¸ã‚’å…¨ã¦æ¶ˆè²»ã—ã€å¿…æ»…ã®å…‰æ§ã‚’æ•µå˜ä½“ã«æ”¾ã¤ã€‚" } }, potentials: [ { name: "æ–½ã—ã®è‹±é›„", desc: "è‡ªèº«ãŒãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸæ™‚ã€å—ã‘ãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã®10%åˆ†ã€å‘³æ–¹å…¨ä½“ã®çµ‚ç„‰ã‚²ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒ¼ã‚¸ã™ã‚‹ã€‚", unlock: { level: 50 }, effect: { type: 'on_hit_party_gauge_charge', ratio: 0.1 } } ] },
                c_god_erosion: { name: 'ä¾µé£Ÿç¥', symbol: 'â˜£ï¸', rarity: 6, attribute: 'erosion', role: 'attacker', attackerType: 'conventional', hp: 600, atk: 170, spd: 120, skills: { otherworld: { name: 'ã‚³ã‚ºãƒŸãƒƒã‚¯ã‚¯ãƒ­ãƒ¼', cost: 1, effect: { type: 'damage', power: 2.8 } }, ultimate: { name: 'ã‚¨ã‚¯ãƒªãƒ—ã‚¹ãƒ»ã‚¨ãƒ³ãƒ‰', cost: 200, effect: { type: 'damage', power: 6.0, target: 'all' } } }, potentials: [] },
                c_god_void: { name: 'è™šç„¡ç¥', symbol: 'ğŸŒŒ', rarity: 6, attribute: 'void', role: 'shielder', hp: 800, atk: 110, spd: 110, skills: { otherworld: { name: 'ã‚¼ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰', cost: 1, effect: { type: 'shield', power: 2.0, target: 'party' } }, ultimate: { name: 'ã‚¤ãƒ™ãƒ³ãƒˆãƒ›ãƒ©ã‚¤ã‚¾ãƒ³', cost: 220, effect: { type: 'shield', power: 3.5, target: 'party' } } }, potentials: [] },
                c_god_quantum: { name: 'é‡å­ç¥', symbol: 'âš›ï¸', rarity: 6, attribute: 'quantum', role: 'attack_buffer', hp: 550, atk: 130, spd: 150, skills: { otherworld: { name: 'ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚½ãƒ¼ãƒˆ', cost: 1, effect: { type: 'buff', buffType: 'damage', multiplier: 1.9, dupeBonus: 0.1, duration: 3, target: 'party' } }, ultimate: { name: 'ã‚·ãƒ³ã‚®ãƒ¥ãƒ©ãƒªãƒ†ã‚£', cost: 240, effect: { type: 'buff', buffType: 'damage', multiplier: 3.2, dupeBonus: 0.2, duration: 4, target: 'party' } } }, potentials: [] },
                c_god_causality: { name: 'å› æœç¥', symbol: 'âš–ï¸', rarity: 6, attribute: 'causality', role: 'healer', hp: 700, atk: 120, spd: 130, skills: { otherworld: { name: 'ãƒªãƒãƒ¼ã‚¹ãƒ»ã‚¯ãƒ­ãƒ‹ã‚¯ãƒ«', cost: 1, effect: { type: 'heal', power: 0.8, target: 'party' } }, ultimate: { name: 'ã‚¢ã‚«ã‚·ãƒƒã‚¯ãƒ¬ã‚³ãƒ¼ãƒ‰', cost: 230, effect: { type: 'heal', power: 1.8, target: 'party' } } }, potentials: [] },
            },
            EQUIPMENT: {
                w001: { name: 'ãƒŠã‚¤ãƒˆã‚½ãƒ¼ãƒ‰', symbol: 'ğŸ—¡ï¸', rarity: 4, type: 'weapon', stats: { atk: 15 } }, a001: { name: 'ãƒãƒˆãƒ«ã‚¢ãƒ¼ãƒãƒ¼', symbol: 'ğŸ›¡ï¸', rarity: 4, type: 'armor', stats: { hp: 50 } },
                w002: { name: 'ãƒ«ãƒ¼ãƒ³ãƒ–ãƒ¬ãƒ¼ãƒ‰', symbol: 'ğŸ—¡ï¸', rarity: 5, type: 'weapon', stats: { atk: 40 } }, a002: { name: 'ãƒ•ã‚©ãƒ¼ã‚¹ãƒ—ãƒ¬ãƒ¼ãƒˆ', symbol: 'ğŸ›¡ï¸', rarity: 5, type: 'armor', stats: { hp: 120 } },
                w003: { name: 'ç¥æ®ºã—ã®å‰£', symbol: 'ğŸ—¡ï¸', rarity: 6, type: 'weapon', stats: { atk: 80, spd: 10 } }, a003: { name: 'å‰µç”Ÿã®é§', symbol: 'ğŸ›¡ï¸', rarity: 6, type: 'armor', stats: { hp: 250 } },
                w004: { name: 'æ™‚ç©ºã®å¼“', symbol: 'ğŸ¹', rarity: 5, type: 'weapon', stats: { atk: 35, spd: 5 } }, a004: { name: 'å› æœã®ãƒ­ãƒ¼ãƒ–', symbol: 'ğŸ‘˜', rarity: 5, type: 'armor', stats: { hp: 100 } },
                w005: { name: 'ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼', symbol: 'âš”ï¸âœ¨', rarity: 6, type: 'weapon', stats: { atk: 90 } }, a005: { name: 'ã‚¢ã‚¤ã‚®ã‚¹ã®ç›¾', symbol: 'ğŸ›¡ï¸âœ¨', rarity: 6, type: 'armor', stats: { hp: 200, spd: -10 } },
                w006: { name: 'ã‚°ãƒ³ã‚°ãƒ‹ãƒ«', symbol: 'â˜„ï¸', rarity: 6, type: 'weapon', stats: { atk: 85, spd: 15 } }, a006: { name: 'ãƒ‰ãƒ©ã‚´ãƒ³ãƒ¡ã‚¤ãƒ«', symbol: 'ğŸ‰', rarity: 5, type: 'armor', stats: { hp: 150, atk: 10 } },
                w007: { name: 'å¤©å¢é›²å‰£', symbol: 'ğŸŒ', rarity: 5, type: 'weapon', stats: { atk: 50, spd: 8 } }, a007: { name: 'è³¢è€…ã®çŸ³', symbol: 'ğŸ’', rarity: 6, type: 'armor', stats: { hp: 100, atk: 20, spd: 20 } },
                w008: { name: 'ã‚¢ã‚µã‚·ãƒ³ãƒ€ã‚¬ãƒ¼', symbol: 'ğŸ”ª', rarity: 4, type: 'weapon', stats: { atk: 10, spd: 12 } }, a008: { name: 'ãƒŸãƒ©ãƒ¼ã‚¸ãƒ¥ãƒ™ã‚¹ãƒˆ', symbol: 'ğŸ’¨', rarity: 4, type: 'armor', stats: { hp: 20, spd: 8 } },
                w009: { name: 'ã‚¢ãƒ­ãƒ³ãƒ€ã‚¤ãƒˆ', symbol: 'ğŸ—¡ï¸âœ¨', rarity: 6, type: 'weapon', stats: { atk: 88, spd: 5 } }, a009: { name: 'ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚­ãƒ£ãƒ¡ãƒ­ãƒƒãƒˆ', symbol: 'ğŸ°', rarity: 6, type: 'armor', stats: { hp: 300 } },
                w010: { name: 'ã‚²ã‚¤ãƒ»ãƒœãƒ«ã‚¯', symbol: 'âš¡ï¸', rarity: 5, type: 'weapon', stats: { atk: 60 } }, a010: { name: 'ãƒ—ãƒªãƒ‰ã‚¥ã‚¨ãƒ³', symbol: 'ğŸ›¡ï¸', rarity: 5, type: 'armor', stats: { hp: 180 } },
                w011: { name: 'å¦‚æ„æ£’', symbol: 'æ£', rarity: 6, type: 'weapon', stats: { atk: 80, spd: 20 } }, a011: { name: 'ã‚«ãƒ´ã‚¡ãƒ¼ãƒãƒ£ï¼†ã‚¯ãƒ³ãƒ€ãƒ¼ãƒ©', symbol: 'â˜€ï¸', rarity: 6, type: 'armor', stats: { hp: 200, atk: 20 } },
            },
            ENEMIES: {
                e001: { name: 'ä¸‹ç´šä¾µé£Ÿä½“', attribute: 'erosion', hp: 80, atk: 20, spd: 30, ticketDrop: { rate: 0.8, amount: [5, 7] } },
                e002: { name: 'å½·å¾¨ã†è™šç„¡', attribute: 'void', hp: 100, atk: 15, spd: 20, ticketDrop: { rate: 0.8, amount: [5, 7] } },
                e003: { name: 'é‡å­ãƒã‚¤ã‚º', attribute: 'quantum', hp: 60, atk: 25, spd: 40, ticketDrop: { rate: 0.8, amount: [5, 7] } },
                e004: { name: 'ä¸­ç´šä¾µé£Ÿä½“', attribute: 'erosion', hp: 250, atk: 50, spd: 35, ticketDrop: { rate: 1.0, amount: [7, 10] } },
                e005: { name: 'ã‚¢ãƒ“ã‚¹ã‚¦ã‚©ãƒƒãƒãƒ£ãƒ¼', attribute: 'void', hp: 300, atk: 40, spd: 30, ticketDrop: { rate: 1.0, amount: [7, 10] } },
                e006: { name: 'ä¸Šç´šé‡å­éœŠ', attribute: 'quantum', hp: 400, atk: 85, spd: 50, ticketDrop: { rate: 1.0, amount: [7, 10] } },
                e007: { name: 'å› æœã®æ®‹æ»“', attribute: 'causality', hp: 600, atk: 60, spd: 45, ticketDrop: { rate: 1.0, amount: [7, 10] } },
                e008: { name: 'ç•°å½¢ã®ç£', attribute: 'erosion', hp: 120, atk: 28, spd: 32, ticketDrop: { rate: 0.8, amount: [5, 7] } },
                e009: { name: 'ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰å…µ', attribute: 'void', hp: 150, atk: 22, spd: 18, ticketDrop: { rate: 0.8, amount: [5, 7] } },
                e010: { name: 'å •å¤©ä½¿ã®ä½¿ã„', attribute: 'quantum', hp: 550, atk: 120, spd: 55, ticketDrop: { rate: 1.0, amount: [7, 10] } },
                e011: { name: 'æ··æ²Œã®å¡Š', attribute: 'causality', hp: 900, atk: 80, spd: 25, ticketDrop: { rate: 1.0, amount: [7, 10] } },
                e012: { name: 'æ¬¡å…ƒã®æ­ªã¿', attribute: 'quantum', hp: 450, atk: 70, spd: 60, ticketDrop: { rate: 0.9, amount: [7, 12] } },
                e013: { name: 'æ˜Ÿè¾°ã®äº¡éœŠ', attribute: 'void', hp: 500, atk: 65, spd: 40, ticketDrop: { rate: 0.9, amount: [7, 12] } },
                e014: { name: 'å› æœã®æ•é£Ÿè€…', attribute: 'causality', hp: 700, atk: 90, spd: 50, ticketDrop: { rate: 0.9, amount: [7, 12] } },
                e015: { name: 'ã‚¨ãƒ¼ãƒ†ãƒ«ã®ç²¾éœŠ', attribute: 'erosion', hp: 400, atk: 80, spd: 70, ticketDrop: { rate: 0.9, amount: [7, 12] } },
                e_elite_1: { name: 'ä¾µé£Ÿã®ç²¾é‹­', attribute: 'erosion', hp: 800, atk: 100, spd: 40, ticketDrop: { rate: 1.0, amount: [10, 15] } },
                e_elite_2: { name: 'è™šç„¡ã®ç²¾é‹­', attribute: 'void', hp: 1000, atk: 90, spd: 35, ticketDrop: { rate: 1.0, amount: [10, 15] } },
                e_elite_3: { name: 'å› æœã®å®ˆè­·è€…', attribute: 'causality', hp: 900, atk: 95, spd: 45, ticketDrop: { rate: 1.0, amount: [10, 15] } },
                e_elite_4: { name: 'é‡å­ã®ç ´å£Šè€…', attribute: 'quantum', hp: 750, atk: 120, spd: 65, ticketDrop: { rate: 1.0, amount: [12, 17] } },
                e_elite_5: { name: 'ä¾µé£Ÿã®å·¨å…µ', attribute: 'erosion', hp: 1200, atk: 110, spd: 30, ticketDrop: { rate: 1.0, amount: [12, 17] } },
                e_midboss_1: { name: 'å› æœã®ç•ªäºº', attribute: 'causality', hp: 2500, atk: 120, spd: 50, ticketDrop: { rate: 1.0, amount: [15, 20] } },
                e_midboss_2: { name: 'æ­ªã¿ã®å…·ç¾', attribute: 'causality', hp: 4000, atk: 180, spd: 60, ticketDrop: { rate: 1.0, amount: [15, 20] } },
                e_midboss_3: { name: 'æ™‚ã®é–€ç•ª', attribute: 'quantum', hp: 3500, atk: 150, spd: 80, ticketDrop: { rate: 1.0, amount: [17, 22] } },
                e_boss_ground: { name: 'å› æœã®è¦³æ¸¬è€…', attribute: 'causality', hp: 1000, atk: 80, spd: 60, ticketDrop: { rate: 1.0, amount: [20, 30] } },
                e_boss_underground: { name: 'æ·±æ·µã®åŸ·è¡Œå®˜', attribute: 'causality', hp: 3000, atk: 100, spd: 70, ticketDrop: { rate: 1.0, amount: [20, 30] } },
                e_boss_heaven: { name: 'å¤©ç©ºã®å¯©åˆ¤è€…', attribute: 'causality', hp: 12000, atk: 250, spd: 80, ticketDrop: { rate: 1.0, amount: [20, 30] } },
                e_boss_abyss: { name: 'çµ‚ç„‰ã®å› æœå¾‹', attribute: 'causality', hp: 25000, atk: 400, spd: 90, ticketDrop: { rate: 1.0, amount: [20, 30] } },
                god_erosion: { name: 'åŸåˆã®ä¾µé£Ÿç¥', attribute: 'erosion', symbol: 'â˜£ï¸', hp: 200000, atk: 1500, spd: 150, ticketDrop: { rate: 1.0, amount: [50, 75] }, rewardId: 'c_god_erosion', traits: ['god'] },
                god_void: { name: 'çµ‚æœ«ã®è™šç„¡ç¥', attribute: 'void', symbol: 'ğŸŒŒ', hp: 250000, atk: 1400, spd: 140, ticketDrop: { rate: 1.0, amount: [50, 75] }, rewardId: 'c_god_void', traits: ['god'] },
                god_quantum: { name: 'æ™‚ç©ºã®é‡å­ç¥', attribute: 'quantum', symbol: 'âš›ï¸', hp: 180000, atk: 1800, spd: 180, ticketDrop: { rate: 1.0, amount: [50, 75] }, rewardId: 'c_god_quantum', traits: ['god'] },
                god_causality: { name: 'ä¸‡è±¡ã®å› æœç¥', attribute: 'causality', symbol: 'âš–ï¸', hp: 220000, atk: 1600, spd: 160, ticketDrop: { rate: 1.0, amount: [50, 75] }, rewardId: 'c_god_causality', traits: ['god'] },
                e_soukai_1: { name: 'è’¼ç•Œã®æ–¥å€™', attribute: 'causality', hp: 5000, atk: 300, spd: 100, ticketDrop: { rate: 1.0, amount: [12, 17] } },
                e_soukai_2: { name: 'è’¼ç•Œã®è¡›å…µ', attribute: 'causality', hp: 6000, atk: 280, spd: 90, ticketDrop: { rate: 1.0, amount: [12, 17] } },
                e_elite_soukai: { name: 'è’¼ç•Œã®ç²¾é‹­', attribute: 'causality', hp: 15000, atk: 500, spd: 120, ticketDrop: { rate: 1.0, amount: [17, 22] } },
                e_midboss_soukai: { name: 'è’¼ç•Œã®å®ˆè­·è€…', attribute: 'causality', hp: 40000, atk: 700, spd: 110, ticketDrop: { rate: 1.0, amount: [22, 27] } },
                e_boss_soukai: { name: 'åŸåˆã®å› æœå¾‹', attribute: 'causality', hp: 100000, atk: 900, spd: 130, ticketDrop: { rate: 1.0, amount: [30, 40] } },
                e_boss_soukai_final: { name: 'åŸåˆã®æ··æ²Œ', attribute: 'causality', hp: 250000, atk: 1200, spd: 140, ticketDrop: { rate: 1.0, amount: [50, 100] } },
            },
            MAPS: {
                ground: { name: 'åœ°ä¸Š', size: 8, enemies: ['e001', 'e002', 'e008'], eliteTiles: { 18: 'e_elite_1', 35: 'e_elite_1', 43: 'e_elite_1', 52: 'e_elite_1'}, midBossTiles: {}, bossTile: 63, bossId: 'e_boss_ground' },
                underground: { name: 'åœ°ä¸‹', size: 8, enemies: ['e002', 'e004', 'e009', 'e013'], eliteTiles: { 12: 'e_elite_2', 28: 'e_elite_1', 47: 'e_elite_2', 51: 'e_elite_2' }, midBossTiles: { 20: 'e_midboss_1', 45: 'e_midboss_1' }, bossTile: 63, bossId: 'e_boss_underground' },
                heaven: { name: 'å¤©ç•Œ', size: 8, enemies: ['e003', 'e006', 'e007', 'e010', 'e012'], eliteTiles: { 10: 'e_elite_4', 22: 'e_elite_3', 36: 'e_elite_2', 49: 'e_elite_1', 58: 'e_elite_3' }, midBossTiles: { 18: 'e_midboss_2', 42: 'e_midboss_3', 55: 'e_midboss_1' }, bossTile: 63, bossId: 'e_boss_heaven' },
                abyss: { name: 'æ·µç•Œ', size: 8, enemies: ['e005', 'e007', 'e011', 'e014', 'e015'], eliteTiles: { 8: 'e_elite_3', 15: 'e_elite_5', 25: 'e_elite_2', 38: 'e_elite_1', 48: 'e_elite_5', 59: 'e_elite_3'}, midBossTiles: { 4: 'e_midboss_2', 29: 'e_midboss_2', 52: 'e_midboss_3' }, bossTile: 63, bossId: 'e_boss_abyss' },
                soukai: { name: 'è’¼ç•Œ', size: 8, enemies: ['e_soukai_1', 'e_soukai_2', 'e014'], eliteTiles: { 10: 'e_elite_soukai', 25: 'e_elite_soukai', 40: 'e_elite_soukai'}, midBossTiles: { 20: 'e_midboss_soukai', 48: 'e_boss_soukai' }, bossTile: 63, bossId: 'e_boss_soukai_final' }
            },
            GACHA_RATES: { 
                character: { 6: 0.002, 5: 0.02, 4: 0.1 },
                weapon: { 6: 0.003, 5: 0.03, 4: 0.15 }
            },
            LIMIT_BREAK_COSTS: [
                { resources: 5000,  materials: { ether_crystal: 5 } }, { resources: 10000, materials: { ether_crystal: 10 } },
                { resources: 20000, materials: { ether_crystal: 15 } }, { resources: 40000, materials: { ether_crystal: 20 } },
                { resources: 80000, materials: { ether_crystal: 30 } }, { resources: 150000,materials: { ether_crystal: 40 } },
                { resources: 300000,materials: { ether_crystal: 50 } }, { resources: 500000,materials: { ether_crystal: 60 } },
                { resources: 1000000,materials:{ ether_crystal: 75 } }
            ],
            RELIC_SETS: {
                warrior: { name: 'æˆ¦å£«', symbol: 'âš”ï¸', bonus: [ { count: 2, desc: 'æ”»æ’ƒåŠ›+15%' }, { count: 4, desc: 'é€šå¸¸æ”»æ’ƒã®ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸+40%' } ] },
                guardian: { name: 'å®ˆè­·è€…', symbol: 'ğŸ›¡ï¸', bonus: [ { count: 2, desc: 'HP+15%' }, { count: 4, desc: 'ä»˜ä¸ã™ã‚‹ã‚·ãƒ¼ãƒ«ãƒ‰é‡+20%' } ] },
                sage: { name: 'è³¢è€…', symbol: 'ğŸ§™', bonus: [ { count: 2, desc: 'çµ‚ç„‰ã‚²ãƒ¼ã‚¸ç²å¾—é‡+20%' }, { count: 4, desc: 'çµ‚ç„‰æ”»æ’ƒã‚’ç™ºå‹•å¾Œã€å‘³æ–¹å…¨ä½“ã®çµ‚ç„‰ã‚²ãƒ¼ã‚¸ã‚’20å›å¾©' } ] },
                sovereign: { name: 'å›ä¸»', symbol: 'ğŸ‘‘', bonus: [ { count: 2, desc: 'HP+15%' }, { count: 4, desc: 'ç•°ç•Œæ”»æ’ƒã‚’ç™ºå‹•å¾Œã€å‘³æ–¹å…¨ä½“ã®HPã‚’10%å›å¾©' } ] },
                berserker: { name: 'ç‹‚æˆ¦å£«', symbol: 'ğŸ©¸', bonus: [ { count: 2, desc: 'æ”»æ’ƒåŠ›+15%' }, { count: 4, desc: 'HPãŒ50%ä»¥ä¸‹ã®æ™‚ã€ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸+50%' } ] },
                cosmic: { name: 'å®‡å®™', symbol: 'ğŸŒŒ', bonus: [ { count: 2, desc: 'æ”»æ’ƒåŠ›+15%' }, { count: 4, desc: 'é€Ÿåº¦+20%' } ] },
                assassin: { name: 'æš—æ®ºè€…', symbol: 'ğŸ”ª', bonus: [ { count: 2, desc: 'é€Ÿåº¦+10%' }, { count: 4, desc: 'çµ‚ç„‰æ”»æ’ƒã®ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸+50%' } ] },
                prophet: { name: 'é è¨€è€…', symbol: 'ğŸ‘ï¸', bonus: [ { count: 2, desc: 'çµ‚ç„‰ã‚²ãƒ¼ã‚¸ç²å¾—é‡+20%' }, { count: 4, desc: 'æˆ¦é—˜é–‹å§‹æ™‚ã€å‘³æ–¹å…¨ä½“ã®çµ‚ç„‰ã‚²ãƒ¼ã‚¸ã‚’25å›å¾©' } ] },
                chrono: { name: 'æ™‚ç©º', symbol: 'â³', bonus: [ { count: 2, desc: 'é€Ÿåº¦+10%' }, { count: 4, desc: 'è¡Œå‹•å¾Œã€20%ã®ç¢ºç‡ã§å†åº¦è¡Œå‹•ã™ã‚‹' } ] },
                abyss: { name: 'æ·±æ·µ', symbol: 'ğŸ™', bonus: [ { count: 2, desc: 'HP+15%' }, { count: 4, desc: 'ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã€æ•µå…¨ä½“ã«è‡ªèº«ã®æœ€å¤§HP5%åˆ†ã®ãƒ€ãƒ¡ãƒ¼ã‚¸' } ] },
            },
            RELIC_MAIN_STATS: {
                flower: { hp: [100, 150, 200] }, // Rarity 3, 4, 5
                clock: { atk: [10, 15, 20] },
                goblet: { ultimateGaugeBonus: [0.1, 0.15, 0.2] }, // 10%, 15%, 20%
                crown: { ap: [1, 2, 3] }
            },
            RELIC_PARTS: ['flower', 'clock', 'goblet', 'crown'],
            RELIC_HUNT_LEVELS: [
                { id: 'hunt1', name: "Lv.1 å¿˜ã‚Œã‚‰ã‚ŒãŸè–åŸŸ", enemies: ['e001','e001'], statMultiplier: 1, rewards: { relics: { setIds: ['warrior', 'guardian'], rarity: 3, rate: 0.4 }, materials: { ether_crystal: { rate: 0.1, amount: [1,1] } } } },
                { id: 'hunt2', name: "Lv.2 å´©ã‚ŒãŸç¥æ®¿", enemies: ['e004','e004'], statMultiplier: 2, rewards: { relics: { setIds: ['warrior', 'guardian'], rarity: 3, rate: 0.4 }, materials: { ether_crystal: { rate: 0.2, amount: [1,2] } } } },
                { id: 'hunt3', name: "Lv.3 æ²ˆã‚“ã éƒ½å¸‚", enemies: ['e_elite_1','e005'], statMultiplier: 3, rewards: { relics: { setIds: ['sage', 'sovereign'], rarity: 4, rate: 0.3 }, materials: { ether_crystal: { rate: 0.3, amount: [1,3] } } } },
                { id: 'hunt4', name: "Lv.4 å¤©ç©ºã®ç¥­å£‡", enemies: ['e_elite_2','e_elite_3'], statMultiplier: 5, rewards: { relics: { setIds: ['sage', 'sovereign', 'assassin'], rarity: 4, rate: 0.3 }, materials: { ether_crystal: { rate: 0.5, amount: [2,4] } } } },
                { id: 'hunt5', name: "Lv.5 æ·µç•Œã®æºã‚Šç± ", enemies: ['e_midboss_2','e_midboss_2'], statMultiplier: 8, rewards: { relics: { setIds: ['berserker', 'cosmic', 'prophet'], rarity: 5, rate: 0.2 }, materials: { ether_crystal: { rate: 0.8, amount: [3,5] } } } },
                { id: 'hunt6', name: "Lv.6 æ™‚ç©ºã®æœã¦", enemies: ['e_boss_abyss', 'e_elite_3'], statMultiplier: 15, rewards: { relics: { setIds: ['chrono', 'abyss'], rarity: 5, rate: 0.2 }, materials: { ether_crystal: { rate: 1.0, amount: [5,10] } } } }
            ],
            INFINITE_CORRIDOR_ENEMIES: ['e001', 'e002', 'e003', 'e004', 'e005', 'e006', 'e007', 'e008', 'e009', 'e010', 'e011', 'e012', 'e013', 'e014', 'e015'],
            INFINITE_CORRIDOR_REWARDS: {
                10: { resources: 10000, gachaTickets: 10, materials: { ether_crystal: 5 } },
                20: { resources: 20000, gachaTickets: 20, materials: { ether_crystal: 10 } },
                30: { resources: 35000, gachaTickets: 30, materials: { ether_crystal: 15 } },
                40: { resources: 50000, gachaTickets: 40, materials: { ether_crystal: 20 } },
                50: { resources: 75000, gachaTickets: 50, materials: { ether_crystal: 30 } },
                60: { resources: 100000, gachaTickets: 60, materials: { ether_crystal: 40 } },
                70: { resources: 150000, gachaTickets: 70, materials: { ether_crystal: 50 } },
                80: { resources: 200000, gachaTickets: 80, materials: { ether_crystal: 60 } },
                90: { resources: 250000, gachaTickets: 90, materials: { ether_crystal: 70 } },
                100: { resources: 500000, gachaTickets: 100, materials: { ether_crystal: 100 } },
            }
        };

        let playerState = {};
        let gameState = {};
        
        function resetGameData() {
            playerState = { resources: 1000, gachaTickets: 100, characters: [], equipment: [], party: [], mentalPollution: 0, mapProgress: { ground: {}, heaven: {}, underground: {}, abyss: {}, soukai: {} }, endingsUnlocked: { salvation: false, corruption: false, ruin: false }, godsDefeated: {}, relicInventory: [], equippedRelics: { flower: null, clock: null, goblet: null, crown: null }, limitBreakMaterials: { ether_crystal: 0 }, clearedRelicHuntLevels: {}, infiniteCorridor: { highestFloor: 0, claimedRewards: {} }, nextUniqueId: 1 };
            gameState = { currentScreen: 'title-screen', currentMap: 'ground', battle: null, activeCharacterDetail: null, equipmentSlotToFill: { charUniqueId: null, type: null }, preBattleScreen: 'hub-screen', relicFilter: 'all', activeRelicDetail: null, activeRelicHunt: null };
        }

        function getNextUniqueId() { return playerState.nextUniqueId++; }
        function switchScreen(screenId) {
            screens.forEach(screen => screen.classList.remove('active-screen'));
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active-screen');
                gameState.currentScreen = screenId;
                if (screenId === 'hub-screen') updateHubUI(); 
                if (screenId === 'map-screen') renderMap();
                if (screenId === 'gacha-screen') updateGachaUI(); 
                if (screenId === 'character-screen') renderCharacterScreen();
                if (screenId === 'god-slay-screen') renderGodSlayScreen();
                if (screenId === 'relic-screen') renderRelicScreen();
                if (screenId === 'relic-hunt-screen') renderRelicHuntScreen();
                if (screenId === 'infinite-corridor-screen') renderInfiniteCorridorScreen();
            } else { console.error(`Screen with id "${screenId}" not found. Defaulting to hub-screen.`); switchScreen('hub-screen'); }
        }
        function showMessage(text, onOk) {
            messageText.innerHTML = text.replace(/\n/g, '<br>');
            messageModal.classList.remove('hidden');
            document.getElementById('message-ok-btn').onclick = () => { messageModal.classList.add('hidden'); if (onOk) onOk(); };
        }
        function updateHubUI() {
            let totalTiles = Object.keys(GAME_DATA.MAPS).length * 64;
            let conqueredTiles = Object.values(playerState.mapProgress).reduce((sum, map) => sum + Object.keys(map).length, 0);
            document.getElementById('purification-rate').textContent = ((conqueredTiles / totalTiles) * 100).toFixed(1);
            document.getElementById('mental-pollution').textContent = playerState.mentalPollution;
            document.getElementById('player-resources').textContent = playerState.resources;
            document.getElementById('gacha-tickets').textContent = playerState.gachaTickets;
            document.getElementById('limit-break-materials-display').textContent = playerState.limitBreakMaterials.ether_crystal;
        }
        
        function getCharacterLevelCap(character) {
            const baseCap = 20;
            const capPerLB = 10;
            return baseCap + (character.limitBreakLevel || 0) * capPerLB;
        }

        function renderCharacterScreen() { renderPartyList(); renderCharacterList(); }
        function renderPartyList() {
            const partyContainer = document.getElementById('current-party'); partyContainer.innerHTML = '';
            for(let i=0; i < 4; i++) {
                const charUniqueId = playerState.party[i];
                const slot = document.createElement('div');
                slot.className = 'glass-panel p-2 rounded-lg flex flex-col gap-2 min-h-[100px]';
                if (charUniqueId) {
                    const character = getCharacterInstance(charUniqueId); const master = GAME_DATA.CHARACTERS[character.charId]; const rarityClass = GAME_DATA.RARITY[master.rarity].colorClass; const role = GAME_DATA.ROLES[master.role];
                    const lbLevelText = character.limitBreakLevel > 0 ? `<span class="text-yellow-400"> LB ${character.limitBreakLevel}</span>` : '';
                    slot.innerHTML = `<div class="flex items-center gap-2 cursor-pointer" data-char-id="${charUniqueId}"><div class="text-4xl w-12 text-center">${master.symbol}</div><div class="flex-grow"><p class="font-bold ${rarityClass}">${master.name} <span class="text-sm text-white">(Lv.${character.level})</span>${lbLevelText}</p><p class="text-xs ${GAME_DATA.ATTRIBUTES[master.attribute].colorClass}">${role.symbol} ${role.name}</p></div><button class="remove-from-party-btn btn-secondary text-red-500 text-xs px-2 rounded" data-unique-id="${charUniqueId}">å¤–ã™</button></div><div class="flex justify-around gap-2">${createPartyEquipSlot(character, 'weapon')}${createPartyEquipSlot(character, 'armor')}</div>`;
                } else { slot.innerHTML = `<div class="h-full flex items-center justify-center text-gray-500">ã‚¹ãƒ­ãƒƒãƒˆ ${i+1}</div>`; }
                partyContainer.appendChild(slot);
            }
            partyContainer.querySelectorAll('[data-char-id]').forEach(el => el.onclick = (e) => showCharacterDetail(parseInt(e.currentTarget.dataset.charId)));
            partyContainer.querySelectorAll('.remove-from-party-btn').forEach(btn => btn.onclick = (e) => { e.stopPropagation(); removeFromParty(parseInt(e.target.dataset.uniqueId)); });
            partyContainer.querySelectorAll('.party-equip-slot').forEach(slot => {
                slot.onclick = (e) => { e.stopPropagation(); const charId = parseInt(slot.dataset.charId); const type = slot.dataset.type; const equipUniqueId = getCharacterInstance(charId)?.equipped[type]; if (equipUniqueId) { showEquipmentDetail(equipUniqueId, charId, type); } else { openEquipmentSelectModal(charId, type); } };
            });
        }
        function createPartyEquipSlot(character, type) {
            const equipUniqueId = character.equipped[type]; let content;
            if (equipUniqueId) {
                const equipment = getEquipmentInstance(equipUniqueId); const master = GAME_DATA.EQUIPMENT[equipment.equipId];
                content = `<span class="text-2xl">${master.symbol}</span> <span class="text-xs ${GAME_DATA.RARITY[master.rarity].colorClass}">${master.name}</span>`;
            } else { content = `<span class="text-gray-500 text-xs">${type === 'weapon' ? 'æ­¦å™¨' : 'é˜²å…·'}</span>`; }
            return `<div data-char-id="${character.uniqueId}" data-type="${type}" class="party-equip-slot w-1/2 h-10 bg-black bg-opacity-20 rounded flex items-center justify-center gap-1 cursor-pointer hover:bg-opacity-40">${content}</div>`;
        }
        function renderCharacterList() {
            const listContainer = document.getElementById('character-list'); listContainer.innerHTML = '';
            playerState.characters.sort((a,b) => GAME_DATA.CHARACTERS[b.charId].rarity - GAME_DATA.CHARACTERS[a.charId].rarity || a.uniqueId - b.uniqueId).forEach(character => {
                const master = GAME_DATA.CHARACTERS[character.charId]; const rarityClass = GAME_DATA.RARITY[master.rarity].colorClass; const role = GAME_DATA.ROLES[master.role];
                 const lbLevelText = character.limitBreakLevel > 0 ? `<span class="text-yellow-400"> LB ${character.limitBreakLevel}</span>` : '';
                const card = document.createElement('div'); card.className = 'glass-panel p-2 rounded-lg text-center h-28 flex flex-col justify-center items-center cursor-pointer hover:border-cyan-400 border border-transparent';
                card.innerHTML = `<div class="text-3xl">${master.symbol}</div><p class="font-bold text-sm ${rarityClass}">${master.name}</p><p class="text-xs">${role.symbol} Lv.${character.level}${lbLevelText} ${character.duplicationBonus > 0 ? `<span class='text-yellow-400'>(+${character.duplicationBonus})</span>` : ''}</p>`;
                card.onclick = () => showCharacterDetail(character.uniqueId); listContainer.appendChild(card);
            });
        }
        function showCharacterDetail(uniqueId) {
            gameState.activeCharacterDetail = uniqueId;
            const content = document.getElementById('character-detail-content'); const character = getCharacterInstance(uniqueId); const master = GAME_DATA.CHARACTERS[character.charId]; const stats = getCharacterFullStats(uniqueId); const isInParty = playerState.party.includes(uniqueId);
            const duplicationBonusText = character.duplicationBonus > 0 ? `<p class="text-yellow-400">é‡è¤‡ãƒœãƒ¼ãƒŠã‚¹: +${character.duplicationBonus}</p>` : ''; const role = GAME_DATA.ROLES[master.role];
            let roleText = `${role.symbol} ${role.name}`;
            if(master.role === 'attacker' && master.attackerType) { roleText += ` <span class="text-cyan-300">(${GAME_DATA.ATTACKER_TYPES[master.attackerType].name})</span>`; }
            const enhanceCost = 100 + (character.level * 50);
            const levelCap = getCharacterLevelCap(character);
            const lbLevel = character.limitBreakLevel || 0;
            const maxLB = GAME_DATA.LIMIT_BREAK_COSTS.length;
            
            let enhanceButtonHTML = '';
            if (character.level < levelCap) {
                enhanceButtonHTML = `<button id="enhance-btn" class="btn-primary mt-2 py-2 px-6 rounded-lg w-full">å¼·åŒ– (${enhanceCost}è³‡æº)</button>`;
            } else if (lbLevel < maxLB) {
                const lbCost = GAME_DATA.LIMIT_BREAK_COSTS[lbLevel];
                enhanceButtonHTML = `<button id="limit-break-btn" class="btn-limit-break mt-2 py-2 px-6 rounded-lg w-full">é™ç•Œçªç ´</button><p class="text-xs text-center mt-1">ã‚³ã‚¹ãƒˆ: ${lbCost.resources}è³‡æº, ${lbCost.materials.ether_crystal}ã‚¨ãƒ¼ãƒ†ãƒ«çµæ™¶</p>`;
            } else {
                 enhanceButtonHTML = `<p class="text-center text-yellow-400 mt-2">ãƒ¬ãƒ™ãƒ«ä¸Šé™ã§ã™</p>`;
            }
            
            let potentialsHTML = '<div class="glass-panel p-4 flex-grow"><h4 class="font-bold text-lg mb-2">æ½œåœ¨èƒ½åŠ›</h4><div class="space-y-2">';
            if (master.potentials && master.potentials.length > 0) {
                master.potentials.forEach((potential, index) => {
                    const isUnlocked = character.unlockedPotentials[index];
                    const unlockCond = potential.unlock.level ? `Lv.${potential.unlock.level}` : `é™ç•Œçªç ´${potential.unlock.limitBreak}`;
                    potentialsHTML += `<div class="${isUnlocked ? '' : 'opacity-50'}"><p class="font-bold text-cyan-300">${potential.name} ${isUnlocked ? '<span class="text-yellow-400">[è§£æ”¾æ¸ˆ]</span>' : `<span class="text-gray-400">[${unlockCond}]</span>`}</p><p class="text-xs text-gray-300">${potential.desc}</p></div>`;
                });
            } else {
                potentialsHTML += '<p class="text-sm text-gray-500">ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«æ½œåœ¨èƒ½åŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
            potentialsHTML += '</div></div>';

            content.innerHTML = `
                <div class="flex flex-col md:flex-row gap-4 h-full">
                    <div class="md:w-1/3 flex flex-col items-center glass-panel p-4">
                        <div class="text-7xl mb-2">${master.symbol}</div>
                        <h2 class="text-2xl font-bold ${GAME_DATA.RARITY[master.rarity].colorClass}">${master.name}</h2>
                        <p class="text-lg">${roleText}</p>
                        <p class="text-md ${GAME_DATA.ATTRIBUTES[master.attribute].colorClass}">${GAME_DATA.ATTRIBUTES[master.attribute].symbol} ${GAME_DATA.ATTRIBUTES[master.attribute].name}</p>
                        <p class="mt-4">Level: ${character.level} / ${levelCap}</p>
                        <p>é™ç•Œçªç ´: ${lbLevel} / ${maxLB}</p>
                        ${duplicationBonusText}
                        ${enhanceButtonHTML}
                        <button id="toggle-party-btn" class="${isInParty ? 'btn-secondary text-red-400' : 'btn-primary'} mt-4 py-2 px-6 rounded-lg w-full">${isInParty ? 'ãƒ‘ãƒ¼ãƒ†ã‚£ã‹ã‚‰å¤–ã™' : 'ãƒ‘ãƒ¼ãƒ†ã‚£ã«å…¥ã‚Œã‚‹'}</button>
                    </div>
                    <div class="md:w-2/3 flex flex-col gap-4">
                        <div class="glass-panel p-4"><h4 class="font-bold text-lg mb-2">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4><div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm"><span>HP: ${stats.hp}</span><span>æ”»æ’ƒåŠ›: ${stats.atk}</span><span>é€Ÿåº¦: ${stats.spd}</span></div></div>
                        <div class="glass-panel p-4"><h4 class="font-bold text-lg mb-2">è£…å‚™</h4><div class="flex gap-4">${createEquipmentSlot(character, 'weapon')}${createEquipmentSlot(character, 'armor')}</div></div>
                        <div class="glass-panel p-4"><h4 class="font-bold text-lg mb-2">ã‚¹ã‚­ãƒ«</h4><p><b>ç•°ç•Œæ”»æ’ƒ:</b> ${master.skills.otherworld.name} (AP:${master.skills.otherworld.cost})<br><small class="text-gray-400">${master.skills.otherworld.desc || ''}</small></p><p class="mt-2"><b>çµ‚ç„‰æ”»æ’ƒ:</b> ${master.skills.ultimate.name} (ã‚²ãƒ¼ã‚¸:${master.skills.ultimate.cost})<br><small class="text-gray-400">${master.skills.ultimate.desc || ''}</small></p></div>
                        ${potentialsHTML}
                    </div>
                </div>`;
            characterDetailModal.classList.remove('hidden');
            if (document.getElementById('enhance-btn')) document.getElementById('enhance-btn').onclick = () => enhanceCharacter(uniqueId);
            if (document.getElementById('limit-break-btn')) document.getElementById('limit-break-btn').onclick = () => limitBreakCharacter(uniqueId);
            document.getElementById('toggle-party-btn').onclick = () => togglePartyStatus(uniqueId);
            document.querySelectorAll('.equip-slot').forEach(slot => { slot.onclick = () => { const equipUniqueId = character.equipped[slot.dataset.type]; if (equipUniqueId) { showEquipmentDetail(equipUniqueId, character.uniqueId, slot.dataset.type); } else { openEquipmentSelectModal(character.uniqueId, slot.dataset.type); } }; });
        }
        function checkAndUnlockPotentials(charUniqueId) {
            const character = getCharacterInstance(charUniqueId);
            const master = GAME_DATA.CHARACTERS[character.charId];
            if (!master.potentials) return;
            let updated = false;
            master.potentials.forEach((potential, index) => {
                if (!character.unlockedPotentials[index]) {
                    const unlock = potential.unlock;
                    const canUnlock = (unlock.level && character.level >= unlock.level) || (unlock.limitBreak && (character.limitBreakLevel || 0) >= unlock.limitBreak);
                    if (canUnlock) {
                        character.unlockedPotentials[index] = true;
                        updated = true;
                        showMessage(`æ½œåœ¨èƒ½åŠ›è§£æ”¾ï¼\n${character.name}ã¯ã€Œ${potential.name}ã€ã‚’ç¿’å¾—ã—ã¾ã—ãŸã€‚`);
                    }
                }
            });
            if(updated) showCharacterDetail(charUniqueId);
        }
        function enhanceCharacter(uniqueId) {
            const character = getCharacterInstance(uniqueId);
            const cost = 100 + (character.level * 50);
            if(character.level >= getCharacterLevelCap(character)) { showMessage("ãƒ¬ãƒ™ãƒ«ãŒä¸Šé™ã«é”ã—ã¦ã„ã¾ã™ã€‚é™ç•Œçªç ´ãŒå¿…è¦ã§ã™ã€‚"); return; }
            if (playerState.resources < cost) { showMessage("è³‡æºãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚"); return; }
            playerState.resources -= cost; character.level++;
            const master = GAME_DATA.CHARACTERS[character.charId];
            character.baseStats.hp += Math.floor(master.hp * 0.1); character.baseStats.atk += Math.floor(master.atk * 0.1); character.baseStats.spd += Math.floor(master.spd * 0.1);
            checkAndUnlockPotentials(uniqueId);
            updateHubUI(); showCharacterDetail(uniqueId); renderCharacterScreen();
        }
        function limitBreakCharacter(uniqueId) {
            const character = getCharacterInstance(uniqueId);
            const lbLevel = character.limitBreakLevel || 0;
            if (lbLevel >= GAME_DATA.LIMIT_BREAK_COSTS.length) { showMessage("ã“ã‚Œä»¥ä¸Šé™ç•Œçªç ´ã§ãã¾ã›ã‚“ã€‚"); return; }
            const cost = GAME_DATA.LIMIT_BREAK_COSTS[lbLevel];
            if (playerState.resources < cost.resources || playerState.limitBreakMaterials.ether_crystal < cost.materials.ether_crystal) {
                showMessage(`ç´ æãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\nå¿…è¦: ${cost.resources}è³‡æº, ${cost.materials.ether_crystal}ã‚¨ãƒ¼ãƒ†ãƒ«çµæ™¶`); return;
            }
            playerState.resources -= cost.resources;
            playerState.limitBreakMaterials.ether_crystal -= cost.materials.ether_crystal;
            character.limitBreakLevel = lbLevel + 1;
            showMessage(`${character.name}ã®é™ç•Œã‚’çªç ´ã—ã¾ã—ãŸï¼\nãƒ¬ãƒ™ãƒ«ã‚­ãƒ£ãƒƒãƒ—ãŒ${getCharacterLevelCap(character)}ã«ä¸Šæ˜‡ï¼`);
            checkAndUnlockPotentials(uniqueId);
            updateHubUI();
            showCharacterDetail(uniqueId);
        }
        function togglePartyStatus(uniqueId) { if (playerState.party.includes(uniqueId)) removeFromParty(uniqueId); else assignToParty(uniqueId); showCharacterDetail(uniqueId); renderPartyList(); }
        function createEquipmentSlot(character, type) {
            const equipUniqueId = character.equipped[type]; const typeName = type === 'weapon' ? 'æ­¦å™¨' : 'é˜²å…·'; let content;
            if (equipUniqueId) {
                const equipment = getEquipmentInstance(equipUniqueId); const master = GAME_DATA.EQUIPMENT[equipment.equipId];
                content = `<div class="text-3xl">${master.symbol}</div><div><p class="font-bold text-sm ${GAME_DATA.RARITY[master.rarity].colorClass}">${master.name}</p><p class="text-xs text-gray-400">ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°</p></div>`;
            } else { content = `<div class="text-gray-500 w-full text-center">ç©ºã (${typeName})</div>`; }
            return `<div data-char-id="${character.uniqueId}" data-type="${type}" class="equip-slot w-1/2 h-20 glass-panel rounded-lg flex items-center justify-center gap-2 cursor-pointer hover:border-cyan-400 border border-transparent">${content}</div>`;
        }
        function openEquipmentSelectModal(charUniqueId, type) {
            gameState.equipmentSlotToFill = { charUniqueId, type };
            const listContainer = document.getElementById('equipment-select-list');
            listContainer.innerHTML = '';
            const availableEquipment = playerState.equipment.filter(e => {
                const master = GAME_DATA.EQUIPMENT[e.equipId];
                const isCorrectType = master.type === type;
                const isNotEquipped = !playerState.characters.some(c => c.equipped.weapon === e.uniqueId || c.equipped.armor === e.uniqueId);
                return isCorrectType && isNotEquipped;
            });
            if (availableEquipment.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-400 col-span-full text-center">è£…å‚™ã§ãã‚‹${type === 'weapon' ? 'æ­¦å™¨' : 'é˜²å…·'}ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
            } else {
                availableEquipment.forEach(equipment => {
                    const master = GAME_DATA.EQUIPMENT[equipment.equipId];
                    const card = document.createElement('div');
                    card.className = 'glass-panel p-2 rounded-lg text-center h-28 flex flex-col justify-center items-center cursor-pointer hover:border-cyan-400 border border-transparent';
                    card.innerHTML = `<div class="text-3xl">${master.symbol}</div><p class="font-bold text-sm ${GAME_DATA.RARITY[master.rarity].colorClass}">${master.name}</p><p class="text-xs">â˜…${master.rarity}</p>`;
                    card.onclick = () => equipItem(equipment.uniqueId);
                    listContainer.appendChild(card);
                });
            }
            equipmentSelectModal.classList.remove('hidden');
        }
        function showEquipmentDetail(equipUniqueId, charUniqueId, type) {
            const equipment = getEquipmentInstance(equipUniqueId); const master = GAME_DATA.EQUIPMENT[equipment.equipId]; const content = document.getElementById('equipment-detail-content'); const buttonsContainer = document.getElementById('equipment-detail-buttons'); let statsHtml = '';
            for (const [stat, value] of Object.entries(master.stats)) { statsHtml += `<p>${stat.toUpperCase()}: ${value > 0 ? '+' : ''}${value}</p>`; }
            content.innerHTML = `<div class="flex flex-col items-center text-center"><div class="text-7xl mb-4">${master.symbol}</div><h2 class="text-2xl font-bold ${GAME_DATA.RARITY[master.rarity].colorClass}">${master.name}</h2><p class="text-lg">â˜…${master.rarity}</p><div class="glass-panel p-4 mt-4 w-full"><h4 class="font-bold text-lg mb-2">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4><div class="text-left">${statsHtml}</div></div></div>`;
            buttonsContainer.innerHTML = `<button id="close-equipment-detail-btn" class="btn-secondary py-2 px-4 rounded-lg">é–‰ã˜ã‚‹</button>`;
            if(charUniqueId && type) { buttonsContainer.innerHTML += `<button id="unequip-btn" class="btn-secondary text-red-400 py-2 px-4 rounded-lg">ã“ã®è£…å‚™ã‚’å¤–ã™</button>`; document.getElementById('unequip-btn').onclick = () => { unequipItem(charUniqueId, type); equipmentDetailModal.classList.add('hidden'); if (!characterDetailModal.classList.contains('hidden')) { showCharacterDetail(charUniqueId); } else { renderCharacterScreen(); } }; }
            document.getElementById('close-equipment-detail-btn').onclick = () => equipmentDetailModal.classList.add('hidden'); equipmentDetailModal.classList.remove('hidden');
        }
        function equipItem(equipUniqueId) {
            const { charUniqueId, type } = gameState.equipmentSlotToFill; const character = getCharacterInstance(charUniqueId);
            if(character) character.equipped[type] = equipUniqueId;
            equipmentSelectModal.classList.add('hidden');
            if (characterDetailModal.classList.contains('hidden')) renderCharacterScreen(); else showCharacterDetail(charUniqueId);
        }
        function unequipItem(charUniqueId, type) {
             const character = getCharacterInstance(charUniqueId); if(character) character.equipped[type] = null;
             if (characterDetailModal.classList.contains('hidden')) renderCharacterScreen(); else showCharacterDetail(charUniqueId);
        }
        function assignToParty(uniqueId) { if (playerState.party.length >= 4) { showMessage('ãƒ‘ãƒ¼ãƒ†ã‚£ã¯4äººã¾ã§ã§ã™ã€‚'); return; } if (!playerState.party.includes(uniqueId)) playerState.party.push(uniqueId); }
        function removeFromParty(uniqueId) { playerState.party = playerState.party.filter(id => id !== uniqueId); renderPartyList(); }
        function renderMap() {
            const mapData = GAME_DATA.MAPS[gameState.currentMap]; const mapGrid = document.getElementById('map-grid'); document.getElementById('map-name').textContent = mapData.name; mapGrid.innerHTML = '';
            for (let i = 0; i < mapData.size * mapData.size; i++) {
                const tile = document.createElement('div'); tile.dataset.tileId = i; tile.className = 'map-tile flex items-center justify-center rounded text-2xl';
                if (playerState.mapProgress[gameState.currentMap]?.[i]) { tile.classList.add('conquered'); tile.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
                } else { tile.classList.add('unexplored'); let specialType = ''; let symbol = ''; if (i === mapData.bossTile) { specialType = 'boss'; symbol = 'ğŸ’€'; } else if (mapData.midBossTiles[i]) { specialType = 'mid-boss'; symbol = 'ğŸ˜ˆ'; } else if (mapData.eliteTiles[i]) { specialType = 'elite'; symbol = 'âš”ï¸'; } if (specialType) { tile.classList.add(specialType); tile.innerHTML = symbol; } tile.addEventListener('click', () => startBattle({type: 'map', id: i})); }
                mapGrid.appendChild(tile);
            }
        }
        function renderGodSlayScreen() {
            const godListContainer = document.getElementById('god-list'); godListContainer.innerHTML = '';
            const godIds = ['god_erosion', 'god_void', 'god_quantum', 'god_causality'];
            godIds.forEach(godId => {
                const god = GAME_DATA.ENEMIES[godId]; const attr = GAME_DATA.ATTRIBUTES[god.attribute]; const isDefeated = playerState.godsDefeated[godId.replace('god_', '')];
                const card = document.createElement('div'); card.className = `glass-panel p-6 flex flex-col items-center justify-center transition-all ${isDefeated ? 'opacity-50' : 'cursor-pointer hover:border-red-500 border-2 border-transparent'}`;
                card.innerHTML = `<div class="text-8xl">${god.symbol}</div><h3 class="text-3xl font-orbitron mt-4 ${attr.colorClass}">${god.name}</h3><p class="text-gray-400">HP: ${god.hp} / ATK: ${god.atk}</p><button class="god-slay-btn btn-primary mt-6 py-2 px-8 rounded-lg" data-god-id="${godId}" ${isDefeated ? 'disabled' : ''}>${isDefeated ? 'è¨ä¼æ¸ˆã¿' : 'è¨ä¼é–‹å§‹'}</button>`;
                godListContainer.appendChild(card);
            });
            document.querySelectorAll('.god-slay-btn').forEach(btn => { if(!btn.disabled) btn.onclick = () => startBattle({type: 'god', id: btn.dataset.godId}); });
        }
        
        function renderRelicHuntScreen() {
            const listContainer = document.getElementById('relic-dungeon-list');
            const detailContainer = document.getElementById('relic-dungeon-detail');
            listContainer.innerHTML = '';
            detailContainer.innerHTML = '<p class="text-center text-gray-400">æŒ‘æˆ¦ã™ã‚‹éºè·¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
            GAME_DATA.RELIC_HUNT_LEVELS.forEach((level, index) => {
                const isCleared = playerState.clearedRelicHuntLevels[level.id];
                const item = document.createElement('div');
                item.className = 'p-3 rounded-lg cursor-pointer hover:bg-white/10 glass-panel';
                item.innerHTML = `${level.name} ${isCleared ? '<span class="text-xs text-yellow-400">[åˆå›ã‚¯ãƒªã‚¢æ¸ˆ]</span>' : ''}`;
                item.onclick = () => {
                    gameState.activeRelicHunt = index;
                    detailContainer.innerHTML = `
                        <h3 class="text-2xl font-bold mb-4">${level.name}</h3>
                        <div class="flex-grow space-y-4">
                           <div>
                                <h4 class="font-bold text-lg mb-2">å‡ºç¾ã™ã‚‹æ•µ</h4>
                                <div class="grid grid-cols-2 gap-2">
                                ${level.enemies.map(eId => { const eMaster = GAME_DATA.ENEMIES[eId]; return `<div class="bg-black/20 p-2 rounded text-sm">${eMaster.name}</div>`}).join('')}
                                </div>
                           </div>
                           <div>
                                <h4 class="font-bold text-lg mb-2">ä¸»ãªå ±é…¬</h4>
                                <div class="grid grid-cols-2 gap-2">
                                ${level.rewards.relics.setIds.map(setId => { const rMaster = GAME_DATA.RELIC_SETS[setId]; return `<div class="bg-black/20 p-2 rounded text-sm flex items-center gap-2"><span class="text-2xl">${rMaster.symbol}</span> <span>${rMaster.name}ã‚»ãƒƒãƒˆ</span></div>`}).join('')}
                                ${level.rewards.materials.ether_crystal ? `<div class="bg-black/20 p-2 rounded text-sm">ã‚¨ãƒ¼ãƒ†ãƒ«çµæ™¶</div>` : ''}
                                </div>
                           </div>
                        </div>
                        <button id="start-relic-hunt-btn" class="btn-primary w-full py-3 mt-4 rounded-lg font-bold">æŒ‘æˆ¦</button>
                    `;
                    document.getElementById('start-relic-hunt-btn').onclick = () => startBattle({ type: 'relic_hunt', levelIndex: index });
                };
                listContainer.appendChild(item);
            });
        }
        function renderRelicScreen() {
            const equippedContainer = document.getElementById('equipped-relics-container');
            const inventoryContainer = document.getElementById('relic-inventory-list');
            const setBonusContainer = document.getElementById('active-set-bonus-container');
            
            equippedContainer.innerHTML = '';
            GAME_DATA.RELIC_PARTS.forEach(part => {
                const relicUniqueId = playerState.equippedRelics[part];
                const slot = document.createElement('div');
                slot.className = 'glass-panel p-2 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-cyan-400 border border-transparent min-h-[100px]';
                if (relicUniqueId) {
                    const relic = getRelicInstance(relicUniqueId);
                    const setInfo = GAME_DATA.RELIC_SETS[relic.setId];
                    slot.innerHTML = `<div class="text-4xl">${setInfo.symbol}</div><p class="text-xs ${GAME_DATA.RARITY[relic.rarity].colorClass}">${setInfo.name}</p>`;
                    slot.onclick = () => showRelicDetail(relicUniqueId);
                } else {
                    slot.innerHTML = `<span class="text-gray-500 text-sm">${part}</span>`;
                    slot.onclick = () => { gameState.relicFilter = part; renderRelicInventoryList(part); }; // Filter inventory on click
                }
                equippedContainer.appendChild(slot);
            });

            renderRelicInventoryList(gameState.relicFilter);
            renderRelicFilterButtons();
            
            const bonuses = getActiveSetBonus();
            setBonusContainer.innerHTML = '<h4 class="font-bold mb-2">ã‚»ãƒƒãƒˆåŠ¹æœ</h4>';
            if (bonuses.length > 0) {
                bonuses.forEach(b => {
                    setBonusContainer.innerHTML += `<p class="text-sm text-green-400">${b.setInfo.name} ${b.count}ã‚»ãƒƒãƒˆ: ${b.bonus.desc}</p>`;
                });
            } else {
                setBonusContainer.innerHTML += '<p class="text-sm text-gray-500">ç™ºå‹•ä¸­ã®ã‚»ãƒƒãƒˆåŠ¹æœã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            }
        }
        function renderRelicFilterButtons() {
            const container = document.getElementById('relic-filter-buttons');
            container.innerHTML = `<button data-filter="all" class="relic-filter-btn btn-sm ${gameState.relicFilter === 'all' ? 'btn-primary' : 'btn-secondary'} px-2 py-1 rounded-md text-xs">å…¨ã¦</button>`;
            GAME_DATA.RELIC_PARTS.forEach(part => {
                 container.innerHTML += `<button data-filter="${part}" class="relic-filter-btn btn-sm ${gameState.relicFilter === part ? 'btn-primary' : 'btn-secondary'} px-2 py-1 rounded-md text-xs">${part}</button>`;
            });
            document.querySelectorAll('.relic-filter-btn').forEach(btn => btn.onclick = (e) => {
                gameState.relicFilter = e.target.dataset.filter;
                renderRelicFilterButtons();
                renderRelicInventoryList(gameState.relicFilter);
            });
        }
        function renderRelicInventoryList(filter) {
            const inventoryContainer = document.getElementById('relic-inventory-list');
            inventoryContainer.innerHTML = '';
            const filteredRelics = playerState.relicInventory.filter(r => {
                const isEquipped = Object.values(playerState.equippedRelics).includes(r.uniqueId);
                const typeMatch = filter === 'all' || r.part === filter;
                return !isEquipped && typeMatch;
            });

            if (filteredRelics.length === 0) {
                inventoryContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">è©²å½“ã™ã‚‹è–éºç‰©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                return;
            }

            filteredRelics.forEach(relic => {
                const setInfo = GAME_DATA.RELIC_SETS[relic.setId];
                const card = document.createElement('div');
                card.className = 'glass-panel p-2 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-cyan-400 border border-transparent h-24';
                card.innerHTML = `<div class="text-3xl">${setInfo.symbol}</div><p class="text-xs ${GAME_DATA.RARITY[relic.rarity].colorClass}">${setInfo.name} (${relic.part})</p>`;
                card.onclick = () => showRelicDetail(relic.uniqueId);
                inventoryContainer.appendChild(card);
            });
        }
        function showRelicDetail(relicUniqueId) {
            gameState.activeRelicDetail = relicUniqueId;
            const relic = getRelicInstance(relicUniqueId);
            const setInfo = GAME_DATA.RELIC_SETS[relic.setId];
            const isEquipped = Object.values(playerState.equippedRelics).includes(relic.uniqueId);
            const content = document.getElementById('relic-detail-content');
            const buttons = document.getElementById('relic-detail-buttons');

            let mainStatText = '';
            if (relic.mainStat.hp) mainStatText = `HP+${relic.mainStat.hp}`;
            if (relic.mainStat.atk) mainStatText = `æ”»æ’ƒåŠ›+${relic.mainStat.atk}`;
            if (relic.mainStat.ultimateGaugeBonus) mainStatText = `çµ‚ç„‰ã‚²ãƒ¼ã‚¸ç²å¾—é‡+${relic.mainStat.ultimateGaugeBonus*100}%`;
            if (relic.mainStat.ap) mainStatText = `åˆæœŸAP+${relic.mainStat.ap}`;

            content.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-2">${setInfo.symbol}</div>
                    <h3 class="text-xl font-bold ${GAME_DATA.RARITY[relic.rarity].colorClass}">${setInfo.name}</h3>
                    <p class="text-gray-400">${relic.part}</p>
                    <p class="text-lg mt-4">${mainStatText}</p>
                    <div class="glass-panel p-3 mt-4 text-left">
                        <h4 class="font-bold mb-1">ã‚»ãƒƒãƒˆåŠ¹æœ</h4>
                        ${setInfo.bonus.map(b => `<p class="text-xs ${GAME_DATA.RARITY[relic.rarity].colorClass}">${b.count}ã‚»ãƒƒãƒˆ: ${b.desc}</p>`).join('')}
                    </div>
                </div>`;
            
            buttons.innerHTML = `<button id="close-relic-detail-btn" class="btn-secondary py-2 px-4 rounded-lg">é–‰ã˜ã‚‹</button>`;
            if (isEquipped) {
                buttons.innerHTML += `<button id="unequip-relic-btn" class="btn-secondary text-red-400 py-2 px-4 rounded-lg">å¤–ã™</button>`;
            } else {
                buttons.innerHTML += `<button id="equip-relic-btn" class="btn-primary py-2 px-4 rounded-lg">è£…å‚™</button>`;
                buttons.innerHTML += `<button id="salvage-relic-btn" class="btn-danger py-2 px-4 rounded-lg">åˆ†è§£</button>`;
            }
            
            document.getElementById('close-relic-detail-btn').onclick = () => relicDetailModal.classList.add('hidden');
            if (document.getElementById('equip-relic-btn')) document.getElementById('equip-relic-btn').onclick = () => equipRelic(relic.uniqueId);
            if (document.getElementById('unequip-relic-btn')) document.getElementById('unequip-relic-btn').onclick = () => unequipRelic(relic.part);
            if (document.getElementById('salvage-relic-btn')) document.getElementById('salvage-relic-btn').onclick = () => salvageRelic(relic.uniqueId);


            relicDetailModal.classList.remove('hidden');
        }
        function equipRelic(relicUniqueId) {
            const relic = getRelicInstance(relicUniqueId);
            if (playerState.equippedRelics[relic.part]) {
                const oldRelicId = playerState.equippedRelics[relic.part];
            }
            playerState.equippedRelics[relic.part] = relic.uniqueId;
            relicDetailModal.classList.add('hidden');
            renderRelicScreen();
        }
        function unequipRelic(part) {
            playerState.equippedRelics[part] = null;
            relicDetailModal.classList.add('hidden');
            renderRelicScreen();
        }
        function salvageRelic(relicUniqueId) {
            const relicIndex = playerState.relicInventory.findIndex(r => r.uniqueId === relicUniqueId);
            if (relicIndex === -1) return;

            const relic = playerState.relicInventory[relicIndex];
            const resourceYields = { 3: 100, 4: 500, 5: 2500, 6: 10000 };
            const gainedResources = resourceYields[relic.rarity] || 100;

            playerState.resources += gainedResources;
            playerState.relicInventory.splice(relicIndex, 1);
            
            relicDetailModal.classList.add('hidden');
            showMessage(`${GAME_DATA.RELIC_SETS[relic.setId].name}ã‚’åˆ†è§£ã—ã€${gainedResources}è³‡æºã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`);
            renderRelicScreen();
            updateHubUI();
        }
        function getActiveSetBonus() {
            const equippedSets = {};
            Object.values(playerState.equippedRelics).forEach(relicId => {
                if (relicId) {
                    const relic = getRelicInstance(relicId);
                    equippedSets[relic.setId] = (equippedSets[relic.setId] || 0) + 1;
                }
            });
            const activeBonuses = [];
            for (const setId in equippedSets) {
                const count = equippedSets[setId];
                const setInfo = GAME_DATA.RELIC_SETS[setId];
                let highestBonus = null;
                setInfo.bonus.forEach(bonus => {
                    if (count >= bonus.count) {
                        highestBonus = {setInfo, count: bonus.count, bonus};
                    }
                });
                if(highestBonus) activeBonuses.push(highestBonus);
            }
            return activeBonuses;
        }
        function createRelic(setIds, rarity) {
            const setId = setIds[Math.floor(Math.random() * setIds.length)];
            const part = GAME_DATA.RELIC_PARTS[Math.floor(Math.random() * GAME_DATA.RELIC_PARTS.length)];
            const mainStatKey = Object.keys(GAME_DATA.RELIC_MAIN_STATS[part])[0];
            const rarityIndex = Math.min(rarity - 3, GAME_DATA.RELIC_MAIN_STATS[part][mainStatKey].length - 1);
            const mainStatValue = GAME_DATA.RELIC_MAIN_STATS[part][mainStatKey][rarityIndex];

            const newRelic = {
                uniqueId: getNextUniqueId(),
                setId: setId,
                rarity: rarity,
                part: part,
                level: 0,
                mainStat: { [mainStatKey]: mainStatValue },
            };
            return newRelic;
        }

        function startBattle(battleInfo) {
            if (playerState.party.length === 0) { showMessage('å‡ºæ’ƒã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç·¨æˆã—ã¦ãã ã•ã„ã€‚'); return; }
            gameState.preBattleScreen = gameState.currentScreen; let enemies = []; let statMultiplier = 1; let enemyIds = []; gameState.battleType = battleInfo.type;
            if (battleInfo.type === 'map') {
                const mapData = GAME_DATA.MAPS[gameState.currentMap];
                if (gameState.currentMap === 'underground') statMultiplier = 3; if (gameState.currentMap === 'heaven') statMultiplier = 8; if (gameState.currentMap === 'abyss') statMultiplier = 15; if (gameState.currentMap === 'soukai') statMultiplier = 25;
                let enemyId;
                if (battleInfo.id === mapData.bossTile) enemyId = mapData.bossId;
                else if (mapData.midBossTiles[battleInfo.id]) enemyId = mapData.midBossTiles[battleInfo.id];
                else if (mapData.eliteTiles[battleInfo.id]) enemyId = mapData.eliteTiles[battleInfo.id];
                if (enemyId) { enemyIds.push(enemyId); } else { const numEnemies = Math.floor(Math.random() * 2) + 1; for (let i = 0; i < numEnemies; i++) enemyIds.push(mapData.enemies[Math.floor(Math.random() * mapData.enemies.length)]); }
            } else if (battleInfo.type === 'god') { enemyIds.push(battleInfo.id); statMultiplier = 10;
            } else if (battleInfo.type === 'relic_hunt') {
                const level = GAME_DATA.RELIC_HUNT_LEVELS[battleInfo.levelIndex];
                enemyIds.push(...level.enemies);
                statMultiplier = level.statMultiplier;
            } else if (battleInfo.type === 'infinite_corridor') {
                statMultiplier = 1 + (battleInfo.floor - 1) * 0.25;
                const numEnemies = Math.min(3, 1 + Math.floor(battleInfo.floor / 10));
                for(let i = 0; i < numEnemies; i++) {
                    enemyIds.push(GAME_DATA.INFINITE_CORRIDOR_ENEMIES[Math.floor(Math.random() * GAME_DATA.INFINITE_CORRIDOR_ENEMIES.length)]);
                }
            }
            function createEnemyInstance(baseId, instanceIndex, multiplier) { const master = { ...GAME_DATA.ENEMIES[baseId] }; const instance = { ...master, baseId: baseId }; instance.id = `enemy-${instanceIndex}`; instance.hp = Math.floor(master.hp * multiplier); instance.atk = Math.floor(master.atk * multiplier); instance.spd = Math.floor(master.spd * multiplier); instance.maxHp = instance.hp; instance.currentHp = instance.hp; return instance; }
            enemies = enemyIds.map((id, i) => createEnemyInstance(id, i, statMultiplier));
            
            const activeBonuses = getActiveSetBonus();

            const party = playerState.party.map((charUniqueId, index) => {
                const charMaster = GAME_DATA.CHARACTERS[getCharacterInstance(charUniqueId).charId];
                let stats = getCharacterFullStats(charUniqueId); // This already includes relic stats
                
                return { ...getCharacterInstance(charUniqueId), ...charMaster, ...stats, id: `player-${index}`, maxHp: stats.hp, currentHp: stats.hp, ultimateGauge: 0, normalAttackEnhance: { turns: 0, power: 1.0 }, otherworldAttackEnhance: { turns: 0, power: 1.0, isFree: false }, battleTriggers: { gutsUsed: false, chrono_extra_turn: false, abyss_dot: false }, activeBonuses };
            });

            const crownRelicId = playerState.equippedRelics.crown;
            const crownRelic = crownRelicId ? getRelicInstance(crownRelicId) : null;
            let initialAp = 2 + (crownRelic ? crownRelic.mainStat.ap : 0);
            
            const prophetBonus = activeBonuses.find(b => b.setInfo.name === 'é è¨€è€…' && b.count >= 4);
            if(prophetBonus) {
                party.forEach(p => p.ultimateGauge = Math.min(p.skills.ultimate.cost, (p.ultimateGauge || 0) + 25));
            }

            gameState.battle = { battleInfo, party, enemies, turn: 0, currentAction: null, partyBuffs: [], partyShield: 0, partyShieldMax: 0, log: [], actionPoints: 0, actionPointsMax: 10, floor: battleInfo.floor || 0};
            gameState.battle.actionPoints = Math.min(initialAp, gameState.battle.actionPointsMax);
            
            gameState.battle.turnOrder = [...party, ...enemies].sort((a, b) => b.spd - a.spd);
            renderBattleScreen(); switchScreen('battle-screen'); addBattleLog('æˆ¦é—˜é–‹å§‹ï¼');
            if(prophetBonus) addBattleLog('é è¨€è€…ã‚»ãƒƒãƒˆåŠ¹æœã§çµ‚ç„‰ã‚²ãƒ¼ã‚¸ãŒä¸Šæ˜‡ï¼');
            setTimeout(battleTurn, 50);
        }
        function renderBattleScreen() {
            const playerArea = document.getElementById('player-area'); const enemyArea = document.getElementById('enemy-area'); const battleHeader = document.getElementById('battle-header');
            playerArea.innerHTML = ''; enemyArea.innerHTML = ''; if(!gameState.battle) return;
            if (gameState.battleType === 'infinite_corridor') { battleHeader.textContent = `ç„¡é™å›å»Š ${gameState.battle.floor}éš`; } else { battleHeader.textContent = ''; }
            gameState.battle.party.forEach(char => playerArea.appendChild(createBattleCharacterCard(char, 'player')));
            gameState.battle.enemies.forEach(enemy => enemyArea.appendChild(createBattleCharacterCard(enemy, 'enemy')));
            updateBattleUI();
        }
        function createBattleCharacterCard(unit, type) {
            const card = document.createElement('div'); card.id = `battle-card-${unit.id}`;
            card.className = 'w-32 h-44 glass-panel p-2 flex flex-col justify-between items-center rounded-lg relative overflow-hidden transition-all';
            if (type === 'enemy') card.classList.add('cursor-pointer', 'hover:border-red-500', 'border', 'border-transparent');
            const attrData = GAME_DATA.ATTRIBUTES[unit.attribute];
            const rarityClass = (unit.rarity && GAME_DATA.RARITY[unit.rarity]) ? GAME_DATA.RARITY[unit.rarity].colorClass : 'text-white';
            const roleSymbol = (unit.role) ? GAME_DATA.ROLES[unit.role].symbol : '';
            card.innerHTML = `<p class="text-sm font-bold truncate ${rarityClass}">${roleSymbol} ${unit.name}</p><div class="w-24 h-24 bg-black bg-opacity-40 rounded flex items-center justify-center text-5xl">${unit.symbol || attrData.symbol}</div><div class="w-full relative h-2.5"><div id="hp-${unit.id}" class="bg-green-500 h-2.5 rounded-full" style="width: ${(unit.currentHp / unit.maxHp) * 100}%"></div></div><p class="text-xs">${Math.ceil(unit.currentHp)} / ${unit.maxHp}</p>`;
            if(type === 'enemy') card.onclick = () => handlePlayerTargetSelection(card.id.replace('battle-card-', ''));
            return card;
        }
        function battleTurn() {
            if(!gameState.battle) return;
            if(gameState.battle.party.every(p => p.currentHp <= 0)) { endBattle(false); return; }
            if(gameState.battle.enemies.every(e => e.currentHp <= 0)) { endBattle(true); return; }
            
            const currentTurnIndex = gameState.battle.turn % gameState.battle.turnOrder.length;
            const currentUnit = gameState.battle.turnOrder[currentTurnIndex];

            // --- Start of turn ---
            if (currentUnit.id.startsWith('player')) {
                // Abyss set DoT
                const abyssDotSource = gameState.battle.party.find(p => p.activeBonuses.some(b => b.setInfo.name === 'æ·±æ·µ' && b.count >= 4) && p.currentHp > 0);
                if(abyssDotSource && !currentUnit.battleTriggers.abyss_dot) {
                    gameState.battle.enemies.forEach(enemy => {
                        if(enemy.currentHp > 0) {
                            const dotDamage = Math.floor(abyssDotSource.maxHp * 0.05);
                            enemy.currentHp = Math.max(0, enemy.currentHp - dotDamage);
                            addBattleLog(`æ·±æ·µã‚»ãƒƒãƒˆåŠ¹æœãŒæ•µå…¨ä½“ã«${dotDamage}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆãŸã€‚`);
                            const targetCard = document.getElementById(`battle-card-${enemy.id}`); const damagePopup = document.createElement('div'); damagePopup.className = 'damage-popup text-purple-400'; damagePopup.textContent = dotDamage; targetCard?.appendChild(damagePopup); setTimeout(() => damagePopup.remove(), 700);
                        }
                    });
                    currentUnit.battleTriggers.abyss_dot = true; // Prevents multi-trigger in one "turn cycle"
                }
            }
             // Reset dot trigger for next cycle
            if(currentTurnIndex === 0) {
                gameState.battle.party.forEach(p => p.battleTriggers.abyss_dot = false);
            }
            
            // Buff/debuff duration update
            if (currentTurnIndex === 0 && gameState.battle.turn > 0) {
                gameState.battle.partyBuffs.forEach(buff => buff.duration--);
                const expiredBuffs = gameState.battle.partyBuffs.filter(buff => buff.duration <= 0);
                expiredBuffs.forEach(buff => addBattleLog(`ãƒ‘ãƒ¼ãƒ†ã‚£ã®${buff.buffType === 'damage' ? 'æ”»æ’ƒåŠ›' : 'é€Ÿåº¦'}ãƒãƒ•ãŒåˆ‡ã‚ŒãŸã€‚`));
                gameState.battle.partyBuffs = gameState.battle.partyBuffs.filter(buff => buff.duration > 0);
            }

            if (currentUnit.id.startsWith('player')) {
                if (currentUnit.normalAttackEnhance?.turns > 0) {
                    currentUnit.normalAttackEnhance.turns--;
                    if(currentUnit.normalAttackEnhance.turns === 0) addBattleLog(`${currentUnit.name}ã®é€šå¸¸æ”»æ’ƒå¼·åŒ–ãŒçµ‚äº†ã—ãŸã€‚`);
                }
                if (currentUnit.otherworldAttackEnhance?.turns > 0) {
                    currentUnit.otherworldAttackEnhance.turns--;
                    if(currentUnit.otherworldAttackEnhance.turns === 0) addBattleLog(`${currentUnit.name}ã®ç•°ç•Œæ”»æ’ƒå¼·åŒ–ãŒçµ‚äº†ã—ãŸã€‚`);
                }
            }
            
            if(gameState.battle.enemies.every(e => e.currentHp <= 0)) { endBattle(true); return; }
            updateBattleUI();
            if (currentUnit.currentHp <= 0) { gameState.battle.turn++; setTimeout(battleTurn, 50); return; }
            
            document.querySelectorAll('[id^=battle-card-]').forEach(c => c.classList.remove('border-yellow-400', 'border-2', 'scale-105'));
            document.getElementById(`battle-card-${currentUnit.id}`)?.classList.add('border-yellow-400', 'border-2', 'scale-105');
            
            if (currentUnit.id.startsWith('player')) { renderActionButtons(currentUnit); } 
            else { renderActionButtons(null); addBattleLog(`${currentUnit.name}ã®ã‚¿ãƒ¼ãƒ³ã€‚`); setTimeout(() => enemyTurn(currentUnit), 1000); }
        }
        function renderActionButtons(unit) {
            const actionArea = document.getElementById('action-buttons-area'); const statusArea = document.getElementById('character-status-area');
            actionArea.innerHTML = ''; statusArea.innerHTML = '';
            if (unit) {
                const rarityClass = GAME_DATA.RARITY[unit.rarity].colorClass;
                statusArea.innerHTML = `<div class="text-center p-2"><p class="text-lg font-bold ${rarityClass}">${unit.name}</p><p class="text-sm">HP: ${Math.ceil(unit.currentHp)}/${unit.maxHp}</p><div class="w-full bg-gray-700 rounded-full h-4 mt-1"><div class="bg-purple-500 h-4 rounded-full" style="width: ${Math.min(100, (unit.ultimateGauge || 0) / unit.skills.ultimate.cost * 100)}%"></div></div><p class="text-xs">çµ‚ç„‰ã‚²ãƒ¼ã‚¸: ${unit.ultimateGauge || 0}/${unit.skills.ultimate.cost}</p></div>`;
                const otherworldSkill = unit.skills.otherworld;
                const ultimateSkill = unit.skills.ultimate;

                let normalBtnClass = 'btn-secondary'; let normalBtnText = 'é€šå¸¸æ”»æ’ƒ';
                if(unit.normalAttackEnhance?.turns > 0) { normalBtnClass = 'btn-enhanced'; normalBtnText = 'å¼·åŒ–é€šå¸¸æ”»æ’ƒ'; }

                let otherworldBtnClass = 'btn-secondary'; let otherworldBtnText = `${otherworldSkill.name} (AP:${otherworldSkill.cost})`; let otherworldDisabled = gameState.battle.actionPoints < otherworldSkill.cost;
                if(unit.otherworldAttackEnhance?.turns > 0) {
                    otherworldBtnClass = 'btn-enhanced';
                    otherworldBtnText = `å¼·åŒ–${otherworldSkill.name}`;
                    if(unit.otherworldAttackEnhance.isFree) { otherworldBtnText += ' (AP:0)'; otherworldDisabled = false; } else { otherworldBtnText += ` (AP:${otherworldSkill.cost})`; }
                }

                let ultimateDisabled = (unit.ultimateGauge || 0) < ultimateSkill.cost;
                if(unit.attackerType === 'gauge_flexible') { ultimateDisabled = (unit.ultimateGauge || 0) <= 0; }

                actionArea.innerHTML = `
                    <button data-action="normal" class="action-btn ${normalBtnClass} w-full py-1 rounded-lg text-sm">${normalBtnText}</button>
                    <button data-action="otherworld" class="action-btn ${otherworldBtnClass} w-full py-1 rounded-lg text-sm" ${otherworldDisabled ? 'disabled' : ''}>${otherworldBtnText}</button>
                    <button data-action="ultimate" class="action-btn btn-secondary w-full py-1 rounded-lg text-sm" ${ultimateDisabled ? 'disabled' : ''}>${ultimateSkill.name}</button>
                `;
                document.querySelectorAll('.action-btn').forEach(btn => { if (!btn.disabled && !btn.classList.contains('btn-enhanced')) { btn.classList.remove('btn-secondary'); btn.classList.add('btn-primary'); } btn.onclick = () => preparePlayerAction(btn.dataset.action); });
            }
        }
        function preparePlayerAction(actionType) {
            const battle = gameState.battle; const currentUnit = battle.turnOrder[battle.turn % battle.turnOrder.length];
            let skill = null; if (actionType !== 'normal') skill = currentUnit.skills[actionType];
            const effectType = skill ? skill.effect.type : 'damage';
            if(effectType === 'damage' || (skill && skill.effect.target === 'all')) { battle.currentAction = { type: actionType, attacker: currentUnit }; addBattleLog(`${currentUnit.name}ã¯${actionType === 'normal' ? 'é€šå¸¸æ”»æ’ƒ' : skill.name}ã®å¯¾è±¡ã‚’é¸æŠ...`); if(skill?.effect?.target === 'all'){ handlePlayerTargetSelection(null); } } // Auto-select for AoE
            else { executeAction(currentUnit, null, actionType); }
        }
        function handlePlayerTargetSelection(targetId) {
            const battle = gameState.battle; if (!battle.currentAction) return;
            executeAction(battle.currentAction.attacker, targetId, battle.currentAction.type);
            battle.currentAction = null; 
        }
        function enemyTurn(attacker) {
            const livingPlayers = gameState.battle.party.filter(p => p.currentHp > 0); if (livingPlayers.length === 0) return;
            const target = livingPlayers[Math.floor(Math.random() * livingPlayers.length)];
            executeAction(attacker, target.id, 'normal'); 
        }
        function executeAction(attacker, targetId, actionType) {
            const battle = gameState.battle; const attackerCard = document.getElementById(`battle-card-${attacker.id}`);
            attackerCard?.classList.add('attacking'); setTimeout(() => attackerCard?.classList.remove('attacking'), 300);
            let effect, logMsg, skillName = "é€šå¸¸æ”»æ’ƒ";
            
            let gaugeGainMultiplier = 1;
            const sageBonus = attacker.activeBonuses?.find(b => b.setInfo.name === 'è³¢è€…' && b.count >= 2);
            if(sageBonus) gaugeGainMultiplier += 0.2;
            const baseGaugeGain = attacker.id.startsWith('player') ? 10 * gaugeGainMultiplier : 0;
            
            if (actionType === 'normal') {
                let power = attacker.id.startsWith('player') ? 0.5 : 1.0;
                if(attacker.normalAttackEnhance?.turns > 0) { power *= attacker.normalAttackEnhance.power; skillName = "å¼·åŒ–é€šå¸¸æ”»æ’ƒ"; }
                 const warriorBonus = attacker.activeBonuses?.find(b => b.setInfo.name === 'æˆ¦å£«' && b.count >= 4);
                 if(warriorBonus) { power *= 1.4; }
                effect = { type: 'damage', power: power };
                logMsg = `${attacker.name}ã®${skillName}ï¼`;
                if (attacker.id.startsWith('player')) { attacker.ultimateGauge = Math.min(attacker.skills.ultimate.cost, (attacker.ultimateGauge || 0) + baseGaugeGain); battle.actionPoints = Math.min(battle.actionPointsMax, battle.actionPoints + 1); }
            } else {
                const skill = attacker.skills[actionType]; skillName = skill.name; effect = skill.effect;
                logMsg = `${attacker.name}ã®ã€Œ${skillName}ã€ï¼`;
                if (actionType === 'otherworld') { 
                    if (!attacker.otherworldAttackEnhance?.isFree) battle.actionPoints -= skill.cost;
                    if (attacker.id.startsWith('player')) attacker.ultimateGauge = Math.min(attacker.skills.ultimate.cost, (attacker.ultimateGauge || 0) + baseGaugeGain * 2); 
                    const sovereignBonus = attacker.activeBonuses?.find(b => b.setInfo.name === 'å›ä¸»' && b.count >= 4);
                    if(sovereignBonus) { battle.party.forEach(p => p.currentHp = Math.min(p.maxHp, p.currentHp + p.maxHp * 0.1)); addBattleLog('å›ä¸»ã‚»ãƒƒãƒˆåŠ¹æœã§ãƒ‘ãƒ¼ãƒ†ã‚£ã®HPãŒ10%å›å¾©ã€‚'); }
                }
                if (actionType === 'ultimate') {
                    if (attacker.attackerType !== 'gauge_flexible') { attacker.ultimateGauge = 0; }
                    if (attacker.id.startsWith('player')) battle.actionPoints = Math.min(battle.actionPointsMax, battle.actionPoints + 1);
                    const sageBonus = attacker.activeBonuses?.find(b => b.setInfo.name === 'è³¢è€…' && b.count >= 4);
                    if(sageBonus) { battle.party.forEach(p => p.ultimateGauge = Math.min(p.skills.ultimate.cost, (p.ultimateGauge || 0) + 20)); addBattleLog('è³¢è€…ã‚»ãƒƒãƒˆåŠ¹æœã§ãƒ‘ãƒ¼ãƒ†ã‚£ã®çµ‚ç„‰ã‚²ãƒ¼ã‚¸ãŒ20å›å¾©ã€‚'); }
                }
            }
            addBattleLog(logMsg);

            switch(effect.type) {
                case 'damage': {
                    const targets = [];
                    if (effect.target === 'all') { if(attacker.id.startsWith('player')) targets.push(...battle.enemies.filter(e => e.currentHp > 0)); else targets.push(...battle.party.filter(p => p.currentHp > 0)); } 
                    else { if(attacker.id.startsWith('player')) targets.push(battle.enemies.find(e => e.id === targetId)); else targets.push(battle.party.find(p => p.id === targetId)); }
                    if (targets.length === 0 || !targets[0]) break;
                    
                    targets.forEach(target => {
                        let damageMultiplier = effect.power;
                        if (attacker.id.startsWith('player')) {
                            battle.partyBuffs.forEach(buff => { if(buff.buffType === 'damage') damageMultiplier *= buff.multiplier; });
                            if (actionType === 'otherworld' && attacker.otherworldAttackEnhance?.turns > 0) { damageMultiplier *= attacker.otherworldAttackEnhance.power; }
                            const berserkerBonus = attacker.activeBonuses?.find(b => b.setInfo.name === 'ç‹‚æˆ¦å£«' && b.count >= 4);
                            if(berserkerBonus && attacker.currentHp / attacker.maxHp <= 0.5) damageMultiplier *= 1.5;
                            if (actionType === 'ultimate') {
                               const assassinBonus = attacker.activeBonuses?.find(b => b.setInfo.name === 'æš—æ®ºè€…' && b.count >= 4);
                               if(assassinBonus) damageMultiplier *= 1.5;
                            }
                        }
                        let damage = Math.max(1, attacker.atk * damageMultiplier);

                        if(actionType === 'ultimate' && attacker.attackerType === 'gauge_flexible') {
                            const gaugeRatio = (attacker.ultimateGauge || 0) / attacker.skills.ultimate.cost;
                            damage = Math.floor(damage * gaugeRatio);
                            addBattleLog(`ã‚²ãƒ¼ã‚¸${attacker.ultimateGauge}ã‚’è§£æ”¾ï¼`);
                            attacker.ultimateGauge = 0;
                        }

                        if (target.id.startsWith('player') && battle.partyShield > 0) { const shieldDamage = Math.min(damage, battle.partyShield); battle.partyShield -= shieldDamage; damage -= shieldDamage; addBattleLog(`ã‚·ãƒ¼ãƒ«ãƒ‰ãŒ${Math.ceil(shieldDamage)}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å¸åï¼`); }
                        let finalDamage = damage;
                        if (target.id.startsWith('player') && target.currentHp - finalDamage <= 0) {
                            const gutsPotential = target.potentials.find((p,i) => target.unlockedPotentials[i] && p.effect.type === 'guts');
                            if (gutsPotential && !target.battleTriggers.gutsUsed) {
                                finalDamage = target.currentHp - 1;
                                target.battleTriggers.gutsUsed = true;
                                addBattleLog(`${target.name}ã¯æŒã¡ã“ãŸãˆãŸï¼`);
                            }
                        }
                        
                        target.currentHp = Math.max(0, target.currentHp - finalDamage);
                        const targetCard = document.getElementById(`battle-card-${target.id}`); const damagePopup = document.createElement('div'); damagePopup.className = 'damage-popup'; damagePopup.textContent = Math.floor(finalDamage); targetCard?.appendChild(damagePopup); setTimeout(() => damagePopup.remove(), 700);
                        if (target.currentHp <= 0) { addBattleLog(`${target.name}ã‚’æ’ƒç ´ï¼`); }
                    });
                    break;
                }
                case 'self_buff': {
                    if(effect.buffTarget === 'normal_attack') {
                        attacker.normalAttackEnhance = { turns: effect.duration + 1, power: effect.power };
                        addBattleLog(`${attacker.name}ã¯æ¬¡ã®${effect.duration}ã‚¿ãƒ¼ãƒ³ã€é€šå¸¸æ”»æ’ƒãŒå¼·åŒ–ã•ã‚Œã‚‹ï¼`);
                    } else if (effect.buffTarget === 'otherworld_attack') {
                        attacker.otherworldAttackEnhance = { turns: effect.duration + 1, power: effect.power, isFree: effect.isFree };
                        addBattleLog(`${attacker.name}ã¯æ¬¡ã®${effect.duration}ã‚¿ãƒ¼ãƒ³ã€ç•°ç•Œæ”»æ’ƒãŒå¼·åŒ–ã•ã‚Œã‚‹ï¼`);
                    }
                    break;
                }
                case 'shield': {
                    let shieldMultiplier = 1.0;
                    const guardianBonus = attacker.activeBonuses?.find(b => b.setInfo.name === 'å®ˆè­·è€…' && b.count >= 4);
                    if(guardianBonus) shieldMultiplier *= 1.2;
                    const shieldAmount = Math.floor(attacker.maxHp * effect.power * shieldMultiplier);
                    battle.partyShield = shieldAmount; battle.partyShieldMax = shieldAmount; addBattleLog(`ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã«${shieldAmount}ã®ã‚·ãƒ¼ãƒ«ãƒ‰ãŒä»˜ä¸ã•ã‚ŒãŸï¼`); break;
                }
                case 'heal': { const healAmount = Math.floor(attacker.maxHp * effect.power); battle.party.forEach(target => { if (target.currentHp > 0) target.currentHp = Math.min(target.maxHp, target.currentHp + healAmount); }); addBattleLog(`ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãŒ${healAmount}å›å¾©ã—ãŸï¼`); break; }
                case 'buff': {
                    const dupeBonus = effect.dupeBonus * (getCharacterInstance(attacker.uniqueId).duplicationBonus || 0); const finalMultiplier = effect.multiplier + dupeBonus; battle.partyBuffs.push({ ...effect, multiplier: finalMultiplier });
                    const buffName = effect.buffType === 'damage' ? 'æ”»æ’ƒåŠ›' : 'é€Ÿåº¦'; addBattleLog(`ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã®${buffName}ãŒ${finalMultiplier.toFixed(2)}å€ã«ãªã£ãŸï¼ (${effect.duration}ã‚¿ãƒ¼ãƒ³)`); break;
                }
                case 'ap_gain': { battle.actionPoints = Math.min(battle.actionPointsMax, battle.actionPoints + effect.amount); addBattleLog(`æ”»æ’ƒãƒã‚¤ãƒ³ãƒˆ(AP)ã‚’${effect.amount}ç²å¾—ã—ãŸï¼`); break; }
                case 'ap_max_up': { battle.actionPointsMax += effect.amount; battle.actionPoints += effect.amount; addBattleLog(`æœ€å¤§APãŒ${effect.amount}å¢—åŠ ã—ãŸï¼`); break; }
                case 'ultimate_gauge_charge': { battle.party.forEach(p => p.ultimateGauge = Math.min(p.skills.ultimate.cost, p.ultimateGauge + effect.amount)); addBattleLog(`ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼å…¨ä½“ã®çµ‚ç„‰ã‚²ãƒ¼ã‚¸ãŒ${effect.amount}å¢—åŠ ã—ãŸï¼`); break; }
            }
            updateBattleUI();
            
            // Post-action turn logic
            const chronoBonus = attacker.activeBonuses?.find(b => b.setInfo.name === 'æ™‚ç©º' && b.count >= 4);
            if (attacker.id.startsWith('player') && chronoBonus && Math.random() < 0.2) {
                addBattleLog(`${attacker.name}ã¯æ™‚ç©ºã‚»ãƒƒãƒˆã®åŠ¹æœã§å†åº¦è¡Œå‹•ã™ã‚‹ï¼`);
                // No turn increment, effectively giving another action
                setTimeout(() => battleTurn(), 1000); // Re-run turn logic for the same character
            } else {
                battle.turn++;
                setTimeout(battleTurn, 1000);
            }
        }
        function updateBattleUI() {
            if (!gameState.battle) return;
            // Party shield
            const shieldContainer = document.getElementById('party-shield-bar-container');
            if (shieldContainer) {
                if (gameState.battle.partyShield > 0) { const shieldPercent = (gameState.battle.partyShield / gameState.battle.partyShieldMax) * 100; shieldContainer.innerHTML = `<div class="text-center text-xs text-blue-300 mb-1">ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã‚·ãƒ¼ãƒ«ãƒ‰: ${Math.ceil(gameState.battle.partyShield)}</div><div class="w-full bg-gray-700 rounded-full h-4"><div class="bg-blue-500 h-4 rounded-full transition-all duration-300" style="width: ${shieldPercent}%"></div></div>`;
                } else { shieldContainer.innerHTML = ''; }
            }
            // Buff display
            const buffDisplay = document.getElementById('party-buff-display');
            if(buffDisplay) {
                let buffText = [];
                const damageBuff = gameState.battle.partyBuffs.find(b => b.buffType === 'damage');
                const speedBuff = gameState.battle.partyBuffs.find(b => b.buffType === 'speed');
                if(damageBuff) buffText.push(`<span class="text-red-400">æ”»æ’ƒ x${damageBuff.multiplier.toFixed(2)}</span> (ã‚ã¨${damageBuff.duration})`);
                if(speedBuff) buffText.push(`<span class="text-green-400">é€Ÿåº¦ x${speedBuff.multiplier.toFixed(2)}</span> (ã‚ã¨${speedBuff.duration})`);
                buffDisplay.innerHTML = buffText.join(' / ');
            }
            // Action Points
            const apDisplay = document.getElementById('action-point-display');
            if (apDisplay) {
                apDisplay.innerHTML = `<span class="self-center text-sm mr-2">AP: </span>`;
                for(let i = 0; i < gameState.battle.actionPointsMax; i++) {
                    const filled = i < gameState.battle.actionPoints;
                    const diamondSVG = `<svg width="20" height="20" viewBox="0 0 16 16" class="inline-block"><path d="M8 0L16 8L8 16L0 8L8 0Z" fill="${filled ? '#22d3ee' : 'none'}" stroke="${filled ? '#a5f3fc' : '#4b5563'}" stroke-width="1.5"/></svg>`;
                    apDisplay.innerHTML += diamondSVG;
                }
            }
            // Turn Order
            const turnOrderDisplay = document.getElementById('turn-order-display');
            if(turnOrderDisplay) {
                turnOrderDisplay.innerHTML = '<span class="text-sm self-center mr-2">è¡Œå‹•é †:</span>';
                let displayedCount = 0;
                for(let i=0; displayedCount<8 && i < gameState.battle.turnOrder.length * 2; i++) {
                    const unit = gameState.battle.turnOrder[(gameState.battle.turn + i) % gameState.battle.turnOrder.length];
                    if(unit.currentHp <= 0) continue; 
                    const icon = document.createElement('div');
                    const isPlayer = unit.id.startsWith('player');
                    icon.className = `w-10 h-10 rounded-full flex items-center justify-center text-2xl bg-black bg-opacity-40 border-2 ${ isPlayer ? 'border-cyan-400' : 'border-red-500'} ${i === 0 ? 'scale-110 shadow-lg shadow-yellow-500/50' : 'opacity-70'}`;
                    icon.innerHTML = unit.symbol || GAME_DATA.ATTRIBUTES[unit.attribute].symbol;
                    turnOrderDisplay.appendChild(icon);
                    displayedCount++;
                }
            }
            // Units HP
            [...gameState.battle.party, ...gameState.battle.enemies].forEach(unit => {
                const card = document.getElementById(`battle-card-${unit.id}`); if (!card) return;
                const hpBar = card.querySelector(`#hp-${unit.id}`); const hpText = card.querySelector('p:last-child');
                if (unit.currentHp <= 0) { card.style.opacity = '0.4'; if(hpBar) hpBar.style.width = '0%'; } 
                else { card.style.opacity = '1'; if (hpBar) hpBar.style.width = `${(unit.currentHp / unit.maxHp) * 100}%`; if (hpText) hpText.textContent = `${Math.ceil(unit.currentHp)}/${unit.maxHp}`; }
            });
        }
        function endBattle(isWin) {
            const battleState = gameState.battle; const preBattleScreen = gameState.preBattleScreen || 'hub-screen';
            if (isWin) {
                if (gameState.battleType === 'infinite_corridor') {
                    addBattleLog(`${battleState.floor}éšã‚’ã‚¯ãƒªã‚¢ï¼`);
                    const nextFloor = battleState.floor + 1;
                    setTimeout(() => {
                        startBattle({ type: 'infinite_corridor', floor: nextFloor });
                    }, 1500);
                    return; 
                }
                let message = "å‹åˆ©ï¼";
                let etherWon = 0;

                if (gameState.battleType === 'map') {
                     const battleTileId = battleState.battleInfo.id;
                     const mapData = GAME_DATA.MAPS[gameState.currentMap];
                     if(battleTileId === mapData.bossTile) etherWon += 5;
                     else if (mapData.eliteTiles[battleTileId]) etherWon += 2;
                }
                else if (gameState.battleType === 'god') {
                    const firstEnemy = battleState.enemies[0]; const enemyMaster = GAME_DATA.ENEMIES[firstEnemy.baseId]; const godId = enemyMaster.rewardId.replace('c_god_', '');
                    if (!playerState.godsDefeated[godId]) { playerState.godsDefeated[godId] = true; const godChar = GAME_DATA.CHARACTERS[enemyMaster.rewardId]; addCharacter(enemyMaster.rewardId); message += `\n\n<span class="${GAME_DATA.RARITY[godChar.rarity].colorClass} font-bold">ã€Œ${godChar.name}ã€</span>ãŒä»²é–“ã«åŠ ã‚ã£ãŸï¼`; }
                    etherWon += 15;
                } else if (gameState.battleType === 'relic_hunt') {
                    const { levelIndex } = battleState.battleInfo;
                    const level = GAME_DATA.RELIC_HUNT_LEVELS[levelIndex];
                    const rewards = level.rewards;
                    const isFirstClear = !playerState.clearedRelicHuntLevels[level.id];
                    if (isFirstClear || Math.random() < rewards.relics.rate) {
                         const newRelic = createRelic(rewards.relics.setIds, rewards.relics.rarity);
                         playerState.relicInventory.push(newRelic);
                         const setInfo = GAME_DATA.RELIC_SETS[newRelic.setId];
                         message += `\n\n<span class="${GAME_DATA.RARITY[newRelic.rarity].colorClass} font-bold">è–éºç‰©ã€Œ${setInfo.name}ã€</span>ã‚’ç™ºè¦‹ï¼`;
                         if (isFirstClear) { playerState.clearedRelicHuntLevels[level.id] = true; }
                    }
                    if (rewards.materials.ether_crystal && Math.random() < rewards.materials.ether_crystal.rate) {
                        const amount = rewards.materials.ether_crystal.amount;
                        etherWon += amount[0] + Math.floor(Math.random() * (amount[1] - amount[0] + 1));
                    }
                }
                if (battleState.battleInfo.type === 'map') { if (!playerState.mapProgress[gameState.currentMap]) playerState.mapProgress[gameState.currentMap] = {}; playerState.mapProgress[gameState.currentMap][battleState.battleInfo.id] = true; message += "\né ˜åŸŸã‚’æµ„åŒ–ã—ã¾ã—ãŸã€‚"; }
                const resourcesWon = Math.floor(Math.random() * 50) + 50 + (battleState.enemies.length * 20); playerState.resources += resourcesWon; message += `\n${resourcesWon}ã®è³‡æºã‚’ç²å¾—ã—ãŸã€‚`;
                let ticketsWon = 0;
                battleState.enemies.forEach(enemy => {
                    const masterEnemy = GAME_DATA.ENEMIES[enemy.baseId];
                    if (masterEnemy && masterEnemy.ticketDrop && Math.random() < masterEnemy.ticketDrop.rate) { const amount = masterEnemy.ticketDrop.amount; ticketsWon += Array.isArray(amount) ? amount[0] + Math.floor(Math.random() * (amount[1] - amount[0] + 1)) : amount; }
                });
                if (ticketsWon > 0) { playerState.gachaTickets += ticketsWon; message += `\né™è‡¨ãƒã‚±ãƒƒãƒˆã‚’${ticketsWon}æšç™ºè¦‹ã—ãŸï¼`; }
                if (etherWon > 0) { playerState.limitBreakMaterials.ether_crystal += etherWon; message += `\nã‚¨ãƒ¼ãƒ†ãƒ«çµæ™¶ã‚’${etherWon}å€‹ç™ºè¦‹ã—ãŸï¼`; }
                
                showMessage(message, () => switchScreen(preBattleScreen)); checkEndings();
            } else { 
                if (gameState.battleType === 'infinite_corridor') {
                    const floorReached = gameState.battle.floor - 1;
                    playerState.infiniteCorridor.highestFloor = Math.max(playerState.infiniteCorridor.highestFloor, floorReached);
                    showMessage(`éƒ¨éšŠã¯æ’¤é€€ã—ãŸ...\nåˆ°é”éšå±¤: ${floorReached}éš\nè‡ªå·±æœ€é«˜è¨˜éŒ²: ${playerState.infiniteCorridor.highestFloor}éš`, () => switchScreen('infinite-corridor-screen'));
                } else {
                    addBattleLog('æˆ¦é—˜æ•—åŒ—...'); playerState.mentalPollution += 5; showMessage('éƒ¨éšŠã¯æ’¤é€€ã—ãŸ... (ç²¾ç¥æ±šæŸ“ +5)', () => switchScreen(preBattleScreen)); checkEndings();
                }
            }
            gameState.battle = null;
        }

        function updateGachaUI() { document.getElementById('gacha-tickets-display').textContent = playerState.gachaTickets; }
        function drawGacha(type, count) {
            if (playerState.gachaTickets < count) { showMessage('é™è‡¨ãƒã‚±ãƒƒãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚'); return; }
            playerState.gachaTickets -= count; const results = []; const rates = GAME_DATA.GACHA_RATES[type];
            const pool = type === 'character' ? Object.keys(GAME_DATA.CHARACTERS).filter(id => !id.startsWith('c_god')) : Object.keys(GAME_DATA.EQUIPMENT);
            for (let i = 0; i < count; i++) {
                const rand = Math.random(); let acquiredRarity = null;
                if (rand < rates[6]) acquiredRarity = 6; else if (rand < rates[5]) acquiredRarity = 5; else if (rand < rates[4]) acquiredRarity = 4;
                if (acquiredRarity) {
                    if (type === 'character') { const charPool = pool.filter(id => GAME_DATA.CHARACTERS[id].rarity === acquiredRarity); const charId = charPool[Math.floor(Math.random() * charPool.length)]; const result = addCharacter(charId); results.push({type: 'character', id: charId, isNew: result.isNew});
                    } else { const equipPool = pool.filter(id => GAME_DATA.EQUIPMENT[id].rarity === acquiredRarity); const equipId = equipPool[Math.floor(Math.random() * equipPool.length)]; addEquipment(equipId); results.push({type: 'equipment', id: equipId}); }
                } else { const reward = 100 * (Math.floor(Math.random() * 5) + 1); playerState.resources += reward; results.push({type: 'resource', amount: reward}); }
            }
            showGachaResultModal(results); updateGachaUI(); updateHubUI();
        }
        function showGachaResultModal(results) {
            const resultContainer = document.getElementById('gacha-result-list'); resultContainer.innerHTML = '';
            results.forEach(result => {
                const itemDiv = document.createElement('div'); itemDiv.className = 'glass-panel p-2 rounded-lg text-center h-28 flex flex-col justify-center items-center'; let master;
                if (result.type === 'character') { master = GAME_DATA.CHARACTERS[result.id]; const rarityClass = GAME_DATA.RARITY[master.rarity].colorClass; const bonusText = !result.isNew ? `<span class='text-xs text-yellow-400'>é‡è¤‡ãƒœãƒ¼ãƒŠã‚¹!</span>` : ''; itemDiv.innerHTML = `<div class="text-4xl">${master.symbol}</div><p class="font-bold text-sm ${rarityClass}">â˜…${master.rarity} ${master.name}</p>${bonusText}`;
                } else if (result.type === 'equipment') { master = GAME_DATA.EQUIPMENT[result.id]; const rarityClass = GAME_DATA.RARITY[master.rarity].colorClass; itemDiv.innerHTML = `<div class="text-4xl">${master.symbol}</div><p class="font-bold text-sm ${rarityClass}">â˜…${master.rarity} ${master.name}</p>`;
                } else { itemDiv.innerHTML = `<p class="font-bold text-gray-400">ç´ æ</p><p class="text-sm">${result.amount} è³‡æº</p>`; }
                resultContainer.appendChild(itemDiv);
            });
            gachaResultModal.classList.remove('hidden');
        }
        function renderInfiniteCorridorScreen() {
            document.getElementById('highest-floor-display').textContent = playerState.infiniteCorridor.highestFloor;
            const rewardsContainer = document.getElementById('corridor-rewards-list');
            rewardsContainer.innerHTML = '';

            for (const floor in GAME_DATA.INFINITE_CORRIDOR_REWARDS) {
                const reward = GAME_DATA.INFINITE_CORRIDOR_REWARDS[floor];
                const canClaim = playerState.infiniteCorridor.highestFloor >= floor && !playerState.infiniteCorridor.claimedRewards[floor];
                const isClaimed = playerState.infiniteCorridor.claimedRewards[floor];
                
                let rewardText = `${reward.resources || 0}è³‡æº, ${reward.gachaTickets || 0}ãƒã‚±ãƒƒãƒˆ, ${reward.materials.ether_crystal || 0}ã‚¨ãƒ¼ãƒ†ãƒ«çµæ™¶`;

                const rewardDiv = document.createElement('div');
                rewardDiv.className = `glass-panel p-3 rounded-lg flex justify-between items-center ${isClaimed ? 'opacity-50' : ''}`;
                rewardDiv.innerHTML = `
                    <div>
                        <p class="font-bold text-cyan-300">${floor}éš åˆ°é”å ±é…¬</p>
                        <p class="text-sm">${rewardText}</p>
                    </div>
                    <button class="claim-corridor-reward-btn btn-primary px-4 py-1 rounded-md" data-floor="${floor}" ${!canClaim ? 'disabled' : ''}>
                        ${isClaimed ? 'å—å–æ¸ˆ' : 'å—ã‘å–ã‚‹'}
                    </button>
                `;
                rewardsContainer.appendChild(rewardDiv);
            }
            document.querySelectorAll('.claim-corridor-reward-btn').forEach(btn => {
                if (!btn.disabled) btn.onclick = () => claimInfiniteCorridorReward(btn.dataset.floor);
            });
        }
        function claimInfiniteCorridorReward(floor) {
            const reward = GAME_DATA.INFINITE_CORRIDOR_REWARDS[floor];
            if (!reward) return;
            if (playerState.infiniteCorridor.highestFloor < floor) { showMessage("ã¾ã åˆ°é”ã—ã¦ã„ã¾ã›ã‚“ã€‚"); return; }
            if (playerState.infiniteCorridor.claimedRewards[floor]) { showMessage("ã“ã®å ±é…¬ã¯æ—¢ã«å—ã‘å–ã‚Šæ¸ˆã¿ã§ã™ã€‚"); return; }

            let message = `${floor}éšã®å ±é…¬ã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼\n`;
            if (reward.resources) { playerState.resources += reward.resources; message += `è³‡æº +${reward.resources}\n`; }
            if (reward.gachaTickets) { playerState.gachaTickets += reward.gachaTickets; message += `é™è‡¨ãƒã‚±ãƒƒãƒˆ +${reward.gachaTickets}\n`; }
            if (reward.materials.ether_crystal) { playerState.limitBreakMaterials.ether_crystal += reward.materials.ether_crystal; message += `ã‚¨ãƒ¼ãƒ†ãƒ«çµæ™¶ +${reward.materials.ether_crystal}`; }

            playerState.infiniteCorridor.claimedRewards[floor] = true;
            
            showMessage(message);
            renderInfiniteCorridorScreen();
            updateHubUI();
        }
        function startInfiniteCorridorRun() {
            const startFloor = playerState.infiniteCorridor.highestFloor + 1;
            startBattle({ type: 'infinite_corridor', floor: startFloor });
        }
        
        function getCharacterInstance(uniqueId) { return playerState.characters.find(c => c.uniqueId === uniqueId); }
        function getEquipmentInstance(uniqueId) { return playerState.equipment.find(e => e.uniqueId === uniqueId); }
        function getRelicInstance(uniqueId) { return playerState.relicInventory.find(r => r.uniqueId === uniqueId); }
        function getCharacterFullStats(uniqueId) {
            const character = getCharacterInstance(uniqueId); if (!character) return null;
            const master = GAME_DATA.CHARACTERS[character.charId]; const stats = { ...character.baseStats }; let bonusRate = 0.2;
            if (master.rarity === 5) { bonusRate = 0.5; } else if (master.rarity === 6) { bonusRate = 1.0; }
            const bonusMultiplier = 1 + (character.duplicationBonus || 0) * bonusRate;
            stats.hp = Math.floor(stats.hp * bonusMultiplier); stats.atk = Math.floor(stats.atk * bonusMultiplier); stats.spd = Math.floor(stats.spd * bonusMultiplier);
            // Equipment stats
            ['weapon', 'armor'].forEach(type => { const equipUniqueId = character.equipped[type]; if (equipUniqueId) { const equipment = getEquipmentInstance(equipUniqueId); const masterEquip = GAME_DATA.EQUIPMENT[equipment.equipId]; for (const key in masterEquip.stats) { stats[key] = (stats[key] || 0) + masterEquip.stats[key]; } } });
            // Relic flat stats
            Object.values(playerState.equippedRelics).forEach(relicId => { if(relicId){ const relic = getRelicInstance(relicId); for(const key in relic.mainStat) stats[key] = (stats[key] || 0) + relic.mainStat[key]; } });
            // Relic set bonus & potential passive stats
            const activeBonuses = getActiveSetBonus();
            activeBonuses.forEach(b => {
                 if(b.bonus.desc.includes('HP+15%')) stats.hp = Math.floor(stats.hp * 1.15);
                 if(b.bonus.desc.includes('æ”»æ’ƒåŠ›+15%')) stats.atk = Math.floor(stats.atk * 1.15);
                 if(b.bonus.desc.includes('é€Ÿåº¦+10%')) stats.spd = Math.floor(stats.spd * 1.10); // Changed from 20% to 10% for some sets
                 if(b.bonus.desc.includes('é€Ÿåº¦+20%')) stats.spd = Math.floor(stats.spd * 1.20);
            });
            if(master.potentials) { master.potentials.forEach((potential, index) => { if (character.unlockedPotentials[index] && potential.effect.type === 'party_passive_stat_buff') { stats[potential.effect.stat] = Math.floor(stats[potential.effect.stat] * potential.effect.multiplier); } }); }
            return stats;
        }
        function addCharacter(charId) {
            const existingChar = playerState.characters.find(c => c.charId === charId);
            if (existingChar) {
                existingChar.duplicationBonus = (existingChar.duplicationBonus || 0) + 1; const master = GAME_DATA.CHARACTERS[charId];
                setTimeout(() => showMessage(`${master.name}ã¯æ—¢ã«ä»²é–“ã«ãªã£ã¦ã„ã¾ã™ã€‚\né­‚ãŒå…±é³´ã—ã€èƒ½åŠ›ãŒä¸Šæ˜‡ã—ã¾ã—ãŸï¼<br>(é‡è¤‡ãƒœãƒ¼ãƒŠã‚¹: +${existingChar.duplicationBonus})`), 100);
                return { isNew: false };
            } else {
                const master = GAME_DATA.CHARACTERS[charId];
                const newChar = {
                    uniqueId: getNextUniqueId(), charId: charId, level: 1, exp: 0,
                    baseStats: { hp: master.hp, atk: master.atk, spd: master.spd },
                    equipped: { weapon: null, armor: null }, duplicationBonus: 0, limitBreakLevel: 0,
                    unlockedPotentials: master.potentials ? master.potentials.map(() => false) : []
                };
                playerState.characters.push(newChar);
                return { isNew: true };
            }
        }
        function addEquipment(equipId) { playerState.equipment.push({ uniqueId: getNextUniqueId(), equipId: equipId }); }
        function addBattleLog(message) { const log = document.getElementById('battle-log'); if(log) { log.innerHTML += `<p>${message}</p>`; log.scrollTop = log.scrollHeight; } }
        function checkEndings() {
            const allConquered = Object.values(playerState.mapProgress).every(map => Object.keys(map).length >= 64);
            if (allConquered && playerState.mentalPollution < 50 && !playerState.endingsUnlocked.salvation) { playerState.endingsUnlocked.salvation = true; showEnding('salvation'); }
            if (allConquered && playerState.mentalPollution >= 50 && !playerState.endingsUnlocked.corruption) { playerState.endingsUnlocked.corruption = true; showEnding('corruption'); }
            if (playerState.mentalPollution >= 100 && !playerState.endingsUnlocked.ruin) { playerState.endingsUnlocked.ruin = true; showEnding('ruin'); }
        }
        function showEnding(type) {
            const endings = { salvation: { title: 'æ•‘æ¸ˆã®å‹åˆ©', text: 'å…¨ã¦ã®ç•°æ¬¡å…ƒå­˜åœ¨ã‚’æ’é™¤ã—ã€åœ°çƒã¯æµ„åŒ–ã•ã‚ŒãŸã€‚é•·ã„æˆ¦ã„ã®æœ«ã€ã‚ãªãŸã¯ä¸–ç•Œã«å…‰ã‚’å–ã‚Šæˆ»ã—ãŸã®ã ã€‚äººé¡ã®æ–°ãŸãªæ­´å²ãŒã€ä»Šã“ã“ã‹ã‚‰å§‹ã¾ã‚‹ã€‚' }, corruption: { title: 'å •è½ã®å‹åˆ©', text: 'ç•°æ¬¡å…ƒã®åŠ›ã‚’å®Œå…¨ã«æ”¯é…ã—ãŸã‚ãªãŸã¯ã€æ—§äººé¡ã®æ”¯é…è€…ã¨ã—ã¦å›è‡¨ã™ã‚‹ã€‚åœ°çƒã¯æ–°ãŸãªç§©åºã®ä¸‹ã§ã€Œå®‰å®šã€ã—ãŸãŒã€ãã“ã«ä»¥å‰ã®æ¸©ã‹ã„å…‰ã¯ã‚‚ã†ãªã„ã€‚' }, ruin: { title: 'ç ´æ»…ã®çµ‚ã‚ã‚Š', text: 'å¢—å¤§ã™ã‚‹ç²¾ç¥æ±šæŸ“ã¯ã€ã¤ã„ã«ã‚ãªãŸã®å¿ƒã‚’è•ã¿å°½ãã—ãŸã€‚ã‚ãªãŸã¯æœ€å¾Œã®ç•°ç•Œæˆ¦å£«ã¨ã—ã¦ã€ç‹‚æ°—ã®æ¸¦ã®ä¸­ã§ä¸–ç•Œã¨å…±ã«çµ‚ç„‰ã‚’è¿ãˆãŸã€‚é™å¯‚ã ã‘ãŒæ®‹ã£ãŸã€‚' } };
            document.getElementById('ending-title').textContent = endings[type].title; document.getElementById('ending-text').textContent = endings[type].text; switchScreen('ending-screen');
        }
        function saveGame() {
            try {
                const saveDataString = JSON.stringify(playerState); const base64SaveData = btoa(unescape(encodeURIComponent(saveDataString)));
                const a = document.createElement('a'); a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(base64SaveData); a.download = `IsekaiChronicle_save_${new Date().toISOString().slice(0,10)}.txt`; a.style.display = 'none';
                document.body.appendChild(a); a.click(); document.body.removeChild(a); showMessage('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸã€‚');
            } catch (e) { console.error('Save failed:', e); showMessage('ã‚»ãƒ¼ãƒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); }
        }
        function loadGame(event) {
            const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const base64SaveData = e.target.result; const saveDataString = decodeURIComponent(escape(atob(base64SaveData))); const loadedState = JSON.parse(saveDataString);
                    if (loadedState && loadedState.characters && loadedState.resources !== undefined) {
                        playerState = loadedState;
                        // --- Data migration & validation for older save files ---
                        playerState.mapProgress = playerState.mapProgress || { ground: {}, heaven: {}, underground: {}, abyss: {}, soukai: {} }; Object.keys(GAME_DATA.MAPS).forEach(mapKey => { playerState.mapProgress[mapKey] = playerState.mapProgress[mapKey] || {}; });
                        playerState.endingsUnlocked = playerState.endingsUnlocked || { salvation: false, corruption: false, ruin: false }; playerState.godsDefeated = playerState.godsDefeated || {};
                        playerState.relicInventory = playerState.relicInventory || [];
                        playerState.equippedRelics = playerState.equippedRelics || { flower: null, clock: null, goblet: null, crown: null };
                        playerState.limitBreakMaterials = playerState.limitBreakMaterials || { ether_crystal: 0 };
                        playerState.clearedRelicHuntLevels = playerState.clearedRelicHuntLevels || {};
                        playerState.infiniteCorridor = playerState.infiniteCorridor || { highestFloor: 0, claimedRewards: {} };
                        playerState.characters.forEach(c => { c.duplicationBonus = c.duplicationBonus || 0; if (!c.baseStats || c.baseStats.def !== undefined) { const master = GAME_DATA.CHARACTERS[c.charId]; if(master) c.baseStats = { hp: master.hp, atk: master.atk, spd: master.spd }; } c.limitBreakLevel = c.limitBreakLevel || 0; const masterPotentials = GAME_DATA.CHARACTERS[c.charId]?.potentials || []; c.unlockedPotentials = c.unlockedPotentials || masterPotentials.map(() => false); });
                        playerState.nextUniqueId = playerState.nextUniqueId || Math.max(1, ...playerState.characters.map(c => c.uniqueId), ...playerState.equipment.map(e => e.uniqueId), ...playerState.relicInventory.map(r => r.uniqueId)) + 1;
                        
                        showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚', () => switchScreen('hub-screen'));
                    } else { throw new Error('ç„¡åŠ¹ãªã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚'); }
                } catch (error) { console.error('Load failed:', error); showMessage('ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚'); } finally { event.target.value = ''; }
            };
            reader.readAsText(file);
        }

        document.getElementById('start-game-btn').addEventListener('click', () => { initGame(); switchScreen('hub-screen'); });
        document.querySelectorAll('.back-to-hub').forEach(btn => btn.addEventListener('click', () => switchScreen('hub-screen')));
        document.querySelectorAll('.hub-btn[data-screen]').forEach(btn => btn.addEventListener('click', () => switchScreen(btn.dataset.screen)));
        document.querySelectorAll('.map-change-btn').forEach(btn => btn.addEventListener('click', (e) => { gameState.currentMap = e.target.dataset.map; document.querySelectorAll('.map-change-btn').forEach(b => b.classList.replace('btn-primary', 'btn-secondary')); e.target.classList.replace('btn-secondary', 'btn-primary'); renderMap(); }));
        document.querySelectorAll('.gacha-btn').forEach(btn => btn.addEventListener('click', (e) => { const type = e.currentTarget.dataset.gachaType; const count = parseInt(e.currentTarget.dataset.gachaCount); drawGacha(type, count); }));
        document.getElementById('message-ok-btn').addEventListener('click', () => messageModal.classList.add('hidden'));
        document.getElementById('close-character-detail-btn').addEventListener('click', () => characterDetailModal.classList.add('hidden'));
        document.getElementById('close-equipment-select-btn').addEventListener('click', () => equipmentSelectModal.classList.add('hidden'));
        document.getElementById('close-gacha-result-btn').addEventListener('click', () => gachaResultModal.classList.add('hidden'));
        document.getElementById('save-game-btn').addEventListener('click', saveGame);
        document.getElementById('load-game-btn').addEventListener('click', () => document.getElementById('load-file-input').click());
        document.getElementById('load-file-input').addEventListener('change', loadGame);
        document.getElementById('start-corridor-btn').addEventListener('click', startInfiniteCorridorRun);
        
        function initGame() {
            resetGameData();
            addCharacter('c001'); addCharacter('c006');
            assignToParty(1); assignToParty(2); addEquipment('w001');
            document.querySelector('.map-change-btn[data-map="ground"]').classList.replace('btn-secondary', 'btn-primary');
        }

        resetGameData();
        switchScreen('title-screen');
    });
    </script>
</body>
</html>
