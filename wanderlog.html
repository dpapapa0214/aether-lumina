<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="散歩の記録を作成。">
    <title>WanderLog - 散歩の記録</title>
    <link rel="icon" href="icons/wanderlog-icon.png">
    <link rel="apple-touch-icon" href="icons/wanderlog-icon.png">
    <link rel="manifest" href="manifest-wanderlog.json">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Dark Theme (Default) */
            --bg-deep: #0f172a;
            --text-main: #e2e8f0;
            --text-sub: #94a3b8;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-glow: #10b981;
            --card-hover: rgba(255, 255, 255, 0.05);
            --input-bg: rgba(0, 0, 0, 0.2);
            --timeline-line: #334155;
            --node-bg: #0f172a;
            --modal-overlay: rgba(15, 23, 42, 0.85);
            --inner-bg: rgba(15, 23, 42, 0.3); /* カード内部の背景色（ダーク） */
        }

        body.light-theme {
            /* Light Theme */
            --bg-deep: #f0f9ff;
            --text-main: #334155;
            --text-sub: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --accent-glow: #059669;
            --card-hover: rgba(255, 255, 255, 0.6);
            --input-bg: rgba(255, 255, 255, 0.6);
            --timeline-line: #cbd5e1;
            --node-bg: #f0f9ff;
            --modal-overlay: rgba(241, 245, 249, 0.85);
            --inner-bg: rgba(255, 255, 255, 0.6); /* カード内部の背景色（ライト） */
        }

        body {
            font-family: 'Zen Kaku Gothic New', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            transition: background-color 0.5s ease, color 0.5s ease;
            overflow-x: hidden;
        }

        /* Dynamic Background Pattern */
        .bg-pattern {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background-image: 
                radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(56, 189, 248, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        body.light-theme .bg-pattern {
            opacity: 0.6;
            background-image: 
                radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(14, 165, 233, 0.1) 0px, transparent 50%);
        }

        h1, h2, h3, .serif {
            font-family: 'Shippori Mincho', serif;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.05);
            transition: background 0.3s, border-color 0.3s;
        }

        .glass-btn {
            background: var(--card-hover);
            border: 1px solid var(--glass-border);
            color: var(--text-sub);
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }
        .glass-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--accent-glow);
            color: var(--accent-glow);
            transform: translateY(-2px);
        }
        .glass-btn.active {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--accent-glow);
            color: var(--accent-glow);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.15);
        }

        /* Timeline */
        .timeline-line {
            position: absolute;
            left: 24px; top: 0; bottom: 0; width: 1px;
            background: linear-gradient(to bottom, transparent, var(--timeline-line) 10%, var(--timeline-line) 90%, transparent);
            z-index: 0;
        }
        .timeline-node {
            background-color: var(--node-bg);
            border-color: var(--text-sub);
            z-index: 10;
        }

        /* View Transitions */
        .view-wrapper {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: none;
        }
        .view-wrapper.active {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        /* Inputs */
        .floating-input {
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            transition: 0.3s;
        }
        .floating-input:focus {
            border-color: var(--accent-glow);
            outline: none;
            background: rgba(16, 185, 129, 0.05);
        }
        
        /* Drop Zone */
        .drop-zone {
            border: 1px dashed var(--text-sub);
            background: var(--input-bg);
            transition: 0.3s;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent-glow);
            background: rgba(16, 185, 129, 0.05);
        }

        /* Lightbox */
        .lightbox-modal {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.4s ease forwards;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-sub); border-radius: 3px; opacity: 0.5; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-glow); }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col md:flex-row">

    <div class="bg-pattern"></div>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 md:relative md:w-24 md:h-full z-50 glass-panel md:flex md:flex-col md:items-center md:justify-between md:py-8 border-t md:border-t-0 md:border-r border-slate-700/10">
        <!-- Logo -->
        <div class="hidden md:flex flex-col items-center gap-4 cursor-pointer group" onclick="navigateTo('home')">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-500 to-cyan-600 flex items-center justify-center shadow-lg shadow-emerald-500/20 group-hover:scale-110 transition-transform">
                <i class="ph-fill ph-compass text-2xl text-white"></i>
            </div>
            <span class="text-xs tracking-widest text-slate-400 rotate-180" style="writing-mode: vertical-rl;">WANDERLOG</span>
        </div>

        <!-- Menu -->
        <div class="flex md:flex-col justify-around w-full md:w-auto md:gap-6 p-4 md:p-0">
            <button onclick="navigateTo('home')" id="nav-home" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center group relative" title="Timeline">
                <i class="ph ph-path text-2xl"></i>
            </button>
            <button onclick="navigateTo('gallery')" id="nav-gallery" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center group relative" title="Gallery">
                <i class="ph ph-squares-four text-2xl"></i>
            </button>
            <button onclick="navigateTo('participants')" id="nav-participants" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center group relative" title="Participants">
                <i class="ph ph-users text-2xl"></i>
            </button>
            <button onclick="navigateTo('stats')" id="nav-stats" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center group relative" title="Statistics">
                <i class="ph ph-chart-bar text-2xl"></i>
            </button>
        </div>

        <!-- Actions -->
        <div class="hidden md:flex flex-col items-center gap-4">
            <button onclick="toggleTheme()" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:text-emerald-500 transition-colors" id="themeBtn" title="Toggle Theme">
                <i class="ph-fill ph-moon text-xl"></i>
            </button>
            <div class="w-8 h-px bg-slate-500/30"></div>
            <button onclick="document.getElementById('importInput').click()" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:text-emerald-500 transition-colors" title="Import">
                <i class="ph ph-upload-simple text-xl"></i>
            </button>
            <button onclick="exportData()" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:text-emerald-500 transition-colors" title="Export">
                <i class="ph ph-download-simple text-xl"></i>
            </button>
            <input type="file" id="importInput" accept=".zip" class="hidden">
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 relative h-full overflow-hidden flex flex-col">
        
        <!-- Mobile Header -->
        <div class="md:hidden flex justify-between items-center p-4 glass-panel border-b border-slate-700/10 z-40">
            <div class="flex items-center gap-2" onclick="navigateTo('home')">
                <i class="ph-fill ph-compass text-emerald-500 text-xl"></i>
                <span class="serif font-bold text-lg">WanderLog</span>
            </div>
            <div class="flex gap-3 items-center">
                <button onclick="toggleTheme()" class="text-slate-400 hover:text-emerald-500"><i class="ph-fill ph-moon text-xl" id="themeBtnMobile"></i></button>
                <button onclick="openModal()" class="w-8 h-8 rounded-full bg-emerald-500 text-white flex items-center justify-center shadow-lg shadow-emerald-500/30"><i class="ph-bold ph-plus"></i></button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto overflow-x-hidden scroll-smooth relative" id="scroll-container">
            <div class="max-w-5xl mx-auto px-4 py-8 md:py-12 pb-24 md:pb-12 min-h-full">

                <!-- VIEW: HOME -->
                <div id="view-home" class="view-wrapper active">
                    <header class="mb-12 flex flex-col md:flex-row justify-between items-start md:items-end relative gap-6">
                        <div>
                            <p class="text-emerald-500 font-bold text-xs tracking-widest uppercase mb-2" id="headerLabel">Total Distance</p>
                            <h1 class="text-5xl md:text-7xl font-light tracking-tighter" id="headerTotalDistance">0.0<span class="text-2xl text-slate-500 ml-2 font-normal">km</span></h1>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <button id="clearFilterBtn" onclick="navigateTo('home')" class="hidden glass-btn px-4 py-2 rounded-full flex items-center gap-2 hover:bg-rose-500/10 hover:text-rose-500 hover:border-rose-500/30 transition-all">
                                <i class="ph-bold ph-x"></i>
                                <span class="text-sm font-bold">Clear Filter</span>
                            </button>

                            <button onclick="openModal()" class="hidden md:flex glass-btn bg-emerald-500/10 border-emerald-500/30 text-emerald-500 px-6 py-3 rounded-full items-center gap-2 hover:bg-emerald-500 hover:text-white group transition-all">
                                <span class="text-sm font-bold">New Entry</span>
                                <i class="ph ph-plus text-lg group-hover:rotate-90 transition-transform"></i>
                            </button>
                        </div>
                    </header>

                    <div id="emptyState" class="hidden flex flex-col items-center justify-center py-32 text-center opacity-60">
                        <i class="ph ph-footprints text-6xl text-slate-400 mb-4"></i>
                        <h3 class="serif text-2xl mb-2">旅の始まり</h3>
                        <p class="text-sm text-slate-500">最初の記録を追加して、地図を埋めていきましょう。</p>
                    </div>

                    <div class="relative pl-6 md:pl-0" id="timeline-container">
                        <div class="timeline-line" style="left: 20px;"></div>
                        <div id="walkList" class="flex flex-col gap-8 md:gap-10 relative">
                            <!-- Items Injected Here -->
                        </div>
                    </div>
                </div>

                <!-- VIEW: GALLERY -->
                <div id="view-gallery" class="view-wrapper">
                    <header class="mb-8 flex items-end gap-4 border-b border-slate-700/20 pb-4">
                        <h2 class="text-3xl font-light serif">Gallery</h2>
                        <span class="text-slate-500 text-sm pb-1 mb-1 font-mono" id="gallery-count">0 PHOTOS</span>
                    </header>
                    <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Masonry Injected Here -->
                    </div>
                </div>

                <!-- VIEW: PARTICIPANTS -->
                <div id="view-participants" class="view-wrapper">
                    <header class="mb-8 flex items-end gap-4 border-b border-slate-700/20 pb-4">
                        <h2 class="text-3xl font-light serif">Participants</h2>
                        <span class="text-slate-500 text-sm pb-1 mb-1 font-mono">ALL MEMBERS</span>
                    </header>
                    <div id="participantsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <!-- Cards Injected Here -->
                    </div>
                </div>

                <!-- VIEW: PARTICIPANT DETAIL (New) -->
                <div id="view-participant" class="view-wrapper">
                    <div id="participantContent">
                        <!-- Dynamic Content -->
                    </div>
                </div>

                <!-- VIEW: STATS -->
                <div id="view-stats" class="view-wrapper">
                    <header class="mb-8 flex items-end gap-4 border-b border-slate-700/20 pb-4">
                        <h2 class="text-3xl font-light serif">Statistics</h2>
                    </header>

                    <!-- Main Numbers -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="glass-panel p-6 rounded-2xl">
                            <div class="text-slate-500 text-xs uppercase tracking-wider mb-2">Logs</div>
                            <div class="text-3xl font-bold" id="statTotalCount">0</div>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl">
                            <div class="text-slate-500 text-xs uppercase tracking-wider mb-2">Total Distance</div>
                            <div class="text-3xl font-bold text-emerald-500" id="statTotalDist">0.0</div>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl">
                            <div class="text-slate-500 text-xs uppercase tracking-wider mb-2">Longest Walk</div>
                            <div class="text-3xl font-bold" id="statMaxDist">0.0</div>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl">
                            <div class="text-slate-500 text-xs uppercase tracking-wider mb-2">Photos</div>
                            <div class="text-3xl font-bold" id="statTotalPhotos">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Walk Ranking -->
                        <div class="glass-panel p-6 md:p-8 rounded-3xl relative overflow-hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-light serif">Distance Ranking <span class="text-xs text-slate-500 font-sans ml-2">Walks</span></h3>
                                <i class="ph-fill ph-trophy text-amber-400 text-xl"></i>
                            </div>
                            <div class="flex flex-col gap-3" id="rankingList"></div>
                        </div>

                        <!-- Participants Ranking -->
                        <div class="glass-panel p-6 md:p-8 rounded-3xl relative overflow-hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-light serif">Top Travelers <span class="text-xs text-slate-500 font-sans ml-2">Participants</span></h3>
                                <i class="ph-fill ph-users-three text-emerald-500 text-xl"></i>
                            </div>
                            <div class="flex flex-col gap-3" id="rankingParticipantsList"></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: DETAIL -->
                <div id="view-detail" class="view-wrapper">
                    <!-- Dynamic Content -->
                    <div id="detailContent"></div>
                </div>

            </div>
        </div>
    </main>

    <!-- Modal Form -->
    <div id="modal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 transition-opacity opacity-0" style="background: var(--modal-overlay); backdrop-filter: blur(4px);" id="modalBackdrop"></div>
        
        <div class="absolute inset-0 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative w-full max-w-3xl transform overflow-hidden rounded-3xl glass-panel text-left shadow-2xl transition-all opacity-0 scale-95" id="modalPanel">
                    
                    <form id="walkForm" onsubmit="saveWalk(event)" class="relative">
                        <!-- Header -->
                        <div class="px-8 py-5 border-b border-slate-700/10 flex justify-between items-center bg-white/5">
                            <h3 class="text-xl serif" id="modalTitle">New Memory</h3>
                            <button type="button" onclick="closeModal()" class="text-slate-400 hover:text-rose-500 transition-colors">
                                <i class="ph-bold ph-x text-xl"></i>
                            </button>
                        </div>

                        <div class="p-8 space-y-8 max-h-[75vh] overflow-y-auto">
                            
                            <!-- Section 1: Basic Info -->
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                                <div class="md:col-span-8 space-y-2">
                                    <label class="text-xs text-emerald-500 uppercase tracking-widest font-bold">Title</label>
                                    <input type="text" name="title" required placeholder="散歩のタイトル..." class="w-full floating-input px-4 py-3 rounded-lg text-lg">
                                </div>
                                <div class="md:col-span-4 space-y-2">
                                    <label class="text-xs text-emerald-500 uppercase tracking-widest font-bold">Date</label>
                                    <input type="date" name="date" required class="w-full floating-input px-4 py-3 rounded-lg">
                                </div>
                            </div>

                            <!-- Section 2: Details Grid -->
                            <div class="p-6 rounded-2xl bg-slate-500/5 border border-slate-500/10 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Distance -->
                                <div class="space-y-2">
                                    <label class="text-xs text-slate-500 uppercase tracking-widest">Distance (km)</label>
                                    <div class="relative">
                                        <input type="number" name="distance" step="0.01" min="0" placeholder="0.00" required class="w-full floating-input pl-4 pr-10 py-2 rounded-lg font-mono text-lg">
                                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm">km</span>
                                    </div>
                                </div>
                                
                                <!-- Time -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-2">
                                        <label class="text-xs text-slate-500 uppercase tracking-widest">Start</label>
                                        <input type="time" name="startTime" required class="w-full floating-input px-3 py-2 rounded-lg text-sm text-center">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs text-slate-500 uppercase tracking-widest">End</label>
                                        <input type="time" name="endTime" required class="w-full floating-input px-3 py-2 rounded-lg text-sm text-center">
                                    </div>
                                </div>

                                <!-- Route -->
                                <div class="md:col-span-2 space-y-3 pt-2 border-t border-slate-500/10">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 rounded-full bg-emerald-500 shrink-0"></div>
                                        <input type="text" name="startLocation" placeholder="Start Point (e.g. Park Entrance)" class="w-full bg-transparent border-b border-slate-500/30 focus:border-emerald-500 outline-none py-1 text-sm transition-colors">
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 rounded-full bg-rose-500 shrink-0"></div>
                                        <input type="text" name="endLocation" placeholder="Goal Point (e.g. Cafe)" class="w-full bg-transparent border-b border-slate-500/30 focus:border-rose-500 outline-none py-1 text-sm transition-colors">
                                    </div>
                                </div>
                            </div>

                            <!-- Section 3: Participants & Photos -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- Participants -->
                                <div class="space-y-2">
                                    <div class="flex justify-between items-end">
                                        <label class="text-xs text-emerald-500 uppercase tracking-widest font-bold">Participants</label>
                                        <span class="text-[10px] text-slate-500">Press Enter to add</span>
                                    </div>
                                    
                                    <div class="floating-input rounded-xl p-3 focus-within:ring-2 ring-emerald-500/20 min-h-[120px] content-start flex flex-wrap content-start gap-2">
                                        <div id="participantTags" class="contents"></div>
                                        <input type="text" id="participantInput" placeholder="Name..." class="bg-transparent border-none outline-none min-w-[80px] flex-1 text-sm placeholder-slate-500 h-7" onkeydown="handleParticipantInput(event)" autocomplete="off">
                                    </div>
                                    
                                    <!-- History Suggestions -->
                                    <div class="flex flex-wrap gap-2 pt-2" id="participantSuggestions">
                                        <!-- Injected -->
                                    </div>
                                </div>

                                <!-- Images -->
                                <div class="space-y-2">
                                    <label class="text-xs text-emerald-500 uppercase tracking-widest font-bold">Photos</label>
                                    <div class="drop-zone rounded-xl h-[120px] flex flex-col items-center justify-center cursor-pointer relative group transition-colors" id="dropArea">
                                        <i class="ph ph-images text-3xl text-slate-400 group-hover:text-emerald-500 mb-1 transition-colors"></i>
                                        <p class="text-xs text-slate-500">Drag & Drop or Click</p>
                                        <input class="file-input opacity-0 absolute inset-0 cursor-pointer" type="file" id="imageInput" multiple accept="image/*">
                                    </div>
                                    <div id="imagePreview" class="flex gap-2 overflow-x-auto py-2 scrollbar-thin h-20"></div>
                                </div>
                            </div>

                        </div>

                        <!-- Footer -->
                        <div class="p-6 border-t border-slate-700/10 bg-white/5 flex justify-end gap-3">
                            <button type="button" onclick="closeModal()" class="px-6 py-2.5 rounded-lg text-slate-500 hover:bg-slate-500/10 transition-colors">Cancel</button>
                            <button type="submit" class="px-8 py-2.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-500/20 transition-all font-medium flex items-center gap-2">
                                <i class="ph-bold ph-check"></i> Save Record
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="fixed inset-0 z-[120] hidden lightbox-modal flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeLightbox(event)">
        <button class="absolute top-4 right-4 text-white hover:text-emerald-400 transition-colors z-50 p-2" onclick="closeLightbox(null, true)">
            <i class="ph-bold ph-x text-3xl"></i>
        </button>
        <div class="relative max-w-5xl max-h-full">
            <img id="lightboxImage" src="" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" onclick="event.stopPropagation()">
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 right-6 z-[110] glass-panel px-6 py-4 rounded-xl shadow-2xl transform translate-x-full opacity-0 transition-all duration-500 flex items-center gap-3 border-l-4 border-emerald-500 bg-white dark:bg-slate-800 text-slate-800 dark:text-white">
        <i class="ph-fill ph-check-circle text-emerald-500 text-xl"></i>
        <span id="toastMessage" class="font-medium">Success</span>
    </div>

    <script>
        // --- DB Config ---
        const DB_NAME = 'WanderLogDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'entries';

        // --- State ---
        let walks = [];
        let currentImages = []; // {src, isHeader}
        let currentParticipants = []; 
        let currentView = 'home';
        let currentFilter = null; 
        let editingId = null;
        let isLightMode = false;

        // --- IDB Helper ---
        const idb = {
            db: null,
            init: async () => new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                };
                req.onsuccess = e => { idb.db = e.target.result; resolve(idb.db); };
                req.onerror = e => reject(e.target.error);
            }),
            getAll: async () => new Promise((resolve, reject) => {
                if(!idb.db) return reject('DB not init');
                const req = idb.db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            }),
            put: async (entry) => new Promise((resolve, reject) => {
                if(!idb.db) return reject('DB not init');
                const req = idb.db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).put(entry);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            }),
            delete: async (id) => new Promise((resolve, reject) => {
                if(!idb.db) return reject('DB not init');
                const req = idb.db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).delete(id);
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            })
        };

        // --- Init ---
        window.addEventListener('DOMContentLoaded', async () => {
            // Theme Init
            const savedTheme = localStorage.getItem('wanderlog_theme');
            if(savedTheme === 'light') toggleTheme(true);

            await idb.init();
            await loadData();
            navigateTo('home');
            initDragDrop();
        });

        // --- Theme Logic ---
        function toggleTheme(forceLight = null) {
            const body = document.body;
            const btnIcon = document.querySelector('#themeBtn i');
            const btnIconMobile = document.querySelector('#themeBtnMobile');
            
            if (forceLight === true) isLightMode = true;
            else if (forceLight === false) isLightMode = false;
            else isLightMode = !isLightMode;

            if (isLightMode) {
                body.classList.add('light-theme');
                btnIcon.classList.replace('ph-moon', 'ph-sun');
                btnIconMobile.classList.replace('ph-moon', 'ph-sun');
                localStorage.setItem('wanderlog_theme', 'light');
            } else {
                body.classList.remove('light-theme');
                btnIcon.classList.replace('ph-sun', 'ph-moon');
                btnIconMobile.classList.replace('ph-sun', 'ph-moon');
                localStorage.setItem('wanderlog_theme', 'dark');
            }
        }

        // --- Navigation ---
        function navigateTo(viewName, data = null) {
            currentView = viewName;
            
            // Handle Home Filter (Legacy) or Data passing
            if (viewName === 'home') {
                if (data && data.filterBy) currentFilter = { type: 'name', value: data.filterBy };
                else if (!data || !data.preserveFilter) currentFilter = null;
            }

            // Update UI
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            const navBtn = document.getElementById(`nav-${viewName}`);
            // Special case for Participant Detail -> highlight Participants tab
            if(viewName === 'participant') document.getElementById('nav-participants').classList.add('active');
            else if(navBtn) navBtn.classList.add('active');

            document.querySelectorAll('.view-wrapper').forEach(el => el.classList.remove('active'));
            setTimeout(() => {
                const target = document.getElementById(`view-${viewName}`);
                if(target) target.classList.add('active');
                document.getElementById('scroll-container').scrollTo({top: 0, behavior: 'smooth'});
            }, 50);

            // Render
            if (viewName === 'home') renderTimeline();
            if (viewName === 'gallery') renderGallery();
            if (viewName === 'participants') renderParticipants();
            if (viewName === 'stats') renderStats();
            if (viewName === 'detail' && data) renderDetailView(data.id || data);
            if (viewName === 'participant' && data) renderParticipantDetail(data); // data is name
        }

        async function loadData() {
            try {
                walks = await idb.getAll();
            } catch(e) { console.error("DB Load Error", e); }
        }

        // --- Render Helpers ---
        function getParticipantInitial(name) {
            return name ? name.charAt(0).toUpperCase() : '?';
        }

        function getColorForName(name) {
            const colors = ['bg-emerald-500', 'bg-blue-500', 'bg-amber-500', 'bg-rose-500', 'bg-purple-500', 'bg-cyan-500'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }

        function createWalkCard(walk) {
            const coverIdx = walk.coverIndex || 0;
            const coverSrc = (walk.images && walk.images[coverIdx]) ? walk.images[coverIdx] : null;
            const dateObj = new Date(walk.date);
            
            // Participants UI
            let participantsHtml = '';
            if (walk.participants && walk.participants.length > 0) {
                participantsHtml = `<div class="flex items-center gap-1 mt-3">` + 
                    walk.participants.slice(0, 3).map(p => `
                        <div class="w-6 h-6 rounded-full ${getColorForName(p)} text-white text-[10px] flex items-center justify-center border border-slate-900" title="${p}">${getParticipantInitial(p)}</div>
                    `).join('') +
                    (walk.participants.length > 3 ? `<span class="text-xs text-slate-500 ml-1">+${walk.participants.length-3}</span>` : '') +
                `</div>`;
            }

            const card = document.createElement('div');
            card.className = `relative flex flex-col md:flex-row items-center w-full pl-12 group cursor-pointer`;
            card.onclick = (e) => {
                    if(!e.target.closest('.action-btn')) navigateTo('detail', walk.id);
            };

            const node = document.createElement('div');
            node.className = `absolute left-0 w-4 h-4 rounded-full border-2 timeline-node top-8 transition-transform group-hover:scale-125 group-hover:border-emerald-500`;
            node.style.left = '14px';

            let mediaHtml = '';
            if(coverSrc) {
                mediaHtml = `
                    <div class="w-full h-48 md:w-48 md:h-full md:absolute md:right-0 md:top-0 md:rounded-r-xl md:rounded-bl-none overflow-hidden rounded-xl relative order-last md:order-none shrink-0 bg-slate-800">
                        <img src="${coverSrc}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                    </div>
                `;
            }

            card.innerHTML = `
                ${node.outerHTML}
                <div class="glass-panel p-1 rounded-2xl w-full hover:border-emerald-500/30 transition-all duration-300">
                    <div class="rounded-xl overflow-hidden p-5 flex flex-col md:flex-row gap-4 relative min-h-[140px] transition-colors" style="background: var(--inner-bg)">
                        
                        <!-- Info -->
                        <div class="flex-1 z-10">
                            <div class="flex items-baseline gap-3 mb-2">
                                <div class="text-xs font-bold text-emerald-500 tracking-wider">${dateObj.getFullYear()} / ${dateObj.toLocaleString('en-US', { month: 'short' }).toUpperCase()}</div>
                                <div class="text-2xl font-light leading-none">${dateObj.getDate()}</div>
                            </div>
                            <h3 class="text-xl serif font-bold group-hover:text-emerald-500 transition-colors mb-2 pr-16">${walk.title}</h3>
                            <div class="flex flex-wrap items-center gap-4 text-sm text-slate-500">
                                <span class="flex items-center gap-1"><i class="ph-fill ph-path text-emerald-500"></i> ${parseFloat(walk.distance).toFixed(2)} km</span>
                                <span class="flex items-center gap-1"><i class="ph-fill ph-clock"></i> ${walk.startTime} - ${walk.endTime}</span>
                            </div>
                            ${participantsHtml}
                        </div>

                        <!-- Edit/Delete -->
                        <div class="absolute top-4 right-4 z-30 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editWalk('${walk.id}', event)" class="action-btn text-slate-400 hover:text-emerald-500 p-2 rounded-full hover:bg-slate-500/10"><i class="ph-bold ph-pencil-simple"></i></button>
                            <button onclick="deleteWalk('${walk.id}', event)" class="action-btn text-slate-400 hover:text-rose-500 p-2 rounded-full hover:bg-slate-500/10"><i class="ph-bold ph-trash"></i></button>
                        </div>
                        
                        ${mediaHtml}
                    </div>
                </div>
            `;
            return card;
        }

        // --- Render: Timeline ---
        function renderTimeline() {
            const list = document.getElementById('walkList');
            const clearBtn = document.getElementById('clearFilterBtn');
            const headerLabel = document.getElementById('headerLabel');
            const headerDist = document.getElementById('headerTotalDistance');

            list.innerHTML = '';
            
            // Filter Logic (Legacy support, but primarily we use Detail View now)
            let displayWalks = [...walks];
            if (currentFilter) {
                clearBtn.classList.remove('hidden');
                displayWalks = displayWalks.filter(w => (w.participants || []).includes(currentFilter.value));
                headerLabel.innerText = `With ${currentFilter.value}`;
            } else {
                clearBtn.classList.add('hidden');
                headerLabel.innerText = 'Total Distance';
            }

            // Calc Total
            const total = displayWalks.reduce((sum, w) => sum + parseFloat(w.distance || 0), 0);
            headerDist.innerHTML = `${total.toFixed(2)}<span class="text-2xl text-slate-500 ml-2 font-normal">km</span>`;

            // Sort
            displayWalks.sort((a, b) => new Date(b.date) - new Date(a.date));

            if(displayWalks.length === 0) {
                if(currentFilter) list.innerHTML = `<div class="text-center text-slate-500 py-10">No records found.</div>`;
                else document.getElementById('emptyState').classList.remove('hidden');
                return;
            } else {
                document.getElementById('emptyState').classList.add('hidden');
            }

            // Render Cards
            displayWalks.forEach(walk => {
                list.appendChild(createWalkCard(walk));
            });
        }

        // --- Render: Participant Detail (New) ---
        function renderParticipantDetail(name) {
            const container = document.getElementById('participantContent');
            const filteredWalks = walks.filter(w => (w.participants || []).includes(name));
            
            // Calc Stats
            const totalDist = filteredWalks.reduce((sum, w) => sum + parseFloat(w.distance || 0), 0);
            const count = filteredWalks.length;
            const sorted = [...filteredWalks].sort((a, b) => new Date(b.date) - new Date(a.date));
            const firstDate = sorted.length > 0 ? sorted[sorted.length-1].date : '-';

            // Gather Photos
            let photos = [];
            filteredWalks.forEach(w => {
                if(w.images) photos.push(...w.images);
            });
            photos = photos.slice(0, 8); // Limit preview

            container.innerHTML = `
                <div class="animate-fadeIn">
                    <!-- Nav -->
                    <div class="flex items-center gap-4 mb-8">
                        <button onclick="navigateTo('participants')" class="flex items-center gap-2 text-emerald-500 hover:text-emerald-400 transition-colors">
                            <i class="ph-bold ph-arrow-left"></i> <span class="text-sm font-bold tracking-widest uppercase">All Participants</span>
                        </button>
                    </div>

                    <!-- Profile Header -->
                    <div class="glass-panel p-8 rounded-3xl mb-12 flex flex-col md:flex-row items-center md:items-start gap-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                        
                        <div class="w-32 h-32 rounded-full ${getColorForName(name)} text-white flex items-center justify-center text-6xl font-bold shadow-2xl shrink-0 z-10 border-4 border-slate-900/50">
                            ${getParticipantInitial(name)}
                        </div>
                        
                        <div class="flex-1 text-center md:text-left z-10">
                            <h1 class="text-4xl serif font-bold mb-2">${name}</h1>
                            <p class="text-slate-500 mb-6 text-sm">Adventure Partner since ${new Date(firstDate).toLocaleDateString()}</p>
                            
                            <div class="flex flex-wrap justify-center md:justify-start gap-6">
                                <div>
                                    <div class="text-3xl font-bold font-mono text-emerald-500">${count}</div>
                                    <div class="text-xs uppercase font-bold text-slate-500">Walks</div>
                                </div>
                                <div class="w-px bg-slate-700/20"></div>
                                <div>
                                    <div class="text-3xl font-bold font-mono text-emerald-500">${totalDist.toFixed(1)}</div>
                                    <div class="text-xs uppercase font-bold text-slate-500">Km Total</div>
                                </div>
                                <div class="w-px bg-slate-700/20"></div>
                                <div>
                                    <div class="text-3xl font-bold font-mono text-emerald-500">${photos.length}${filteredWalks.reduce((a,b)=>a+(b.images?.length||0),0) > 8 ? '+' : ''}</div>
                                    <div class="text-xs uppercase font-bold text-slate-500">Photos</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Layout: Timeline & Photos -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Timeline -->
                        <div class="lg:col-span-2 space-y-8">
                            <h3 class="text-xl serif font-bold flex items-center gap-2"><i class="ph-fill ph-path text-emerald-500"></i> Shared Journeys</h3>
                            <div class="relative pl-6 md:pl-0">
                                <div class="timeline-line" style="left: 20px;"></div>
                                <div id="participantWalkList" class="flex flex-col gap-8"></div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="space-y-8">
                            <!-- Recent Photos -->
                            <div class="glass-panel p-6 rounded-2xl">
                                <h3 class="text-sm font-bold uppercase tracking-widest text-slate-500 mb-4 flex items-center gap-2"><i class="ph-fill ph-image"></i> Recent Photos</h3>
                                <div class="grid grid-cols-2 gap-2">
                                    ${photos.length > 0 ? photos.map(src => `
                                        <div class="aspect-square rounded-lg overflow-hidden cursor-pointer hover:opacity-80 transition-opacity bg-slate-800" onclick="openLightbox('${src}')">
                                            <img src="${src}" class="w-full h-full object-cover">
                                        </div>
                                    `).join('') : '<div class="text-slate-500 text-xs col-span-2 text-center py-4">No photos available</div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Render Timeline Items
            const timelineList = document.getElementById('participantWalkList');
            if(sorted.length === 0) {
                timelineList.innerHTML = `<div class="text-slate-500 py-4">No walks found.</div>`;
            } else {
                sorted.forEach(walk => {
                    timelineList.appendChild(createWalkCard(walk));
                });
            }
        }

        // --- Render: Detail (Improved Participants & UI) ---
        function renderDetailView(walkId) {
            const walk = walks.find(w => w.id === walkId);
            if(!walk) return navigateTo('home');
            const container = document.getElementById('detailContent');
            const coverSrc = (walk.images && walk.images[walk.coverIndex||0]) || null;

            let participantsHtml = '';
            if (walk.participants && walk.participants.length > 0) {
                participantsHtml = `
                    <div class="mb-8">
                         <h4 class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-3 flex items-center gap-2"><i class="ph-fill ph-users"></i> Participants</h4>
                         <div class="flex flex-wrap gap-2">
                            ${walk.participants.map(p => `
                                <div class="flex items-center gap-2 bg-slate-500/10 rounded-full pl-1 pr-4 py-1.5 cursor-pointer hover:bg-emerald-500/20 border border-transparent hover:border-emerald-500/30 transition-all" onclick="navigateTo('participant', '${p}')">
                                    <div class="w-6 h-6 rounded-full ${getColorForName(p)} text-white flex items-center justify-center font-bold text-xs shadow-sm">
                                        ${getParticipantInitial(p)}
                                    </div>
                                    <span class="text-sm font-medium">${p}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="animate-fadeIn pb-12">
                    <!-- Nav -->
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="navigateTo('home')" class="flex items-center gap-2 text-emerald-500 hover:text-emerald-400 transition-colors">
                            <i class="ph-bold ph-arrow-left"></i> <span class="text-sm font-bold tracking-widest uppercase">Back</span>
                        </button>
                        <div class="flex gap-2">
                            <button onclick="editWalk('${walk.id}', event)" class="glass-btn px-4 py-2 rounded-lg flex items-center gap-2 text-sm"><i class="ph-bold ph-pencil-simple"></i> Edit</button>
                            <button onclick="deleteWalk('${walk.id}', event)" class="glass-btn px-4 py-2 rounded-lg text-rose-400 hover:text-rose-500 border-rose-500/20 hover:bg-rose-500/10 flex items-center gap-2 text-sm"><i class="ph-bold ph-trash"></i> Delete</button>
                        </div>
                    </div>

                    <!-- Hero -->
                    <div class="relative w-full h-[350px] md:h-[450px] rounded-3xl overflow-hidden mb-8 shadow-2xl group cursor-pointer bg-slate-800" onclick="${coverSrc ? `openLightbox('${coverSrc}')` : ''}">
                        ${coverSrc ? `<img src="${coverSrc}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-600"><i class="ph ph-image text-6xl"></i></div>`}
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/20 to-transparent"></div>
                        <div class="absolute bottom-0 left-0 w-full p-8 md:p-12">
                            <div class="text-emerald-400 text-sm font-bold tracking-widest uppercase mb-3 shadow-black drop-shadow-md border-l-4 border-emerald-500 pl-3 leading-none">${new Date(walk.date).toLocaleDateString()}</div>
                            <h1 class="text-4xl md:text-6xl serif text-white font-bold leading-tight drop-shadow-lg">${walk.title}</h1>
                        </div>
                    </div>

                    <!-- Participants Section -->
                    ${participantsHtml}

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
                        <div class="glass-panel p-5 rounded-2xl text-center">
                            <div class="text-3xl font-bold text-emerald-500 mb-1">${walk.distance}</div>
                            <div class="text-xs text-slate-500 uppercase font-bold">Kilometers</div>
                        </div>
                        <div class="glass-panel p-5 rounded-2xl text-center">
                            <div class="text-3xl font-bold mb-1">${walk.startTime}</div>
                            <div class="text-xs text-slate-500 uppercase font-bold">Start</div>
                        </div>
                        <div class="glass-panel p-5 rounded-2xl text-center">
                            <div class="text-3xl font-bold mb-1">${walk.endTime}</div>
                            <div class="text-xs text-slate-500 uppercase font-bold">End</div>
                        </div>
                        <div class="glass-panel p-5 rounded-2xl text-center flex flex-col justify-center">
                            <div class="flex items-center justify-center gap-2 text-sm font-medium">
                                <span class="truncate max-w-[80px]">${walk.startLocation || '?'}</span>
                                <i class="ph-bold ph-arrow-right text-emerald-500"></i>
                                <span class="truncate max-w-[80px]">${walk.endLocation || '?'}</span>
                            </div>
                            <div class="text-xs text-slate-500 uppercase font-bold mt-1">Route</div>
                        </div>
                    </div>

                    <!-- Photos -->
                    ${(walk.images && walk.images.length > 0) ? `
                        <div>
                            <h4 class="text-slate-500 text-sm font-bold uppercase tracking-widest mb-6 border-b border-slate-700/20 pb-2">Photo Gallery</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                ${walk.images.map(src => `
                                    <div class="aspect-square rounded-xl overflow-hidden cursor-zoom-in relative group bg-slate-800" onclick="openLightbox('${src}')">
                                        <img src="${src}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // --- Render: Participants List (Compact) ---
        function renderParticipants() {
            const container = document.getElementById('participantsGrid');
            container.innerHTML = '';

            const stats = {};
            walks.forEach(w => {
                (w.participants || []).forEach(p => {
                    if(!stats[p]) stats[p] = { count: 0, dist: 0, last: w.date };
                    stats[p].count++;
                    stats[p].dist += parseFloat(w.distance || 0);
                    if(new Date(w.date) > new Date(stats[p].last)) stats[p].last = w.date;
                });
            });

            const sorted = Object.entries(stats).sort((a,b) => b[1].count - a[1].count);

            if(sorted.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 text-slate-500">No participants yet.</div>`;
                return;
            }

            sorted.forEach(([name, data]) => {
                const el = document.createElement('div');
                // Compact Grid Item
                el.className = 'glass-panel p-4 rounded-xl flex items-center gap-3 hover:border-emerald-500/50 hover:bg-emerald-500/5 transition-all cursor-pointer group relative overflow-hidden';
                // Update to navigate to participant detail
                el.onclick = () => navigateTo('participant', name);
                
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full ${getColorForName(name)} text-white flex items-center justify-center text-lg font-bold shadow-md shrink-0">
                        ${getParticipantInitial(name)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-1">
                            <h3 class="font-bold text-sm truncate">${name}</h3>
                            <i class="ph-bold ph-caret-right text-slate-500 group-hover:text-emerald-500 text-xs"></i>
                        </div>
                        <div class="flex gap-3 text-xs text-slate-500">
                            <span class="flex items-center gap-1"><i class="ph-fill ph-footprints text-emerald-500"></i> ${data.count}</span>
                            <span class="flex items-center gap-1"><i class="ph-fill ph-path text-emerald-500"></i> ${data.dist.toFixed(0)}km</span>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- Render: Stats & Rankings ---
        function renderStats() {
            // Summary
            const totalDist = walks.reduce((acc, w) => acc + parseFloat(w.distance||0), 0);
            const maxDist = walks.reduce((max, w) => Math.max(max, parseFloat(w.distance||0)), 0);
            const totalPhotos = walks.reduce((acc, w) => acc + (w.images ? w.images.length : 0), 0);

            document.getElementById('statTotalCount').innerText = walks.length;
            document.getElementById('statTotalDist').innerText = totalDist.toFixed(1);
            document.getElementById('statMaxDist').innerText = maxDist.toFixed(1);
            document.getElementById('statTotalPhotos').innerText = totalPhotos;

            // 1. Walk Ranking (Distance)
            const rankList = document.getElementById('rankingList');
            rankList.innerHTML = '';
            const sortedWalks = [...walks].sort((a, b) => parseFloat(b.distance) - parseFloat(a.distance)).slice(0, 5);
            
            if(sortedWalks.length === 0) rankList.innerHTML = '<div class="text-slate-500 text-sm">No data</div>';
            
            sortedWalks.forEach((w, i) => {
                const el = document.createElement('div');
                el.className = 'flex items-center gap-3 p-3 rounded-xl bg-slate-500/5 hover:bg-slate-500/10 cursor-pointer transition-colors';
                el.onclick = () => navigateTo('detail', w.id);
                el.innerHTML = `
                    <div class="font-mono font-bold text-slate-400 w-6 text-center">#${i+1}</div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold truncate text-sm">${w.title}</div>
                        <div class="text-xs text-slate-500">${new Date(w.date).toLocaleDateString()}</div>
                    </div>
                    <div class="font-mono font-bold text-emerald-500">${parseFloat(w.distance).toFixed(1)}km</div>
                `;
                rankList.appendChild(el);
            });

            // 2. Participant Ranking (Distance)
            const partList = document.getElementById('rankingParticipantsList');
            partList.innerHTML = '';

            const pStats = {};
            walks.forEach(w => {
                (w.participants || []).forEach(p => {
                    if(!pStats[p]) pStats[p] = { dist: 0 };
                    pStats[p].dist += parseFloat(w.distance || 0);
                });
            });
            const sortedPart = Object.entries(pStats).sort((a,b) => b[1].dist - a[1].dist).slice(0, 5);

            if(sortedPart.length === 0) partList.innerHTML = '<div class="text-slate-500 text-sm">No participants data</div>';

            sortedPart.forEach(([name, data], i) => {
                const el = document.createElement('div');
                el.className = 'flex items-center gap-3 p-3 rounded-xl bg-slate-500/5 hover:bg-slate-500/10 cursor-pointer transition-colors';
                // Update to navigate to detail
                el.onclick = () => navigateTo('participant', name);
                el.innerHTML = `
                    <div class="font-mono font-bold text-slate-400 w-6 text-center">#${i+1}</div>
                    <div class="w-8 h-8 rounded-full ${getColorForName(name)} text-white flex items-center justify-center text-xs font-bold">
                        ${getParticipantInitial(name)}
                    </div>
                    <div class="flex-1 font-bold text-sm truncate">${name}</div>
                    <div class="font-mono font-bold text-emerald-500">${data.dist.toFixed(1)}km</div>
                `;
                partList.appendChild(el);
            });
        }

        // --- Gallery ---
        function renderGallery() {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = '';
            let allImgs = [];
            walks.forEach(w => {
                if(w.images) w.images.forEach(src => allImgs.push({src, id: w.id}));
            });
            allImgs.reverse();
            document.getElementById('gallery-count').innerText = `${allImgs.length} PHOTOS`;

            if(allImgs.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-slate-500 py-20">No photos yet.</div>';
                return;
            }

            allImgs.forEach(item => {
                const el = document.createElement('div');
                el.className = 'relative aspect-square rounded-xl overflow-hidden group cursor-pointer bg-slate-800';
                el.onclick = () => openLightbox(item.src);
                el.innerHTML = `
                    <img src="${item.src}" loading="lazy" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 opacity-80 group-hover:opacity-100">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                `;
                grid.appendChild(el);
            });
        }

        // --- Modal & Form Logic ---
        const modal = document.getElementById('modal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalPanel = document.getElementById('modalPanel');
        const form = document.getElementById('walkForm');
        
        // Open Modal (Edit or New)
        window.openModal = () => {
            editingId = null;
            form.reset();
            currentImages = [];
            currentParticipants = [];
            
            // Defaults
            const now = new Date();
            form['date'].value = now.toISOString().split('T')[0];
            form['startTime'].value = now.toTimeString().substring(0,5);
            form['endTime'].value = now.toTimeString().substring(0,5);
            
            renderImagePreviews();
            renderParticipantTags();
            renderParticipantSuggestions();
            
            document.getElementById('modalTitle').innerText = 'New Memory';
            showModalUI();
        }

        window.editWalk = (id, e) => {
            if(e) e.stopPropagation();
            const walk = walks.find(w => w.id === id);
            if(!walk) return;

            editingId = id;
            form['title'].value = walk.title;
            form['date'].value = walk.date;
            form['distance'].value = walk.distance;
            form['startTime'].value = walk.startTime;
            form['endTime'].value = walk.endTime;
            form['startLocation'].value = walk.startLocation || '';
            form['endLocation'].value = walk.endLocation || '';

            currentImages = (walk.images || []).map((src, idx) => ({
                src: src, isHeader: idx === (walk.coverIndex || 0)
            }));
            currentParticipants = [...(walk.participants || [])];

            renderImagePreviews();
            renderParticipantTags();
            renderParticipantSuggestions();

            document.getElementById('modalTitle').innerText = 'Edit Memory';
            showModalUI();
        }

        function showModalUI() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                modalPanel.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        window.closeModal = () => {
            modalBackdrop.classList.add('opacity-0');
            modalPanel.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                form.reset();
            }, 300);
        }

        // Form: Participants (FIXED + IME support)
        window.handleParticipantInput = (e) => {
            // Check if user is composting (IME for Japanese etc.)
            if (e.isComposing) return;
            
            if(e.key === 'Enter') { 
                e.preventDefault(); // Stop form submission
                addParticipantFromInput(); 
            }
        }
        window.addParticipantFromInput = () => {
            const input = document.getElementById('participantInput');
            const name = input.value.trim();
            if(name) {
                // Add if not exists
                if (!currentParticipants.includes(name)) {
                    currentParticipants.push(name);
                    renderParticipantTags();
                }
                // ALWAYS clear input and focus
                input.value = '';
                input.focus();
            }
        }
        window.addParticipant = (name) => {
            if(!currentParticipants.includes(name)) {
                currentParticipants.push(name);
                renderParticipantTags();
            }
        }
        window.removeParticipant = (name) => {
            currentParticipants = currentParticipants.filter(p => p !== name);
            renderParticipantTags();
        }
        function renderParticipantTags() {
            const container = document.getElementById('participantTags');
            container.innerHTML = '';
            currentParticipants.forEach(p => {
                const el = document.createElement('div');
                el.className = 'flex items-center gap-1 bg-emerald-500/20 text-emerald-600 dark:text-emerald-400 px-2 py-1 rounded text-xs border border-emerald-500/20 h-7 whitespace-nowrap';
                el.innerHTML = `${p} <button type="button" onclick="removeParticipant('${p}')" class="hover:text-rose-500 ml-1 flex items-center"><i class="ph-bold ph-x"></i></button>`;
                container.appendChild(el);
            });
        }
        
        // Suggest from history
        function renderParticipantSuggestions() {
            const container = document.getElementById('participantSuggestions');
            container.innerHTML = '';
            
            const allP = new Set();
            walks.forEach(w => (w.participants||[]).forEach(p => allP.add(p)));
            
            if(allP.size > 0) {
                container.innerHTML = '<span class="text-[10px] text-slate-500 uppercase tracking-widest w-full mb-1">Recent:</span>';
                allP.forEach(p => {
                    const el = document.createElement('button');
                    el.type = 'button';
                    el.className = 'px-2 py-1 rounded-md bg-slate-500/10 hover:bg-emerald-500/20 text-slate-500 hover:text-emerald-600 transition-colors text-xs';
                    el.innerText = p;
                    el.onclick = () => addParticipant(p);
                    container.appendChild(el);
                });
            }
        }

        // Form: Images (Unlimited)
        function initDragDrop() {
            const zone = document.getElementById('dropArea');
            const input = document.getElementById('imageInput');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => zone.addEventListener(ev, e => {e.preventDefault();e.stopPropagation()}, false));
            ['dragenter', 'dragover'].forEach(ev => zone.addEventListener(ev, () => zone.classList.add('dragover'), false));
            ['dragleave', 'drop'].forEach(ev => zone.addEventListener(ev, () => zone.classList.remove('dragover'), false));
            
            zone.addEventListener('drop', e => processFiles(e.dataTransfer.files));
            input.addEventListener('change', e => processFiles(e.target.files));
        }

        function processFiles(files) {
            // No Limit Check here
            Array.from(files).forEach(file => {
                if(!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = e => {
                    currentImages.push({ src: e.target.result, isHeader: currentImages.length === 0 });
                    renderImagePreviews();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderImagePreviews() {
            const container = document.getElementById('imagePreview');
            container.innerHTML = '';
            currentImages.forEach((img, idx) => {
                const el = document.createElement('div');
                el.className = `relative flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border ${img.isHeader ? 'border-emerald-500 ring-2 ring-emerald-500/20' : 'border-slate-500/30'} group`;
                el.innerHTML = `
                    <img src="${img.src}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-1">
                        <button type="button" onclick="setHeader(${idx})" class="text-white hover:text-emerald-400 p-1"><i class="ph-fill ph-star text-xs"></i></button>
                        <button type="button" onclick="removeImg(${idx})" class="text-white hover:text-rose-400 p-1"><i class="ph-fill ph-trash text-xs"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
        }
        window.setHeader = i => { currentImages.forEach((img, idx) => img.isHeader = idx===i); renderImagePreviews(); };
        window.removeImg = i => { currentImages.splice(i, 1); if(currentImages.length>0 && !currentImages.some(x=>x.isHeader)) currentImages[0].isHeader=true; renderImagePreviews(); };

        // Save
        window.saveWalk = async (e) => {
            e.preventDefault();
            const fd = new FormData(form);
            const entry = {
                title: fd.get('title'),
                date: fd.get('date'),
                distance: parseFloat(fd.get('distance')),
                startTime: fd.get('startTime'),
                endTime: fd.get('endTime'),
                startLocation: fd.get('startLocation'),
                endLocation: fd.get('endLocation'),
                images: currentImages.map(i => i.src),
                coverIndex: Math.max(0, currentImages.findIndex(i => i.isHeader)),
                participants: currentParticipants
            };

            try {
                if(editingId) {
                    const idx = walks.findIndex(w => w.id === editingId);
                    if(idx !== -1) {
                        walks[idx] = { ...walks[idx], ...entry };
                        await idb.put(walks[idx]);
                        showToast('Entry Updated');
                    }
                } else {
                    const newEntry = { id: crypto.randomUUID(), ...entry };
                    walks.push(newEntry);
                    await idb.put(newEntry);
                    showToast('Entry Saved');
                }
            } catch(err) { console.error(err); showToast('Save Failed', true); }

            closeModal();
            navigateTo(currentView, editingId ? editingId : null);
        }

        // Delete
        window.deleteWalk = async (id, e) => {
            if(e) e.stopPropagation();
            if(confirm('Delete this record?')) {
                await idb.delete(id);
                walks = walks.filter(w => w.id !== id);
                if(currentView === 'detail') navigateTo('home');
                else navigateTo(currentView);
                showToast('Deleted');
            }
        }

        // --- Utils ---
        window.openLightbox = (src) => {
            const lb = document.getElementById('lightbox');
            document.getElementById('lightboxImage').src = src;
            lb.classList.remove('hidden');
            requestAnimationFrame(() => lb.classList.remove('opacity-0'));
        }
        window.closeLightbox = (e, f) => {
            if(f || e.target.id === 'lightbox') {
                const lb = document.getElementById('lightbox');
                lb.classList.add('opacity-0');
                setTimeout(() => { lb.classList.add('hidden'); document.getElementById('lightboxImage').src=''; }, 300);
            }
        }

        function showToast(msg, isErr=false) {
            const t = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            t.className = `fixed top-6 right-6 z-[110] glass-panel px-6 py-4 rounded-xl shadow-2xl transition-all duration-500 flex items-center gap-3 border-l-4 ${isErr ? 'border-rose-500' : 'border-emerald-500'} bg-white dark:bg-slate-800 text-slate-800 dark:text-white`;
            t.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => t.classList.add('translate-x-full', 'opacity-0'), 3000);
        }

        // Export/Import (Simple Wrapper)
        window.exportData = async () => {
            if(walks.length===0) return showToast('No data', true);
            const zip = new JSZip();
            const json = walks.map(w => {
                const {images, ...rest} = w;
                return {...rest, _imgMap: images ? images.map((_, i) => `${w.id}_${i}.png`) : []};
            });
            zip.file("wanderlog_data_v3.json", JSON.stringify(json));
            const imgF = zip.folder("images");
            walks.forEach(w => {
                if(w.images) w.images.forEach((src, i) => imgF.file(`${w.id}_${i}.png`, src.split(',')[1], {base64:true}));
            });
            const blob = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `wanderlog_${new Date().toISOString().split('T')[0]}.zip`;
            a.click();
        }

        document.getElementById('importInput').onchange = async (e) => {
            const f = e.target.files[0];
            if(!f) return;
            try {
                const zip = new JSZip();
                const uz = await zip.loadAsync(f);
                // Simple V3 Support Only for brevity
                const raw = await uz.file("wanderlog_data_v3.json")?.async("string");
                if(!raw) throw new Error("Format?");
                const json = JSON.parse(raw);
                const imgF = uz.folder("images");
                let count = 0;
                for(const w of json) {
                    const exist = await new Promise(r => { 
                         const req = idb.db.transaction(STORE_NAME).objectStore(STORE_NAME).get(w.id);
                         req.onsuccess = () => r(req.result);
                    });
                    if(!exist) {
                        let imgs = [];
                        if(w._imgMap && imgF) {
                            for(const fn of w._imgMap) {
                                const file = imgF.file(fn);
                                if(file) imgs.push(`data:image/png;base64,${await file.async("base64")}`);
                            }
                            delete w._imgMap;
                        }
                        w.images = imgs;
                        walks.push(w);
                        await idb.put(w);
                        count++;
                    }
                }
                showToast(`Imported ${count}`);
                navigateTo('home');
            } catch(e) { console.error(e); showToast('Import Failed', true); }
        }

    </script>
</body>
</html>
